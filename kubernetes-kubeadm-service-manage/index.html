<!doctype html>
<html lang="zh" class="no-js">
  <head>
     <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3436206915764997"
     crossorigin="anonymous"></script>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>服务管理 - 尹亚亮</title>
<meta name="description" content="创建及删除service">


  <meta name="author" content="Your Name">
  
  <meta property="article:author" content="Your Name">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="zh_CN">
<meta property="og:site_name" content="尹亚亮">
<meta property="og:title" content="服务管理">
<meta property="og:url" content="/kubernetes-kubeadm-service-manage/">


  <meta property="og:description" content="创建及删除service">







  <meta property="article:published_time" content="2023-02-23T00:00:00+08:00">





  

  


<link rel="canonical" href="/kubernetes-kubeadm-service-manage/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Your Name",
      "url": "/"
    
  }
</script>


  <meta name="google-site-verification" content="A4xb7189wuH7_ck4RBWFMcZetHQvGEtM6c4NkowkBXo" />




  <meta name="yandex-verification" content="b34490b8136e1c97">


  <meta name="naver-site-verification" content="bcc3391cbb77775a98167dd719a9653fad02042a">


  <meta name="baidu-site-verification" content="code-faatzlDIxD">

<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="尹亚亮 Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    
  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">转到主导航栏</a></li>
    <li><a href="#main" class="screen-reader-shortcut">转到内容</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">转到底部</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          尹亚亮
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/year-archive/">归档</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">分类</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">切换菜单</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="服务管理">
    <meta itemprop="description" content="创建及删除service">
    <meta itemprop="datePublished" content="2023-02-23T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="/kubernetes-kubeadm-service-manage/" class="u-url" itemprop="url">服务管理
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-02-23T00:00:00+08:00">February 23, 2023</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> 目录</h4></header>
              <ul class="toc__menu"><li><a href="#创建及删除service">创建及删除service</a><ul><li><a href="#创建空间">创建空间</a></li><li><a href="#创建一个deployment的yaml文件">创建一个deployment的yaml文件</a></li><li><a href="#创建">创建</a></li><li><a href="#查看">查看</a></li><li><a href="#创建svc">创建svc</a></li><li><a href="#查看-1">查看</a></li><li><a href="#扩展deployment">扩展deployment</a></li><li><a href="#再次查看">再次查看</a></li><li><a href="#删除svc">删除svc</a></li><li><a href="#pod多个标签">pod多个标签</a></li></ul></li><li><a href="#验证负载均衡">验证负载均衡</a><ul><li><a href="#修改pod">修改pod</a></li><li><a href="#创建svc-1">创建svc</a></li><li><a href="#查看svc的ip">查看svc的IP</a></li><li><a href="#测试">测试</a></li><li><a href="#删除">删除</a></li><li><a href="#yaml创建service">yaml创建service</a></li></ul></li><li><a href="#服务发现">服务发现</a><ul><li><a href="#环境准备">环境准备</a></li><li><a href="#mysql">mysql</a></li><li><a href="#wordpress">wordpress</a></li><li><a href="#通过clusterip的方式访问">通过clusterip的方式访问</a></li><li><a href="#通过变量">通过变量</a></li><li><a href="#通过dns">通过DNS</a></li></ul></li><li><a href="#通过nodeport发布服务">通过NodePort发布服务</a><ul><li><a href="#为此pod创建类型为nodeport类型的service名字为blog">为此pod创建类型为NodePort类型的service,名字为blog</a></li></ul></li><li><a href="#通过loadbalancer">通过loadbalancer</a><ul><li><a href="#创建命名空间">创建命名空间</a></li><li><a href="#创建secret">创建secret</a></li><li><a href="#下载部署metallb">下载部署metallb</a></li><li><a href="#安装">安装</a></li><li><a href="#查看运行状态">查看运行状态</a></li><li><a href="#创建地址池">创建地址池</a></li><li><a href="#测试-1">测试</a></li><li><a href="#删除-1">删除</a></li></ul></li><li><a href="#创建ingress并发布服务">创建ingress并发布服务</a><ul><li><a href="#搭建ingress-nginx服务器">搭建ingress-nginx服务器</a></li><li><a href="#部署nginx-ingress-控制器">部署nginx ingress 控制器</a></li><li><a href="#环境准备-1">环境准备</a></li><li><a href="#定义ingress规则">定义ingress规则</a></li></ul></li></ul></li></ul>

            </nav>
          </aside>
        
        <h2 id="创建及删除service">创建及删除service</h2>

<p>service 通过 kube-proxy 实现 服务转发到后端的pod.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ds]# <span class="nb">mkdir </span>svc <span class="o">&amp;&amp;</span> <span class="nb">cd </span>svc
</code></pre></div></div>

<h4 id="创建空间">创建空间</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl create ns nssvc
namespace/nssvc created
<span class="o">[</span>root@master svc]# kubens nssvc
Context <span class="s2">"kubernetes-admin@kubernetes"</span> modified.
Active namespace is <span class="s2">"nssvc"</span><span class="nb">.</span>
</code></pre></div></div>

<h4 id="创建一个deployment的yaml文件">创建一个deployment的yaml文件</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl create deployment web <span class="nt">--image</span><span class="o">=</span>nginx <span class="nt">--dry-run</span><span class="o">=</span>client <span class="nt">-o</span> yaml <span class="o">&gt;</span> web1.yaml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app1</span><span class="pi">:</span> <span class="s">web1</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">web</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app1</span><span class="pi">:</span> <span class="s">web1</span>
  <span class="na">strategy</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app1</span><span class="pi">:</span> <span class="s">web1</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
        <span class="na">resources</span><span class="pi">:</span> <span class="pi">{}</span>
<span class="na">status</span><span class="pi">:</span> <span class="pi">{}</span>
   
</code></pre></div></div>

<ul>
  <li>
    <p>deployment 创建出来的pod都具有 app1=web1这个标签. template这里</p>
  </li>
  <li>
    <p>deployment通过app1=web1这个标签来定位pod . selector这里</p>
  </li>
  <li>
    <p>deployment自身的标签是app=web</p>

    <h4 id="创建">创建</h4>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl apply <span class="nt">-f</span> web1.yaml 
deployment.apps/web created
</code></pre></div></div>

<h4 id="查看">查看</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get deploy <span class="nt">-o</span> wide
NAME   READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES   SELECTOR
web    1/1     1            1           43s   nginx        nginx    <span class="nv">app1</span><span class="o">=</span>web1
</code></pre></div></div>

<h4 id="创建svc">创建svc</h4>

<p>svc可以基于deployment来创建</p>

<p>​        kubectl expose deployment deploy的名字 &gt; –name=服务名 –port=端口 –target-port=端口</p>

<p>也可以基于pod来创建</p>

<p>​         kubectl expose pod pod的名字 –name=服务名 –port=端口 –target-port=端口</p>

<p>–name 不指定默认使用deployment或者pod的名字</p>

<p>–port 指服务的端口,可以随意指定</p>

<p>–target-port 指后端运行的端口</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl expose deployment web <span class="nt">--name</span><span class="o">=</span>svc1 <span class="nt">--port</span><span class="o">=</span>80 <span class="nt">--target-port</span><span class="o">=</span>80
service/svc1 exposed
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get svc <span class="nt">-o</span> wide
NAME   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE   SELECTOR
svc1   ClusterIP   10.106.29.73   &lt;none&gt;        80/TCP    18s   <span class="nv">app1</span><span class="o">=</span>web1
</code></pre></div></div>

<p>svc1通过app1=web1来定位pod,所以 这个svc虽然是基于depolyment来创建,其实定位的是此deployment所管理的pod</p>

<h4 id="查看-1">查看</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl describe svc svc1
Name:              svc1
Namespace:         nssvc
Labels:            <span class="nv">app</span><span class="o">=</span>web
Annotations:       &lt;none&gt;
Selector:          <span class="nv">app1</span><span class="o">=</span>web1
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                10.106.29.73
IPs:               10.106.29.73
Port:              &lt;<span class="nb">unset</span><span class="o">&gt;</span>  80/TCP
TargetPort:        80/TCP
Endpoints:         10.244.166.142:80
Session Affinity:  None
Events:            &lt;none&gt;
</code></pre></div></div>

<p>Endpoints是后端的IP</p>

<h4 id="扩展deployment">扩展deployment</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl scale deploy web <span class="nt">--replicas</span><span class="o">=</span>3
deployment.apps/web scaled
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get pods <span class="nt">-o</span> wide 
NAME                   READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES
web-79974f444d-2g75d   1/1     Running   0          35s   10.244.166.144   node1   &lt;none&gt;           &lt;none&gt;
web-79974f444d-gzqz2   1/1     Running   0          35s   10.244.166.141   node1   &lt;none&gt;           &lt;none&gt;
web-79974f444d-xznvt   1/1     Running   0          10m   10.244.166.142   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<h4 id="再次查看">再次查看</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl describe svc svc1
Name:              svc1
Namespace:         nssvc
Labels:            <span class="nv">app</span><span class="o">=</span>web
Annotations:       &lt;none&gt;
Selector:          <span class="nv">app1</span><span class="o">=</span>web1
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                10.106.29.73
IPs:               10.106.29.73
Port:              &lt;<span class="nb">unset</span><span class="o">&gt;</span>  80/TCP
TargetPort:        80/TCP
Endpoints:         10.244.166.141:80,10.244.166.142:80,10.244.166.144:80
Session Affinity:  None
Events:            &lt;none&gt;
</code></pre></div></div>

<h4 id="删除svc">删除svc</h4>

<ul>
  <li>kubectl delete svc 名字</li>
  <li>kubectl delete -f svc的.yaml文件</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl delete svc svc1
service <span class="s2">"svc1"</span> deleted
</code></pre></div></div>

<h4 id="pod多个标签">pod多个标签</h4>

<p>可以指定根据哪个标签来定位</p>

<p>kubectl expose pod web-xxx –name=scv1 –selector=app1=web1 –port=80 –target-port=80</p>

<h3 id="验证负载均衡">验证负载均衡</h3>

<h4 id="修改pod">修改pod</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl <span class="nb">exec</span> <span class="nt">-ti</span> web-79974f444d-2g75d <span class="nt">--</span> bash
root@web-79974f444d-2g75d:/# <span class="nb">echo </span>111 <span class="o">&gt;</span> /usr/share/nginx/html/index.html 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl <span class="nb">exec</span> <span class="nt">-ti</span> web-79974f444d-gzqz2 <span class="nt">--</span> bash
root@web-79974f444d-gzqz2:/# <span class="nb">echo </span>222 <span class="o">&gt;</span> /usr/share/nginx/html/index.html 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl <span class="nb">exec</span> <span class="nt">-ti</span> web-79974f444d-xznvt <span class="nt">--</span> bash
root@web-79974f444d-xznvt:/# <span class="nb">echo </span>333 <span class="o">&gt;</span> /usr/share/nginx/html/index.html 
</code></pre></div></div>

<h4 id="创建svc-1">创建svc</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl expose deployment web <span class="nt">--name</span><span class="o">=</span>svc1 <span class="nt">--port</span><span class="o">=</span>80 <span class="nt">--target-port</span><span class="o">=</span>80
service/svc1 exposed
</code></pre></div></div>

<h4 id="查看svc的ip">查看svc的IP</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get svc
NAME   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
svc1   ClusterIP   10.103.10.106   &lt;none&gt;        80/TCP    18s
</code></pre></div></div>

<h4 id="测试">测试</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# curl <span class="nt">-s</span> 10.103.10.106
111
<span class="o">[</span>root@master svc]# curl <span class="nt">-s</span> 10.103.10.106
333
<span class="o">[</span>root@master svc]# curl <span class="nt">-s</span> 10.103.10.106
333
<span class="o">[</span>root@master svc]# curl <span class="nt">-s</span> 10.103.10.106
333
<span class="o">[</span>root@master svc]# curl <span class="nt">-s</span> 10.103.10.106
222
</code></pre></div></div>

<h4 id="删除">删除</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl delete svc svc1
service <span class="s2">"svc1"</span> deleted
</code></pre></div></div>

<h4 id="yaml创建service">yaml创建service</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl expose deployment web <span class="nt">--name</span><span class="o">=</span>svc1 <span class="nt">--port</span><span class="o">=</span>80 <span class="nt">--target-port</span><span class="o">=</span>80 <span class="nt">--dry-run</span><span class="o">=</span>client <span class="nt">-o</span> yaml <span class="o">&gt;</span> svc1.yaml
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
kind: Service
metadata:
  creationTimestamp: null
  labels:
    app: web
  name: svc1
spec:
  ports:
  - port: 80
    protocol: TCP
    targetPort: 80
  selector:
    app1: web1
status:
  loadBalancer: <span class="o">{}</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl apply <span class="nt">-f</span> svc1.yaml 
service/svc1 created
<span class="o">[</span>root@master svc]# kubectl get svc
NAME   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
svc1   ClusterIP   10.110.221.154   &lt;none&gt;        80/TCP    8s
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl delete deployment web
deployment.apps <span class="s2">"web"</span> deleted
<span class="o">[</span>root@master svc]# kubectl delete svc svc1
service <span class="s2">"svc1"</span> deleted
</code></pre></div></div>

<h3 id="服务发现">服务发现</h3>

<ul>
  <li>通过clusterIP发现svc</li>
  <li>通过变量发现svc</li>
  <li>通过dns发现svc</li>
</ul>

<h4 id="环境准备">环境准备</h4>

<h4 id="mysql">mysql</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">mysql:8</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">env</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">redhat</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_USER</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">tom</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_PASSWORD</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">redhat</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_DATABASE</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">blog</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
      <span class="na">containerPort</span><span class="pi">:</span> <span class="m">3306</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get pods <span class="nt">-o</span> wide
NAME    READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES
mysql   1/1     Running   0          32s   10.244.166.140   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>为mysql创建svc</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl expose pod mysql <span class="nt">--name</span><span class="o">=</span>dbsvc <span class="nt">--port</span><span class="o">=</span>3306
service/dbsvc exposed
</code></pre></div></div>

<h4 id="wordpress">wordpress</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">wordpress:latest</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_USE</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">root</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_PASSWORD</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">redhat</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_NAME</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">blog</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_HOST</span>
        <span class="na">value</span><span class="pi">:</span> 
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
      <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<p>mysql的主机地址没有填写</p>

<h4 id="通过clusterip的方式访问">通过clusterip的方式访问</h4>

<p>获取mysql的svc ip地址</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get svc
NAME    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
dbsvc   ClusterIP   10.106.124.116   &lt;none&gt;        3306/TCP   50m
</code></pre></div></div>

<p>修改wordpress的地址</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">wordpress:latest</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_USE</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">root</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_PASSWORD</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">redhat</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_NAME</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">blog</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_HOST</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">10.106.124.116</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
      <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<p>创建wordpress</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl apply <span class="nt">-f</span> pod-wordpress.yaml 
pod/wordpress created
</code></pre></div></div>

<p>查看状态</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get pods <span class="nt">-o</span> wide
NAME        READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES
mysql       1/1     Running   0          79m   10.244.166.140   node1   &lt;none&gt;           &lt;none&gt;
wordpress   1/1     Running   0          21m   10.244.166.147   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>测试</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>firefox &amp;
</code></pre></div></div>

<h4 id="通过变量">通过变量</h4>

<p>同一个命名空间内,如果先存在了A服务,则在创建B pod的时候,B pod会自动学习到A服务的变量，标记服务IP和端口的格式如下</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A 服务名_SERVICE_HOST
B 服务名_SERVICE_PORT
</code></pre></div></div>

<p><strong>服务名要大写</strong></p>

<p>在B pod的yaml文件里要引用关于A的变量时候,用$(变量名)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@wordpress:/var/www/html# <span class="nb">env</span> | <span class="nb">grep </span>DB
<span class="nv">DBSVC_PORT</span><span class="o">=</span>tcp://10.106.124.116:3306
<span class="nv">DBSVC_PORT_3306_TCP_ADDR</span><span class="o">=</span>10.106.124.116
<span class="nv">DBSVC_PORT_3306_TCP</span><span class="o">=</span>tcp://10.106.124.116:3306
<span class="nv">DBSVC_PORT_3306_TCP_PORT</span><span class="o">=</span>3306
<span class="nv">WORDPRESS_DB_USE</span><span class="o">=</span>root
<span class="nv">WORDPRESS_DB_HOST</span><span class="o">=</span>10.106.124.116
<span class="nv">DBSVC_SERVICE_PORT</span><span class="o">=</span>3306
<span class="nv">WORDPRESS_DB_PASSWORD</span><span class="o">=</span>redhat
<span class="nv">DBSVC_SERVICE_HOST</span><span class="o">=</span>10.106.124.116
<span class="nv">WORDPRESS_DB_NAME</span><span class="o">=</span>blod
<span class="nv">DBSVC_PORT_3306_TCP_PROTO</span><span class="o">=</span>tcp
</code></pre></div></div>

<p>所以在wordpress的yaml文件中，可以直接使用变量的方式获取dbsvc的IP</p>

<p>删除wordpress的pod</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl delete pod wordpress <span class="nt">--force</span>
warning: Immediate deletion does not <span class="nb">wait </span><span class="k">for </span>confirmation that the running resource has been terminated. The resource may <span class="k">continue </span>to run on the cluster indefinitely.
pod <span class="s2">"wordpress"</span> force deleted
</code></pre></div></div>

<p>创建</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl apply <span class="nt">-f</span> pod-wordpress.yaml 
pod/wordpress created
</code></pre></div></div>

<p>删除</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl delete pod wordpress
pod <span class="s2">"wordpress"</span> deleted
</code></pre></div></div>

<h4 id="通过dns">通过DNS</h4>

<p>kubernetes安装后 有一个coredns的deplyment</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get pods <span class="nt">-n</span> kube-system| <span class="nb">grep </span>dns
coredns-545d6fc579-j9f7q                   1/1     Running   7          12d
coredns-545d6fc579-t7st8                   1/1     Running   7          12d
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get svc <span class="nt">-n</span> kube-system
NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                  AGE
kube-dns         ClusterIP   10.96.0.10       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   12d
</code></pre></div></div>

<p>在k8s中,只要创建了服务,都会自动到coreDNS里去注册,这样coreDNS会知道每个服务的IP地址</p>

<p>同一个命名空间,可以通过服务名来访问</p>

<p>临时创建一个pod测试</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl run busybox <span class="nt">--rm</span> <span class="nt">-ti</span> <span class="nt">--image</span><span class="o">=</span>busybox sh
If you don<span class="s1">'t see a command prompt, try pressing enter.
/ # ping dbsvc
PING dbsvc (10.106.124.116): 56 data bytes
</span></code></pre></div></div>

<p>可以看到已经解析了</p>

<p>如果访问其它命名空间的服务使用</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>服务名.命名空间
</code></pre></div></div>

<p>修改wordpress的配置</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">wordpress:latest</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_USE</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">root</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_PASSWORD</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">redhat</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_NAME</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">blog</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_HOST</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">dbsvc</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
      <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl apply <span class="nt">-f</span> pod-wordpress.yaml 
pod/wordpress created
</code></pre></div></div>

<p>查看</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get pods <span class="nt">-o</span> wide 
NAME        READY   STATUS    RESTARTS   AGE    IP               NODE    NOMINATED NODE   READINESS GATES
mysql       1/1     Running   0          104m   10.244.166.140   node1   &lt;none&gt;           &lt;none&gt;
wordpress   1/1     Running   0          31s    10.244.166.149   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<h3 id="通过nodeport发布服务">通过NodePort发布服务</h3>

<p>把服务的端口映射到物理机器(kubernetes集群中所有节点)的某端口,以后访问服务器该端口的时候,请求就会转发到该svc上</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get pods
NAME        READY   STATUS    RESTARTS   AGE
mysql       1/1     Running   0          121m
wordpress   1/1     Running   0          17m
</code></pre></div></div>

<h4 id="为此pod创建类型为nodeport类型的service名字为blog">为此pod创建类型为NodePort类型的service,名字为blog</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl expose pod wordpress <span class="nt">--name</span><span class="o">=</span>blog <span class="nt">--port</span><span class="o">=</span>80 <span class="nt">--type</span><span class="o">=</span>NodePort 
service/blog exposed
</code></pre></div></div>

<p>查看服务</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get svc
NAME    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
blog    NodePort    10.110.246.12    &lt;none&gt;        80:31285/TCP   5m19s
dbsvc   ClusterIP   10.106.124.116   &lt;none&gt;        3306/TCP       126m
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get node <span class="nt">-o</span> wide
NAME     STATUS   ROLES                  AGE   VERSION   INTERNAL-IP       EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION          CONTAINER-RUNTIME
master   Ready    control-plane,master   12d   v1.21.1   192.168.122.200   &lt;none&gt;        CentOS Linux 7 <span class="o">(</span>Core<span class="o">)</span>   3.10.0-862.el7.x86_64   docker://20.10.17
node1    Ready    node1                  12d   v1.21.1   192.168.122.202   &lt;none&gt;        CentOS Linux 7 <span class="o">(</span>Core<span class="o">)</span>   3.10.0-862.el7.x86_64   docker://20.10.17
node2    Ready    node2                  12d   v1.21.1   192.168.122.203   &lt;none&gt;        CentOS Linux 7 <span class="o">(</span>Core<span class="o">)</span>   3.10.0-862.el7.x86_64   docker://20.10.17
</code></pre></div></div>

<p>通过任一node的IP+ 31285端口都可以访问这个服务</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.122.202:31285/
</code></pre></div></div>

<p>删除以上pod和svc</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl delete pod mysql
pod <span class="s2">"mysql"</span> deleted
<span class="o">[</span>root@master svc]# kubectl delete pod wordpress <span class="nt">-force</span>
error: the path <span class="s2">"orce"</span> does not exist
<span class="o">[</span>root@master svc]# kubectl delete pod wordpress <span class="nt">--force</span>
warning: Immediate deletion does not <span class="nb">wait </span><span class="k">for </span>confirmation that the running resource has been terminated. The resource may <span class="k">continue </span>to run on the cluster indefinitely.
pod <span class="s2">"wordpress"</span> force deleted
<span class="o">[</span>root@master svc]# kubectl get svc
NAME    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
blog    NodePort    10.110.246.12    &lt;none&gt;        80:31285/TCP   32m
dbsvc   ClusterIP   10.106.124.116   &lt;none&gt;        3306/TCP       153m
<span class="o">[</span>root@master svc]# kubectl delete svc blog
service <span class="s2">"blog"</span> deleted
<span class="o">[</span>root@master svc]# kubectl delete svc dbsvc
service <span class="s2">"dbsvc"</span> deleted
</code></pre></div></div>

<h3 id="通过loadbalancer">通过loadbalancer</h3>

<h4 id="创建命名空间">创建命名空间</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl create ns metallb-system
namespace/metallb-system created
</code></pre></div></div>

<h4 id="创建secret">创建secret</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl create secret generic <span class="nt">-n</span> metallb-system memberlist <span class="nt">--from-literal</span><span class="o">=</span><span class="nv">secretkey</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span>openssl rand <span class="nt">-base64</span> 128<span class="si">)</span><span class="s2">"</span>
secret/memberlist created
</code></pre></div></div>

<h4 id="下载部署metallb">下载部署metallb</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/metallb.yaml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
</code></pre></div></div>

<h4 id="安装">安装</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl apply <span class="nt">-f</span> metallb.yaml 
Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="k">in </span>v1.21+, unavailable <span class="k">in </span>v1.25+
podsecuritypolicy.policy/controller configured
podsecuritypolicy.policy/speaker configured
serviceaccount/controller unchanged
serviceaccount/speaker unchanged
clusterrole.rbac.authorization.k8s.io/metallb-system:controller unchanged
clusterrole.rbac.authorization.k8s.io/metallb-system:speaker unchanged
role.rbac.authorization.k8s.io/config-watcher unchanged
role.rbac.authorization.k8s.io/pod-lister unchanged
clusterrolebinding.rbac.authorization.k8s.io/metallb-system:controller unchanged
clusterrolebinding.rbac.authorization.k8s.io/metallb-system:speaker unchanged
rolebinding.rbac.authorization.k8s.io/config-watcher unchanged
rolebinding.rbac.authorization.k8s.io/pod-lister unchanged
daemonset.apps/speaker unchanged
deployment.apps/controller unchanged
</code></pre></div></div>

<h4 id="查看运行状态">查看运行状态</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl get pods <span class="nt">-n</span> metallb-system
NAME                         READY   STATUS    RESTARTS   AGE
controller-b4df945f8-d9kc4   1/1     Running   0          2m17s
speaker-dwwhj                1/1     Running   0          2m17s
speaker-gnlkz                1/1     Running   0          2m17s
speaker-jdv9v                1/1     Running   0          2m17s
</code></pre></div></div>

<h4 id="创建地址池">创建地址池</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">metallb-system</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">config</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">address-pools:</span>
    <span class="s">- name: default</span>
      <span class="s">protocol: layer2</span>
      <span class="s">addresses:</span>
      <span class="s">- 192.168.122.200-192.168.122.205  # 虚拟机使用桥接网卡地址网段</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl apply <span class="nt">-f</span> pool1.yaml 
configmap/config created
</code></pre></div></div>

<h4 id="测试-1">测试</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl run pod1 <span class="nt">--image</span><span class="o">=</span>nginx <span class="nt">--image-pull-policy</span><span class="o">=</span>IfNotPresent
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl expose <span class="nt">--name</span><span class="o">=</span>svc10 pod pod1 <span class="nt">--port</span><span class="o">=</span>80 <span class="nt">--type</span><span class="o">=</span>LoadBalancer
service/svc10 exposed
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl get svc
NAME    TYPE           CLUSTER-IP       EXTERNAL-IP       PORT<span class="o">(</span>S<span class="o">)</span>        AGE
svc1    ClusterIP      10.107.76.165    &lt;none&gt;            80/TCP         2d3h
svc10   LoadBalancer   10.100.124.221   192.168.122.202   80:30113/TCP   4s
svc2    ClusterIP      10.107.147.148   &lt;none&gt;            80/TCP         2d3h
svc3    ClusterIP      10.111.192.216   &lt;none&gt;            80/TCP         2d3h
</code></pre></div></div>

<p>访问192.168.122.202则成功</p>

<h4 id="删除-1">删除</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<h3 id="创建ingress并发布服务">创建ingress并发布服务</h3>

<p>nodeport 会在服务增多的情况下导致映射端口过多</p>

<h4 id="搭建ingress-nginx服务器">搭建ingress-nginx服务器</h4>

<ul>
  <li>本质通过nginx的反向代理来实现.然后在用户所在的命名空间写ingress规则，这些规则会嵌入 ingres-nginx控制器里</li>
  <li>用户在自己的命名空间里定义ingress规则</li>
</ul>

<p>​     www1.rhce.cc 转发到svc1</p>

<p>​     www2.rhce.cc 转发到svc2</p>

<p>​      www3.rhce.cc 转发到svc3</p>

<p>我们把www1.rhce.cc 和  www2.rhce.cc 都解析为ingress-nginx控制器所在的IP，以后客户端访问www1.rhce.cc的时候访问的就是ingress-nginx控制器，根据规则,控制器会把请求转发到svc1</p>

<h4 id="部署nginx-ingress-控制器">部署nginx ingress 控制器</h4>

<p>参考:  https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal-clusters</p>

<p>镜像: https://hub.docker.com/r/anjia0532/google-containers.ingress-nginx.controller/tags</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.3.0/deploy/static/provider/baremetal/deploy.yaml
</code></pre></div></div>

<p>查看命名空间</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get ns
NAME              STATUS   AGE
default           Active   14d
ingress-nginx     Active   31s
kube-node-lease   Active   14d
kube-public       Active   14d
kube-system       Active   14d
nsdeploy          Active   2d21h
nsds              Active   44h
nsjob             Active   30h
nsprobe           Active   44h
nssec             Active   4d21h
nssvc             Active   29h
nsvolume          Active   6d20h
</code></pre></div></div>

<p>查看deployment</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get deploy <span class="nt">-n</span> ingress-nginx
NAME                       READY   UP-TO-DATE   AVAILABLE   AGE
ingress-nginx-controller   0/1     1            0           46s
</code></pre></div></div>

<p>查看pod节点</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">[</span>root@master svc]# kubectl get pods <span class="nt">-n</span> ingress-nginx <span class="nt">-o</span> wide 
NAME                                        READY   STATUS              RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES
ingress-nginx-admission-create-t265f        0/1     ErrImagePull        0          61s   10.244.166.157   node1   &lt;none&gt;           &lt;none&gt;
ingress-nginx-admission-patch-72c7w         0/1     ImagePullBackOff    0          61s   10.244.166.158   node1   &lt;none&gt;           &lt;none&gt;
ingress-nginx-controller-787f856bb4-2qd46   0/1     ContainerCreating   0          61s   &lt;none&gt;           node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>这里发现ErrImagePull报错:</p>

<p>修改yaml文件</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Namespace</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">automountServiceAccountToken</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">namespaces</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">configmaps</span>
  <span class="pi">-</span> <span class="s">pods</span>
  <span class="pi">-</span> <span class="s">secrets</span>
  <span class="pi">-</span> <span class="s">endpoints</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">services</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">networking.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingresses</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">networking.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingresses/status</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">update</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">networking.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingressclasses</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resourceNames</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingress-controller-leader</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">configmaps</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">update</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">configmaps</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">create</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">coordination.k8s.io</span>
  <span class="na">resourceNames</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingress-controller-leader</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">leases</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">update</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">coordination.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">leases</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">create</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">events</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">create</span>
  <span class="pi">-</span> <span class="s">patch</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">secrets</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">create</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">configmaps</span>
  <span class="pi">-</span> <span class="s">endpoints</span>
  <span class="pi">-</span> <span class="s">nodes</span>
  <span class="pi">-</span> <span class="s">pods</span>
  <span class="pi">-</span> <span class="s">secrets</span>
  <span class="pi">-</span> <span class="s">namespaces</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">coordination.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">leases</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">nodes</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">services</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">networking.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingresses</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">events</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">create</span>
  <span class="pi">-</span> <span class="s">patch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">networking.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingresses/status</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">update</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">networking.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingressclasses</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">admissionregistration.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">validatingwebhookconfigurations</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">update</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">RoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">RoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">allow-snippet-annotations</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-controller</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-controller</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">appProtocol</span><span class="pi">:</span> <span class="s">http</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="s">http</span>
  <span class="pi">-</span> <span class="na">appProtocol</span><span class="pi">:</span> <span class="s">https</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">https</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">443</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="s">https</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="c1"># type: NodePort</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span> <span class="c1">#这里改成LoadBalancer，获取外部IP</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-controller-admission</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">appProtocol</span><span class="pi">:</span> <span class="s">https</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">https-webhook</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">443</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="s">webhook</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-controller</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">minReadySeconds</span><span class="pi">:</span> <span class="m">0</span>
  <span class="na">revisionHistoryLimit</span><span class="pi">:</span> <span class="m">10</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
      <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
      <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
        <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
        <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">/nginx-ingress-controller</span>
        <span class="pi">-</span> <span class="s">--election-id=ingress-controller-leader</span>
        <span class="pi">-</span> <span class="s">--controller-class=k8s.io/ingress-nginx</span>
        <span class="pi">-</span> <span class="s">--ingress-class=nginx</span>
        <span class="pi">-</span> <span class="s">--configmap=$(POD_NAMESPACE)/ingress-nginx-controller</span>
        <span class="pi">-</span> <span class="s">--validating-webhook=:8443</span>
        <span class="pi">-</span> <span class="s">--validating-webhook-certificate=/usr/local/certificates/cert</span>
        <span class="pi">-</span> <span class="s">--validating-webhook-key=/usr/local/certificates/key</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">POD_NAME</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.name</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">POD_NAMESPACE</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.namespace</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">LD_PRELOAD</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">/usr/local/lib/libmimalloc.so</span>
        <span class="c1"># image: registry.k8s.io/ingress-nginx/controller:v1.3.0@sha256:d1707ca76d3b044ab8a28277a2466a02100ee9f58a86af1535a3edf9323ea1b5</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">anjia0532/google-containers.ingress-nginx.controller:v1.3.0</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">lifecycle</span><span class="pi">:</span>
          <span class="na">preStop</span><span class="pi">:</span>
            <span class="na">exec</span><span class="pi">:</span>
              <span class="na">command</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">/wait-shutdown</span>
        <span class="na">livenessProbe</span><span class="pi">:</span>
          <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">5</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/healthz</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">10254</span>
            <span class="na">scheme</span><span class="pi">:</span> <span class="s">HTTP</span>
          <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">10</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">10</span>
          <span class="na">successThreshold</span><span class="pi">:</span> <span class="m">1</span>
          <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">1</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">controller</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">443</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">https</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8443</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">webhook</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
        <span class="na">readinessProbe</span><span class="pi">:</span>
          <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">3</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/healthz</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">10254</span>
            <span class="na">scheme</span><span class="pi">:</span> <span class="s">HTTP</span>
          <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">10</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">10</span>
          <span class="na">successThreshold</span><span class="pi">:</span> <span class="m">1</span>
          <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">1</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s">100m</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">90Mi</span>
        <span class="na">securityContext</span><span class="pi">:</span>
          <span class="na">allowPrivilegeEscalation</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">capabilities</span><span class="pi">:</span>
            <span class="na">add</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">NET_BIND_SERVICE</span>
            <span class="na">drop</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">ALL</span>
          <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">101</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/usr/local/certificates/</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">webhook-cert</span>
          <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">dnsPolicy</span><span class="pi">:</span> <span class="s">ClusterFirst</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="na">kubernetes.io/os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
      <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">300</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">webhook-cert</span>
        <span class="na">secret</span><span class="pi">:</span>
          <span class="na">secretName</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission-create</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
        <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
        <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
        <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
        <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission-create</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">create</span>
        <span class="pi">-</span> <span class="s">--host=ingress-nginx-controller-admission,ingress-nginx-controller-admission.$(POD_NAMESPACE).svc</span>
        <span class="pi">-</span> <span class="s">--namespace=$(POD_NAMESPACE)</span>
        <span class="pi">-</span> <span class="s">--secret-name=ingress-nginx-admission</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">POD_NAMESPACE</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.namespace</span>
        <span class="c1"># image: registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">anjia0532/google-containers.ingress-nginx.kube-webhook-certgen:v1.1.1</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">create</span>
        <span class="na">securityContext</span><span class="pi">:</span>
          <span class="na">allowPrivilegeEscalation</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="na">kubernetes.io/os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">OnFailure</span>
      <span class="na">securityContext</span><span class="pi">:</span>
        <span class="na">fsGroup</span><span class="pi">:</span> <span class="m">2000</span>
        <span class="na">runAsNonRoot</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">2000</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission-patch</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
        <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
        <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
        <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
        <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission-patch</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">patch</span>
        <span class="pi">-</span> <span class="s">--webhook-name=ingress-nginx-admission</span>
        <span class="pi">-</span> <span class="s">--namespace=$(POD_NAMESPACE)</span>
        <span class="pi">-</span> <span class="s">--patch-mutating=false</span>
        <span class="pi">-</span> <span class="s">--secret-name=ingress-nginx-admission</span>
        <span class="pi">-</span> <span class="s">--patch-failure-policy=Fail</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">POD_NAMESPACE</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.namespace</span>
        <span class="c1"># image: registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">anjia0532/google-containers.ingress-nginx.kube-webhook-certgen:v1.1.1</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">patch</span>
        <span class="na">securityContext</span><span class="pi">:</span>
          <span class="na">allowPrivilegeEscalation</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="na">kubernetes.io/os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">OnFailure</span>
      <span class="na">securityContext</span><span class="pi">:</span>
        <span class="na">fsGroup</span><span class="pi">:</span> <span class="m">2000</span>
        <span class="na">runAsNonRoot</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">2000</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IngressClass</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">controller</span><span class="pi">:</span> <span class="s">k8s.io/ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">admissionregistration.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ValidatingWebhookConfiguration</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
<span class="na">webhooks</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">admissionReviewVersions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">v1</span>
  <span class="na">clientConfig</span><span class="pi">:</span>
    <span class="na">service</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-controller-admission</span>
      <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s">/networking/v1/ingresses</span>
  <span class="na">failurePolicy</span><span class="pi">:</span> <span class="s">Fail</span>
  <span class="na">matchPolicy</span><span class="pi">:</span> <span class="s">Equivalent</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">validate.nginx.ingress.kubernetes.io</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">networking.k8s.io</span>
    <span class="na">apiVersions</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">v1</span>
    <span class="na">operations</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">CREATE</span>
    <span class="pi">-</span> <span class="s">UPDATE</span>
    <span class="na">resources</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ingresses</span>
  <span class="na">sideEffects</span><span class="pi">:</span> <span class="s">None</span>
</code></pre></div></div>

<p>重新安装查看</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get pods <span class="nt">-n</span> ingress-nginx <span class="nt">-o</span> wide
NAME                                        READY   STATUS      RESTARTS   AGE     IP               NODE    NOMINATED NODE   READINESS GATES
ingress-nginx-admission-create-ftxdq        0/1     Completed   0          2m13s   10.244.166.173   node1   &lt;none&gt;           &lt;none&gt;
ingress-nginx-admission-patch-8c76s         0/1     Completed   3          2m13s   10.244.166.174   node1   &lt;none&gt;           &lt;none&gt;
ingress-nginx-controller-6d86674cfd-wdqts   0/1     Running     0          2m13s   10.244.166.170   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>修改node1和node2的hosts</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.244.166.170 www1.rhce.cc www1
10.244.166.170 www2.rhce.cc www2
</code></pre></div></div>

<h4 id="环境准备-1">环境准备</h4>

<p>3个pod</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl run nginx1 <span class="nt">--image</span><span class="o">=</span>nginx <span class="nt">--image-pull-policy</span><span class="o">=</span>IfNotPresent
pod/nginx1 created
<span class="o">[</span>root@master svc]# kubectl run nginx2 <span class="nt">--image</span><span class="o">=</span>nginx <span class="nt">--image-pull-policy</span><span class="o">=</span>IfNotPresent
pod/nginx2 created
<span class="o">[</span>root@master svc]# kubectl run nginx3 <span class="nt">--image</span><span class="o">=</span>nginx <span class="nt">--image-pull-policy</span><span class="o">=</span>IfNotPresent
pod/nginx3 created
</code></pre></div></div>

<p>3个svc</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl expose pod nginx1 <span class="nt">--name</span><span class="o">=</span>svc1 <span class="nt">--port</span><span class="o">=</span>80
service/svc1 exposed
<span class="o">[</span>root@master svc]# kubectl expose pod nginx2 <span class="nt">--name</span><span class="o">=</span>svc2 <span class="nt">--port</span><span class="o">=</span>80
service/svc2 exposed
<span class="o">[</span>root@master svc]# kubectl expose pod nginx3 <span class="nt">--name</span><span class="o">=</span>svc3 <span class="nt">--port</span><span class="o">=</span>80
service/svc3 exposed
</code></pre></div></div>

<p>查看svc</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get svc
NAME   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
svc1   ClusterIP   10.107.76.165    &lt;none&gt;        80/TCP    24s
svc2   ClusterIP   10.107.147.148   &lt;none&gt;        80/TCP    19s
svc3   ClusterIP   10.111.192.216   &lt;none&gt;        80/TCP    15s
</code></pre></div></div>

<p>修改nginx的html文件</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl <span class="nb">exec</span> <span class="nt">-it</span> nginx1 <span class="nt">--</span> bash
root@nginx1:/# <span class="nb">echo </span>111 <span class="o">&gt;</span> /usr/share/nginx/html/index.html 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl <span class="nb">exec</span> <span class="nt">-it</span> nginx2 <span class="nt">--</span> bash
root@nginx2:/# <span class="nb">echo </span>222 <span class="o">&gt;</span> /usr/share/nginx/html/index.html
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl <span class="nb">exec</span> <span class="nt">-ti</span> nginx3 <span class="nt">--</span> bash
root@nginx3:/# <span class="nb">mkdir</span> /usr/share/nginx/html/cka
root@nginx3:/# <span class="nb">echo </span>333 <span class="o">&gt;</span> /usr/share/nginx/html/cka/index.html
</code></pre></div></div>

<h4 id="定义ingress规则">定义ingress规则</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mying</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">kubernetes.io/ingress.class</span><span class="pi">:</span> <span class="s">nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">www1.rhce.cc</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
        <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">svc1</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">number</span><span class="pi">:</span> <span class="m">80</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/cka</span>
        <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">svc3</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">number</span><span class="pi">:</span> <span class="m">80</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">www2.rhce.cc</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
        <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">svc2</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">number</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl apply <span class="nt">-f</span> ingress.yaml 
ingress.networking.k8s.io/mying created
</code></pre></div></div>

<p>查看ingress</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl get ing
NAME    CLASS    HOSTS                       ADDRESS           PORTS   AGE
mying   &lt;none&gt;   www1.rhce.cc,www2.rhce.cc   192.168.122.202   80      25h
</code></pre></div></div>

<p>这里不显示ADDRESS</p>

<p>测试</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@node1 ~]# curl www1.rhce.cc/cka/
333
<span class="o">[</span>root@node1 ~]# curl www1.rhce.cc
111
<span class="o">[</span>root@node1 ~]# curl www2.rhce.cc
222
</code></pre></div></div>

        
      </section>

      <!-- <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 标签: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#kubernetes" class="page__taxonomy-item p-category" rel="tag">Kubernetes</a>
    
    </span>
  </p>



 
        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 更新时间:</strong> <time class="dt-published" datetime="2023-02-23T00:00:00+08:00">February 23, 2023</time></p>
 
      </footer> -->

      <!-- <section class="page__share">
  
    <h4 class="page__share-title">分享</h4>
  

  <a href="https://twitter.com/intent/tweet?text=%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86%20%2Fkubernetes-kubeadm-service-manage%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="分享 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=%2Fkubernetes-kubeadm-service-manage%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="分享 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=%2Fkubernetes-kubeadm-service-manage%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="分享 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>
 -->

      
  <nav class="pagination">
    
      <a href="/kubernetes-kubeadm-job/" class="pagination--pager" title="Job
">上一页</a>
    
    
      <a href="/leetcode-golang-easy-01/" class="pagination--pager" title="leetcode-golang-easy-01
">下一页</a>
    
  </nav>

    </div>

     <div class="page__comments">
  
  
      <h4 class="page__comments-title">留下评论</h4>
      <section id="utterances-comments"></section>
    
</div>

  </article>

</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        
        <div class="page__footer-follow">
  多研究些问题，少谈些主义。
 </div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







    <script>
  'use strict';

  (function() {
    var commentContainer = document.querySelector('#utterances-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://utteranc.es/client.js');
    script.setAttribute('repo', 'yinyaliang/yinyaliang.github.io');
    script.setAttribute('issue-term', 'pathname');
    script.setAttribute('label', 'comment');
    script.setAttribute('theme', 'github-dark');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>

  





  </body>
</html>
