<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="/feed.xml" rel="self" type="application/atom+xml" /><link href="/" rel="alternate" type="text/html" /><updated>2022-08-22T15:48:31+08:00</updated><id>/feed.xml</id><title type="html">尹亚亮</title><subtitle>An amazing website.</subtitle><author><name>Your Name</name></author><entry><title type="html">`Python 装饰器 - 02`</title><link href="/python-decorator-02/" rel="alternate" type="text/html" title="`Python 装饰器 - 02`" /><published>2022-08-22T00:00:00+08:00</published><updated>2022-08-22T00:00:00+08:00</updated><id>/python-decorator-02</id><content type="html" xml:base="/python-decorator-02/"><![CDATA[<p>Python装饰器介绍</p>

<h3 id="装饰类">装饰类</h3>

<p>在类中有两种不通的方式使用装饰器，第一个和我们之前做过的函数非常相似:在类的方法上应用。这也是当时引入装饰器的原因之一</p>

<p>一些常用的装饰器已经内置到python中，像@classmethod @staticmethod @property。这三个装饰器我们之前都介绍过，这段就不翻译了(打字手酸，偷懒下)</p>

<p>下面的Circle 类使用了@classmethod @staticmethod和@property三个装饰器</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Circle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_radius</span> <span class="o">=</span> <span class="n">radius</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">radius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Get value of radius"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_radius</span>

    <span class="o">@</span><span class="n">radius</span><span class="p">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="s">"""Set radius, raise error if negative"""</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_radius</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"Radius must be positive"</span><span class="p">)</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Calculate area inside circle"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">pi</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">radius</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">def</span> <span class="nf">cylinder_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="s">"""Calculate volume of cylinder with circle as base"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">area</span> <span class="o">*</span> <span class="n">height</span>

    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">unit_circle</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="s">"""Factory method creating a circle with radius 1"""</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">pi</span><span class="p">():</span>
        <span class="s">"""Value of π, could use math.pi instead though"""</span>
        <span class="k">return</span> <span class="mf">3.1415926535</span>
</code></pre></div></div>

<p>在这个类中</p>
<blockquote>
  <p>.cylinder_volume()是一个常规函数
.radius是一个可变属性:它可以被设置不同的值.然而通过定义setter方法，我们可以做一些判断来确保它不会被设置成一个没有意义的负数，.radius作为属性访问，不使用括号
.area 是一个不可变的属性:没有.setter()方法的属性是无法更改的，即使它被定义为一个方法，它也被作为不需要括号的属性来使用。
.unit_circle() 是一个类方法。它不被绑定到Circle的实例上.类方法通常用在工厂模式，用来创建类的特殊实例
.pi() 是一个静态方法.除了命名空间外它不依赖Circle类。静态方法可以在实例或类上调用。</p>
</blockquote>

<p>Circle类的使用例子</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">radius</span>
<span class="mi">5</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">area</span>
<span class="mf">78.5398163375</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">radius</span> <span class="o">=</span> <span class="mi">2</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">area</span>
<span class="mf">12.566370614</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="mi">100</span>
<span class="nb">AttributeError</span><span class="p">:</span> <span class="n">can</span><span class="s">'t set attribute

&gt;&gt;&gt; c.cylinder_volume(height=4)
50.265482456

&gt;&gt;&gt; c.radius = -1
ValueError: Radius must be positive

&gt;&gt;&gt; c = Circle.unit_circle()
&gt;&gt;&gt; c.radius
1

&gt;&gt;&gt; c.pi()
3.1415926535

&gt;&gt;&gt; Circle.pi()
3.1415926535
</span></code></pre></div></div>

<p>让我们定义一个类，在这个类中，我们会用到前面的@debug和@timer装饰器:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">decorators</span> <span class="kn">import</span> <span class="n">debug</span><span class="p">,</span> <span class="n">timer</span>

<span class="k">class</span> <span class="nc">TimeWaster</span><span class="p">:</span>
    <span class="o">@</span><span class="n">debug</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_num</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">max_num</span> <span class="o">=</span> <span class="n">max_num</span>

    <span class="o">@</span><span class="n">timer</span>
    <span class="k">def</span> <span class="nf">waste_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_times</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_times</span><span class="p">):</span>
            <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">max_num</span><span class="p">)])</span>
</code></pre></div></div>

<p>看一下结果:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">tw</span> <span class="o">=</span> <span class="n">TimeWaster</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">Calling</span> <span class="n">__init__</span><span class="p">(</span><span class="o">&lt;</span><span class="n">time_waster</span><span class="p">.</span><span class="n">TimeWaster</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x7efccce03908</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="s">'__init__'</span> <span class="n">returned</span> <span class="bp">None</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">tw</span><span class="p">.</span><span class="n">waste_time</span><span class="p">(</span><span class="mi">999</span><span class="p">)</span>
<span class="n">Finished</span> <span class="s">'waste_time'</span> <span class="ow">in</span> <span class="mf">0.3376</span> <span class="n">secs</span>
</code></pre></div></div>

<p>另外一种方式是在整个类上使用装饰器.这里有个Python3.7中的dataclasses方法用例:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>

<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">PlayingCard</span><span class="p">:</span>
    <span class="n">rank</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">suit</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div></div>

<p>语法的类似于函数装饰器。在上面的例子中，也可以通过PlayingCard = dataclass(PlayingCard)来实现。</p>

<p>类装饰器的一种简单用法是作为元类方式的替代.在两种情况下，你都在动态的改变一个类的定义</p>

<p>类的装饰器和函数的装饰器语法接近，不同的是装饰器需要接收一个类而不是一个函数作为参数.事实上，上面的装饰器都可以作用于类，但当你这么用的时候，你可能得不到预期的结果。下面将@timer装饰器应用到一个类</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">decorators</span> <span class="kn">import</span> <span class="n">timer</span>

<span class="o">@</span><span class="n">timer</span>
<span class="k">class</span> <span class="nc">TimeWaster</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_num</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">max_num</span> <span class="o">=</span> <span class="n">max_num</span>

    <span class="k">def</span> <span class="nf">waste_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_times</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_times</span><span class="p">):</span>
            <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">max_num</span><span class="p">)])</span>
</code></pre></div></div>

<p>@timer只是TimeWaster = timer(TimeWaster)的缩写</p>

<p>在这里@timer只能显示类实例化需要的时间</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">tw</span> <span class="o">=</span> <span class="n">TimeWaster</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">Finished</span> <span class="s">'TimeWaster'</span> <span class="ow">in</span> <span class="mf">0.0000</span> <span class="n">secs</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">tw</span><span class="p">.</span><span class="n">waste_time</span><span class="p">(</span><span class="mi">999</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div></div>
<p>在后面会有一个正确的类装饰器的示例@singleton。它保证一个类只有一个实例</p>

<h3 id="嵌套的装饰器">嵌套的装饰器</h3>

<p>可以将多个装饰器叠加到一个函数上</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">decorators</span> <span class="kn">import</span> <span class="n">debug</span><span class="p">,</span> <span class="n">do_twice</span>

<span class="o">@</span><span class="n">debug</span>
<span class="o">@</span><span class="n">do_twice</span>
<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Hello </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>运行的顺序会按照叠加的顺序, @debug 调用 @do_twice @do_twice 调用greet()，或者debug(do_twice(greet()))</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">greet</span><span class="p">(</span><span class="s">"Eva"</span><span class="p">)</span>
<span class="n">Calling</span> <span class="n">greet</span><span class="p">(</span><span class="s">'Eva'</span><span class="p">)</span>
<span class="n">Hello</span> <span class="n">Eva</span>
<span class="n">Hello</span> <span class="n">Eva</span>
<span class="s">'greet'</span> <span class="n">returned</span> <span class="bp">None</span>
</code></pre></div></div>
<p>更改@debug和@do_twice的顺序:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">decorators</span> <span class="kn">import</span> <span class="n">debug</span><span class="p">,</span> <span class="n">do_twice</span>

<span class="o">@</span><span class="n">do_twice</span>
<span class="o">@</span><span class="n">debug</span>
<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Hello </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>  
</code></pre></div></div>
<p>在这种情况下，@do_twice也会被应用到@debug中:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">greet</span><span class="p">(</span><span class="s">"Eva"</span><span class="p">)</span>
<span class="n">Calling</span> <span class="n">greet</span><span class="p">(</span><span class="s">'Eva'</span><span class="p">)</span>
<span class="n">Hello</span> <span class="n">Eva</span>
<span class="s">'greet'</span> <span class="n">returned</span> <span class="bp">None</span>
<span class="n">Calling</span> <span class="n">greet</span><span class="p">(</span><span class="s">'Eva'</span><span class="p">)</span>
<span class="n">Hello</span> <span class="n">Eva</span>
<span class="s">'greet'</span> <span class="n">returned</span> <span class="bp">None</span>
</code></pre></div></div>

<h3 id="带参数的装饰器">带参数的装饰器</h3>
<p>在需要传参给你的装饰器是这个例子会非常有用。例如,@do_twice可以扩展到@repeat(num_times)装饰器.然后，可以将执行的被装饰函数的次数作为参数给出。    <br />
可以这么做:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">repeat</span><span class="p">(</span><span class="n">num_times</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Hello </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>      
        
<span class="o">&gt;&gt;&gt;</span> <span class="n">greet</span><span class="p">(</span><span class="s">"World"</span><span class="p">)</span>
<span class="n">Hello</span> <span class="n">World</span>
<span class="n">Hello</span> <span class="n">World</span>
<span class="n">Hello</span> <span class="n">World</span>
<span class="n">Hello</span> <span class="n">World</span> 
</code></pre></div></div>

<p>考虑下如何实现这个功能</p>

<p>到目前为止,写在@后面写的名字引用一个可以被另外一个函数调用的函数对象，需要repeat(num_times=4)来返回一个函数对象，这个对象可以被作为装饰器，幸运的是，我们已经知道如何返回函数!一般来说，需要以下内容:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">repeat</span><span class="p">(</span><span class="n">num_times</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator_repeat</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="p">...</span>  <span class="c1"># Create and return a wrapper function
</span>    <span class="k">return</span> <span class="n">decorator_repeat</span>
</code></pre></div></div>

<p>通常，装饰器创建并返回一个内部包装函数，所以完整地写出这个例子会给你一个内部函数</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">repeat</span><span class="p">(</span><span class="n">num_times</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator_repeat</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper_repeat</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_times</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">wrapper_repeat</span>
    <span class="k">return</span> <span class="n">decorator_repeat</span>
</code></pre></div></div>
<p>例子看起来有点乱，但我们只是添加了一个def来接收参数，这个装饰器语法我们之前处理过多次.让我们从最里面的函数开始:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">wrapper_repeat</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_times</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div></div>

<p>wrapper_repeat()函数接收任意参数，并放回被装饰函数的值，func(). 这个包装函数还包括了被装饰函数num_times的循环 ，除了必须要使用外部参数num_times外，和之前看到的装饰器函数没有什么不同，</p>

<p>再走一步，你就会发现装饰器函数:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">decorator_repeat</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper_repeat</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="p">...</span>
    <span class="k">return</span> <span class="n">wrapper_repeat</span>
</code></pre></div></div>

<p>decorator_repeat()和我们之前写的装饰器函数非常像,除了他的名字不同,因为我们为最外层的函数保留了基础名称repeat()，这个是用户要调用的函数。</p>

<p>最外层返回装饰器函数的引用</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">repeat</span><span class="p">(</span><span class="n">num_times</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator_repeat</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="p">...</span>
    <span class="k">return</span> <span class="n">decorator_repeat</span>
</code></pre></div></div>

<p>在repeat()中有一些细节:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    将decorator_repeat()作为一个内部函数意味着repeat()将引用一个函数对象-decotator_repeat.之前，我们用没有括号的repeat来引用函数对象.定义带有参数的装饰器，就需要添加括号
    
    num_times参数看起来没有在repeat()本身中使用，但是通过传递num_times，会创建一个闭包，来存储num_times的值，直到wrapper_repeat()使用它为止。
</code></pre></div></div>

<p>一切就绪后，让我们看看结果:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">repeat</span><span class="p">(</span><span class="n">num_times</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Hello </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">greet</span><span class="p">(</span><span class="s">"World"</span><span class="p">)</span>
<span class="n">Hello</span> <span class="n">World</span>
<span class="n">Hello</span> <span class="n">World</span>
<span class="n">Hello</span> <span class="n">World</span>
<span class="n">Hello</span> <span class="n">World</span>
</code></pre></div></div>

<p>这是我们想要的结果</p>

<h3 id="both-please-but-never-mind-the-bread">Both Please, But Never Mind the Bread</h3>

<p>稍微注意下.你可以把装饰器同时定义为带参数或者不带参数.你可能不需要这样，但更有灵活性也不错</p>

<p>前面已经看到，当装饰器需要参数的时候，需要有一个额外的外部函数，困难在于，代码需要知道装饰器是否被调用了，是否有参数</p>

<p>因为只有在没有参数的情况下调用装饰器时才会直接传递装饰的函数，这个函数必须是可选参数.意味着装饰器参数必须要友关键字指定，可以使用特殊的*，也就是说，下面的参数都是关键字</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="n">_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">kw1</span><span class="o">=</span><span class="n">val1</span><span class="p">,</span> <span class="n">kw2</span><span class="o">=</span><span class="n">val2</span><span class="p">,</span> <span class="p">...):</span>  <span class="c1"># 1
</span>    <span class="k">def</span> <span class="nf">decorator_name</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="p">...</span>  <span class="c1"># Create and return a wrapper function.
</span>
    <span class="k">if</span> <span class="n">_func</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">decorator_name</span>                      <span class="c1"># 2
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">decorator_name</span><span class="p">(</span><span class="n">_func</span><span class="p">)</span>               <span class="c1"># 3
</span></code></pre></div></div>

<p>_func参数是一个标记，提示装饰器被调用的时候是否有参数
    1.如果name调用的时候没有传参,被装饰函数会被作为_func传入.如果有参数传入,_func会被置为None,一些关键字参数可能已不再是默认值， 参数列表中的*表示其余参数不能作为位置参数调用。
    2.装饰器可以传参调用，返回一个装饰器函数，它可以读取和返回一个函数
    3.装饰器不可以传参调用,会只将装饰器应用到函数上</p>

<p>改造下之前的@repeat装饰器</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">repeat</span><span class="p">(</span><span class="n">_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_times</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator_repeat</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper_repeat</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_times</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">wrapper_repeat</span>

    <span class="k">if</span> <span class="n">_func</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">decorator_repeat</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">decorator_repeat</span><span class="p">(</span><span class="n">_func</span><span class="p">)</span><span class="n">n</span>
</code></pre></div></div>

<p>和之前的对比,唯一的变化是在末尾添加了_func参数和if-else。
这些例子表明，@repeat现在可以在有或没有参数的情况下使用:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">repeat</span>
<span class="k">def</span> <span class="nf">say_whee</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Whee!"</span><span class="p">)</span>

<span class="o">@</span><span class="n">repeat</span><span class="p">(</span><span class="n">num_times</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Hello </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>默认情况num_times的值是2</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">say_whee</span><span class="p">()</span>
<span class="n">Whee</span><span class="err">!</span>
<span class="n">Whee</span><span class="err">!</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">greet</span><span class="p">(</span><span class="s">"Penny"</span><span class="p">)</span>
<span class="n">Hello</span> <span class="n">Penny</span>
<span class="n">Hello</span> <span class="n">Penny</span>
<span class="n">Hello</span> <span class="n">Penny</span>
</code></pre></div></div>

<h3 id="有状态的装饰器">有状态的装饰器</h3>
<p>有时候，可以跟踪状态的装饰器也是很有用的.一个简单的例子，我们会创建一个统计函数调用次数的装饰器</p>

<p>注意:在教程的前面，我们讨论了基于给定参数返回值的纯函数.有状态的装饰器正好相反,返回值取决于当前状态以及给定的参数。</p>

<p>在下一节中，您将看到如何使用类来保持状态。但在简单的情况下，也可以使用函数属性</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">functools</span>

<span class="k">def</span> <span class="nf">count_calls</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper_count_calls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">wrapper_count_calls</span><span class="p">.</span><span class="n">num_calls</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Call </span><span class="si">{</span><span class="n">wrapper_count_calls</span><span class="p">.</span><span class="n">num_calls</span><span class="si">}</span><span class="s"> of </span><span class="si">{</span><span class="n">func</span><span class="p">.</span><span class="n">__name__</span><span class="si">!r}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">wrapper_count_calls</span><span class="p">.</span><span class="n">num_calls</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">wrapper_count_calls</span>

<span class="o">@</span><span class="n">count_calls</span>
<span class="k">def</span> <span class="nf">say_whee</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Whee!"</span><span class="p">)</span>
</code></pre></div></div>

<p>状态——函数的调用次数——存储在包裹函数(wrapper_count_calls)的函数属性.num_calls中。下面是使用它的效果:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">say_whee</span><span class="p">()</span>
<span class="n">Call</span> <span class="mi">1</span> <span class="n">of</span> <span class="s">'say_whee'</span>
<span class="n">Whee</span><span class="err">!</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">say_whee</span><span class="p">()</span>
<span class="n">Call</span> <span class="mi">2</span> <span class="n">of</span> <span class="s">'say_whee'</span>
<span class="n">Whee</span><span class="err">!</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">say_whee</span><span class="p">.</span><span class="n">num_calls</span>
<span class="mi">2</span>
</code></pre></div></div>

<h3 id="类装饰器">类装饰器</h3>
<p>典型的维护状态的方式是使用类。在本节中，将看到如何重写@count_calls的例子来实现类装饰器</p>

<p>回想一下，装饰器语法@my_decorator只是func = my_decorator(func)一种方便快捷的用法.因此，如果my_decorator是一个类，需要在它的.__init__方法中接收func作为一个参数.而且,这个类需要是可以被调用的,这样它就可以替代装饰器函数了</p>

<p>如果需要一个类可以被调用,要实现.__call__方法</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Counter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">start</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Current count is </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">count</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>__call__方法每次运行都会尝试调用一个类的实例：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">counter</span><span class="p">()</span>
<span class="n">Current</span> <span class="n">count</span> <span class="ow">is</span> <span class="mi">1</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">counter</span><span class="p">()</span>
<span class="n">Current</span> <span class="n">count</span> <span class="ow">is</span> <span class="mi">2</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">counter</span><span class="p">.</span><span class="n">count</span>
<span class="mi">2</span>
</code></pre></div></div>

<p>因此，实现类装饰器需要实现.<strong>init__和.__call</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">functools</span>

<span class="k">class</span> <span class="nc">CountCalls</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="n">functools</span><span class="p">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">num_calls</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">num_calls</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Call </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">num_calls</span><span class="si">}</span><span class="s"> of </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">__name__</span><span class="si">!r}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="o">@</span><span class="n">CountCalls</span>
<span class="k">def</span> <span class="nf">say_whee</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Whee!"</span><span class="p">)</span>
</code></pre></div></div>

<p>.__init__方法必须可以存储一个函数的引用和能够做一些必要的初始化. 调用.__call__方法来替代装饰器函数.它做的和我们之前的 wrapper()函数基本一样，注意，这里使用functools.update_wrapper()函数，而不是@functools.wraps</p>

<p>这个@CountCalls装饰器的工作原理与前一节相同:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">say_whee</span><span class="p">()</span>
<span class="n">Call</span> <span class="mi">1</span> <span class="n">of</span> <span class="s">'say_whee'</span>
<span class="n">Whee</span><span class="err">!</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">say_whee</span><span class="p">()</span>
<span class="n">Call</span> <span class="mi">2</span> <span class="n">of</span> <span class="s">'say_whee'</span>
<span class="n">Whee</span><span class="err">!</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">say_whee</span><span class="p">.</span><span class="n">num_calls</span>
<span class="mi">2</span>
</code></pre></div></div>

<h3 id="更多现实中的例子">更多现实中的例子</h3>

<p>我们已经学到了很多(看了下翻译的行数量，已经1K+了，确实很多)，已经学会如何创建各种各样的装饰师，把我们的新知识应用到创建更多的示例中，这些示例在现实中可能非常有用。</p>

<h4 id="代码降速重新访问">代码降速,重新访问</h4>

<p>我们之前实现的@slow_down一直是保持sleep 1秒.现在你知道了如何给装饰器添加参数,因此，让我们来重写@slow_down，使用一个可选的rate参数来控制它的sleep时间:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">slow_down</span><span class="p">(</span><span class="n">_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s">"""Sleep given amount of seconds before calling the function"""</span>
    <span class="k">def</span> <span class="nf">decorator_slow_down</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper_slow_down</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper_slow_down</span>

    <span class="k">if</span> <span class="n">_func</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">decorator_slow_down</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">decorator_slow_down</span><span class="p">(</span><span class="n">_func</span><span class="p">)</span>
</code></pre></div></div>

<p>我们使用  Both Please, But Never Mind the Bread  这里的样例来让@slow_down有参数和没有参数时都可调用，countdown()函数现在在每次计数之间休眠2秒:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">slow_down</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">countdown</span><span class="p">(</span><span class="n">from_number</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">from_number</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Liftoff!"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">from_number</span><span class="p">)</span>
        <span class="n">countdown</span><span class="p">(</span><span class="n">from_number</span> <span class="o">-</span> <span class="mi">1</span>
</code></pre></div></div>

<p>和前面一样，你最好自己写写，跑下看看结果</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">countdown</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="mi">3</span>
<span class="mi">2</span>
<span class="mi">1</span>
<span class="n">Liftoff</span><span class="err">!</span>
</code></pre></div></div>

<h4 id="创建单例模式">创建单例模式</h4>

<p>单例模式是一个只有一个实例的类.在Python经常使用的单例对象包括None,True和False.可以使用is来比较,像我们之前在Both Please的章节中:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">_func</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">decorator_name</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">decorator_name</span><span class="p">(</span><span class="n">_func</span><span class="p">)</span>
</code></pre></div></div>

<p>is只对完全相同实例的对象返回True。下面的@singleton装饰器将类的第一个实例存储为属性，从而将类转换为单例对象。之后创建实例只是返回已经存储的实例</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">functools</span>

<span class="k">def</span> <span class="nf">singleton</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="s">"""Make a class a Singleton class (only one instance)"""</span>
    <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper_singleton</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wrapper_singleton</span><span class="p">.</span><span class="n">instance</span><span class="p">:</span>
            <span class="n">wrapper_singleton</span><span class="p">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper_singleton</span><span class="p">.</span><span class="n">instance</span>
    <span class="n">wrapper_singleton</span><span class="p">.</span><span class="n">instance</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">wrapper_singleton</span>

<span class="o">@</span><span class="n">singleton</span>
<span class="k">class</span> <span class="nc">TheOne</span><span class="p">:</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p>这个类装饰器和我们的函数装饰器基本一样.唯一不同的地方在于使用cls代替了fun来表示这是一个类装饰器</p>

<p>看下运行结果</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">first_one</span> <span class="o">=</span> <span class="n">TheOne</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">another_one</span> <span class="o">=</span> <span class="n">TheOne</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span> <span class="nb">id</span><span class="p">(</span><span class="n">first_one</span><span class="p">)</span>
<span class="mi">140094218762280</span>

<span class="o">&gt;&gt;&gt;</span> <span class="nb">id</span><span class="p">(</span><span class="n">another_one</span><span class="p">)</span>
<span class="mi">140094218762280</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">first_one</span> <span class="ow">is</span> <span class="n">another_one</span>
<span class="bp">True</span>
</code></pre></div></div>
<p>很明显，first_one确实与另一个实例完全相同。</p>

<h4 id="缓存返回值">缓存返回值</h4>

<p>装饰器可以提供很方便的缓存和记忆机制.作为一个例子，我们来看看斐波那契数列的递归定义:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">decorators</span> <span class="kn">import</span> <span class="n">count_calls</span>

<span class="o">@</span><span class="n">count_calls</span>
<span class="k">def</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num</span>
    <span class="k">return</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>实现很简单，性能很糟糕</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">Lots</span> <span class="n">of</span> <span class="n">output</span> <span class="k">from</span> <span class="n">count_calls</span><span class="o">&gt;</span>
<span class="mi">55</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">fibonacci</span><span class="p">.</span><span class="n">num_calls</span>
<span class="mi">177</span>
</code></pre></div></div>
<p>为了计算第10个斐波那契数，你实际上只需要计算前面的斐波那契数，但是这个实现需要177次计算。更糟糕的是:斐波纳契数列(20)需要21891次计算，第30次需要270万次计算。这是因为代码一直在重新计算已知的斐波那契数。</p>

<p>通常的解决方案是使用for循环和查找表来实现斐波那契数。但是，简单的计算缓存也可以做到这一点</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">from</span> <span class="nn">decorators</span> <span class="kn">import</span> <span class="n">count_calls</span>

<span class="k">def</span> <span class="nf">cache</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="s">"""Keep a cache of previous function calls"""</span>
    <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper_cache</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="n">args</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">kwargs</span><span class="p">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wrapper_cache</span><span class="p">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">wrapper_cache</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper_cache</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
    <span class="n">wrapper_cache</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">wrapper_cache</span>

<span class="o">@</span><span class="n">cache</span>
<span class="o">@</span><span class="n">count_calls</span>
<span class="k">def</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num</span>
    <span class="k">return</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>缓存作为查找表工作，所以现在fibonacci()只执行一次计算</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">Call</span> <span class="mi">1</span> <span class="n">of</span> <span class="s">'fibonacci'</span>
<span class="p">...</span>
<span class="n">Call</span> <span class="mi">11</span> <span class="n">of</span> <span class="s">'fibonacci'</span>
<span class="mi">55</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="mi">21</span>
</code></pre></div></div>
<p>注意，在对fibonacci(8)的最后调用中，没有进行新的计算，因为fibonacci(10)已经计算了第8个fibonacci数。
在标准库中，提供了@functools.lru_cache。</p>

<p>这个装饰器比上面的例子要具备更多特性.我们应该使用@functools.lru_cache来代替我们自己写的缓存装饰器</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">functools</span>

<span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Calculating fibonacci(</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num</span>
    <span class="k">return</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>maxsize参数指定缓存了多少次调用。默认值是128，但是可以指定maxsize=None来缓存所有函数调用。但是，请注意，如果正在缓存许多很大的对象，这可能会导致内存问题。</p>

<p>可以使用.cache_info()方法查看缓存的执行情况，并在需要时进行调优。在我们的示例中，我们设定一个小maxsize来查看从缓存中删除元素的效果:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="mi">55</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="mi">21</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="mi">5</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">Calculating</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="mi">21</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="mi">5</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">fibonacci</span><span class="p">.</span><span class="n">cache_info</span><span class="p">()</span>
<span class="n">CacheInfo</span><span class="p">(</span><span class="n">hits</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">misses</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">currsize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="添加单元信息">添加单元信息</h4>

<p>下面的示例与前面的Registering Plugins示例有点类似，因为它不会真正改变被装饰函数的行为。相反，它只是将unit添加为函数属性</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">set_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
    <span class="s">"""Register a unit on a function"""</span>
    <span class="k">def</span> <span class="nf">decorator_set_unit</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">func</span><span class="p">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">decorator_set_unit</span>
</code></pre></div></div>
<p>下面的示例根据圆柱体的半径和高度(以厘米为单位)来计算体积</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">math</span>

<span class="o">@</span><span class="n">set_unit</span><span class="p">(</span><span class="s">"cm^3"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">volume</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">math</span><span class="p">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">radius</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">height</span>   
    
<span class="n">这个</span><span class="p">.</span><span class="n">unit函数属性是可以访问的</span><span class="p">:</span>    
<span class="o">&gt;&gt;&gt;</span> <span class="n">volume</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="mf">141.3716694115407</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">volume</span><span class="p">.</span><span class="n">unit</span>
<span class="s">'cm^3'</span> 
</code></pre></div></div>
<p>注意，可以使用函数注释实现类似的功能</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">math</span>

<span class="k">def</span> <span class="nf">volume</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">"cm^3"</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">math</span><span class="p">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">radius</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">height</span>
</code></pre></div></div>

<p>但是，由于注释用于类型提示，因此很难将注释和静态类型检查相结合。</p>

<p>在连接到一个能够在单位间转换的库，单位可以变得更加强大和有趣.pip install pint,  您可以将体积转换为立方英寸或加仑:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">复制代码</span>

<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pint</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ureg</span> <span class="o">=</span> <span class="n">pint</span><span class="p">.</span><span class="n">UnitRegistry</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">vol</span> <span class="o">=</span> <span class="n">volume</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">ureg</span><span class="p">(</span><span class="n">volume</span><span class="p">.</span><span class="n">unit</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">vol</span>
<span class="o">&lt;</span><span class="n">Quantity</span><span class="p">(</span><span class="mf">141.3716694115407</span><span class="p">,</span> <span class="s">'centimeter ** 3'</span><span class="p">)</span><span class="o">&gt;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">vol</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="s">"cubic inches"</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">Quantity</span><span class="p">(</span><span class="mf">8.627028576414954</span><span class="p">,</span> <span class="s">'inch ** 3'</span><span class="p">)</span><span class="o">&gt;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">vol</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="s">"gallons"</span><span class="p">).</span><span class="n">m</span>  <span class="c1"># Magnitude
</span><span class="mf">0.0373464440537444</span>  
</code></pre></div></div>

<p>你还可以修改装饰器来直接返回一个Pint数量.数量是通过与单位相乘得到的，在pint中，units必须只能在UnitRegistry中查询.这里注册用来存储函数属性来避免命名空间混乱</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">use_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
    <span class="s">"""Have a function return a Quantity with given unit"""</span>
    <span class="n">use_unit</span><span class="p">.</span><span class="n">ureg</span> <span class="o">=</span> <span class="n">pint</span><span class="p">.</span><span class="n">UnitRegistry</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">decorator_use_unit</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper_use_unit</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span> <span class="o">*</span> <span class="n">use_unit</span><span class="p">.</span><span class="n">ureg</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper_use_unit</span>
    <span class="k">return</span> <span class="n">decorator_use_unit</span>

<span class="o">@</span><span class="n">use_unit</span><span class="p">(</span><span class="s">"meters per second"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">average_speed</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">distance</span> <span class="o">/</span> <span class="n">duration</span>
</code></pre></div></div>

<p>使用@use_unit装饰器，转换单位实际上是很容易</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">bolt</span> <span class="o">=</span> <span class="n">average_speed</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mf">9.58</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bolt</span>
<span class="o">&lt;</span><span class="n">Quantity</span><span class="p">(</span><span class="mf">10.438413361169102</span><span class="p">,</span> <span class="s">'meter / second'</span><span class="p">)</span><span class="o">&gt;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">bolt</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="s">"km per hour"</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">Quantity</span><span class="p">(</span><span class="mf">37.578288100208766</span><span class="p">,</span> <span class="s">'kilometer / hour'</span><span class="p">)</span><span class="o">&gt;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">bolt</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="s">"mph"</span><span class="p">).</span><span class="n">m</span>  <span class="c1"># Magnitude
</span><span class="mf">23.350065679064745</span>
</code></pre></div></div>

<h4 id="验证json">验证JSON</h4>

<p>让我们看最后一个用例。快速看下Flask路由的管理程序</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/grade"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"POST"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_grade</span><span class="p">():</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">if</span> <span class="s">"student_id"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="c1"># Update database
</span>    <span class="k">return</span> <span class="s">"success!"</span>
</code></pre></div></div>

<p>这里我们确保key student_id是请求的一部分.虽然验证有效，但它实际上并不属于函数本身.另外，可能还有其他使用相同验证的路由。因此，让我们Don’t repeat yourself，来使用装饰器抽象出任何不必要的逻辑，下面的@validate_json装饰器会完成这个工作</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">validate_json</span><span class="p">(</span><span class="o">*</span><span class="n">expected_args</span><span class="p">):</span>                  <span class="c1"># 1
</span>    <span class="k">def</span> <span class="nf">decorator_validate_json</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper_validate_json</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">json_object</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">get_json</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">expected_arg</span> <span class="ow">in</span> <span class="n">expected_args</span><span class="p">:</span>      <span class="c1"># 2
</span>                <span class="k">if</span> <span class="n">expected_arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">json_object</span><span class="p">:</span>
                    <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper_validate_json</span>
    <span class="k">return</span> <span class="n">decorator_validate_json</span>
</code></pre></div></div>

<p>在上面的代码中，装饰器采用了一个可变长度列表作为参数，这样我们就可以传递尽可能多的字符串参数，每个参数都代表一个用于验证JSON数据的键:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1.json的keys列表作为参数传递给装饰器
2.包裹函数验证JSON数据中出现的每个预期键
</code></pre></div></div>

<p>然后，路由管理程序可以关注其真正的业务级别——因为它可以安全地假设JSON数据是有效的:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/grade"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"POST"</span><span class="p">])</span>
<span class="o">@</span><span class="n">validate_json</span><span class="p">(</span><span class="s">"student_id"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_grade</span><span class="p">():</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="c1"># Update database.
</span>    <span class="k">return</span> <span class="s">"success!"</span>
</code></pre></div></div>

<h3 id="引用地址">引用地址</h3>
<p>https://realpython.com/primer-on-python-decorators/</p>]]></content><author><name>Your Name</name></author><category term="Python" /><summary type="html"><![CDATA[Python装饰器介绍]]></summary></entry><entry><title type="html">`Python 装饰器 - 01`</title><link href="/python-decorator-01/" rel="alternate" type="text/html" title="`Python 装饰器 - 01`" /><published>2022-08-21T00:00:00+08:00</published><updated>2022-08-21T00:00:00+08:00</updated><id>/python-decorator-01</id><content type="html" xml:base="/python-decorator-01/"><![CDATA[<p>Python装饰器介绍</p>

<p>这是一篇介绍python装饰器的文章，对比之前看到的类似介绍装饰器的文章，个人认为无人可出其右，文章由浅到深，由函数介绍到装饰器的高级应用，每个介绍必有例子说明。文章太长，看完原文后我计划按照文章作者的划分，将分为两章翻出来和大家分享,如果你觉得干的还不错，就点个赞吧</p>

<p>在本次的装饰器教程中，将介绍何为装饰器以及如何创建和使用它们,装饰器提供了简单的语法来调用高阶函数。
从定义上讲，装饰器是一个函数，它接收另一个函数作为参数并且扩展它的功能，但不会显式的去修改它
说起来可能会让人觉得难理解，但它(装饰器)确实不会这么做，特别是一会你会看到一些装饰器如何工作的例子</p>

<h3 id="函数">函数</h3>
<p>在理解装饰器之前，你首先需要理解函数如何工作。函数会基于给定的参数返回值。这里有一个非常简单的例子:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">add_one</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">return</span> <span class="n">number</span> <span class="o">+</span> <span class="mi">1</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">add_one</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="mi">3</span>
</code></pre></div></div>

<p>通常情况下，函数在python中也会有其它功效而不是仅仅接收输入并返回输出。print()函数是一个例子。在控制台输出的时候它会返回None(1)，然而，为了理解装饰器，
将函数认为是接收参数并返回值就足够了</p>

<p>注意:在面向函数编程,你几乎只会使用纯函数，不会有其它功能，然而python不是一个纯函数式语言，python支持许多函数式编程概念，包括一等对象</p>

<h4 id="一等对象">一等对象</h4>
<p>在python中，函数是一等对象，意思是函数可以作为参数被传递，就像其它的对象(string，int，fload，list和其它)，思考下面的三个函数</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">say_hello</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">"Hello </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">"</span>

<span class="k">def</span> <span class="nf">be_awesome</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">"Yo </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">, together we are the awesomest!"</span>

<span class="k">def</span> <span class="nf">greet_bob</span><span class="p">(</span><span class="n">greeter_func</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">greeter_func</span><span class="p">(</span><span class="s">"Bob"</span><span class="p">)</span>
</code></pre></div></div>

<p>在这里,say_hello()和be_awsone()是常规函数，接收一个name参数返回一个字符串，然而greet_bob()函数，接收一个函数作为他的参数，我们可以将say_hello()或者be_awesome()函数传递给它</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">greet_bob</span><span class="p">(</span><span class="n">say_hello</span><span class="p">)</span>
<span class="s">'Hello Bob'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">greet_bob</span><span class="p">(</span><span class="n">be_awesome</span><span class="p">)</span>
<span class="s">'Yo Bob, together we are the awesomest!'</span>
</code></pre></div></div>

<p>注意greet_bob(say_hello) 涉及到两个函数，但是不同的是:greet_bob()和say_hello,say_hello函数并没有使用()，代表只传递了对函数的引用，函数没有运行，greet_bob()函数，是使用了括号，所以它会被正常调用</p>

<h4 id="内部函数">内部函数</h4>
<p>在函数内定义函数是被允许的。这类函数被称为内部函数，这里有一个函数和两个内函数的例子</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">parent</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Printing from the parent() function"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">first_child</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Printing from the first_child() function"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">second_child</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Printing from the second_child() function"</span><span class="p">)</span>

    <span class="n">second_child</span><span class="p">()</span>
    <span class="n">first_child</span><span class="p">()</span>
</code></pre></div></div>

<p>当你调用parent()的时候会发生什么? 请考虑一分钟。会出现下面的输出结果</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">parent</span><span class="p">()</span>
<span class="n">Printing</span> <span class="k">from</span> <span class="n">the</span> <span class="n">parent</span><span class="p">()</span> <span class="n">function</span>
<span class="n">Printing</span> <span class="k">from</span> <span class="n">the</span> <span class="n">second_child</span><span class="p">()</span> <span class="n">function</span>
<span class="n">Printing</span> <span class="k">from</span> <span class="n">the</span> <span class="n">first_child</span><span class="p">()</span> <span class="n">function</span>
</code></pre></div></div>

<p>注意内部函数定义的顺序无关紧要，和其它的函数一样，打印只会发生在内部函数运行的时候</p>

<p>而且，内部函数在父函数被调用之前不会生效，它们的局部作用域是父()，它们只作为局部变量存在在父()函数的内部，尝试调用first_child()，你会得到下面的错误</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="nb">NameError</span><span class="p">:</span> <span class="n">name</span> <span class="s">'first_child'</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">defined</span>
</code></pre></div></div>

<p>不管你何时调用parent()，内部函数first_child()和second_child()都会被调用，因为它们的局部作用域，它们无法再parent()函数外使用</p>

<h4 id="从函数中返回函数">从函数中返回函数</h4>

<p>python允许使用函数来作为返回值，下面的例子从外部的父函数parent()返回了一个内部函数</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">parent</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">first_child</span><span class="p">():</span>
        <span class="k">return</span> <span class="s">"Hi, I am Emma"</span>

    <span class="k">def</span> <span class="nf">second_child</span><span class="p">():</span>
        <span class="k">return</span> <span class="s">"Call me Liam"</span>

    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">first_child</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">second_chil</span>
</code></pre></div></div>

<p>注意这里返回的first_child是没有括号的，也就是返回了对函数first_child的引用， 带括号的first_child() 指的是对函数求值的结果，这个可以在下面的实例中看到</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">first</span> <span class="o">=</span> <span class="n">parent</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">second</span> <span class="o">=</span> <span class="n">parent</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">first</span>
<span class="o">&lt;</span><span class="n">function</span> <span class="n">parent</span><span class="p">.</span><span class="o">&lt;</span><span class="nb">locals</span><span class="o">&gt;</span><span class="p">.</span><span class="n">first_child</span> <span class="n">at</span> <span class="mh">0x7f599f1e2e18</span><span class="o">&gt;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">second</span>
<span class="o">&lt;</span><span class="n">function</span> <span class="n">parent</span><span class="p">.</span><span class="o">&lt;</span><span class="nb">locals</span><span class="o">&gt;</span><span class="p">.</span><span class="n">second_child</span> <span class="n">at</span> <span class="mh">0x7f599dad5268</span><span class="o">&gt;</span>
</code></pre></div></div>
<p>这个输出代表first变量引用了在parent()中的本地函数first_child()，second则指向了second_child()</p>

<p>你现在可以像常规函数一样使用first和second，虽然他们指向的函数无法被直接访问</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">first</span><span class="p">()</span>
<span class="s">'Hi, I am Emma'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">second</span><span class="p">()</span>
<span class="s">'Call me Liam'</span>
</code></pre></div></div>

<p>请注意，在前面的例子中我们在父函数中运行内部函数，例如first_child()，然后在最后的例子中，返回的时候没有给内部函数first_child添加括号。这样，就获取了将来可以调用的函数的引用。这样有意义吗?</p>

<h3 id="简单装饰器">简单装饰器</h3>

<p>现在你已经看到函数和python中的其它对象一样，你已经准备好前进来认识python装饰器，让我们以一个例子开始</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">my_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Something is happening before the function is called."</span><span class="p">)</span>
        <span class="n">func</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Something is happening after the function is called."</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="k">def</span> <span class="nf">say_whee</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Whee!"</span><span class="p">)</span>

<span class="n">say_whee</span> <span class="o">=</span> <span class="n">my_decorator</span><span class="p">(</span><span class="n">say_whee</span><span class="p">)</span>
</code></pre></div></div>
<p>你能猜到当你调用say_whee()的时候回发生什么么？试一下</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">say_whee</span><span class="p">()</span>
<span class="n">Something</span> <span class="ow">is</span> <span class="n">happening</span> <span class="n">before</span> <span class="n">the</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">called</span><span class="p">.</span>
<span class="n">Whee</span><span class="err">!</span>
<span class="n">Something</span> <span class="ow">is</span> <span class="n">happening</span> <span class="n">after</span> <span class="n">the</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">called</span><span class="p">.</span>
</code></pre></div></div>

<p>要理解这里发生了什么，需要回看下之前的例子，我们只是应用了你到目前为止学到的所有东西</p>

<p>所谓的装饰器发生在下面这行</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">say_whee</span> <span class="o">=</span> <span class="n">my_decorator</span><span class="p">(</span><span class="n">say_whee</span><span class="p">)</span>
</code></pre></div></div>

<p>事实上，say_whee现在指向了内部函数wrapper()，当你调用my_decorator(say_whee)的时候会将wrapper作为函数返回</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">say_whee</span>
<span class="o">&lt;</span><span class="n">function</span> <span class="n">my_decorator</span><span class="p">.</span><span class="o">&lt;</span><span class="nb">locals</span><span class="o">&gt;</span><span class="p">.</span><span class="n">wrapper</span> <span class="n">at</span> <span class="mh">0x7f3c5dfd42f0</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>wrapper()引用原始的say_whee()作为func，在两个print()之间调用这个函数</p>

<p>简而言之:装饰器包裹一个函数，并改变它的行为</p>

<p>在继续之前，让我们看下第二个例子。因为wrapper()是一个常规的函数，装饰器可以以一种动态的方式来修改函数。为了不打扰你的邻居，下面的示例演示只会在白天运行的装饰器</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span> <span class="nf">not_during_the_night</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">():</span>
        <span class="k">if</span> <span class="mi">7</span> <span class="o">&lt;=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">22</span><span class="p">:</span>
            <span class="n">func</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Hush, the neighbors are asleep
</span>    <span class="k">return</span> <span class="n">wrapper</span>

<span class="k">def</span> <span class="nf">say_whee</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Whee!"</span><span class="p">)</span>

<span class="n">say_whee</span> <span class="o">=</span> <span class="n">not_during_the_night</span><span class="p">(</span><span class="n">say_whee</span><span class="p">)</span>
</code></pre></div></div>

<p>如果你在睡觉的时间调用say_whee()，不会发生任何事情</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">say_whee</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div></div>

<h4 id="语法糖">语法糖</h4>

<p>上面的装饰器say_whee()用起来有一点笨拙。首先，你键入了三次say_whee，另外，装饰器隐藏在了函数的定义之下</p>

<p>作为替代，python允许你使用@symbol的方式使用装饰器，有时被称为”pie”语法，下面的例子和之前第一个装饰器做了同样的事情</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">my_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Something is happening before the function is called."</span><span class="p">)</span>
        <span class="n">func</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Something is happening after the function is called."</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="o">@</span><span class="n">my_decorator</span>
<span class="k">def</span> <span class="nf">say_whee</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Whee!"</span><span class="p">)</span>
</code></pre></div></div>

<p>所以，@my_decorator 只是say_whee = my_decorator(say_whee)的一种快捷方式，这就是如何将装饰器应用到函数上</p>

<h4 id="复用装饰器">复用装饰器</h4>

<p>回想一下，装饰器只是一个普通的函数。所有常用的工具都是方便重复利用的，让我们将装饰器移动到他自己的模型上以便于在其它的函数上使用</p>

<p>下面创建了一个decorators.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">do_twice</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper_do_twice</span><span class="p">():</span>
        <span class="n">func</span><span class="p">()</span>
        <span class="n">func</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">wrapper_do_twice</span>
</code></pre></div></div>

<p>注意:你可以随意定义内部函数的名称，通常像wrapper()用起来是没问题的。你在这篇文章中会遇到许多装饰器。为了区别开它们，我们将使用decorator名称来命名内部函数，但会加上wrapper_前缀。</p>

<p>你可以使用常规导入来使用一个新的装饰器</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">decorators</span> <span class="kn">import</span> <span class="n">do_twice</span>

<span class="o">@</span><span class="n">do_twice</span>
<span class="k">def</span> <span class="nf">say_whee</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Whee!"</span><span class="p">)</span>
</code></pre></div></div>

<p>当你运行这个例子，你会看到原始韩式say_whee()执行两次</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">say_whee</span><span class="p">()</span>
<span class="n">Whee</span><span class="err">!</span>
<span class="n">Whee</span><span class="err">!</span>
</code></pre></div></div>

<h4 id="装饰器传参">装饰器传参</h4>

<p>如果你有一个函数需要接收一些参数，这时候还可以再使用装饰器么，然我们试试</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">decorators</span> <span class="kn">import</span> <span class="n">do_twice</span>

<span class="o">@</span><span class="n">do_twice</span>
<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Hello </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>不幸的是，运行代码抛出了错误</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">greet</span><span class="p">(</span><span class="s">"World"</span><span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="nb">TypeError</span><span class="p">:</span> <span class="n">wrapper_do_twice</span><span class="p">()</span> <span class="n">takes</span> <span class="mi">0</span> <span class="n">positional</span> <span class="n">arguments</span> <span class="n">but</span> <span class="mi">1</span> <span class="n">was</span> <span class="n">given</span>
</code></pre></div></div>

<p>问题在于内部函数wrapper_do_twice()没有接收任何参数，但是name=”World”却传给了它。你可以让wrapper_do_twice()接收一个参数来修补这个问题，但是这样前面的say_whee()函数就无法工作了</p>

<p>解决方案是在内部函数使用*args和**kwargs ，这样它会允许接收任意个关键参数，下面重写了decorators.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">do_twice</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper_do_twice</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper_do_twice</span>
</code></pre></div></div>

<p>内部函数wrapper_do_twice()现在接收任意数量的参数并会传递给装饰的函数，目前say_whee()和greet()都会正常工作</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">say_whee</span><span class="p">()</span>
<span class="n">Whee</span><span class="err">!</span>
<span class="n">Whee</span><span class="err">!</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">greet</span><span class="p">(</span><span class="s">"World"</span><span class="p">)</span>
<span class="n">Hello</span> <span class="n">World</span>
<span class="n">Hello</span> <span class="n">World</span>
</code></pre></div></div>

<h4 id="从装饰器返回值">从装饰器返回值</h4>

<p>被装饰的函数返回值会发生什么？这会由装饰器来决定，我们下面有一个简单的装饰器函数</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">decorators</span> <span class="kn">import</span> <span class="n">do_twice</span>

<span class="o">@</span><span class="n">do_twice</span>
<span class="k">def</span> <span class="nf">return_greeting</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Creating greeting"</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">"Hi </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">"</span>
</code></pre></div></div>

<p>尝试运行它</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">hi_adam</span> <span class="o">=</span> <span class="n">return_greeting</span><span class="p">(</span><span class="s">"Adam"</span><span class="p">)</span>
<span class="n">Creating</span> <span class="n">greeting</span>
<span class="n">Creating</span> <span class="n">greeting</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">hi_adam</span><span class="p">)</span>
<span class="bp">None</span>
</code></pre></div></div>

<p>装饰器吃掉了从函数返回的值</p>

<p>因为do_twice_wrapper()没有返回值，调用 return_greeting(“Adam”) 最后返回了None</p>

<p>修复的方式是,需要确认装饰器返回它装饰的函数的值，改变decorators.py文件:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">do_twice</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper_do_twice</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper_do_twice</span>
</code></pre></div></div>

<p>执行这个函数返回的值</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">return_greeting</span><span class="p">(</span><span class="s">"Adam"</span><span class="p">)</span>
<span class="n">Creating</span> <span class="n">greeting</span>
<span class="n">Creating</span> <span class="n">greeting</span>
<span class="s">'Hi Adam'</span>
</code></pre></div></div>

<h4 id="你是谁">你是谁</h4>

<p>在使用Python(尤其是在交互式shell中)时，强大的内省是非常方便的功能。内省是对象在运行时了解其自身属性的能力。例如，函数知道自己的名称和文档:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span>
<span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">function</span> <span class="k">print</span><span class="o">&gt;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">.</span><span class="n">__name__</span>
<span class="s">'print'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">help</span><span class="p">(</span><span class="k">print</span><span class="p">)</span>
<span class="n">Help</span> <span class="n">on</span> <span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">function</span> <span class="k">print</span> <span class="ow">in</span> <span class="n">module</span> <span class="n">builtins</span><span class="p">:</span>

<span class="k">print</span><span class="p">(...)</span>
    <span class="o">&lt;</span><span class="n">full</span> <span class="n">help</span> <span class="n">message</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>内省同样适用于你自定义的函数</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">say_whee</span>
<span class="o">&lt;</span><span class="n">function</span> <span class="n">do_twice</span><span class="p">.</span><span class="o">&lt;</span><span class="nb">locals</span><span class="o">&gt;</span><span class="p">.</span><span class="n">wrapper_do_twice</span> <span class="n">at</span> <span class="mh">0x7f43700e52f0</span><span class="o">&gt;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">say_whee</span><span class="p">.</span><span class="n">__name__</span>
<span class="s">'wrapper_do_twice'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">help</span><span class="p">(</span><span class="n">say_whee</span><span class="p">)</span>
<span class="n">Help</span> <span class="n">on</span> <span class="n">function</span> <span class="n">wrapper_do_twice</span> <span class="ow">in</span> <span class="n">module</span> <span class="n">decorators</span><span class="p">:</span>

<span class="n">wrapper_do_twice</span><span class="p">()</span>
</code></pre></div></div>

<p>然而在被装饰后，say_whee()会对自身感到疑惑。它现在显示为 do_twice()装饰器的内部函数 wrapper_do_twice()</p>

<p>为了修复这个，装饰器需要使用@functools.wraps装饰器，它会保留原始函数的信息，再次更新下decorators.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">functools</span>

<span class="k">def</span> <span class="nf">do_twice</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper_do_twice</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper_do_twice</span>
</code></pre></div></div>

<p>不需要对被装饰的say_whee()函数做任何更改</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">say_whee</span>
<span class="o">&lt;</span><span class="n">function</span> <span class="n">say_whee</span> <span class="n">at</span> <span class="mh">0x7ff79a60f2f0</span><span class="o">&gt;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">say_whee</span><span class="p">.</span><span class="n">__name__</span>
<span class="s">'say_whee'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">help</span><span class="p">(</span><span class="n">say_whee</span><span class="p">)</span>
<span class="n">Help</span> <span class="n">on</span> <span class="n">function</span> <span class="n">say_whee</span> <span class="ow">in</span> <span class="n">module</span> <span class="n">whee</span><span class="p">:</span>

<span class="n">say_whee</span><span class="p">()</span>
</code></pre></div></div>
<p>非常好，现在say_whee()在被装饰后可以保持自己</p>

<p>技术细节:@funtools.wraps 装饰器使用函数functools.update_wrapper()来更新指定的属性，像__name__和__doc__来用于自省</p>

<h3 id="一些现实中的例子">一些现实中的例子</h3>

<p>让我们看一些用处更大的装饰器例子。你会注意到他们主要的模式和你现在所学的都是一样的</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">functools</span>

<span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper_decorator</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Do something before
</span>        <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Do something after
</span>        <span class="k">return</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">wrapper_decorator</span>
</code></pre></div></div>

<p>对于构建更复杂的装饰器，这个是一个很好的模板</p>

<h4 id="时间函数">时间函数</h4>
<p>让我们从@timer装饰器开始，它会测量函数运行的时间并且打印持续时间到控制台，这是代码</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">timer</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="s">"""Print the runtime of the decorated function"""</span>
    <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper_timer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>    <span class="c1"># 1
</span>        <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>      <span class="c1"># 2
</span>        <span class="n">run_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>    <span class="c1"># 3
</span>        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Finished </span><span class="si">{</span><span class="n">func</span><span class="p">.</span><span class="n">__name__</span><span class="si">!r}</span><span class="s"> in </span><span class="si">{</span><span class="n">run_time</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> secs"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">wrapper_timer</span>

<span class="o">@</span><span class="n">timer</span>
<span class="k">def</span> <span class="nf">waste_some_time</span><span class="p">(</span><span class="n">num_times</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_times</span><span class="p">):</span>
        <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">)])</span>
</code></pre></div></div>

<p>这个函数是在函数运行之前获取时间(#1行)，并且在函数运行结束之后获取时间(#2行)，我们使用 time.perf_counter() 函数，这个函数可以非常好的计算时间间隔。下面是一个示例</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">waste_some_time</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Finished</span> <span class="s">'waste_some_time'</span> <span class="ow">in</span> <span class="mf">0.0010</span> <span class="n">secs</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">waste_some_time</span><span class="p">(</span><span class="mi">999</span><span class="p">)</span>
<span class="n">Finished</span> <span class="s">'waste_some_time'</span> <span class="ow">in</span> <span class="mf">0.3260</span> <span class="n">secs</span>
</code></pre></div></div>

<p>自己运行测试下，手敲下这里的代码，确保你理解它的工作原理。如果不明白，也不要担心。装饰器是高级方法，试着思考下或者画下流程图</p>

<p>注意: 如果你只是想获取函数的运行时间，@timer 装饰器可以满足。如果你想获取到更精确的数据，你应该考虑使用timeit 模块来替代它。它临时禁用了垃圾收集并且运行多次以避免函数快速调用带来的噪音数据</p>

<h4 id="调试代码">调试代码</h4>

<p>下面的@debug函数会在每次调用的时候打印函数被调用的参数和它的返回结果</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">functools</span>

<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="s">"""Print the function signature and return value"""</span>
    <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper_debug</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">args_repr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>                      <span class="c1"># 1
</span>        <span class="n">kwargs_repr</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">=</span><span class="si">{</span><span class="n">v</span><span class="si">!r}</span><span class="s">"</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">.</span><span class="n">items</span><span class="p">()]</span>  <span class="c1"># 2
</span>        <span class="n">signature</span> <span class="o">=</span> <span class="s">", "</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">args_repr</span> <span class="o">+</span> <span class="n">kwargs_repr</span><span class="p">)</span>           <span class="c1"># 3
</span>        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Calling </span><span class="si">{</span><span class="n">func</span><span class="p">.</span><span class="n">__name__</span><span class="si">}</span><span class="s">(</span><span class="si">{</span><span class="n">signature</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">func</span><span class="p">.</span><span class="n">__name__</span><span class="si">!r}</span><span class="s"> returned </span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s">"</span><span class="p">)</span>           <span class="c1"># 4
</span>        <span class="k">return</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">wrapper_debug</span>
</code></pre></div></div>

<p>signature 变量是通过 字符串表示方法 来创建所有的输入参数。下面的数字对应了代码中的注释</p>
<ul>
  <li>将args创建为列表，使用repr修饰</li>
  <li>将kwargs创建为列表，使用f-string格式化参数为key=value，!r表示使用repr()表示值</li>
  <li>args和kwargs转换后会合并在signature变量中，使用逗号分隔每个变量</li>
  <li>函数运行结束后会返回值</li>
</ul>

<p>让我们在一个简单的函数中使用装饰器被观察它是如何运行的，被装饰的函数只有一个位置参数和一个关键字参数</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">debug</span>
<span class="k">def</span> <span class="nf">make_greeting</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">age</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">"Howdy </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">!"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">"Whoa </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">! </span><span class="si">{</span><span class="n">age</span><span class="si">}</span><span class="s"> already, you are growing up!"</span>
</code></pre></div></div>

<p>注意@debug装饰器如何打印make_greeting()函数的signature 和返回值</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">make_greeting</span><span class="p">(</span><span class="s">"Benjamin"</span><span class="p">)</span>
<span class="n">Calling</span> <span class="n">make_greeting</span><span class="p">(</span><span class="s">'Benjamin'</span><span class="p">)</span>
<span class="s">'make_greeting'</span> <span class="n">returned</span> <span class="s">'Howdy Benjamin!'</span>
<span class="s">'Howdy Benjamin!'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">make_greeting</span><span class="p">(</span><span class="s">"Richard"</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">112</span><span class="p">)</span>
<span class="n">Calling</span> <span class="n">make_greeting</span><span class="p">(</span><span class="s">'Richard'</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">112</span><span class="p">)</span>
<span class="s">'make_greeting'</span> <span class="n">returned</span> <span class="s">'Whoa Richard! 112 already, you are growing up!'</span>
<span class="s">'Whoa Richard! 112 already, you are growing up!'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">make_greeting</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Dorrisile"</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">116</span><span class="p">)</span>
<span class="n">Calling</span> <span class="n">make_greeting</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Dorrisile'</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">116</span><span class="p">)</span>
<span class="s">'make_greeting'</span> <span class="n">returned</span> <span class="s">'Whoa Dorrisile! 116 already, you are growing up!'</span>
<span class="s">'Whoa Dorrisile! 116 already, you are growing up!'</span> 
</code></pre></div></div>

<p>@debug修饰符看起来只是重复了我们刚才写的内容 ，并不是非常有用。 但当应用到不能直接修改的其它函数时，它会更加强大。</p>

<p>下面的例子计算了一个数学常数E的近似值</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">decorators</span> <span class="kn">import</span> <span class="n">debug</span>

<span class="c1"># Apply a decorator to a standard library function
</span><span class="n">math</span><span class="p">.</span><span class="n">factorial</span> <span class="o">=</span> <span class="n">debug</span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="n">factorial</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">approximate_e</span><span class="p">(</span><span class="n">terms</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">math</span><span class="p">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">terms</span><span class="p">))</span>
</code></pre></div></div>

<p>这个例子还演示了如何将装饰器应用到已经定义了的函数</p>

<p><img src="/assets/images/python/p01.jpg" /></p>

<p>当调用approximate_e()函数，你可以看到@debug函数在工作</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">approximate_e</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">Calling</span> <span class="n">factorial</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="s">'factorial'</span> <span class="n">returned</span> <span class="mi">1</span>
<span class="n">Calling</span> <span class="n">factorial</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="s">'factorial'</span> <span class="n">returned</span> <span class="mi">1</span>
<span class="n">Calling</span> <span class="n">factorial</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="s">'factorial'</span> <span class="n">returned</span> <span class="mi">2</span>
<span class="n">Calling</span> <span class="n">factorial</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="s">'factorial'</span> <span class="n">returned</span> <span class="mi">6</span>
<span class="n">Calling</span> <span class="n">factorial</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="s">'factorial'</span> <span class="n">returned</span> <span class="mi">24</span>
<span class="mf">2.708333333333333</span>
</code></pre></div></div>

<p>在这个例子中，可以得到一个真实值的近似值e = 2.718281828</p>

<h4 id="给代码降速">给代码降速</h4>

<p>下面的例子看起来可能不是很有用。可能最常见的用例是，您希望对一个不断检查资源是否存在的函数进行速率限制 。 @slow_down decorator在调用被修饰的函数之前会暂停一秒钟</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">slow_down</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="s">"""Sleep 1 second before calling the function"""</span>
    <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper_slow_down</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper_slow_down</span>

<span class="o">@</span><span class="n">slow_down</span>
<span class="k">def</span> <span class="nf">countdown</span><span class="p">(</span><span class="n">from_number</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">from_number</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Liftoff!"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">from_number</span><span class="p">)</span>
        <span class="n">countdown</span><span class="p">(</span><span class="n">from_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>   
</code></pre></div></div>

<p>来看下@slow_down装饰器的效果，你需要自己运行跑下</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">countdown</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="mi">3</span>
<span class="mi">2</span>
<span class="mi">1</span>
<span class="n">Liftoff</span><span class="err">!</span>  
</code></pre></div></div>

<p>countdown()是一个递归函数。也就是说，它是一个调用自身的函数 。</p>

<h4 id="注册插件">注册插件</h4>

<p>装饰器不是必须要修饰被装饰的函数(这句话不太好翻译，看下面的例子理解起来很容易)，它还可以简单地注册一个函数，并将其解包返回，例如，可以使用它来创建一个轻量级插件体系结构:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span>
<span class="n">PLUGINS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="s">"""Register a function as a plug-in"""</span>
    <span class="n">PLUGINS</span><span class="p">[</span><span class="n">func</span><span class="p">.</span><span class="n">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">func</span>

<span class="o">@</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">say_hello</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">"Hello </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">"</span>

<span class="o">@</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">be_awesome</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">"Yo </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">, together we are the awesomest!"</span>

<span class="k">def</span> <span class="nf">randomly_greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">greeter</span><span class="p">,</span> <span class="n">greeter_func</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">PLUGINS</span><span class="p">.</span><span class="n">items</span><span class="p">()))</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Using </span><span class="si">{</span><span class="n">greeter</span><span class="si">!r}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">greeter_func</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> 
</code></pre></div></div>

<p>@register装饰器只是在全局PLUGINS 字典中储存了被装饰函数的引用。注意你不需要在例子中写内部函数或者使用@functools.wraps ，因为返回的是一个未经过修改的初始函数</p>

<p>randomly_greet()函数在注册函数中随机选择一个使用。注意PLUGINS字典已经包含了对注册为插件的每个函数对象的引用:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">&gt;&gt;&gt;</span> <span class="n">PLUGINS</span>
<span class="p">{</span><span class="s">'say_hello'</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">say_hello</span> <span class="n">at</span> <span class="mh">0x7f768eae6730</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="s">'be_awesome'</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">be_awesome</span> <span class="n">at</span> <span class="mh">0x7f768eae67b8</span><span class="o">&gt;</span><span class="p">}</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">randomly_greet</span><span class="p">(</span><span class="s">"Alice"</span><span class="p">)</span>
<span class="n">Using</span> <span class="s">'say_hello'</span>
<span class="s">'Hello Alice'</span>
</code></pre></div></div>

<p>这个插件的主要用处在于不需要再单独维护一个插件列表。这个列表在插件注册时自动创建，使得添加一个新插件变得很简单，只需定义函数并用@register装饰即可。</p>

<p>如果你对python中的globals()函数熟悉，你可能会看到一些和我们的插件结构相似之处。globals()可以访问当前作用于的所有全局变量</p>

<p>包括我们的插件</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">globals</span><span class="p">()</span>
<span class="p">{...,</span> <span class="c1"># Lots of variables not shown here.
</span> <span class="s">'say_hello'</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">say_hello</span> <span class="n">at</span> <span class="mh">0x7f768eae6730</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="s">'be_awesome'</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">be_awesome</span> <span class="n">at</span> <span class="mh">0x7f768eae67b8</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="s">'randomly_greet'</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">randomly_greet</span> <span class="n">at</span> <span class="mh">0x7f768eae6840</span><span class="o">&gt;</span><span class="p">}</span>
</code></pre></div></div>

<p>使用@register 装饰器，可以创建感兴趣的变量管理列表，有效地从globals()中筛选出一些函数</p>

<h4 id="用户是否登录">用户是否登录</h4>

<p>在继续讨论一些更有趣的装饰器之前，让我们在最后一个示例中演示通常在处理web框架时使用的装饰器。在这个例子中，我们使用Flask去设置一个/secret web页面，这个页面只对登录用户或者其他有权限的用户展示</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">login_required</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="s">"""Make sure user is logged in before proceeding"""</span>
    <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper_login_required</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">g</span><span class="p">.</span><span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">"login"</span><span class="p">,</span> <span class="nb">next</span><span class="o">=</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper_login_required</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/secret"</span><span class="p">)</span>
<span class="o">@</span><span class="n">login_required</span>
<span class="k">def</span> <span class="nf">secret</span><span class="p">():</span>
    <span class="p">...</span>    
</code></pre></div></div>

<p>虽然这里演示了如何对web框架添加身份验证吗，但通常不应该自己编写这些类型的装饰器。对于Flask可以使用Flask-login扩展，这里的功能更丰富也更加安全</p>

<p>有想象力的装饰器
到目前为止，你已经看到了如何创建简单的装饰器并且非常了解什么是装饰器以及它们是如何工作的。请从这篇文章中休息一下，练习学到的一切。</p>

<p>在本教程的第二部分中，我们将探索更高级的特性，包括如何使用以下特性:</p>
<ul>
  <li>在类上使用装饰器(装饰类)</li>
  <li>在一个函数上应用多个装饰器</li>
  <li>带参数的装饰器</li>
  <li>可以选择是否接收参数的装饰器</li>
  <li>带状态的装饰器</li>
  <li>类装饰器</li>
</ul>]]></content><author><name>Your Name</name></author><category term="Python" /><summary type="html"><![CDATA[Python装饰器介绍]]></summary></entry><entry><title type="html">路由交换 - RIP - 01</title><link href="/rs-rip-01/" rel="alternate" type="text/html" title="路由交换 - RIP - 01" /><published>2022-08-21T00:00:00+08:00</published><updated>2022-08-21T00:00:00+08:00</updated><id>/rs-rip-01</id><content type="html" xml:base="/rs-rip-01/"><![CDATA[<p>RIP 笔记</p>

<h3 id="rip的基本原理与实现">RIP的基本原理与实现</h3>

<p>RIP的端口: UDP 520</p>

<h4 id="rip的计时器和稳定性">RIP的计时器和稳定性</h4>

<ul>
  <li>启动后，每隔30s从启动协议的接口发送更新信息，包含整个路由表。更新的目的地址是广播地址 255.255.255.255</li>
  <li>rip也使用无效计时器，也成为限时计时器，初始化时间为180s，如果超过这个时间还没有收到这条路有的更新，就将这条路有的跳数设置为16跳</li>
  <li>另一种计时器称为垃圾收集或刷新计时器，一般比限时计时器长240-60s，如果到时，这条路由就会被宣告为一条度量值为不可达的路由</li>
  <li>第三个计时器是抑制计时器。如果一条路由更新的跳数大于路由表已记录的该路由的跳数，那么将会引起该路由进入180s的抑制状态阶段</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>timers basic update invalid holddown flush
</code></pre></div></div>

<blockquote>
  <p>默认不建议更改计时器，如果一台路由器更改，那这个RIP域中的路由器都需要更改</p>
</blockquote>

<p>RIP使用带毒性逆转的水平分隔和触发更新，触发更新只有在路由的度量值发生变化时产生，触发更新会有一个1-5s的随机计时器，以免产生触发更新风暴</p>

<h4 id="rip的消息格式">RIP的消息格式</h4>

<p><img src="/assets/images/rip/r01.png" /></p>

<h4 id="请求消息类型">请求消息类型</h4>

<p>可以请求整个路由表信息，也可以请求某些具体路由信息</p>

<h4 id="有类别路由选择">有类别路由选择</h4>

<p>RIP的管理距离为120
数据包选路过程</p>
<ul>
  <li>读出目的地址的网络部分(A\B\C类)，查看在路由表中是否有匹配的条目，没有则丢弃，同时发出一个ICMP目的不可达的消息给源</li>
  <li>如果存在匹配该数据包网络部分的主类网络，会在路由器的主网络的子网中查找，找到匹配则转发，否则发送ICMP目的不可达消息</li>
</ul>

<p>有类别路由选择:直连的子网络</p>

<p><img src="/assets/images/rip/r02.png" /></p>

<ul>
  <li>192.168.35.3数据包进入路由器，路由器没有发现192.168.35.0的条目，该数据包则丢弃</li>
  <li>172.25.33.89数据包进入路由器，路由器中有一个B类172.25.0.0条目，但没有发现172.25.0.0的子网条目，该数据包丢弃</li>
  <li>172.25.153.220数据包进入路由器，路由器中有172.25.0.0的条目并找到172.25.153.0的条目，该数据包被转发到172.25.15.2</li>
</ul>

<p><strong>有类别路由选择:在边界路由器上汇总路由</strong></p>

<p>如果没有和某个目的网络直连，那么该路由器仅仅需要一条路由指向直接相连的路由器</p>

<h4 id="有类别路由选择小结">有类别路由选择:小结</h4>
<ul>
  <li>特点：在通告目的地址时无法通告它的掩码</li>
  <li>如果目的地址是一个和路由器直接相连的主网络成员，那么该网络的路由器接口上配置的子网掩码将被用来确定目的地址的子网</li>
  <li>如果目的地址不是一个和路由器直接相连的主网络的成员，那么路由器会尝试匹配A\B\C类的主网络号</li>
</ul>

<h3 id="配置rip">配置RIP</h3>

<ul>
  <li>router rip</li>
  <li>network 指定主网络</li>
</ul>

<h4 id="被动接口">被动接口</h4>
<p><img src="/assets/images/rip/r03.png" /></p>

<h4 id="配置单播更新">配置单播更新</h4>
<p><img src="/assets/images/rip/r04.png" /></p>

<p>为了防止广播更新，也需要加上一条passive-interface命令</p>

<h4 id="不连续的子网">不连续的子网</h4>

<p><img src="/assets/images/rip/r05.png" /></p>

<p><img src="/assets/images/rip/r06.png" /></p>

<h4 id="控制rip的度量">控制RIP的度量</h4>
<p>可以使用offset-list来改变路由的度量值</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>offset-list <span class="o">{</span>access-list-number | name<span class="o">}</span> <span class="o">{</span><span class="k">in</span> | out<span class="o">}</span> offset <span class="o">{</span><span class="nb">type </span>number<span class="o">}</span>
</code></pre></div></div>

<p><img src="/assets/images/rip/r07.png" /></p>

<p>将serial0的入方向的10.33.0.0的路由加大2跳</p>

<h4 id="最小化更新信息的影响">最小化更新信息的影响</h4>
<ul>
  <li>调整路由选择协议的计时器频率</li>
  <li>配置触发扩展特性消除周期性的RIP更新</li>
</ul>

<p>链路上的两台路由器都必须配置ip rip triggered命令，仅仅发送路由表最初的交换信息和路由表发生变化使得更新信息，只在串行链路上生效</p>]]></content><author><name>Your Name</name></author><category term="RS" /><summary type="html"><![CDATA[RIP 笔记]]></summary></entry><entry><title type="html">路由交换 - OSPF - 01</title><link href="/rs-ospf-01/" rel="alternate" type="text/html" title="路由交换 - OSPF - 01" /><published>2022-08-20T00:00:00+08:00</published><updated>2022-08-20T00:00:00+08:00</updated><id>/rs-ospf-01</id><content type="html" xml:base="/rs-ospf-01/"><![CDATA[<p>OSPF备忘信息</p>

<h2 id="基础术语">基础术语</h2>

<h3 id="链路状态协议的特点">链路状态协议的特点</h3>
<ul>
  <li>快速适应网络变化</li>
  <li>在网络发生变化时发送触发更新</li>
  <li>以较低的频率（如每隔30分钟）发送定期更新，这被称为链路状态刷新</li>
</ul>

<h3 id="每台路由器都必须记录下述信息">每台路由器都必须记录下述信息</h3>
<ul>
  <li>直接相连的邻接路由器</li>
  <li>网络或区域内的其他路由器及其连接的网络</li>
  <li>前往每个目的地的最佳路径</li>
</ul>

<h3 id="ospf使用的各种表">OSPF使用的各种表</h3>
<ul>
  <li>OSPF邻居表=邻接关系数据库</li>
  <li>OSPF拓扑表=OSPF拓扑数据库=LSDB</li>
  <li>路由表=转发数据库</li>
</ul>

<h3 id="区域结构">区域结构</h3>
<ul>
  <li>内部路由器：所有接口都位于同一个区域中的路由器，同一区域中所有内部路由器的LSDB都相同</li>
  <li>骨干路由器：位于骨干区域0边缘的路由器，至少有一个接口与区域0相连。骨干路由器在维护OSPF路由信息时采用的步骤和算法与内部路由器相同</li>
  <li>区域边界路由器（ABR）：连接多个区域的路由器，为其连接的每个区域维护一个LSDB，并路由前往/来自其他区域的数据流</li>
  <li>自治系统边界路由器（ASBR）：至少有一个接口与其他域（如另一个OSPF自治系统或使用增强内部网关协议[EIGRP]的域）相连</li>
</ul>

<p><img src="/assets/images/ospf/01.png" /></p>

<p>在多路访问广播环境中，每个网段都有独立的DR和BDR
在路由器链路通告中，以链路开销的方式通告它。默认的OSPF开销如下</p>
<ul>
  <li>56kbit/s 的串行链路：默认开销为1785</li>
  <li>64kbit/s 的串行链路：默认开销为1562</li>
  <li>T1（1.544Mbit/s 的串行链路）：默认开销为64</li>
  <li>E1（2.048Mbit/s 的串行链路）：默认开销为48</li>
  <li>以太网：默认开销为10</li>
  <li>快速以太网：默认开销为1</li>
  <li>FDDI：默认开销为1</li>
  <li>ATM：默认开销为1</li>
</ul>

<p><img src="/assets/images/ospf/02.png" /></p>

<p><img src="/assets/images/ospf/03.png" /></p>

<p><img src="/assets/images/ospf/04.png" /></p>

<p><img src="/assets/images/ospf/05.png" /></p>

<p>这5种OSPF分组都被直接封装到IP分组的有效负载中，OSPF分组不使用传输控制协议（TCP）和用户数据报协议（UDP）</p>

<h3 id="邻接路由器要建立邻接关系hello分组的如下字段必须匹配">邻接路由器要建立邻接关系，Hello分组的如下字段必须匹配</h3>
<ul>
  <li>Hello 间隔</li>
  <li>失效间隔</li>
  <li>区域ID</li>
  <li>身份验证密码</li>
  <li>末节区域标记</li>
</ul>

<p><strong>要让路由器通过接口建立邻接关系，接口的主IP地址必须位于同一个子网且子网掩码相同，接口的最大传输单元（MTU）也必须匹配</strong></p>

<h3 id="ospf-邻接关系状态">OSPF 邻接关系状态</h3>
<ul>
  <li>Down：没有检测到活动邻居</li>
  <li>Init：收到Hello分组</li>
  <li>双向：路由器在其收到的Hello分组中看到了自己的路由器ID</li>
  <li>预启动：确定了主/从角色</li>
  <li>交换：发送DBD（LSDB摘要）</li>
  <li>加载：交换LSR和LSU以填充LSDB</li>
  <li>完全邻接：邻居处于完全邻接状态</li>
</ul>

<p><strong>如果邻居是通过 NBMA 接口（如帧中继）相连的，OSPF 还可能在 Init 状态前进入Atempt状态</strong></p>

<h3 id="满足如下条件时lsa将被视为更新的">满足如下条件时，LSA将被视为更新的</h3>
<ul>
  <li>序列号更大</li>
  <li>校验和更大（如果序列号相同）</li>
  <li>年龄等于maxage（这表明LSA被抑制）</li>
  <li>LS 年龄小得多</li>
</ul>

<p><img src="/assets/images/ospf/06.png" /></p>

<p><img src="/assets/images/ospf/07.png" /></p>

<p><img src="/assets/images/ospf/08.png" /></p>

<h2 id="常规配置">常规配置</h2>

<h3 id="配置ospf进程的步骤">配置OSPF进程的步骤</h3>

<ul>
  <li>router ospf process-id [vrf vpn-name]在路由器上启用OSPF 进程</li>
  <li>network ip address wildcard-mask area area-id 指定路由器的哪些接口将参与OSPF进程以及网络所属的OSPF区域</li>
</ul>

<p><img src="/assets/images/ospf/9.png" /></p>

<p><img src="/assets/images/ospf/10.png" /></p>

<p><strong>接口配置命令 ip ospf process-id area area-id [secondaries none],优先于命令network area</strong></p>

<p><img src="/assets/images/ospf/11.png" /></p>

<p><img src="/assets/images/ospf/12.png" /></p>

<p>区域OSPF配置示例</p>

<p><img src="/assets/images/ospf/13.png" /></p>

<h3 id="路由器id">路由器ID</h3>
<ul>
  <li>router-id ip-address</li>
  <li>路由器ID设置为最大的活动环回接口地址</li>
  <li>最大的活动物理接口IP地址</li>
</ul>

<p><strong>OSPF数据库使用路由器ID来唯一地标识网络中的每台路由器,因此在整个OSPF自治系统中，路由器ID都不能重复</strong></p>

<p><img src="/assets/images/ospf/14.png" /></p>

<h3 id="查看ospf的运行">查看OSPF的运行</h3>
<ul>
  <li>show ip ospf显示OSPF路由器ID（RID）、OSPF定时器、执行了 SPF 算法多少次以及LSA信息。</li>
  <li>show ip ospf interface [type number] [ brief]：查看接口是否被加入到正确的区域中；该命令还显示各种定时器（包括Hello间隔）和邻接关系</li>
  <li>show ip ospf neighbor detail [type number] [neighbor-id] [detail]：显示一个邻居列表，包括它们的OSPF路由器ID、OSPF优先级、邻接关系状态（如init、预启动或完全邻接）及失效定时器</li>
  <li>show ip route ospf：显示路由器知道的 OSPF 路由，它是判断本地路由器和互连网络其他部分之间的连接性的最佳方法之一。该命令还有可选参数，让您能够进一步指定要显示的信息，如OSPF进程ID</li>
  <li>show ip protocols：显示 IP 路由协议参数，包括定时器、过滤器、度量值、网络及路由器的其他信息</li>
  <li>debug ip ospf events显示与OSPF相关的事件，如建立邻接关系、扩散信息、DR选举和SPF计算</li>
</ul>

<p><img src="/assets/images/ospf/15.png" /></p>

<p><img src="/assets/images/ospf/16.png" /></p>

<p><img src="/assets/images/ospf/17.png" /></p>

<p><img src="/assets/images/ospf/18.png" /></p>

<p><img src="/assets/images/ospf/19.png" /></p>

<h2 id="网络类型">网络类型</h2>

<h3 id="dr和bdr">DR和BDR</h3>

<p><img src="/assets/images/ospf/20.png" /></p>

<ul>
  <li>优先级最高的路由器成为DR</li>
  <li>优先级次高的路由器成为BDR</li>
  <li>接口的OSPF优先级默认为1</li>
  <li>优先级为0的路由器不能成为DR或BDR</li>
  <li>优先级更高的路由器加入网络时，并不会抢占DR或BDR</li>
</ul>

<p><strong>DR 概念是链路级的，牢记这一点很重要。在多路访问广播环境中，每个网段都有自己的DR和BDR</strong></p>

<p>要指定将多路访问链路上的哪个路由器接口用做DR或BDR，可使用接口配置命令ip ospf priority number。默认的优先级为 0，其取值范围为0～255
DR和BDR的价值体现在以下方面</p>

<ul>
  <li>减少路由更新数据流</li>
  <li>管理链路状态同步</li>
</ul>

<p><img src="/assets/images/ospf/21.png" /></p>

<p><img src="/assets/images/ospf/22.png" /></p>

<h2 id="lsa">LSA</h2>

<p><img src="/assets/images/ospf/30.png" />
<img src="/assets/images/ospf/31.png" /></p>

<ul>
  <li>1类（路由器LSA）：每台路由器都生成有关其所属区域的路由器链路通告。路由器链路通告描述了路由器连接到区域的链路的状态，只在区域内扩散。每种LSA的报头都是20字节，其中一个字段是链路状态ID。对于1类LSA，该字段的值为最初发送LSA的路由器的ID。</li>
  <li>2类（网络LSA）：DR为多路访问网络生成的网络链路通告，描述了特定多路访问网络上的一组路由器。网络链路通告在网络所在的区域内扩散。2类LSA的链路状态ID为DR的IP接口地址。</li>
  <li>3类和4类（汇总LSA）：汇总链路通告是由ABR生成的，描述了下述区域间路由
    3类 LSA描述了前往网络的路由（还可能包含汇总路由）
    4类 LSA描述了前往ASBR的路由</li>
  <li>5类（自治系统外部LSA）：自治系统外部链路状态通告是由ASBR生成的，描述了前往自治系统外部的目标网络的路由，被扩散到除各种末节区域外的其他所有地方。5类LSA的链路状态ID为外部网络的地址。</li>
  <li>6 类（多播 OSPF LSA）：这些 LSA 用于 OSPF 多播应用中</li>
  <li>7类（用于NSSA的LSA）：这些LSA用于NSSA中，将在本章后面的“配置NSSA”一节介绍</li>
  <li>8类（BGP的外部属性LSA）：这些LSA用于互联OSPF和BGP</li>
  <li>9、10和11类（不透明LSA）：这些LSA用于升级到OSPF，旨在在OSPF域中分发应用程序特定的信息。例如，Cisco使用9类不透明LSA在OSPF中实现MPLS流量工程。分发不透明LSA时，使用的是标准的LSDB扩散机制。这3种LSA的扩散范围各不相同，9类LSA只在本地网络或子网内扩散，10类LSA只在当前区域内扩散，而11类LSA扩散到整个自治系统（与5类LSA相同）。不透明LSA是在 RFC 5250（The OSPF Opaque LSA Option）中定义的。</li>
</ul>

<p><strong>在Cisco路由器中，OSPFv2不支持6类和8类LSA</strong></p>

<h3 id="1类lsa">1类LSA</h3>
<p>路由器通告1类LSA，这种LSA被扩散到当前区域内的所有路由器，1类LSA指出了每条链路的OSPF开销以及路由器是不是ABR或ASBR</p>

<p><img src="/assets/images/ospf/32.png" /></p>

<p><img src="/assets/images/ospf/33.png" /></p>

<h3 id="2类lsa">2类LSA</h3>
<p>2 类 LSA 是为区域中每个中转的广播或 NBMA 网络生成的，中转网络至少与两台OSPF 路由器直接相连</p>

<p><img src="/assets/images/ospf/34.png" /></p>

<h3 id="3类lsa">3类LSA</h3>
<p>3类（汇总）LSA由ABR生成，它将一个区域内的网络通告给OSPF自治系统中的其他区域</p>

<p><img src="/assets/images/ospf/35.png" /></p>

<h3 id="4类lsa">4类LSA</h3>
<p>仅当区域中有ASBR时，ABR才会生成4类（汇总）LSA。4类LSA标识ASBR，并提供一条前往该ASBR的路由</p>

<p><img src="/assets/images/ospf/36.png" /></p>

<h3 id="5类lsa">5类LSA</h3>
<p>5类LSA描述了前往OSPF自治系统外的网络的路由，它由ASBR发送并被扩散到整个AS</p>

<p><img src="/assets/images/ospf/37.png" /></p>

<p><img src="/assets/images/ospf/38.png" /></p>

<h3 id="ospf的路由表和路由类型">OSPF的路由表和路由类型</h3>

<p><img src="/assets/images/ospf/39.png" /></p>

<p><img src="/assets/images/ospf/40.png" /></p>

<h3 id="计算o-e1-和-o-e2的开销">计算O E1 和 O E2的开销</h3>

<p><img src="/assets/images/ospf/41.png" /></p>

<ul>
  <li>对于O E1 外部路由，开销为外部开销加上分组经过的每条链路的内部开销。多个ASBR将同一条外部路由通告到同一个自治系统中时，应使用这种类型，以避免次优路由</li>
  <li>O E2路由的开销总是只包含外部开销。只有一台 ASBR将外部路由通告到自治系统中时，使用这种类型</li>
</ul>

<h3 id="lsdb的过载保护">LSDB的过载保护</h3>

<p><img src="/assets/images/ospf/42.png" /></p>

<h2 id="特殊区域">特殊区域</h2>

<h3 id="标准区域">标准区域</h3>
<p>这是默认的区域类型，它接受链路更新、汇总路由和外部路由。</p>

<h3 id="骨干区域">骨干区域</h3>
<p>骨干区域为区域0，其他区域都与之相连以交换和路由信息。OSPF骨干区域具有标准OSPF区域的所有特征</p>

<h3 id="末节区域">末节区域</h3>
<p>这种区域不接受关于自治系统外部的路由的信息，如来自非 OSPF 路由器的路由。需要路由到自治系统外部的网络时，路由器使用默认路由（用0.0.0.0表示）。末节区域不能包含ASBR（除非ABR也是ASBR）</p>

<h3 id="绝对末节区域">绝对末节区域</h3>
<p>这种 Cisco 专用的区域不接受来自自治系统外部的路由以及来自自治系统中其他区域的汇总路由。需要将分组发送到区域外的网络时，路由器使用默认路由。绝对末节区域中不能有ASBR（除非ABR也是ASBR）</p>

<h3 id="nssa">NSSA</h3>
<p>NSSA 是对OSPF RFC的补充。这种区域定义了一种特殊的 LSA——7类LSA。NSSA具有末节区域的优点，它们不接受有关自治系统外部的路由的信息，而使用默认路由前往外部网络。然而，NSSA可以包含ASBR，这违反了关于末节区域的规则。</p>

<h3 id="绝对末节nssa">绝对末节NSSA</h3>
<p>Cisco路由器也允许将区域配置为绝对末节NSSA，这种区域可包含 ASBR，但不接受外部路由和来自其他区域的汇总路由。它使用默认路由前往区域外的网络。</p>

<p><img src="/assets/images/ospf/70.png" /></p>

<p><img src="/assets/images/ospf/71.png" /></p>

<h3 id="配置末节区域">配置末节区域</h3>

<p><img src="/assets/images/ospf/72.png" /></p>

<p>步骤</p>
<ul>
  <li>在区域内的所有路由器上配置OSPF</li>
  <li>在区域中所有的路由器上配置路由器配置命令area area-id stub</li>
  <li>（可选）在ABR中配置默认路由的开销</li>
</ul>

<p><img src="/assets/images/ospf/73.png" /></p>

<p><img src="/assets/images/ospf/74.png" /></p>

<h3 id="配置绝对末节区域cisco专有">配置绝对末节区域(CISCO专有)</h3>
<p>5类外部LSA以及3类和4类汇总LSA（区域间路由）不能传播到绝对末节区域中</p>

<p><img src="/assets/images/ospf/75.png" /></p>

<p>步骤</p>
<ul>
  <li>在区域内的所有路由器上配置OSPF</li>
  <li>在区域中所有的路由器上配置路由器配置命令area area-id stub</li>
  <li>在ABR上，在命令area area-id stub中指定关键字no-summary，这让区域变成绝对末节的</li>
  <li>(可选)在ABR上，配置默认路由的开销</li>
</ul>

<p><img src="/assets/images/ospf/76.png" /></p>

<p><img src="/assets/images/ospf/77.png" /></p>

<p><img src="/assets/images/ospf/78.png" /></p>

<h3 id="ospf的路由表">OSPF的路由表</h3>

<p><img src="/assets/images/ospf/79.png" /></p>

<p>（没有任何末节配置的）标准区域中OSPF路由器的路由表，其中包括区域内路由（O）、区域间路由（O IA）和外部路由（O E1和 O E2）</p>

<p><img src="/assets/images/ospf/80.png" /></p>

<p>配置为末节区域后的路由表，其中包含区域内路由（O）和区域间路由（O IA），但不包含外部路由（O E1和 O E2），因为这些路由被区域间默认路由（O*IA）取代</p>

<p><img src="/assets/images/ospf/81.png" /></p>

<p><img src="/assets/images/ospf/82.png" /></p>

<p>ABR上执行汇总（区域仍被配置为末节的）后的路由表，其中包含区域内路由（O）和区域间汇总路由（O IA，这里将路由 172.31.11.1 和 172.31.11.2 汇总成了172.31.11.0/24），但不包含外部路由，（O E1 和 O E2），因为这些路由被区域间默认路由（O*IA）取代</p>

<p><img src="/assets/images/ospf/83.png" /></p>

<p>绝对末节区域后的路由表。注意到在绝对末节区域中，路由器的路由表最小，其中只包含区域内路由（O），而不包含区域间路由（O IA）和外部路由（O E1和 O E2），因为用区域间默认路由（O*IA）取代了这些路由</p>

<h3 id="配置nssa">配置NSSA</h3>
<p>将路由重分发到NSSA中时，将创建一种特殊的LSA——7类LSA，这种LSA只能出现在NSSA中，它是由NSSA ASBR生成的，而NSSA ABR将其转换为5类LSA并在OSPF域中传播。7类LSA的LSA报头中有一个传播（P）位，用于避免在NSSA和骨干区域之间循环传播它。7类LSA的格式与5类LSA相同。</p>

<p><img src="/assets/images/ospf/84.png" /></p>

<p>步骤</p>
<ul>
  <li>在区域内的所有路由器上配置OSPF</li>
  <li>在区域内的所有路由器上配置路由器配置命令 area area-id nssa [no-redistr-ibution] [default-information-originate] [metric metric-value] [metric-type type-value]而不是 area area-id stub</li>
  <li>(可选)ABR上配置默认路由的开销。</li>
</ul>

<p><img src="/assets/images/ospf/85.png" /></p>

<p><img src="/assets/images/ospf/86.png" /></p>

<p><img src="/assets/images/ospf/87.png" /></p>

<h3 id="ospf-nssa-的-lsdb">OSPF NSSA 的 LSDB</h3>

<p><img src="/assets/images/ospf/88.png" /></p>

<p><img src="/assets/images/ospf/89.png" /></p>

<p><img src="/assets/images/ospf/90.png" /></p>

<p>注意到这里没有使用ASBR汇总（4类）LSA，因为5类外部LSA来自ABR而不是ASBR，而ABR在区域0内。如果区域为标准区域，ASBR将生成5类LSA，而ABR将创建4类LSA，以告诉其他路由器如何前往ASBR。</p>

<h3 id="配置绝对末节nssacisco专有">配置绝对末节NSSA(CISCO专有)</h3>
<p>步骤</p>
<ul>
  <li>在区域内的所有路由器上配置OSPF</li>
  <li>在区域内的所有路由器上配置路由器配置命令 area area-id nssa [no-redistr-ibution] [default-information-originate] [metric metric-value] [metric-type type-value]而不是area area-id stub</li>
  <li>在ABR上，在命令area area-id nssa中添加关键字no-summary</li>
  <li>(可选)在ABR上配置默认路由的开销</li>
</ul>

<p><img src="/assets/images/ospf/91.png" /></p>

<p><img src="/assets/images/ospf/92.png" /></p>

<p><img src="/assets/images/ospf/93.png" /></p>

<p>#各种OSPF区域示例</p>

<p><img src="/assets/images/ospf/94.png" /></p>

<p>区域11为标准区域，它接受链路更新、汇总和外部路由。
区域14为末节区域，它不接受4类汇总LSA和5类外部LSA，但接受3类汇总LSA。
区域12为绝对末节区域，它不接受汇总LSA和外部LSA。
区域10为NSSA，它不接受4类汇总LSA和5类外部LSA，但接受3类汇总LSA且可以有ASBR。
区域13为绝对末节NSSA，它不接受汇总LSA和外部LSA，但可以有ASBR</p>

<p><img src="/assets/images/ospf/95.png" /></p>

<h3 id="默认路由">默认路由</h3>
<p>在标准区域中，路由器不生成默认路由 ，可使用命令default-information originate [always] [metric metric-value]  [metric-typetype-value] [route-map map-name]。默认情况下，该命令生成一条E2 路由，其链路状态ID为0.0.0.0，网络掩码为0.0.0.0，导致路由器成为ASBR。
末节区域和绝对末节区域，与末节区域相连的ABR将生成一个链路状态ID为0.0.0.0的汇总LSA，即使该ABR没有默认路由
对于NSSA，默认路由是由与之相连的ABR生成的，但默认情况下不会生成。要让ABR生成默认路由，可使用命令area area-idnssa default-information-originate。ABR将生成一个链路状态ID为0.0.0.0的7类LSA。如果只想将路由导入到标准区域中，而不想将其导入到NSSA中，可在NSSA ABR上使用选项no-redistribution。绝对末节NSSA的ABR自动生成一条默认路由</p>

<h2 id="身份认证">身份认证</h2>

<h3 id="配置简单密码身份验证">配置简单密码身份验证</h3>

<p>步骤</p>
<ul>
  <li>使用接口配置命令 ip ospf authentication-key password指定一个密码</li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>使用接口配置命令 ip ospf authentication [message-digest</td>
          <td>null] md5指定身份验证类型</td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

<p>如果要使用简单身份验证，可在配置命令 area authentication 时不指定任何参数。</p>

<p><img src="/assets/images/ospf/100.png" /></p>

<p>示例</p>

<p><img src="/assets/images/ospf/101.png" /></p>

<p><img src="/assets/images/ospf/102.png" /></p>

<p><img src="/assets/images/ospf/103.png" /></p>

<p>验证</p>

<p><img src="/assets/images/ospf/104.png" /></p>

<p><img src="/assets/images/ospf/105.png" /></p>

<p>排障</p>
<ul>
  <li>没有在两台路由器上都配置身份验证</li>
  <li>两台路由器配置的身份验证类型不同</li>
  <li>两台路由器配置的密码不同</li>
</ul>

<p>在虚链路上配置OSPF简单密码身份验证</p>

<p><img src="/assets/images/ospf/106.png" /></p>

<h3 id="md5身份验证的配置-验证-和故障排除">MD5身份验证的配置 验证 和故障排除</h3>

<p><img src="/assets/images/ospf/107.png" /></p>

<p><img src="/assets/images/ospf/108.png" /></p>

<p>验证</p>

<p><img src="/assets/images/ospf/109.png" /></p>

<p>排障
简单密码身份验证一样，命令 debug ip ospf obj 显示与 OSPF 邻接关系相关的事件，对于排除MD5身份验证故障很有帮助</p>

<p><img src="/assets/images/ospf/110.png" /></p>

<p><img src="/assets/images/ospf/111.png" /></p>

<h2 id="总结">总结</h2>

<h3 id="ospf-使用的表">OSPF 使用的表</h3>
<p>邻居表（也叫邻接关系数据库）、拓扑表（也叫拓扑数据库[LSDB]）和路由表（也叫转发数据库）</p>

<h3 id="由两层组成ospf分层区域结构">由两层组成OSPF分层区域结构</h3>
<p>骨干区域0和常规区域。</p>

<h3 id="各类型的ospf路由器">各类型的OSPF路由器</h3>
<ul>
  <li>内部路由器</li>
  <li>骨干路由器</li>
  <li>ABR</li>
  <li>ASBR。</li>
</ul>

<h3 id="ospf-路由器如何使用-hello-协议建立邻接关系">OSPF 路由器如何使用 Hello 协议建立邻接关系</h3>
<p>两台路由器使用 Hello 分组建立邻接关系后，它们交换LSA并确认收到了邻接路由器的LSA，以同步LSDB。在点到点链路上，路由器彼此建立完全邻接关系，而在 LAN 链路上，路由器只与DR和BDR建立完全邻接关系。</p>

<h3 id="cisco-路由器如何计算-ospf-度量值">Cisco 路由器如何计算 OSPF 度量值</h3>
<p>默认情况下，根据链路带宽计算度量值；如果有速度超过 100Mbit/s 的接口，应在所有路由器上都配置路由器配置命令<strong>auto-cost reference-bandwidth ref-bw</strong>。要覆盖默认开销，可使用接口配置命令 <strong>ip ospf cost interface-cost</strong>手工指定开销。</p>

<h3 id="5-种类型的-ospf分组">5 种类型的 OSPF分组</h3>
<p>Hello、DBD、LSR、LSU 和LSAck</p>
<ul>
  <li>Hello 分组用于发现邻居和建立邻接关系</li>
  <li>DBD用于同步LSDB</li>
  <li>LSR用于请求特定的链路状态记录</li>
  <li>LSU 用于发送请求的记录</li>
  <li>LSAck 用于确认收到了其他类型的分组
    <blockquote>
      <p>OSPF 分组是在IP分组中发送的，使用的协议号为89。</p>
    </blockquote>
  </li>
</ul>

<h3 id="可能经历的ospf-邻接关系状态">可能经历的OSPF 邻接关系状态</h3>
<p>Down、Atempt、Init、双向、预启动、交换、加载和完全邻接。</p>

<h3 id="在邻接路由器上必须匹配的5个hello分组字段">在邻接路由器上，必须匹配的5个Hello分组字段</h3>
<ul>
  <li>Hello间隔</li>
  <li>失效间隔</li>
  <li>区域ID</li>
  <li>身份验证密码</li>
  <li>末节区域标记。</li>
</ul>

<h3 id="规划ospf实施">规划OSPF实施</h3>
<p>包括IP编址方案、网络拓扑和OSPF区域。对于网络中的每台路由器，需要完成的任务包括启用路由协议 OSPF 并指定进程号（可在接口上直接启用，也可使用合适的network命令）、给接口指定正确的区域ID以及给合适的接口配置度量值（这是可选的）。</p>

<h3 id="基本的ospf配置命令">基本的OSPF配置命令</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 全局配置命令 </span>
router ospf process-id。
<span class="c">#接口配置命令 </span>
network ip-address wildcard-mask area area-id 和 ip ospf process-idareaarea-id <span class="o">[</span>secondaries none]。
<span class="c">#接口配置命令</span>
bandwidth kilobits。
<span class="c">#路由器配置命令</span>
router-id ip-address。
<span class="c">#用于查看OSPF运行情况的命令。</span>
show ip ospf。
show ip route。
show ip ospf interface。
show ip ospf neighbor。
show ip route ospf。
show ip protocols。
debug ip ospf events。
debug ip ospf adj。
debug ip ospf packet。
</code></pre></div></div>
<h3 id="如何选择ospf路由器id">如何选择OSPF路由器ID</h3>
<p>路由器配置命令router-id ip-address指定的、最大的活动环回接口IP地址或最大的活动物理接口IP地址。</p>

<h3 id="ospf-定义的三类网络">OSPF 定义的三类网络</h3>
<p>点到点、广播和 NBMA。</p>

<h3 id="如何选举dr和bdr">如何选举DR和BDR</h3>
<p>优先级最高的路由器为DR，优先级次高的路由器为BDR。如果优先级相同，则根据路由器ID来选举。优先级为0的路由器不能成为DR或BDR。优先级是使用接口配置命令 ip ospf prioritynumber 设置的。</p>

<h3 id="可用于nbma网络的5种ospf运行模式">可用于NBMA网络的5种OSPF运行模式</h3>
<p>RFC模式非广播和点到多点以及Cisco模式广播、点到多点非广播和点到点。</p>

<h3 id="lsa类型">LSA类型</h3>
<p>11种 OSPF LSA类型,前5 种是最常用的，它们分别是由每台路由器生成的1类（路由器）、DR生成的2类（网络）、ABR生成的描述区域路由的3类（汇总）、ABR生成的描述前往ASBR的路由的4类（汇总）以及ASBR生成的描述前往外部的路由的5类（外部）。</p>

<h3 id="三种ospf-路由">三种OSPF 路由</h3>
<p>区域内路由（O）、区域间路由（O IA）和外部路由（O E1或OE2）。</p>

<h3 id="使用路由器配置命令">使用路由器配置命令</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>max-lsa maximum-number <span class="o">[</span>threshold-percentage] <span class="o">[</span>warning-only] <span class="o">[</span>ignore-time minutes] <span class="o">[</span>ignore-count countnumber] <span class="o">[</span>reset-time minutes]配置OSPF LSDB过载保护。
</code></pre></div></div>

<h3 id="使用路由器配置命令-1">使用路由器配置命令</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>passive-interface <span class="nb">type </span>number <span class="o">[</span>default]禁止从指定路由器接口向外发送路由协议的路由更新
<span class="c"># 从OSPF 而言，指定接口看起来像末节网络，不通过该接口发送和接收OSPF路由信息。</span>
</code></pre></div></div>

<h3 id="ospf的默认路由">OSPF的默认路由</h3>
<p>在 OSPF 中可使用默认路由，这样就无需知道前往所有目标网络的具体路由。这样做的好处是，路由表和LSDB将小得多，同时又能够到达所有网络。要传播OSPF默认路由，可使用路由器配置命令</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>default-information originate <span class="o">[</span>always] <span class="o">[</span>metric metric-value] <span class="o">[</span>metric-typetype-value] <span class="o">[</span>route-map map-name]。
</code></pre></div></div>

<h3 id="配置路由汇总">配置路由汇总</h3>
<p>可减少占用的CPU周期和LSA扩散，还可缩小LSDB和路由表的规模。OSPF不自动汇总</p>

<p>要在ABR上配置OSPF汇总，可使用路由器配置命令</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>area area-id range address mask <span class="o">[</span>advertise | not-advertise] <span class="o">[</span>cost cost]；
</code></pre></div></div>
<p>要在ASBR 上配置 OSPF 汇总，可使用路由器配置命令</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>summary-address ip-address mask <span class="o">[</span>not-advertise] <span class="o">[</span>tag tag]。
</code></pre></div></div>

<h3 id="ospf-虚链路">OSPF 虚链路</h3>
<p>这是一种用于临时修复骨干故障或将区域连接到骨干的功能。要配置虚链路，可使用路由器配置命令</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>area area-id virtual-link router-id <span class="o">[</span>authentic- ation <span class="o">[</span>message-digest | null]] <span class="o">[</span>hello-interval seconds] <span class="o">[</span>retransmit-interval seconds] <span class="o">[</span>transmit-delay seconds] <span class="o">[</span>dead-interval seconds] <span class="o">[[</span>authentication-key key] | <span class="o">[</span>message-digest-keykey-idmd5key]]；要查看其运行情况，可使用命令 show ip ospf virtual-links。
</code></pre></div></div>

<h3 id="ospf-中定义的多种区域类型">OSPF 中定义的多种区域类型</h3>
<p>标准区域、骨干区域、末节区域、绝对末节区域、NSSA和绝对末节NSSA。要配置末节区域，可使用路由器配置命令</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>area area-id stub；
</code></pre></div></div>
<p>在ABR上配置该命令时，如果指定了关键字<strong>no-summary</strong>，区域将被配置为绝对末节区域。要配置NSSA，应使用路由器配置命令</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>area area-id nssa <span class="o">[</span>no-redistribution] <span class="o">[</span>default-information-originate] <span class="o">[</span>met-ric metric-value] <span class="o">[</span>metric-type type-value] <span class="o">[</span>no-summary]
</code></pre></div></div>
<p>而不要使用命令</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>area area-id stub
</code></pre></div></div>
<p>要将区域配置成绝对末节NSSA，只需在ABR上配置该命令时指定关键字<strong>no-summary</strong>。</p>

<h3 id="ospf-身份验证类型">OSPF 身份验证类型</h3>
<ul>
  <li>null</li>
  <li>简单密码身份验证（也叫明文身份验证）</li>
  <li>MD5 身份验证</li>
  <li>要排除身份验证故障，可使用命令
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debug ip ospf adj。
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="配置ospf简单密码身份验证的命令">配置OSPF简单密码身份验证的命令</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 接口配置命令 </span>
ip ospf authentication-keypassword。
<span class="c"># 接口配置命令 </span>
ip ospf authentication 和路由器配置命令 area area-id authentication。
<span class="c"># 配置OSPF MD5 身份验证的命令</span>
<span class="c"># 接口配置命令 </span>
ip ospf message-digest-key key-id md5key。
<span class="c">#接口配置命令 </span>
ip ospf authentication message-digest 
<span class="c"># 路由器配置命令 </span>
area area-id authentication message-digest。
</code></pre></div></div>]]></content><author><name>Your Name</name></author><category term="RS" /><summary type="html"><![CDATA[OSPF备忘信息]]></summary></entry><entry><title type="html">pgsql监控</title><link href="/monitor-pgsql/" rel="alternate" type="text/html" title="pgsql监控" /><published>2022-08-19T00:00:00+08:00</published><updated>2022-08-19T00:00:00+08:00</updated><id>/monitor-pgsql</id><content type="html" xml:base="/monitor-pgsql/"><![CDATA[<p>测试pgsql监控</p>

<h3 id="系统">系统</h3>
<p>Centos 7</p>

<h3 id="安装pgsql">安装pgsql</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
<span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> postgresql12-server
<span class="nb">sudo</span> /usr/pgsql-12/bin/postgresql-12-setup initdb
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>postgresql-12
<span class="nb">sudo </span>systemctl start postgresql-12
</code></pre></div></div>

<h3 id="数据库设置">数据库设置</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>su postgres
psql
CREATE USER zbx_monitor WITH PASSWORD <span class="s1">'monitor'</span> INHERIT<span class="p">;</span>
GRANT EXECUTE ON FUNCTION pg_catalog.pg_ls_dir<span class="o">(</span>text<span class="o">)</span> TO zbx_monitor<span class="p">;</span>
GRANT EXECUTE ON FUNCTION pg_catalog.pg_stat_file<span class="o">(</span>text<span class="o">)</span> TO zbx_monitor<span class="p">;</span>
GRANT EXECUTE ON FUNCTION pg_catalog.pg_ls_waldir<span class="o">()</span> TO zbx_monitor<span class="p">;</span>
</code></pre></div></div>

<h3 id="监控配置">监控配置</h3>
<p>监控页面添加主机挂载对应pgsql模板</p>

<h3 id="参考">参考</h3>
<p>https://www.postgresql.org/download/linux/redhat/</p>]]></content><author><name>Your Name</name></author><category term="Monitor" /><summary type="html"><![CDATA[测试pgsql监控]]></summary></entry><entry><title type="html">使用kubeadm 升级Kubernetes</title><link href="/kubernetes-kubeadm-update/" rel="alternate" type="text/html" title="使用kubeadm 升级Kubernetes" /><published>2022-08-18T00:00:00+08:00</published><updated>2022-08-18T00:00:00+08:00</updated><id>/kubernetes-kubeadm-update</id><content type="html" xml:base="/kubernetes-kubeadm-update/"><![CDATA[<p>升级kubernetes版本</p>

<h3 id="安装一套v1201集群">安装一套v1.20.1集群</h3>

<h4 id="创建两台主机">创建两台主机</h4>

<table>
  <thead>
    <tr>
      <th>主机名</th>
      <th>IP地址</th>
      <th>内存需求</th>
      <th>操作系统</th>
      <th>角色</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>umaster</td>
      <td>192.168.122.240</td>
      <td>4GB</td>
      <td>centos 7</td>
      <td>master</td>
    </tr>
    <tr>
      <td>unode1</td>
      <td>192.168.122.241</td>
      <td>4GB</td>
      <td>centos 7</td>
      <td>node</td>
    </tr>
  </tbody>
</table>

<h4 id="初始化配置">初始化配置</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>virt-install --name umaster --ram 4096 --vcpus=4 --os-type=linux --accelerate --cdrom=/home/kvm/CentOS-7.5-x86_64-Minimal-1804.iso  --disk path=/home/kvm/umaster.qcow2,size=30,format=qcow2,bus=ide --bridge=virbr0 --vnc --vncport=60021 --vnclisten=0.0.0.0
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>virt-install --name unode1 --ram 4096 --vcpus=2 --os-type=linux --accelerate --cdrom=/home/kvm/CentOS-7.5-x86_64-Minimal-1804.iso  --disk path=/home/kvm/unode1.qcow2,size=30,format=qcow2,bus=ide --bridge=virbr0 --vnc --vncport=60022 --vnclisten=0.0.0.0
</code></pre></div></div>

<p>所有节点初始化</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># master node 关闭防火墙  </span>
systemctl stop firewalld 
systemctl disable firewalld 
 
<span class="c"># master node 关闭selinux   </span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/enforcing/disabled/'</span> /etc/selinux/config  <span class="c"># 永久 </span>
setenforce 0  <span class="c"># 临时 </span>
 
<span class="c"># master node 关闭swap </span>
swapoff <span class="nt">-a</span>  <span class="c"># 临时 </span>
<span class="nb">sed</span> <span class="nt">-ri</span> <span class="s1">'s/.*swap.*/#&amp;/'</span> /etc/fstab    <span class="c"># 永久 </span>
 
<span class="c"># master node 时间同步 </span>
yum <span class="nb">install </span>ntpdate <span class="nt">-y</span> 
ntpdate time.windows.com

<span class="c"># master node 安装vim wget</span>
yum <span class="nt">-y</span> <span class="nb">install </span>vim wget 
 
<span class="c">#添加hosts </span>
<span class="nb">cat</span> <span class="o">&gt;&gt;</span> /etc/hosts <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> 
192.168.122.240 master
192.168.122.241 node1 
</span><span class="no">EOF 
 
</span><span class="c"># 将桥接的IPv4流量传递到iptables的链 </span>
<span class="nb">cat</span> <span class="o">&gt;</span> /etc/sysctl.d/k8s.conf <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> 
net.bridge.bridge-nf-call-ip6tables = 1 
net.bridge.bridge-nf-call-iptables = 1 
</span><span class="no">EOF 

</span>sysctl <span class="nt">--system</span>  <span class="c"># 生效 </span>
 
<span class="c"># master 设置 </span>
hostnamectl set-hostname master
<span class="c"># node1 设置</span>
hostnamectl set-hostname node1
<span class="c"># node2 设置</span>
hostnamectl set-hostname node2

<span class="c"># 安装docker</span>
bash &lt;<span class="o">(</span>wget <span class="nt">-O-</span> get.docker.com<span class="o">)</span>

<span class="c">#启动并设置开机启动</span>
systemctl daemon-reload
systemctl start docker
systemctl <span class="nb">enable </span>docker
systemctl status docker

<span class="c">#修改配置</span>
<span class="nb">cat</span> <span class="o">&gt;</span> /etc/docker/daemon.json <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
{
  "registry-mirrors": ["https://b9pmyelo.mirror.aliyuncs.com"]
}
</span><span class="no">EOF

</span><span class="c">#重启</span>
systemctl restart docker
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mv</span> /etc/yum.repos.d/<span class="k">*</span> /tmp/
wget <span class="nt">-P</span> /etc/yum.repos.d/ ftp://ftp.rhce.cc/k8s/<span class="k">*</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nb">install</span> <span class="nt">-y</span> kubelet-1.20.1-0 kubeadm-1.20.1-0 kubectl-1.20.1-0 <span class="nt">--disableexcludes</span><span class="o">=</span>kubernetes
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart kubelet
systemctl <span class="nb">enable </span>kubelet
</code></pre></div></div>

<h4 id="导出配置">导出配置</h4>

<p>master上到传到umaster，修改版本</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master tmp]# kubectl get cm <span class="nt">-o</span> yaml <span class="nt">-n</span> kube-system kubeadm-config
apiVersion: v1
data:
  ClusterConfiguration: |
    apiServer:
      extraArgs:
        authorization-mode: Node,RBAC
      timeoutForControlPlane: 4m0s
    apiVersion: kubeadm.k8s.io/v1beta2
    certificatesDir: /etc/kubernetes/pki
    clusterName: kubernetes
    controllerManager: <span class="o">{}</span>
    dns:
      <span class="nb">type</span>: CoreDNS
    etcd:
      <span class="nb">local</span>:
        dataDir: /var/lib/etcd
    imageRepository: registry.aliyuncs.com/google_containers
    kind: ClusterConfiguration
    kubernetesVersion: v1.20.1
    networking:
      dnsDomain: cluster.local
      podSubnet: 10.244.0.0/16
      serviceSubnet: 10.96.0.0/12
    scheduler: <span class="o">{}</span>
  ClusterStatus: |
    apiEndpoints:
      master:
        advertiseAddress: 192.168.122.200
        bindPort: 6443
    apiVersion: kubeadm.k8s.io/v1beta2
    kind: ClusterStatus
kind: ConfigMap
metadata:
  creationTimestamp: <span class="s2">"2022-07-10T12:08:39Z"</span>
  name: kubeadm-config
  namespace: kube-system
  resourceVersion: <span class="s2">"206"</span>
  uid: ccf5abbc-caed-4528-a572-9422a71112a1
</code></pre></div></div>

<p>创建集群</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubeadm init <span class="nt">--config</span><span class="o">=</span>kubeadm-config.yaml
</code></pre></div></div>

<p>umaster执行</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$HOME</span>/.kube
  <span class="nb">sudo cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
  <span class="nb">sudo chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> <span class="nv">$HOME</span>/.kube/config
</code></pre></div></div>

<p>unode1加入集群</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubeadm <span class="nb">join </span>192.168.122.240:6443 <span class="nt">--token</span> vy5ws2.p3e19ircj05jfoyo <span class="se">\</span>
    <span class="nt">--discovery-token-ca-cert-hash</span> sha256:6441dd3e73c23c9cc85c62454f1786d820f891a8fd73263f500fdf2180c4efb8 
</code></pre></div></div>

<h4 id="安装calico">安装calico</h4>

<p>master上执行</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /tmp
wget https://docs.projectcalico.org/v3.19/manifests/calico.yaml <span class="nt">--no-check-certificate</span>
</code></pre></div></div>

<p>修改</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CALICO_IPV4POOL_CIDR</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">192.168.0.0/16"</span>
</code></pre></div></div>

<p>为</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CALICO_IPV4POOL_CIDR</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10.244.0.0/16"</span>
</code></pre></div></div>

<p>下载镜像</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@master tmp]# grep image calico.yaml 
          image: docker.io/calico/cni:v3.19.4
          image: docker.io/calico/cni:v3.19.4
          image: docker.io/calico/pod2daemon-flexvol:v3.19.4
          image: docker.io/calico/node:v3.19.4
          image: docker.io/calico/kube-controllers:v3.19.4
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for </span>i <span class="k">in </span>calico/cni:v3.19.4 calico/pod2daemon-flexvol:v3.19.4  calico/node:v3.19.4 calico/kube-controllers:v3.19.4 <span class="p">;</span><span class="k">do </span>docker pull <span class="nv">$i</span><span class="p">;</span><span class="k">done</span>
</code></pre></div></div>

<p>安装calico</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> calico.yaml
</code></pre></div></div>

<p>查看</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@umaster tmp]# kubectl get nodes
NAME      STATUS   ROLES                  AGE   VERSION
umaster   Ready    control-plane,master   16m   v1.20.1
unode1    Ready    &lt;none&gt;                 15m   v1.20.1

<span class="o">[</span>root@umaster tmp]# kubectl version <span class="nt">--short</span>
Client Version: v1.20.1
Server Version: v1.20.1
</code></pre></div></div>

<h3 id="步骤">步骤</h3>

<p>节点  先升级master  再升级worker  多台master，先升级master 在升级worker</p>

<p>软件  先升级kubeadm 然后执行 kubeadm upgrade,再升级 kubelet和kubectl</p>

<h2 id="升级master">升级master</h2>

<p>确定源里的kubeadm的可用版本</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum list <span class="nt">--showduplicates</span> kubeadm
</code></pre></div></div>

<h4 id="升级kubeadm">升级kubeadm</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nt">-y</span> <span class="nb">install </span>kubeadm-1.21.1-0 <span class="nt">--disableexcludes</span><span class="o">=</span>kubernetes
</code></pre></div></div>

<p>验证</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@umaster tmp]# kubeadm version
kubeadm version: &amp;version.Info<span class="o">{</span>Major:<span class="s2">"1"</span>, Minor:<span class="s2">"21"</span>, GitVersion:<span class="s2">"v1.21.1"</span>, GitCommit:<span class="s2">"5e58841cce77d4bc13713ad2b91fa0d961e69192"</span>, GitTreeState:<span class="s2">"clean"</span>, BuildDate:<span class="s2">"2021-05-12T14:17:27Z"</span>, GoVersion:<span class="s2">"go1.16.4"</span>, Compiler:<span class="s2">"gc"</span>, Platform:<span class="s2">"linux/amd64"</span><span class="o">}</span>
</code></pre></div></div>

<h4 id="查看集群是否需要升级以及可以升级的版本">查看集群是否需要升级,以及可以升级的版本</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@umaster tmp]# kubeadm upgrade plan
<span class="o">[</span>upgrade/config] Making sure the configuration is correct:
<span class="o">[</span>upgrade/config] Reading configuration from the cluster...
<span class="o">[</span>upgrade/config] FYI: You can look at this config file with <span class="s1">'kubectl -n kube-system get cm kubeadm-config -o yaml'</span>
<span class="o">[</span>preflight] Running pre-flight checks.
<span class="o">[</span>upgrade] Running cluster health checks
<span class="o">[</span>upgrade] Fetching available versions to upgrade to
<span class="o">[</span>upgrade/versions] Cluster version: v1.20.1
<span class="o">[</span>upgrade/versions] kubeadm version: v1.21.1
I0710 23:34:23.085584    1579 version.go:254] remote version is much newer: v1.24.2<span class="p">;</span> falling back to: stable-1.21
<span class="o">[</span>upgrade/versions] Target version: v1.21.14
<span class="o">[</span>upgrade/versions] Latest version <span class="k">in </span>the v1.20 series: v1.20.15

Components that must be upgraded manually after you have upgraded the control plane with <span class="s1">'kubeadm upgrade apply'</span>:
COMPONENT   CURRENT       TARGET
kubelet     2 x v1.20.1   v1.20.15

Upgrade to the latest version <span class="k">in </span>the v1.20 series:

COMPONENT                 CURRENT    TARGET
kube-apiserver            v1.20.1    v1.20.15
kube-controller-manager   v1.20.1    v1.20.15
kube-scheduler            v1.20.1    v1.20.15
kube-proxy                v1.20.1    v1.20.15
CoreDNS                   1.7.0      v1.8.0
etcd                      3.4.13-0   3.4.13-0

You can now apply the upgrade by executing the following <span class="nb">command</span>:

        kubeadm upgrade apply v1.20.15

_____________________________________________________________________

Components that must be upgraded manually after you have upgraded the control plane with <span class="s1">'kubeadm upgrade apply'</span>:
COMPONENT   CURRENT       TARGET
kubelet     2 x v1.20.1   v1.21.14

Upgrade to the latest stable version:

COMPONENT                 CURRENT    TARGET
kube-apiserver            v1.20.1    v1.21.14
kube-controller-manager   v1.20.1    v1.21.14
kube-scheduler            v1.20.1    v1.21.14
kube-proxy                v1.20.1    v1.21.14
CoreDNS                   1.7.0      v1.8.0
etcd                      3.4.13-0   3.4.13-0

You can now apply the upgrade by executing the following <span class="nb">command</span>:

        kubeadm upgrade apply v1.21.14

Note: Before you can perform this upgrade, you have to update kubeadm to v1.21.14.

_____________________________________________________________________


The table below shows the current state of component configs as understood by this version of kubeadm.
Configs that have a <span class="s2">"yes"</span> mark <span class="k">in </span>the <span class="s2">"MANUAL UPGRADE REQUIRED"</span> column require manual config upgrade or
resetting to kubeadm defaults before a successful upgrade can be performed. The version to manually
upgrade to is denoted <span class="k">in </span>the <span class="s2">"PREFERRED VERSION"</span> column.

API GROUP                 CURRENT VERSION   PREFERRED VERSION   MANUAL UPGRADE REQUIRED
kubeproxy.config.k8s.io   v1alpha1          v1alpha1            no
kubelet.config.k8s.io     v1beta1           v1beta1             no
_____________________________________________________________________
</code></pre></div></div>

<h4 id="master置为维护模式">master置为维护模式</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@umaster tmp]# kubectl drain umaster <span class="nt">--ignore-daemonsets</span>
node/umaster cordoned
WARNING: ignoring DaemonSet-managed Pods: kube-system/calico-node-76vzp, kube-system/kube-proxy-ttm4n
evicting pod kube-system/coredns-7f89b7bc75-qrns5
evicting pod kube-system/calico-kube-controllers-848c5d445f-8v7t2
evicting pod kube-system/coredns-7f89b7bc75-p54c4
pod/coredns-7f89b7bc75-qrns5 evicted
pod/coredns-7f89b7bc75-p54c4 evicted
pod/calico-kube-controllers-848c5d445f-8v7t2 evicted
</code></pre></div></div>

<p>验证</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@umaster tmp]# kubectl get nodes
NAME      STATUS                     ROLES                  AGE   VERSION
umaster   Ready,SchedulingDisabled   control-plane,master   47m   v1.20.1
unode1    Ready                      &lt;none&gt;                 46m   v1.20.1
</code></pre></div></div>

<p>处理coredns</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull coredns/coredns:1.8.0
docker tag coredns/coredns:1.8.0 registry.aliyuncs.com/google_containers/coredns/coredns:v1.8.0
docker rmi coredns/coredns:1.8.0
</code></pre></div></div>

<h4 id="升级组件">升级组件</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@umaster tmp]# kubeadm upgrade apply v1.21.1
<span class="o">[</span>upgrade/config] Making sure the configuration is correct:
<span class="o">[</span>upgrade/config] Reading configuration from the cluster...
<span class="o">[</span>upgrade/config] FYI: You can look at this config file with <span class="s1">'kubectl -n kube-system get cm kubeadm-config -o yaml'</span>
<span class="o">[</span>preflight] Running pre-flight checks.
<span class="o">[</span>upgrade] Running cluster health checks
<span class="o">[</span>upgrade/version] You have chosen to change the cluster version to <span class="s2">"v1.21.1"</span>
<span class="o">[</span>upgrade/versions] Cluster version: v1.20.1
<span class="o">[</span>upgrade/versions] kubeadm version: v1.21.1
<span class="o">[</span>upgrade/confirm] Are you sure you want to proceed with the upgrade? <span class="o">[</span>y/N]: y
<span class="o">[</span>upgrade/prepull] Pulling images required <span class="k">for </span>setting up a Kubernetes cluster
<span class="o">[</span>upgrade/prepull] This might take a minute or two, depending on the speed of your internet connection
<span class="o">[</span>upgrade/prepull] You can also perform this action <span class="k">in </span>beforehand using <span class="s1">'kubeadm config images pull'</span>
<span class="o">[</span>upgrade/apply] Upgrading your Static Pod-hosted control plane to version <span class="s2">"v1.21.1"</span>...
Static pod: kube-apiserver-umaster <span class="nb">hash</span>: 6df1b5224c3fc3fb71a622a2c30fcaea
Static pod: kube-controller-manager-umaster <span class="nb">hash</span>: de64b953177047fd563a18150d6c6070
Static pod: kube-scheduler-umaster <span class="nb">hash</span>: 78404d25f9e940515e51f92dc60988eb
<span class="o">[</span>upgrade/etcd] Upgrading to TLS <span class="k">for </span>etcd
Static pod: etcd-umaster <span class="nb">hash</span>: 8810d7e5e8825396038f6fef0fb4bd30
<span class="o">[</span>upgrade/staticpods] Preparing <span class="k">for</span> <span class="s2">"etcd"</span> upgrade
<span class="o">[</span>upgrade/staticpods] Current and new manifests of etcd are equal, skipping upgrade
<span class="o">[</span>upgrade/etcd] Waiting <span class="k">for </span>etcd to become available
<span class="o">[</span>upgrade/staticpods] Writing new Static Pod manifests to <span class="s2">"/etc/kubernetes/tmp/kubeadm-upgraded-manifests922784263"</span>
<span class="o">[</span>upgrade/staticpods] Preparing <span class="k">for</span> <span class="s2">"kube-apiserver"</span> upgrade
<span class="o">[</span>upgrade/staticpods] Renewing apiserver certificate
<span class="o">[</span>upgrade/staticpods] Renewing apiserver-kubelet-client certificate
<span class="o">[</span>upgrade/staticpods] Renewing front-proxy-client certificate
<span class="o">[</span>upgrade/staticpods] Renewing apiserver-etcd-client certificate
<span class="o">[</span>upgrade/staticpods] Moved new manifest to <span class="s2">"/etc/kubernetes/manifests/kube-apiserver.yaml"</span> and backed up old manifest to <span class="s2">"/etc/kubernetes/tmp/kubeadm-backup-manifests-2022-07-10-23-44-12/kube-apiserver.yaml"</span>
<span class="o">[</span>upgrade/staticpods] Waiting <span class="k">for </span>the kubelet to restart the component
<span class="o">[</span>upgrade/staticpods] This might take a minute or longer depending on the component/version gap <span class="o">(</span><span class="nb">timeout </span>5m0s<span class="o">)</span>
Static pod: kube-apiserver-umaster <span class="nb">hash</span>: 6df1b5224c3fc3fb71a622a2c30fcaea
Static pod: kube-apiserver-umaster <span class="nb">hash</span>: bec11aedb967e3dd4da819e28c3611dc
<span class="o">[</span>apiclient] Found 1 Pods <span class="k">for </span>label selector <span class="nv">component</span><span class="o">=</span>kube-apiserver
<span class="o">[</span>upgrade/staticpods] Component <span class="s2">"kube-apiserver"</span> upgraded successfully!
<span class="o">[</span>upgrade/staticpods] Preparing <span class="k">for</span> <span class="s2">"kube-controller-manager"</span> upgrade
<span class="o">[</span>upgrade/staticpods] Renewing controller-manager.conf certificate
<span class="o">[</span>upgrade/staticpods] Moved new manifest to <span class="s2">"/etc/kubernetes/manifests/kube-controller-manager.yaml"</span> and backed up old manifest to <span class="s2">"/etc/kubernetes/tmp/kubeadm-backup-manifests-2022-07-10-23-44-12/kube-controller-manager.yaml"</span>
<span class="o">[</span>upgrade/staticpods] Waiting <span class="k">for </span>the kubelet to restart the component
<span class="o">[</span>upgrade/staticpods] This might take a minute or longer depending on the component/version gap <span class="o">(</span><span class="nb">timeout </span>5m0s<span class="o">)</span>
Static pod: kube-controller-manager-umaster <span class="nb">hash</span>: de64b953177047fd563a18150d6c6070
Static pod: kube-controller-manager-umaster <span class="nb">hash</span>: d69c9bc304051e2fcc0aba1a366e8511
<span class="o">[</span>apiclient] Found 1 Pods <span class="k">for </span>label selector <span class="nv">component</span><span class="o">=</span>kube-controller-manager
<span class="o">[</span>upgrade/staticpods] Component <span class="s2">"kube-controller-manager"</span> upgraded successfully!
<span class="o">[</span>upgrade/staticpods] Preparing <span class="k">for</span> <span class="s2">"kube-scheduler"</span> upgrade
<span class="o">[</span>upgrade/staticpods] Renewing scheduler.conf certificate
<span class="o">[</span>upgrade/staticpods] Moved new manifest to <span class="s2">"/etc/kubernetes/manifests/kube-scheduler.yaml"</span> and backed up old manifest to <span class="s2">"/etc/kubernetes/tmp/kubeadm-backup-manifests-2022-07-10-23-44-12/kube-scheduler.yaml"</span>
<span class="o">[</span>upgrade/staticpods] Waiting <span class="k">for </span>the kubelet to restart the component
<span class="o">[</span>upgrade/staticpods] This might take a minute or longer depending on the component/version gap <span class="o">(</span><span class="nb">timeout </span>5m0s<span class="o">)</span>
Static pod: kube-scheduler-umaster <span class="nb">hash</span>: 78404d25f9e940515e51f92dc60988eb
Static pod: kube-scheduler-umaster <span class="nb">hash</span>: 57952607cc2b5d4a4ac242954121e925
<span class="o">[</span>apiclient] Found 1 Pods <span class="k">for </span>label selector <span class="nv">component</span><span class="o">=</span>kube-scheduler
<span class="o">[</span>upgrade/staticpods] Component <span class="s2">"kube-scheduler"</span> upgraded successfully!
<span class="o">[</span>upgrade/postupgrade] Applying label node-role.kubernetes.io/control-plane<span class="o">=</span><span class="s1">''</span> to Nodes with label node-role.kubernetes.io/master<span class="o">=</span><span class="s1">''</span> <span class="o">(</span>deprecated<span class="o">)</span>
<span class="o">[</span>upgrade/postupgrade] Applying label node.kubernetes.io/exclude-from-external-load-balancers<span class="o">=</span><span class="s1">''</span> to control plane Nodes
<span class="o">[</span>upload-config] Storing the configuration used <span class="k">in </span>ConfigMap <span class="s2">"kubeadm-config"</span> <span class="k">in </span>the <span class="s2">"kube-system"</span> Namespace
<span class="o">[</span>kubelet] Creating a ConfigMap <span class="s2">"kubelet-config-1.21"</span> <span class="k">in </span>namespace kube-system with the configuration <span class="k">for </span>the kubelets <span class="k">in </span>the cluster
<span class="o">[</span>kubelet-start] Writing kubelet configuration to file <span class="s2">"/var/lib/kubelet/config.yaml"</span>
<span class="o">[</span>bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes
<span class="o">[</span>bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class="k">in </span>order <span class="k">for </span>nodes to get long term certificate credentials
<span class="o">[</span>bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
<span class="o">[</span>bootstrap-token] configured RBAC rules to allow certificate rotation <span class="k">for </span>all node client certificates <span class="k">in </span>the cluster
<span class="o">[</span>addons] Applied essential addon: CoreDNS
<span class="o">[</span>addons] Applied essential addon: kube-proxy

<span class="o">[</span>upgrade/successful] SUCCESS! Your cluster was upgraded to <span class="s2">"v1.21.1"</span><span class="nb">.</span> Enjoy!

<span class="o">[</span>upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets <span class="k">if </span>you haven<span class="s1">'t already done so.
</span></code></pre></div></div>

<p>如果不想升级某个组建,可以添加上 –etcd-upgrade=false</p>

<h4 id="取消维护模式">取消维护模式</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@umaster tmp]# kubectl uncordon umaster
node/umaster uncordoned

<span class="o">[</span>root@umaster tmp]# kubectl get nodes
NAME      STATUS   ROLES                  AGE   VERSION
umaster   Ready    control-plane,master   53m   v1.20.1
unode1    Ready    &lt;none&gt;                 52m   v1.20.1
</code></pre></div></div>

<h4 id="升级master上的kubelet和kubectl">升级master上的kubelet和kubectl</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nb">install</span> <span class="nt">-y</span> kubelet-1.21.1-0 kubectl-1.21.1-0 <span class="nt">--disableexcludes</span><span class="o">=</span>kubernetes
</code></pre></div></div>

<h4 id="重启服务">重启服务</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl restart kubelet
</code></pre></div></div>

<h4 id="查看版本">查看版本</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@umaster tmp]# kubectl version <span class="nt">--short</span>
Client Version: v1.21.1
Server Version: v1.21.1
</code></pre></div></div>

<h3 id="升级worker">升级worker</h3>

<h4 id="升级kubeadm-1">升级kubeadm</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nt">-y</span> <span class="nb">install </span>kubeadm-1.21.1-0 <span class="nt">--disableexcludes</span><span class="o">=</span>kubernetes
</code></pre></div></div>

<h4 id="置为维护模式-master操作">置为维护模式-master操作</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@umaster tmp]# kubectl drain unode1 <span class="nt">--ignore-daemonsets</span>
node/unode1 cordoned
WARNING: ignoring DaemonSet-managed Pods: kube-system/calico-node-wvf6l, kube-system/kube-proxy-2c88l
evicting pod kube-system/coredns-7f89b7bc75-vqghq
evicting pod kube-system/calico-kube-controllers-848c5d445f-vxmk6
evicting pod kube-system/coredns-545d6fc579-rp2sv
evicting pod kube-system/coredns-545d6fc579-v647b
pod/coredns-7f89b7bc75-vqghq evicted
pod/coredns-545d6fc579-v647b evicted
pod/coredns-545d6fc579-rp2sv evicted
pod/calico-kube-controllers-848c5d445f-vxmk6 evicted
node/unode1 evicted
</code></pre></div></div>

<p>查看状态</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@umaster tmp]# kubectl get nodes
NAME      STATUS                     ROLES                  AGE   VERSION
umaster   Ready                      control-plane,master   72m   v1.21.1
unode1    Ready,SchedulingDisabled   &lt;none&gt;                 71m   v1.20.1
</code></pre></div></div>

<h4 id="升级">升级</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@unode1 tmp]# kubeadm upgrade node
<span class="o">[</span>upgrade] Reading configuration from the cluster...
<span class="o">[</span>upgrade] FYI: You can look at this config file with <span class="s1">'kubectl -n kube-system get cm kubeadm-config -o yaml'</span>
<span class="o">[</span>preflight] Running pre-flight checks
<span class="o">[</span>preflight] Skipping prepull. Not a control plane node.
<span class="o">[</span>upgrade] Skipping phase. Not a control plane node.
<span class="o">[</span>kubelet-start] Writing kubelet configuration to file <span class="s2">"/var/lib/kubelet/config.yaml"</span>
<span class="o">[</span>upgrade] The configuration <span class="k">for </span>this node was successfully updated!
<span class="o">[</span>upgrade] Now you should go ahead and upgrade the kubelet package using your package manager.
</code></pre></div></div>

<h4 id="更新kubelet-和-kubectl">更新kubelet 和 kubectl</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nb">install</span> <span class="nt">-y</span> kubelet-1.21.1-0 kubectl-1.21.1-0 <span class="nt">--disableexcludes</span><span class="o">=</span>kubernetes
</code></pre></div></div>

<h4 id="取消维护">取消维护</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl uncordon unode1
</code></pre></div></div>

<p>查看</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get nodes
</code></pre></div></div>]]></content><author><name>Your Name</name></author><category term="Kubernetes" /><summary type="html"><![CDATA[升级kubernetes版本]]></summary></entry><entry><title type="html">docker 入门 – 02</title><link href="/docker-02/" rel="alternate" type="text/html" title="docker 入门 – 02" /><published>2022-08-17T00:00:00+08:00</published><updated>2022-08-17T00:00:00+08:00</updated><id>/docker-02</id><content type="html" xml:base="/docker-02/"><![CDATA[<p>自定义镜像 数据卷  仓库</p>

<h4 id="自定义镜像">自定义镜像</h4>

<p>需要写Dockerfile文件 ,如果名字不叫Dockerfile,则需要使用-f来指定文件</p>

<p>常用命令:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM:                          指定基镜像
MAINTAINER:                    维护者信息
RUN:                           在临时容器里执行的操作系统命令
ADD file /path/ :              把物理机里file拷贝到镜像的制定目录 /path
COPY file /path/ :             把物理机里file拷贝到镜像的制定目录 /path
ENV:                           指定变量
USER:                          指定容器内部以哪个用户运行进程
VOLUME:                        指定数据卷
EXPOSE:                        指定镜像容器所使用的端口，只是一个标记
CMD:                           指定镜像创建出来的容器运行在什么进程
</code></pre></div></div>

<h4 id="创建一个可以执行ipconfig的centos镜像">创建一个可以执行ipconfig的centos镜像</h4>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> centos:7</span>
<span class="k">MAINTAINER</span><span class="s"> yaliang.yin@eeoa.com</span>
<span class="k">RUN </span>yun <span class="nt">-y</span> <span class="nb">install </span>net-tools <span class="nt">-y</span>
<span class="k">CMD</span><span class="s"> ["/bin/bash"]</span>
</code></pre></div></div>

<p>构建命令</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> centos:ifconfig <span class="nt">-f</span> Dockerfile
</code></pre></div></div>

<p>使用命令</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> centos:ifconfig <span class="nb">.</span>
</code></pre></div></div>

<p>输出</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sending build context to Docker daemon  2.048kB
Step 1/4 : FROM centos:7
7: Pulling from library/centos
2d473b07cdd5: Pull <span class="nb">complete 
</span>Digest: sha256:c73f515d06b0fa07bb18d8202035e739a494ce760aa73129f60f4bf2bd22b407
Status: Downloaded newer image <span class="k">for </span>centos:7
 <span class="nt">---</span><span class="o">&gt;</span> eeb6ee3f44bd
Step 2/4 : MAINTAINER yaliang.yin@eeoa.com
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>e818620bd59b
Removing intermediate container e818620bd59b
 <span class="nt">---</span><span class="o">&gt;</span> 3bb5dd251ef3
Step 3/4 : RUN yum <span class="nb">install </span>net-tools <span class="nt">-y</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>ec51a9326dd6
Loaded plugins: fastestmirror, ovl
Determining fastest mirrors
 <span class="k">*</span> base: mirrors.bfsu.edu.cn
 <span class="k">*</span> extras: mirrors.bfsu.edu.cn
 <span class="k">*</span> updates: mirrors.bfsu.edu.cn
Resolving Dependencies
<span class="nt">--</span><span class="o">&gt;</span> Running transaction check
<span class="nt">---</span><span class="o">&gt;</span> Package net-tools.x86_64 0:2.0-0.25.20131004git.el7 will be installed
<span class="nt">--</span><span class="o">&gt;</span> Finished Dependency Resolution

Dependencies Resolved

<span class="o">================================================================================</span>
 Package         Arch         Version                          Repository  Size
<span class="o">================================================================================</span>
Installing:
 net-tools       x86_64       2.0-0.25.20131004git.el7         base       306 k

Transaction Summary
<span class="o">================================================================================</span>
Install  1 Package

Total download size: 306 k
Installed size: 917 k
Downloading packages:
warning: /var/cache/yum/x86_64/7/base/packages/net-tools-2.0-0.25.20131004git.el7.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID f4a80eb5: NOKEY
Public key <span class="k">for </span>net-tools-2.0-0.25.20131004git.el7.x86_64.rpm is not installed
Retrieving key from file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
Importing GPG key 0xF4A80EB5:
 Userid     : <span class="s2">"CentOS-7 Key (CentOS 7 Official Signing Key) &lt;security@centos.org&gt;"</span>
 Fingerprint: 6341 ab27 53d7 8a78 a7c2 7bb1 24c6 a8a7 f4a8 0eb5
 Package    : centos-release-7-9.2009.0.el7.centos.x86_64 <span class="o">(</span>@CentOS<span class="o">)</span>
 From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
Running transaction check
Running transaction <span class="nb">test
</span>Transaction <span class="nb">test </span>succeeded
Running transaction
  Installing : net-tools-2.0-0.25.20131004git.el7.x86_64                    1/1 
  Verifying  : net-tools-2.0-0.25.20131004git.el7.x86_64                    1/1 

Installed:
  net-tools.x86_64 0:2.0-0.25.20131004git.el7                                   

Complete!
Removing intermediate container ec51a9326dd6
 <span class="nt">---</span><span class="o">&gt;</span> 323418cab375
Step 4/4 : CMD <span class="o">[</span><span class="s2">"/bin/bash"</span><span class="o">]</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>5bd2a3ebeaef
Removing intermediate container 5bd2a3ebeaef
 <span class="nt">---</span><span class="o">&gt;</span> 9d02a810de55
Successfully built 9d02a810de55
Successfully tagged centos:ifconfig
</code></pre></div></div>

<p>验证</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@docker:/tmp/docker# docker run <span class="nt">--rm</span> <span class="nt">-it</span> centos:ifconfig
<span class="o">[</span>root@62d870933f79 /]# ifconfig
eth0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.0.2  netmask 255.255.255.0  broadcast 192.168.0.255
        ether 02:42:c0:a8:00:02  txqueuelen 0  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 9  bytes 979 <span class="o">(</span>979.0 B<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 <span class="o">(</span>0.0 B<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: <span class="nv">flags</span><span class="o">=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        loop  txqueuelen 1000  <span class="o">(</span>Local Loopback<span class="o">)</span>
        RX packets 0  bytes 0 <span class="o">(</span>0.0 B<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 <span class="o">(</span>0.0 B<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code></pre></div></div>

<h4 id="自定义nginx镜像">自定义nginx镜像</h4>

<p>拷贝repo文件</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> centos:7</span>
<span class="k">MAINTAINER</span><span class="s"> yaliang.yin@eeoa.com</span>
<span class="k">RUN </span>yum <span class="nt">-y</span> <span class="nb">install </span>epel-release
<span class="k">RUN </span>yum <span class="nt">-y</span> update
<span class="k">RUN </span>yum <span class="nt">-y</span> <span class="nb">install </span>nginx
<span class="k">ADD</span><span class="s"> index.html /usr/share/nginx/html</span>
<span class="k">EXPOSE</span><span class="s"> 80</span>
<span class="k">CMD</span><span class="s"> ["nginx","-g","daemon off;"]</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>index.html
nginx
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> centos:nginx <span class="nb">.</span>
</code></pre></div></div>

<p>运行</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="nt">--name</span><span class="o">=</span>nginx <span class="nt">--restart</span><span class="o">=</span>always <span class="nt">-p80</span>:80 centos:nginx
</code></pre></div></div>

<p>访问测试</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@docker ~]# curl 192.168.122.100
nginx
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@docker ~]# docker <span class="nb">rm</span> <span class="nt">-f</span> d3
d3
</code></pre></div></div>

<h4 id="add和copy的区别">ADD和COPY的区别</h4>

<p>ADD 会解压</p>

<p>COPY 不解压</p>

<h4 id="user命令的使用">USER命令的使用</h4>

<p>docker file</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> centos:7</span>
<span class="k">MAINTAINER</span><span class="s"> yaliang.yin@eeoa.com</span>
<span class="k">RUN </span>useradd zabbix
<span class="k">USER</span><span class="s"> zabbix</span>
<span class="k">CMD</span><span class="s"> ["bin/bash"]</span>
</code></pre></div></div>

<p>验证</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@docker ~]# docker run <span class="nt">--restart</span><span class="o">=</span>always <span class="nt">--name</span><span class="o">=</span>user <span class="nt">-it</span> centos:user
<span class="o">[</span>zabbix@d783a47f5cad /]<span class="nv">$ </span><span class="nb">whoami
</span>zabbix
</code></pre></div></div>

<p>指定用户运行</p>

<p>–user</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@docker ~]# docker <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">--user</span><span class="o">=</span>root user /bin/bash
<span class="o">[</span>root@d783a47f5cad /]# <span class="nb">whoami
</span>root
</code></pre></div></div>

<h4 id="使用env指定变量">使用ENV指定变量</h4>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@docker ~]# cat Dockerfile 
<span class="k">FROM</span><span class="s"> centos:7</span>
<span class="k">MAINTAINER</span><span class="s"> yaliang.yin@eeoa.com</span>
<span class="k">ENV</span><span class="s"> zabbixdir=/tmp</span>
<span class="k">CMD</span><span class="s"> ["bin/bash"]</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> centos:env <span class="nb">.</span>
</code></pre></div></div>

<p>验证</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@docker ~]# docker run <span class="nt">--rm</span> <span class="nt">-it</span> centos:env
<span class="o">[</span>root@c5e757373d8f /]# <span class="nb">echo</span> <span class="nv">$zabbixdir</span>
/tmp
</code></pre></div></div>

<h4 id="数据卷">数据卷</h4>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> centos:7</span>
<span class="k">MAINTAINER</span><span class="s"> yaliang.yin@eeoa.com</span>
<span class="k">VOLUME</span><span class="s"> ["/data1"]</span>
<span class="k">CMD</span><span class="s"> ["bin/bash"]</span>
</code></pre></div></div>

<p>绑定data1到物理机的随机目录</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@docker ~]# docker run <span class="nt">--rm</span> <span class="nt">-it</span> centos:volume
<span class="o">[</span>root@58fa1b19ff20 /]# 

</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@docker ~]# docker inspect 58 | <span class="nb">grep</span> <span class="nt">-A5</span>  Mounts
        <span class="s2">"Mounts"</span>: <span class="o">[</span>
            <span class="o">{</span>
                <span class="s2">"Type"</span>: <span class="s2">"volume"</span>,
                <span class="s2">"Name"</span>: <span class="s2">"113269358f756253dd6cd59063f91f3427438ae6121c981451a476fd50015506"</span>,
                <span class="s2">"Source"</span>: <span class="s2">"/var/lib/docker/volumes/113269358f756253dd6cd59063f91f3427438ae6121c981451a476fd50015506/_data"</span>,
                <span class="s2">"Destination"</span>: <span class="s2">"/data1"</span>,
</code></pre></div></div>

<h2 id="使用registry-搭建私有仓库">使用registry 搭建私有仓库</h2>

<p>不做介绍</p>

<h2 id="使用harbor搭建私有仓库">使用harbor搭建私有仓库</h2>

<p>安装harbor需要docker-compose</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nt">-y</span> <span class="nb">install </span>epel-release
yum <span class="nt">-y</span> update
yum <span class="nt">-y</span> <span class="nb">install </span>docker-compose
</code></pre></div></div>

<p>看下版本</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose -v
</code></pre></div></div>

<p>修改docker的配置</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /etc/docker/daemon.json
<span class="o">{</span>
  <span class="s2">"registry-mirrors"</span>: <span class="o">[</span><span class="s2">"http://192.168.122.100"</span><span class="o">]</span>
<span class="o">}</span>

</code></pre></div></div>

<p>重启docker</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl restart docker
</code></pre></div></div>

<p>下载</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /tmp
wget https://github.com/goharbor/harbor/releases/download/v2.5.3/harbor-offline-installer-v2.5.3.tgz
<span class="nb">tar </span>zxvfp harbor-offline-installer-v2.5.3.tgz
<span class="nb">cd </span>harbor
docker load <span class="nt">-i</span> harbor.v2.5.3.tar.gz
./prepare
<span class="nb">cp </span>harbor.yml.tmpl harbor.yml
</code></pre></div></div>

<p>编辑harbor.yml文件,将hostname修改为本机名称</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 5 hostname: docker
</code></pre></div></div>

<p>注释以下几行</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 15 #  port: 443
 16   # The path of cert and key files for nginx
 17 #  certificate: /your/certificate/path
 18 #  private_key: /your/private/key/path
</code></pre></div></div>

<p>修改默认密码,默认为Harbor12345</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>34 harbor_admin_password: docker
</code></pre></div></div>

<p>安装</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./install.sh 
</code></pre></div></div>

<p>访问</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.122.100
</code></pre></div></div>

<p>修改 /etc/docker/daemon.json,增加</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"insecure-registries"</span>:[<span class="s2">"192.168.122.100"</span><span class="o">]</span>
</code></pre></div></div>

<p>重启docker</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart docker
</code></pre></div></div>

<p>登录仓库</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@docker harbor]# docker login 192.168.122.100
Username: yinyaliang
Password: 
WARNING! Your password will be stored unencrypted <span class="k">in</span> /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
<span class="o">[</span>root@docker harbo
</code></pre></div></div>

<p>推送镜像</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker tag centos:volume 192.168.122.100/cka/centos:volume
docker push 192.168.122.100/cka/centos:volume
</code></pre></div></div>]]></content><author><name>Your Name</name></author><category term="Docker" /><summary type="html"><![CDATA[自定义镜像 数据卷 仓库]]></summary></entry><entry><title type="html">使用kubeadm 安装Kubernetes</title><link href="/kubernetes-kubeadm-install/" rel="alternate" type="text/html" title="使用kubeadm 安装Kubernetes" /><published>2022-08-17T00:00:00+08:00</published><updated>2022-08-17T00:00:00+08:00</updated><id>/kubernetes-kubeadm-install</id><content type="html" xml:base="/kubernetes-kubeadm-install/"><![CDATA[<p>介绍使用kubeadm部署集群</p>

<h3 id="使用kubeadm-部署集群">使用kubeadm 部署集群</h3>

<h4 id="master上的组件">master上的组件</h4>

<table>
  <thead>
    <tr>
      <th>名称</th>
      <th>作用</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>kubectl</td>
      <td>命令行工具，用户来创建、删除，都使用此工具</td>
    </tr>
    <tr>
      <td>api-server</td>
      <td>接口,接收用户发送的请求</td>
    </tr>
    <tr>
      <td>scheduler</td>
      <td>调度器,当用户创建pod时,判断这个pod会调度到哪个worker</td>
    </tr>
    <tr>
      <td>controller-manager</td>
      <td>k8s的大管家,包括监测节点的状态,pod的数目</td>
    </tr>
  </tbody>
</table>

<h4 id="worker上的组件">worker上的组件</h4>

<table>
  <thead>
    <tr>
      <th>名称</th>
      <th>作用</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>kubelet</td>
      <td>在包括master上的所有节点上运行,是一个代理,接受master分配的任务,并把节点的信息反馈给master上的api-server</td>
    </tr>
    <tr>
      <td>kube-proxy</td>
      <td>在包括master在内的所有节点上运行,用于把发送给server的请求转发给后端的Pod,有iptables和ipvs两种模式.</td>
    </tr>
    <tr>
      <td>calico网络</td>
      <td>使得节点的pod能够互相通信,集群安装好后,一定要安装它</td>
    </tr>
  </tbody>
</table>

<h4 id="安装集群">安装集群</h4>

<h4 id="建立主机">建立主机</h4>

<table>
  <thead>
    <tr>
      <th>主机名</th>
      <th>IP地址</th>
      <th>内存需求</th>
      <th>操作系统</th>
      <th>角色</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>master</td>
      <td>192.168.122.200</td>
      <td>4GB</td>
      <td>centos 7</td>
      <td>master</td>
    </tr>
    <tr>
      <td>node1</td>
      <td>192.168.122.202</td>
      <td>4GB</td>
      <td>centos 7</td>
      <td>node</td>
    </tr>
    <tr>
      <td>node2</td>
      <td>192.168.122.203</td>
      <td>4GB</td>
      <td>centos 7</td>
      <td>node</td>
    </tr>
  </tbody>
</table>

<h4 id="初始化配置">初始化配置</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>virt-install --name k8smaster --ram 4096 --vcpus=4 --os-type=linux --accelerate --cdrom=/home/kvm/CentOS-7.5-x86_64-Minimal-1804.iso  --disk path=/home/kvm/k8smaster.qcow2,size=30,format=qcow2,bus=ide --bridge=virbr0 --vnc --vncport=60011 --vnclisten=0.0.0.0
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>virt-install --name k8snode1 --ram 4096 --vcpus=2 --os-type=linux --accelerate --cdrom=/home/kvm/CentOS-7.5-x86_64-Minimal-1804.iso  --disk path=/home/kvm/k8snode1.qcow2,size=30,format=qcow2,bus=ide --bridge=virbr0 --vnc --vncport=60012 --vnclisten=0.0.0.0
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>virt-install --name k8snode2 --ram 4096 --vcpus=2 --os-type=linux --accelerate --cdrom=/home/kvm/CentOS-7.5-x86_64-Minimal-1804.iso  --disk path=/home/kvm/k8snode2.qcow2,size=30,format=qcow2,bus=ide --bridge=virbr0 --vnc --vncport=60013 --vnclisten=0.0.0.0
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># master node 关闭防火墙  </span>
systemctl stop firewalld 
systemctl disable firewalld 
 
<span class="c"># master node 关闭selinux   </span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/enforcing/disabled/'</span> /etc/selinux/config  <span class="c"># 永久 </span>
setenforce 0  <span class="c"># 临时 </span>
 
<span class="c"># master node 关闭swap </span>
swapoff <span class="nt">-a</span>  <span class="c"># 临时 </span>
<span class="nb">sed</span> <span class="nt">-ri</span> <span class="s1">'s/.*swap.*/#&amp;/'</span> /etc/fstab    <span class="c"># 永久 </span>
 
<span class="c"># master node 时间同步 </span>
yum <span class="nb">install </span>ntpdate <span class="nt">-y</span> 
ntpdate time.windows.com

<span class="c"># master node 安装vim wget</span>
yum <span class="nt">-y</span> <span class="nb">install </span>vim wget 
 
<span class="c">#添加hosts </span>
<span class="nb">cat</span> <span class="o">&gt;&gt;</span> /etc/hosts <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> 
192.168.122.200 master
192.168.122.202 node1 
192.168.122.203 node2 
</span><span class="no">EOF 
 
</span><span class="c"># 将桥接的IPv4流量传递到iptables的链 </span>
<span class="nb">cat</span> <span class="o">&gt;</span> /etc/sysctl.d/k8s.conf <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> 
net.bridge.bridge-nf-call-ip6tables = 1 
net.bridge.bridge-nf-call-iptables = 1 
</span><span class="no">EOF 

</span>sysctl <span class="nt">--system</span>  <span class="c"># 生效 </span>
 
<span class="c"># master 设置 </span>
hostnamectl set-hostname master
<span class="c"># node1 设置</span>
hostnamectl set-hostname node1
<span class="c"># node2 设置</span>
hostnamectl set-hostname node2

<span class="c"># 安装docker</span>
bash &lt;<span class="o">(</span>wget <span class="nt">-O-</span> get.docker.com<span class="o">)</span>

<span class="c">#启动并设置开机启动</span>
systemctl daemon-reload
systemctl start docker
systemctl <span class="nb">enable </span>docker
systemctl status docker

<span class="c">#修改配置</span>
<span class="nb">cat</span> <span class="o">&gt;</span> /etc/docker/daemon.json <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
{
  "registry-mirrors": ["https://b9pmyelo.mirror.aliyuncs.com"]
}
</span><span class="no">EOF

</span><span class="c">#重启</span>
systemctl restart docker
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mv</span> /etc/yum.repos.d/<span class="k">*</span> /tmp/
wget <span class="nt">-P</span> /etc/yum.repos.d/ ftp://ftp.rhce.cc/k8s/<span class="k">*</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nb">install</span> <span class="nt">-y</span> kubelet-1.21.1-0 kubeadm-1.21.1-0 kubectl-1.21.1-0 <span class="nt">--disableexcludes</span><span class="o">=</span>kubernetes
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart kubelet
systemctl <span class="nb">enable </span>kubelet
</code></pre></div></div>

<p>此时的kubelet状态</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Active: activating
</code></pre></div></div>

<h4 id="安装master">安装master</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubeadm config images list
I0710 19:43:05.808790   15767 version.go:254] remote version is much newer: v1.24.2<span class="p">;</span> falling back to: stable-1.21
k8s.gcr.io/kube-apiserver:v1.21.14
k8s.gcr.io/kube-controller-manager:v1.21.14
k8s.gcr.io/kube-scheduler:v1.21.14
k8s.gcr.io/kube-proxy:v1.21.14
k8s.gcr.io/pause:3.4.1
k8s.gcr.io/etcd:3.4.13-0
k8s.gcr.io/coredns/coredns:v1.8.0
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull coredns/coredns:1.8.0
docker tag coredns/coredns:1.8.0 registry.aliyuncs.com/google_containers/coredns/coredns:v1.8.0
docker rmi coredns/coredns:1.8.0
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubeadm init <span class="nt">--image-repository</span><span class="o">=</span>registry.aliyuncs.com/google_containers <span class="nt">--kubernetes-version</span><span class="o">=</span>v1.21.1 <span class="nt">--pod-network-cidr</span><span class="o">=</span>10.244.0.0/16
</code></pre></div></div>

<p>–image-repository 使用阿里云镜像</p>

<p>–pod-network-cidr 制定pod网段</p>

<p>复制kubeconfig文件</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$HOME</span>/.kube
<span class="nb">sudo cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
<span class="nb">sudo chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> <span class="nv">$HOME</span>/.kube/config
</code></pre></div></div>

<p>把worker加入集群的命令</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubeadm <span class="nb">join </span>192.168.122.200:6443 <span class="nt">--token</span> jtukiq.4perijhdbyzrtgiz <span class="se">\</span>
        <span class="nt">--discovery-token-ca-cert-hash</span> sha256:82d9f6ab3f416feeb452f37fae396439a65173b51ed0dc23c2680ed4ad5f9cc6 
</code></pre></div></div>

<p>忘记这个命令可以使用</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubeadm token create <span class="nt">--print-join-command</span>
</code></pre></div></div>

<h3 id="添加及删除worker">添加及删除worker</h3>

<p>在node1和node2上分别执行</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubeadm <span class="nb">join </span>192.168.122.200:6443 <span class="nt">--token</span> jtukiq.4perijhdbyzrtgiz <span class="se">\</span>
        <span class="nt">--discovery-token-ca-cert-hash</span> sha256:82d9f6ab3f416feeb452f37fae396439a65173b51ed0dc23c2680ed4ad5f9cc6 
</code></pre></div></div>

<p>返回数据</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@node1 ~]# kubeadm <span class="nb">join </span>192.168.122.200:6443 <span class="nt">--token</span> jtukiq.4perijhdbyzrtgiz <span class="se">\</span>
<span class="o">&gt;</span>         <span class="nt">--discovery-token-ca-cert-hash</span> sha256:82d9f6ab3f416feeb452f37fae396439a65173b51ed0dc23c2680ed4ad5f9cc6
<span class="o">[</span>preflight] Running pre-flight checks
        <span class="o">[</span>WARNING IsDockerSystemdCheck]: detected <span class="s2">"cgroupfs"</span> as the Docker cgroup driver. The recommended driver is <span class="s2">"systemd"</span><span class="nb">.</span> Please follow the guide at https://kubernetes.io/docs/setup/cri/
<span class="o">[</span>preflight] Reading configuration from the cluster...
<span class="o">[</span>preflight] FYI: You can look at this config file with <span class="s1">'kubectl -n kube-system get cm kubeadm-config -o yaml'</span>
<span class="o">[</span>kubelet-start] Writing kubelet configuration to file <span class="s2">"/var/lib/kubelet/config.yaml"</span>
<span class="o">[</span>kubelet-start] Writing kubelet environment file with flags to file <span class="s2">"/var/lib/kubelet/kubeadm-flags.env"</span>
<span class="o">[</span>kubelet-start] Starting the kubelet
<span class="o">[</span>kubelet-start] Waiting <span class="k">for </span>the kubelet to perform the TLS Bootstrap...

This node has joined the cluster:
<span class="k">*</span> Certificate signing request was sent to apiserver and a response was received.
<span class="k">*</span> The Kubelet was informed of the new secure connection details.

Run <span class="s1">'kubectl get nodes'</span> on the control-plane to see this node <span class="nb">join </span>the cluster.

</code></pre></div></div>

<p>在master上查看node节点</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl get nodes
NAME     STATUS     ROLES                  AGE     VERSION
master   NotReady   control-plane,master   6m59s   v1.21.1
node1    NotReady   &lt;none&gt;                 14s     v1.21.1
node2    NotReady   &lt;none&gt;                 11s     v1.21.1
</code></pre></div></div>

<h4 id="安装calico">安装calico</h4>

<p>master上执行</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /tmp
wget https://docs.projectcalico.org/v3.19/manifests/calico.yaml <span class="nt">--no-check-certificate</span>
</code></pre></div></div>

<p>修改</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CALICO_IPV4POOL_CIDR</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">192.168.0.0/16"</span>
</code></pre></div></div>

<p>为</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CALICO_IPV4POOL_CIDR</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10.244.0.0/16"</span>
</code></pre></div></div>

<p>修改</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">policy/v1beat1</span>
</code></pre></div></div>

<p>为</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">policy/v1</span>
</code></pre></div></div>

<p>下载镜像</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@master tmp]# grep image calico.yaml 
          image: docker.io/calico/cni:v3.19.4
          image: docker.io/calico/cni:v3.19.4
          image: docker.io/calico/pod2daemon-flexvol:v3.19.4
          image: docker.io/calico/node:v3.19.4
          image: docker.io/calico/kube-controllers:v3.19.4
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for </span>i <span class="k">in </span>calico/cni:v3.19.4 calico/pod2daemon-flexvol:v3.19.4  calico/node:v3.19.4 calico/kube-controllers:v3.19.4 <span class="p">;</span><span class="k">do </span>docker pull <span class="nv">$i</span><span class="p">;</span><span class="k">done</span>
</code></pre></div></div>

<p>安装calico</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> calico.yaml
</code></pre></div></div>

<p>查看节点</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master tmp]# kubectl get nodes
NAME     STATUS   ROLES                  AGE   VERSION
master   Ready    control-plane,master   17m   v1.21.1
node1    Ready    &lt;none&gt;                 10m   v1.21.1
node2    Ready    &lt;none&gt;                 10m   v1.21.1
</code></pre></div></div>

<h4 id="设置tab补全">设置tab补全</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /etc/profile
<span class="nb">source</span> &lt;<span class="o">(</span>kubectl completion bash<span class="o">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>source /etc/profile
</code></pre></div></div>

<h4 id="删除节点">删除节点</h4>

<p>设置维护模式</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl drain node1 <span class="nt">--delete-local-data</span> <span class="nt">--force</span> <span class="nt">--ignore-daemonsets</span>
</code></pre></div></div>

<p>删除节点</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl delete node node1
node <span class="s2">"node1"</span> deleted
</code></pre></div></div>

<p>再次加入节点</p>

<p>在node1上执行</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@node1 ~]# kubeadm reset
<span class="o">[</span>reset] WARNING: Changes made to this host by <span class="s1">'kubeadm init'</span> or <span class="s1">'kubeadm join'</span> will be reverted.
<span class="o">[</span>reset] Are you sure you want to proceed? <span class="o">[</span>y/N]: y
<span class="o">[</span>preflight] Running pre-flight checks
W0710 20:41:03.391549    4728 removeetcdmember.go:79] <span class="o">[</span>reset] No kubeadm config, using etcd pod spec to get data directory
<span class="o">[</span>reset] No etcd config found. Assuming external etcd
<span class="o">[</span>reset] Please, manually reset etcd to prevent further issues
<span class="o">[</span>reset] Stopping the kubelet service
<span class="o">[</span>reset] Unmounting mounted directories <span class="k">in</span> <span class="s2">"/var/lib/kubelet"</span>
<span class="o">[</span>reset] Deleting contents of config directories: <span class="o">[</span>/etc/kubernetes/manifests /etc/kubernetes/pki]
<span class="o">[</span>reset] Deleting files: <span class="o">[</span>/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf]
<span class="o">[</span>reset] Deleting contents of stateful directories: <span class="o">[</span>/var/lib/kubelet /var/lib/dockershim /var/run/kubernetes /var/lib/cni]

The reset process does not clean CNI configuration. To <span class="k">do </span>so, you must remove /etc/cni/net.d

The reset process does not reset or clean up iptables rules or IPVS tables.
If you wish to reset iptables, you must <span class="k">do </span>so manually by using the <span class="s2">"iptables"</span> command.

If your cluster was setup to utilize IPVS, run ipvsadm <span class="nt">--clear</span> <span class="o">(</span>or similar<span class="o">)</span>
to reset your system<span class="s1">'s IPVS tables.

The reset process does not clean your kubeconfig files and you must remove them manually.
Please, check the contents of the $HOME/.kube/config file.
</span></code></pre></div></div>

<p>重新加入集群</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@node1 ~]# kubeadm <span class="nb">join </span>192.168.122.200:6443 <span class="nt">--token</span> jtukiq.4perijhdbyzrtgiz <span class="se">\</span>
<span class="o">&gt;</span>         <span class="nt">--discovery-token-ca-cert-hash</span> sha256:82d9f6ab3f416feeb452f37fae396439a65173b51ed0dc23c2680ed4ad5f9cc6
</code></pre></div></div>

<p>出错处理</p>

<p>手动删除 /etc/kubernetes/pki/和/var/lib/kubelet/两个目录</p>

<h4 id="常用命令">常用命令</h4>

<p>查看集群信息</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl cluster-info
Kubernetes control plane is running at https://192.168.122.200:6443
CoreDNS is running at https://192.168.122.200:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use <span class="s1">'kubectl cluster-info dump'</span><span class="nb">.</span>
</code></pre></div></div>

<p>查看版本</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl version
Client Version: version.Info<span class="o">{</span>Major:<span class="s2">"1"</span>, Minor:<span class="s2">"21"</span>, GitVersion:<span class="s2">"v1.21.1"</span>, GitCommit:<span class="s2">"5e58841cce77d4bc13713ad2b91fa0d961e69192"</span>, GitTreeState:<span class="s2">"clean"</span>, BuildDate:<span class="s2">"2021-05-12T14:18:45Z"</span>, GoVersion:<span class="s2">"go1.16.4"</span>, Compiler:<span class="s2">"gc"</span>, Platform:<span class="s2">"linux/amd64"</span><span class="o">}</span>
Server Version: version.Info<span class="o">{</span>Major:<span class="s2">"1"</span>, Minor:<span class="s2">"21"</span>, GitVersion:<span class="s2">"v1.21.1"</span>, GitCommit:<span class="s2">"5e58841cce77d4bc13713ad2b91fa0d961e69192"</span>, GitTreeState:<span class="s2">"clean"</span>, BuildDate:<span class="s2">"2021-05-12T14:12:29Z"</span>, GoVersion:<span class="s2">"go1.16.4"</span>, Compiler:<span class="s2">"gc"</span>, Platform:<span class="s2">"linux/amd64"</span><span class="o">}</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl version <span class="nt">--short</span>
Client Version: v1.21.1
Server Version: v1.21.1
</code></pre></div></div>

<p>查看支持的api-version</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl api-versions
admissionregistration.k8s.io/v1
admissionregistration.k8s.io/v1beta1
apiextensions.k8s.io/v1
apiextensions.k8s.io/v1beta1
apiregistration.k8s.io/v1
apiregistration.k8s.io/v1beta1
apps/v1
authentication.k8s.io/v1
authentication.k8s.io/v1beta1
authorization.k8s.io/v1
authorization.k8s.io/v1beta1
autoscaling/v1
autoscaling/v2beta1
autoscaling/v2beta2
batch/v1
batch/v1beta1
certificates.k8s.io/v1
certificates.k8s.io/v1beta1
coordination.k8s.io/v1
coordination.k8s.io/v1beta1
crd.projectcalico.org/v1
discovery.k8s.io/v1
discovery.k8s.io/v1beta1
events.k8s.io/v1
events.k8s.io/v1beta1
extensions/v1beta1
flowcontrol.apiserver.k8s.io/v1beta1
networking.k8s.io/v1
networking.k8s.io/v1beta1
node.k8s.io/v1
node.k8s.io/v1beta1
policy/v1
policy/v1beta1
rbac.authorization.k8s.io/v1
rbac.authorization.k8s.io/v1beta1
scheduling.k8s.io/v1
scheduling.k8s.io/v1beta1
storage.k8s.io/v1
storage.k8s.io/v1beta1
v1
</code></pre></div></div>

<h3 id="查看pod及节点的负载">查看pod及节点的负载</h3>

<p>如果需要查看kubernetes集群每个节点及每个pod的CPU负载、内存负载、需要安装metric-serer</p>

<p>所有节点安装</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull mirrorgooglecontainers/metrics-server-amd64:v0.3.6
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker tag mirrorgooglecontainers/metrics-server-amd64:v0.3.6 k8s.gcr.io/metrics-server-amd64:v0.3.6
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker rmi mirrorgooglecontainers/metrics-server-amd64:v0.3.6
</code></pre></div></div>

<p>master</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /tmp
curl -Ls https://api.github.com/repos/kubernetes-sigs/metrics-server/tarball/v0.3.6 -o metrics-server-v0.3.6.tar.gz
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tar </span>zxvfp metrics-server-v0.3.6.tar.gz
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>kubernetes-sigs-metrics-server-d1f4f6f/deploy/1.8+/
</code></pre></div></div>

<p>修改</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@node2 1.8+]# <span class="nb">cat </span>metrics-server-deployment.yaml 
<span class="nt">---</span>
apiVersion: v1
kind: ServiceAccount
metadata:
  name: metrics-server
  namespace: kube-system
<span class="nt">---</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: metrics-server
  namespace: kube-system
  labels:
    k8s-app: metrics-server
spec:
  selector:
    matchLabels:
      k8s-app: metrics-server
  template:
    metadata:
      name: metrics-server
      labels:
        k8s-app: metrics-server
    spec:
      serviceAccountName: metrics-server
      volumes:
      <span class="c"># mount in tmp so we can safely use from-scratch images and/or read-only containers</span>
      - name: tmp-dir
        emptyDir: <span class="o">{}</span>
      containers:
      - name: metrics-server
        image: k8s.gcr.io/metrics-server-amd64:v0.3.6
        imagePullPolicy: IfNotPresent
        <span class="nb">command</span>:
        - /metrics-server
        - <span class="nt">--metric-resolution</span><span class="o">=</span>30s
        - <span class="nt">--kubelet-insecure-tls</span>
        - <span class="nt">--kubelet-preferred-address-types</span><span class="o">=</span>InternalIP
        volumeMounts:
</code></pre></div></div>

<p>运行当前目录</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master 1.8+]# kubectl apply <span class="nt">-f</span> <span class="nb">.</span>
clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created
Warning: rbac.authorization.k8s.io/v1beta1 ClusterRoleBinding is deprecated <span class="k">in </span>v1.17+, unavailable <span class="k">in </span>v1.22+<span class="p">;</span> use rbac.authorization.k8s.io/v1 ClusterRoleBinding
clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created
Warning: rbac.authorization.k8s.io/v1beta1 RoleBinding is deprecated <span class="k">in </span>v1.17+, unavailable <span class="k">in </span>v1.22+<span class="p">;</span> use rbac.authorization.k8s.io/v1 RoleBinding
rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created
Warning: apiregistration.k8s.io/v1beta1 APIService is deprecated <span class="k">in </span>v1.19+, unavailable <span class="k">in </span>v1.22+<span class="p">;</span> use apiregistration.k8s.io/v1 APIService
apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created
serviceaccount/metrics-server created
deployment.apps/metrics-server created
service/metrics-server created
clusterrole.rbac.authorization.k8s.io/system:metrics-server created
clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created
</code></pre></div></div>

<p>查看pod的状态</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master 1.8+]# kubectl get pods <span class="nt">-n</span> kube-system | <span class="nb">grep </span>metric
metrics-server-6b7f4dfdcb-xfpl4            1/1     Running   0          59s
</code></pre></div></div>

<p>查看节点负载</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master 1.8+]# kubectl top nodes <span class="nt">--use-protocol-buffers</span>
NAME     CPU<span class="o">(</span>cores<span class="o">)</span>   CPU%   MEMORY<span class="o">(</span>bytes<span class="o">)</span>   MEMORY%   
master   245m         6%     1270Mi          32%       
node1    88m          4%     579Mi           15%       
node2    106m         5%     638Mi           16%    
</code></pre></div></div>

<p>查看metrics-server的IP地址</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master 1.8+]# kubectl get pods <span class="nt">-n</span> kube-system <span class="nt">-o</span> wide 
NAME                                       READY   STATUS    RESTARTS   AGE    IP                NODE     NOMINATED NODE   READINESS GATES
calico-kube-controllers-7cc8dd57d9-mwx5q   1/1     Running   1          92m    10.244.104.2      node2    &lt;none&gt;           &lt;none&gt;
calico-node-54njj                          1/1     Running   1          92m    192.168.122.203   node2    &lt;none&gt;           &lt;none&gt;
calico-node-559jn                          1/1     Running   1          92m    192.168.122.200   master   &lt;none&gt;           &lt;none&gt;
calico-node-w6rwp                          1/1     Running   0          76m    192.168.122.202   node1    &lt;none&gt;           &lt;none&gt;
coredns-545d6fc579-j9f7q                   1/1     Running   1          109m   10.244.219.65     master   &lt;none&gt;           &lt;none&gt;
coredns-545d6fc579-t7st8                   1/1     Running   1          109m   10.244.219.66     master   &lt;none&gt;           &lt;none&gt;
etcd-master                                1/1     Running   1          109m   192.168.122.200   master   &lt;none&gt;           &lt;none&gt;
kube-apiserver-master                      1/1     Running   1          109m   192.168.122.200   master   &lt;none&gt;           &lt;none&gt;
kube-controller-manager-master             1/1     Running   1          109m   192.168.122.200   master   &lt;none&gt;           &lt;none&gt;
kube-proxy-j28gq                           1/1     Running   1          109m   192.168.122.200   master   &lt;none&gt;           &lt;none&gt;
kube-proxy-jgsxd                           1/1     Running   1          102m   192.168.122.203   node2    &lt;none&gt;           &lt;none&gt;
kube-proxy-qrf8c                           1/1     Running   0          76m    192.168.122.202   node1    &lt;none&gt;           &lt;none&gt;
kube-scheduler-master                      1/1     Running   1          109m   192.168.122.200   master   &lt;none&gt;           &lt;none&gt;
metrics-server-6b7f4dfdcb-xfpl4            1/1     Running   0          3m     10.244.166.129    node1    &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<h3 id="了解及管理命名空间">了解及管理命名空间</h3>

<h4 id="管理命令空间">管理命令空间</h4>

<p>查看</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master 1.8+]# kubectl get ns
NAME              STATUS   AGE
default           Active   112m
kube-node-lease   Active   112m
kube-public       Active   112m
kube-system       Active   112m
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">default</code> 没有指明使用其它名字空间的对象所使用的默认名字空间</li>
  <li><code class="language-plaintext highlighter-rouge">kube-system</code> Kubernetes 系统创建对象所使用的名字空间</li>
  <li><code class="language-plaintext highlighter-rouge">kube-public</code> 这个名字空间是自动创建的，所有用户（包括未经过身份验证的用户）都可以读取它。 这个名字空间主要用于集群使用，以防某些资源在整个集群中应该是可见和可读的。 这个名字空间的公共方面只是一种约定，而不是要求。</li>
  <li><code class="language-plaintext highlighter-rouge">kube-node-lease</code> 此名字空间用于与各个节点相关的 <a href="https://kubernetes.io/docs/reference/kubernetes-api/cluster-resources/lease-v1/">租约（Lease）</a>对象。 节点租期允许 kubelet 发送<a href="https://kubernetes.io/zh-cn/docs/concepts/architecture/nodes/#heartbeats">心跳</a>，由此控制面能够检测到节点故障</li>
</ul>

<p>创建一个命名空间</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master tmp]# kubectl create ns ns1
namespace/ns1 created
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master tmp]# kubectl get ns
NAME              STATUS   AGE
default           Active   114m
kube-node-lease   Active   114m
kube-public       Active   114m
kube-system       Active   114m
ns1               Active   17s
</code></pre></div></div>

<p>删除命名空间</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master tmp]# kubectl delete ns ns1
namespace <span class="s2">"ns1"</span> deleted
</code></pre></div></div>]]></content><author><name>Your Name</name></author><category term="Kubernetes" /><summary type="html"><![CDATA[介绍使用kubeadm部署集群]]></summary></entry><entry><title type="html">ubuntu install zabbix agent2</title><link href="/ubuntu-install-zabbix-agent2/" rel="alternate" type="text/html" title="ubuntu install zabbix agent2" /><published>2022-08-17T00:00:00+08:00</published><updated>2022-08-17T00:00:00+08:00</updated><id>/ubuntu-install-zabbix-agent2</id><content type="html" xml:base="/ubuntu-install-zabbix-agent2/"><![CDATA[<p>ubuntu install zabbix agent2</p>

<h4 id="安装依赖">安装依赖</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    apt <span class="nb">install </span>gcc
    apt <span class="nb">install </span>libpcre3 libpcre3-dev
    apt-get <span class="nb">install </span>zlib1g-dev
    apt <span class="nb">install </span>make
</code></pre></div></div>

<h4 id="golang-安装">golang 安装</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://go.dev/doc/install
</code></pre></div></div>

<h4 id="创建组和用户">创建组和用户</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    groupadd <span class="nt">-g</span> 2210 zabbix
    useradd <span class="nt">-u</span> 2210 zabbix <span class="nt">-g</span> zabbix
</code></pre></div></div>

<h4 id="创建目录及赋权">创建目录及赋权</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> /data/scripts/oss/zabbix <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-p</span> /data/scripts/oss/zabbix
    <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> /data/logs/oss/zabbix <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-p</span> /data/logs/oss/zabbix
    <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> /data/config/oss/zabbix <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-p</span> /data/config/oss/zabbix
    <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> /data/run/oss/zabbix <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-p</span> /data/run/oss/zabbix
    
    <span class="nb">chown </span>zabbix:zabbix /data/config/oss/zabbix/<span class="k">*</span> <span class="nt">-Rf</span>
    <span class="nb">chown </span>zabbix:zabbix /data/logs/oss/zabbix/<span class="k">*</span> <span class="nt">-Rf</span>
    <span class="nb">chown </span>zabbix:zabbix /data/scripts/oss/zabbix/<span class="k">*</span> <span class="nt">-Rf</span>
    <span class="nb">chown </span>zabbix:zabbix /data/run/oss/zabbix/<span class="k">*</span> <span class="nt">-Rf</span>
    
    <span class="nb">chown </span>zabbix: <span class="nt">-R</span> /data/logs/oss/zabbix/
    <span class="nb">chown </span>zabbix: <span class="nt">-R</span> /data/run/oss/zabbix

</code></pre></div></div>

<h4 id="下载源文件">下载源文件</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nb">cd</span> /tmp
    wget https://cdn.zabbix.com/zabbix/sources/stable/6.0/zabbix-6.0.0.tar.gz
    <span class="nb">tar </span>zxvf zabbix-6.0.0.tar.gz
    <span class="nb">cd </span>zabbix-6.0.0/

</code></pre></div></div>

<h4 id="编译安装">编译安装</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="c"># 5.4版本</span>
  <span class="c">#  ./configure --prefix=/usr/local/zabbix-6.0.0 --enable-agent --enable-agent2 --disable-dependency-tracking</span>
   ./configure <span class="nt">--prefix</span><span class="o">=</span>/usr/local/zabbix-6.0.0 <span class="nt">--enable-agent</span> <span class="nt">--enable-agent2</span> 
    make <span class="o">&amp;&amp;</span> make <span class="nb">install</span> 
</code></pre></div></div>

<h4 id="目录软件">目录软件</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nb">ln</span> <span class="nt">-s</span> /usr/local/zabbix-6.0.0 /usr/local/zabbix
    <span class="nb">ln</span> <span class="nt">-s</span> /data/scripts/oss/zabbix /usr/local/zabbix/scripts
    <span class="nb">ln</span> <span class="nt">-s</span> /usr/local/zabbix/sbin/zabbix_agentd /usr/local/bin/zabbix_agentd
    <span class="nb">ln</span> <span class="nt">-s</span> /usr/local/zabbix/sbin/zabbix_agent2 /usr/local/bin/zabbix_agent2
    
    <span class="nb">cd</span> /usr/local/zabbix
    <span class="nb">mv </span>etc/<span class="k">*</span> /data/config/oss/zabbix/
    <span class="nb">ln</span> <span class="nt">-s</span> /data/config/oss/zabbix/ etc

</code></pre></div></div>

<h4 id="zabbix-配置文件">Zabbix 配置文件</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    配置启动文件:/data/config/oss/zabbix/zabbix_agentd.conf
    	<span class="nv">PidFile</span><span class="o">=</span>/data/run/oss/zabbix/zabbix_agentd.pid
    	<span class="nv">LogFile</span><span class="o">=</span>/data/logs/oss/zabbix/zabbix_agentd.log
    	<span class="nv">AllowKey</span><span class="o">=</span>system.run[<span class="k">*</span><span class="o">]</span>
    	<span class="nv">ListenPort</span><span class="o">=</span>31350
    	<span class="nv">Hostname</span><span class="o">=</span>glb-ubuntu
    	<span class="nv">BufferSize</span><span class="o">=</span>1000
    	<span class="nv">Timeout</span><span class="o">=</span>3
    	<span class="nv">Include</span><span class="o">=</span>/data/config/oss/zabbix/zabbix_agentd.conf.d/<span class="k">*</span>.conf
    	<span class="nv">ListenIP</span><span class="o">=</span>10.0.9.150
    	<span class="nv">ServerActive</span><span class="o">=</span>10.0.2.39:31351
    	<span class="nv">Server</span><span class="o">=</span>10.0.2.39
</code></pre></div></div>

<h4 id="zabbix2-配置文件">Zabbix2 配置文件</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">PidFile</span><span class="o">=</span>/data/run/oss/zabbix/zabbix_agent2.pid
<span class="nv">LogFile</span><span class="o">=</span>/data/logs/oss/zabbix/zabbix_agent2.log
<span class="nv">Server</span><span class="o">=</span>10.0.2.39,10.0.2.40
<span class="nv">ListenPort</span><span class="o">=</span>31350
<span class="nv">ListenIP</span><span class="o">=</span>10.0.2.34
<span class="nv">ServerActive</span><span class="o">=</span>10.0.2.39:31351<span class="p">;</span>10.0.2.40:31351
<span class="nv">Hostname</span><span class="o">=</span>oif-ozw3
<span class="nv">Timeout</span><span class="o">=</span>3
<span class="nv">Include</span><span class="o">=</span>/data/config/oss/zabbix/zabbix_agentd.conf.d/<span class="k">*</span>.conf
<span class="nv">ControlSocket</span><span class="o">=</span>/data/run/oss/zabbix/agent.sock
</code></pre></div></div>

<h4 id="systemd-配置-agentd">SYSTEMD 配置 agentd</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="o">[</span>Unit]
	<span class="nv">Description</span><span class="o">=</span>Zabbix Agent
	<span class="nv">After</span><span class="o">=</span>syslog.target
	<span class="nv">After</span><span class="o">=</span>network.target

	<span class="o">[</span>Service]
	<span class="nv">Type</span><span class="o">=</span>forking
	<span class="nv">User</span><span class="o">=</span>root
	<span class="nv">Group</span><span class="o">=</span>root
	<span class="nv">Environment</span><span class="o">=</span><span class="s2">"CONFFILE=/data/config/oss/zabbix/zabbix_agentd.conf"</span>
	<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/zabbix_agentd <span class="nt">-c</span> <span class="nv">$CONFFILE</span>
	<span class="nv">PIDFile</span><span class="o">=</span>/data/run/oss/zabbix/zabbix_agentd.pid
	<span class="nv">KillSignal</span><span class="o">=</span>SIGQUIT

	<span class="o">[</span>Install]
	<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<h4 id="systemd-配置-agent2">SYSTEMD 配置 agent2</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">[</span>Unit]
    <span class="nv">Description</span><span class="o">=</span>Zabbix Agent
    <span class="nv">After</span><span class="o">=</span>syslog.target
    <span class="nv">After</span><span class="o">=</span>network.target

    <span class="o">[</span>Service]
<span class="c">#    Type=forking   会卡住,取消</span>
    <span class="nv">User</span><span class="o">=</span>root
    <span class="nv">Group</span><span class="o">=</span>root
    <span class="nv">Environment</span><span class="o">=</span><span class="s2">"CONFFILE=/data/config/oss/zabbix/zabbix_agent2.conf"</span>
    <span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/zabbix_agent2 <span class="nt">-c</span> <span class="nv">$CONFFILE</span> 
    <span class="nv">PIDFile</span><span class="o">=</span>/data/run/oss/zabbix/agent.sock
    <span class="nv">KillSignal</span><span class="o">=</span>SIGQUIT

    <span class="o">[</span>Install]
    <span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<h4 id="重载">重载</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    systemctl daemon-reload
</code></pre></div></div>

<h4 id="相关命令">相关命令</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    systemctl start zabbix_agent2.service
    systemctl restart zabbix_agent2.service
    systemctl stop zabbix_agent2.service
</code></pre></div></div>]]></content><author><name>Your Name</name></author><category term="Application" /><summary type="html"><![CDATA[ubuntu install zabbix agent2]]></summary></entry><entry><title type="html">`Centos 更新Glibc `</title><link href="/centos-update-glibc/" rel="alternate" type="text/html" title="`Centos 更新Glibc `" /><published>2022-08-16T00:00:00+08:00</published><updated>2022-08-16T00:00:00+08:00</updated><id>/centos-update-glibc</id><content type="html" xml:base="/centos-update-glibc/"><![CDATA[<p>写CBPF需要更新系统的Glibc</p>

<h4 id="安装centos-release-scl">安装centos-release-scl</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install centos-release-scl
</code></pre></div></div>

<h4 id="安装7版本的devtoolset">安装7版本的devtoolset</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install devtoolset-7-gcc*
</code></pre></div></div>

<h4 id="激活">激活</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scl enable devtoolset-7 bash
</code></pre></div></div>

<h4 id="查看gcc版本">查看gcc版本</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc -v
</code></pre></div></div>

<h4 id="下载安装包">下载安装包</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /tmp
wget https://ftp.gnu.org/gnu/glibc/glibc-2.23.tar.gz
tar xf glibc-2.23.tar.gz
cd glibc-2.23/
mkdir glibc-build
cd glibc-build 
</code></pre></div></div>

<h4 id="安装">安装</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>../configure --prefix=/usr
make
make install
</code></pre></div></div>

<h4 id="验证">验证</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ldd --version
ldd (GNU libc) 2.23

Copyright (C) 2016 Free Software Foundation, Inc.

This is free software; see the source for copying conditions.  There is NO

warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

Written by Roland McGrath and Ulrich Drepper.
</code></pre></div></div>

<h4 id="排错">排错</h4>
<p>1、</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>setenv.c:279:6: error: suggest explicit braces to avoid ambiguous ‘else’ [-Werror=dangling-else]
   if (ep != NULL)
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>增加{}
</code></pre></div></div>

<p>2、</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>../sysdeps/ieee754/dbl-64/e_pow.c:469:13: error: ‘&lt;&lt;’ in boolean context, did you mean ‘&lt;’ ? [-Werror=int-in-bool-context]
       if (n &lt;&lt; (k - 20))
           ~~^~~~~~~~~~~
../sysdeps/ieee754/dbl-64/e_pow.c:471:17: error: ‘&lt;&lt;’ in boolean context, did you mean ‘&lt;’ ? [-Werror=int-in-bool-context]
       return (n &lt;&lt; (k - 21)) ? -1 : 1;
              ~~~^~~~~~~~~~~~
../sysdeps/ieee754/dbl-64/e_pow.c:477:9: error: ‘&lt;&lt;’ in boolean context, did you mean ‘&lt;’ ? [-Werror=int-in-bool-context]
   if (m &lt;&lt; (k + 12))
       ~~^~~~~~~~~~~
../sysdeps/ieee754/dbl-64/e_pow.c:479:13: error: ‘&lt;&lt;’ in boolean context, did you mean ‘&lt;’ ? [-Werror=int-in-bool-context]
   return (m &lt;&lt; (k + 11)) ? -1 : 1;
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> if (n &lt;&lt; (k - 20)!=0)

 (n &lt;&lt; (k - 21)!=0) ? -1 : 1;

 (m &lt;&lt; (k + 12)!=0)

 (m &lt;&lt; (k + 11)!=0) ? -1 : 1;
</code></pre></div></div>

<p>3、</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpc_parse.c: In function ‘get_prog_declaration’:
rpc_parse.c:543:23: error: ‘%d’ directive writing between 1 and 10 bytes into a region of size 7 [-Werror=format-overflow=]
     sprintf (name, "%s%d", ARGNAME, num); /* default name of argument */
                       ^~
rpc_parse.c:543:20: note: directive argument in the range [1, 2147483647]
     sprintf (name, "%s%d", ARGNAME, num); /* default name of argument */
                    ^~~~~~
rpc_parse.c:543:5: note: ‘sprintf’ output between 5 and 14 bytes into a destination of size 10
     sprintf (name, "%s%d", ARGNAME, num); /* default name of argument */
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sprintf (name, "%s%d", ARGNAME, (short)num)
</code></pre></div></div>

<p>4、</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nis_call.c:682:6: error: suggest explicit braces to avoid ambiguous ‘else’ [-Werror=dangling-else]
   if (*loc != NULL)
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (*loc != NULL)
{ 
  for (i = 1; i &lt; 16; ++i)
    if (nis_server_cache[i] == NULL)
  {
    loc = &amp;nis_server_cache[i];
    break;
  }
    else if ((*loc)-&gt;uses &gt; nis_server_cache[i]-&gt;uses
         || ((*loc)-&gt;uses == nis_server_cache[i]-&gt;uses
         &amp;&amp; (*loc)-&gt;expires &gt; nis_server_cache[i]-&gt;expires))
  loc = &amp;nis_server_cache[i];
}
</code></pre></div></div>

<p>5、</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nss_nisplus/nisplus-alias.c:300:12: error: argument 1 null where non-null expected [-Werror=nonnull]
   char buf[strlen (name) + 9 + tablename_len];
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>char buf[tablename_len + 9];
snprintf (buf, sizeof (buf), "[name=],%s", tablename_val);
</code></pre></div></div>

<p>6、</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gawk '/\.gnu\.glibc-stub\./ { \
	  sub(/\.gnu\.glibc-stub\./, "", $2); \
	  stubs[$2] = 1; } \
	END { for (s in stubs) print "#define __stub_" s }' &gt; /tmp/glibc-2.23/glibc-build/math/stubsT
gawk: error while loading shared libraries: /lib64/libm.so.6: invalid ELF header
make[2]: *** [/tmp/glibc-2.23/glibc-build/math/stubs] Error 127
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /lib64
unlink libm.so.6
ln -s libm-2.23.so libm.so.6
</code></pre></div></div>]]></content><author><name>Your Name</name></author><category term="Linux" /><summary type="html"><![CDATA[写CBPF需要更新系统的Glibc]]></summary></entry></feed>