<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="/feed.xml" rel="self" type="application/atom+xml" /><link href="/" rel="alternate" type="text/html" /><updated>2023-03-13T11:17:36+08:00</updated><id>/feed.xml</id><title type="html">尹亚亮</title><subtitle>An amazing website.</subtitle><author><name>Your Name</name></author><entry><title type="html">zabbix 报警显示网络设备的端口描述</title><link href="/monitor-zabbix-network-describe/" rel="alternate" type="text/html" title="zabbix 报警显示网络设备的端口描述" /><published>2023-03-13T00:00:00+08:00</published><updated>2023-03-13T00:00:00+08:00</updated><id>/monitor-zabbix-network-describe</id><content type="html" xml:base="/monitor-zabbix-network-describe/"><![CDATA[<p>zabbix 报警显示网络设备的端口描述</p>

<h3 id="配置自动发现">配置自动发现</h3>

<h4 id="自动发现oid">自动发现OID</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>discovery[{#SNMPVALUE},IF-MIB::ifDescr,{#IFALIAS},IF-MIB::ifAlias]
</code></pre></div></div>
<p>** {#SNMPVALUE} 表示 端口描述 **
** {#IFALIAS}   表示 端口别名 **</p>

<h4 id="获取后的值为">获取后的值为</h4>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="p">[</span><span class="w">

    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"{#SNMPINDEX}"</span><span class="p">:</span><span class="s2">"11"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"{#SNMPVALUE}"</span><span class="p">:</span><span class="s2">"Eth-Trunk47"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"{#IFALIAS}"</span><span class="p">:</span><span class="s2">"to-glb-hvn7-up"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"{#SNMPINDEX}"</span><span class="p">:</span><span class="s2">"12"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"{#SNMPVALUE}"</span><span class="p">:</span><span class="s2">"GigabitEthernet1/0/5"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"{#IFALIAS}"</span><span class="p">:</span><span class="s2">"test02"</span><span class="w">
    </span><span class="p">}</span><span class="w">

</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<h3 id="trigger-name">trigger name</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>端口 {#SNMPVALUE} Down
</code></pre></div></div>

<h3 id="触发器message配置">触发器Message配置</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"端口描述":"{ITEM.LASTVALUE2}",
</code></pre></div></div>

<h3 id="效果">效果</h3>
<p><img src="/assets/images/zabbix/2023-03-13_11-16.png" /></p>]]></content><author><name>Your Name</name></author><category term="Monitor" /><summary type="html"><![CDATA[zabbix 报警显示网络设备的端口描述]]></summary></entry><entry><title type="html">zabbix 实现 histogram_quantile</title><link href="/monitor-zabbix-histogram-quantile/" rel="alternate" type="text/html" title="zabbix 实现 histogram_quantile" /><published>2023-03-09T00:00:00+08:00</published><updated>2023-03-09T00:00:00+08:00</updated><id>/monitor-zabbix-histogram-quantile</id><content type="html" xml:base="/monitor-zabbix-histogram-quantile/"><![CDATA[<p>zabbix 收集TIDB的etcd_disk_wal_fsync_duration_seconds_bucket, 实现prometheus的 histogram_quantile</p>

<h3 id="prometheus的报警规则">prometheus的报警规则</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>histogram_quantile<span class="o">(</span>0.99,sum<span class="o">(</span>rate<span class="o">(</span>etcd_disk_wal_fsync_duration_seconds_bucket[1m]<span class="o">))</span> by <span class="o">(</span>instance,job,le<span class="o">))</span> <span class="o">&gt;</span> 1
</code></pre></div></div>

<h3 id="客户端-metrics">客户端 metrics</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>etcd_disk_wal_fsync_duration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">"0.002"</span><span class="o">}</span> 1.16569197e+08
etcd_disk_wal_fsync_duration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">"0.004"</span><span class="o">}</span> 1.16826659e+08
etcd_disk_wal_fsync_duration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">"0.008"</span><span class="o">}</span> 1.16908279e+08
etcd_disk_wal_fsync_duration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">"0.016"</span><span class="o">}</span> 1.1695191e+08
etcd_disk_wal_fsync_duration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">"0.032"</span><span class="o">}</span> 1.16979685e+08
etcd_disk_wal_fsync_duration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">"0.064"</span><span class="o">}</span> 1.17018263e+08
etcd_disk_wal_fsync_duration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">"0.128"</span><span class="o">}</span> 1.17029029e+08
etcd_disk_wal_fsync_duration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">"0.256"</span><span class="o">}</span> 1.17033774e+08
etcd_disk_wal_fsync_duration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">"0.512"</span><span class="o">}</span> 1.17035754e+08
etcd_disk_wal_fsync_duration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">"1.024"</span><span class="o">}</span> 1.17036426e+08
etcd_disk_wal_fsync_duration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">"2.048"</span><span class="o">}</span> 1.17036682e+08
etcd_disk_wal_fsync_duration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">"4.096"</span><span class="o">}</span> 1.17036699e+08
etcd_disk_wal_fsync_duration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">"8.192"</span><span class="o">}</span> 1.17036699e+08
etcd_disk_wal_fsync_duration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">"+Inf"</span><span class="o">}</span> 1.17036699e+08
</code></pre></div></div>

<h3 id="zabbix-yaml">zabbix yaml</h3>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">zabbix_export</span><span class="pi">:</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">6.2'</span>
  <span class="na">date</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2023-03-09T08:29:57Z'</span>
  <span class="na">template_groups</span><span class="pi">:</span>
    <span class="pi">-</span>
      <span class="na">uuid</span><span class="pi">:</span> <span class="s">748ad4d098d447d492bb935c907f652f</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">Templates/Databases</span>
  <span class="na">templates</span><span class="pi">:</span>
    <span class="pi">-</span>
      <span class="na">uuid</span><span class="pi">:</span> <span class="s">43596328d4d74a5592906a9e08e3fd96</span>
      <span class="na">template</span><span class="pi">:</span> <span class="s">service.TiDB-PD</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">service.TiDB-PD</span>
      <span class="na">groups</span><span class="pi">:</span>
        <span class="pi">-</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Templates/Databases</span>
      <span class="na">items</span><span class="pi">:</span>
        <span class="pi">-</span>
          <span class="na">uuid</span><span class="pi">:</span> <span class="s">a0e6cf6c975042e0b884de64710b56b5</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">[TIDB-PD]</span><span class="nv"> </span><span class="s">etcd</span><span class="nv"> </span><span class="s">write</span><span class="nv"> </span><span class="s">disk</span><span class="nv"> </span><span class="s">latency'</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">CALCULATED</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">etcd.write.disk.latency</span>
          <span class="na">value_type</span><span class="pi">:</span> <span class="s">FLOAT</span>
          <span class="na">params</span><span class="pi">:</span> <span class="s1">'</span><span class="s">histogram_quantile(0.99,bucket_rate_foreach(//etcd.write.disk.latency[*],60s))'</span>
          <span class="na">tags</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">tag</span><span class="pi">:</span> <span class="s">Application</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s">TIDB-PD</span>
        <span class="pi">-</span>
          <span class="na">uuid</span><span class="pi">:</span> <span class="s">3a1fd879a08a445cbf438f3d68078111</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">PD:</span><span class="nv"> </span><span class="s">Get</span><span class="nv"> </span><span class="s">instance</span><span class="nv"> </span><span class="s">metrics'</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">HTTP_AGENT</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">pd.get_metrics</span>
          <span class="na">delay</span><span class="pi">:</span> <span class="s">30s</span>
          <span class="na">history</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
          <span class="na">trends</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
          <span class="na">value_type</span><span class="pi">:</span> <span class="s">TEXT</span>
          <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Get</span><span class="nv"> </span><span class="s">TiDB</span><span class="nv"> </span><span class="s">PD</span><span class="nv"> </span><span class="s">instance</span><span class="nv"> </span><span class="s">metrics.'</span>
          <span class="na">preprocessing</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">CHECK_NOT_SUPPORTED</span>
              <span class="na">parameters</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
            <span class="pi">-</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">PROMETHEUS_TO_JSON</span>
              <span class="na">parameters</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
          <span class="na">url</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{HOST.IP}:{$PD.PORT}/metrics'</span>
          <span class="na">tags</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">tag</span><span class="pi">:</span> <span class="s">Application</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s">RAW</span>
      <span class="na">discovery_rules</span><span class="pi">:</span>
        <span class="pi">-</span>
          <span class="na">uuid</span><span class="pi">:</span> <span class="s">74748726242c46bcaa7533edde4b2633</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">etcd</span><span class="nv"> </span><span class="s">disk</span><span class="nv"> </span><span class="s">wal</span><span class="nv"> </span><span class="s">fsync</span><span class="nv"> </span><span class="s">duration</span><span class="nv"> </span><span class="s">seconds</span><span class="nv"> </span><span class="s">bucket</span><span class="nv"> </span><span class="s">discovery'</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">etcd.disk.wal.fsync.duration.seconds.bucket.discovery</span>
          <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
          <span class="na">lifetime</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
          <span class="na">item_prototypes</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">uuid</span><span class="pi">:</span> <span class="s">c56a7113b37d48db836e6af8043e2639</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">TiDB-PD:</span><span class="nv"> </span><span class="s">{#NAME}</span><span class="nv">  </span><span class="s">{#LE}'</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s1">'</span><span class="s">etcd.write.disk.latency[{#LE}]'</span>
              <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
              <span class="na">value_type</span><span class="pi">:</span> <span class="s">FLOAT</span>
              <span class="na">preprocessing</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">JSONPATH</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">$[?(@.name=="etcd_disk_wal_fsync_duration_seconds_bucket")]'</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">JAVASCRIPT</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="pi">|</span>
                      <span class="s">var obj = JSON.parse(value)</span>
                      <span class="s">for (var i=0;i&lt; obj.length;i++){</span>
                          <span class="s">if (obj[i]['labels']['le'] == "{#LE}" &amp;&amp; obj[i]["name"] == "{#NAME}" ){</span>
                              <span class="s">return obj[i]["line_raw"].split(" ")[1]</span>
                          <span class="s">}</span>
                      <span class="s">}</span>
                      <span class="s">return</span>
                      
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">CHANGE_PER_SECOND</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
              <span class="na">master_item</span><span class="pi">:</span>
                <span class="na">key</span><span class="pi">:</span> <span class="s">pd.get_metrics</span>
              <span class="na">tags</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">tag</span><span class="pi">:</span> <span class="s">Application</span>
                  <span class="na">value</span><span class="pi">:</span> <span class="s">TIDB-PD</span>
          <span class="na">master_item</span><span class="pi">:</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">pd.get_metrics</span>
          <span class="na">preprocessing</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">JSONPATH</span>
              <span class="na">parameters</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s1">'</span><span class="s">$[?(@.name=="etcd_disk_wal_fsync_duration_seconds_bucket")]'</span>
              <span class="na">error_handler</span><span class="pi">:</span> <span class="s">CUSTOM_VALUE</span>
              <span class="na">error_handler_params</span><span class="pi">:</span> <span class="s1">'</span><span class="s">[]'</span>
            <span class="pi">-</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">JAVASCRIPT</span>
              <span class="na">parameters</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="pi">|</span>
                  <span class="s">var obj = JSON.parse(value)</span>
                  <span class="s">var outJson=[]</span>
                  <span class="s">for (var i=0;i&lt;obj.length;i++){</span>
                      <span class="s">outJson.push({"{#LE}":obj[i]['labels']['le'],"{#NAME}":obj[i]["name"]})</span>
                  <span class="s">}</span>
                  <span class="s">var ret = {}</span>
                  <span class="s">ret["data"] = outJson</span>
                  <span class="s">return JSON.stringify(ret)</span>
        <span class="pi">-</span>
          <span class="na">uuid</span><span class="pi">:</span> <span class="s">cd1f27cf5f1d4f6f84032386ec7f8abb</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Cluster</span><span class="nv"> </span><span class="s">metrics</span><span class="nv"> </span><span class="s">discovery'</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">pd.cluster.discovery</span>
          <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
          <span class="na">lifetime</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
          <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Discovery</span><span class="nv"> </span><span class="s">cluster</span><span class="nv"> </span><span class="s">specific</span><span class="nv"> </span><span class="s">metrics.'</span>
          <span class="na">item_prototypes</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">uuid</span><span class="pi">:</span> <span class="s">060fe77d53c24329a9165b50068ba757</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">TiDB</span><span class="nv"> </span><span class="s">cluster:</span><span class="nv"> </span><span class="s">tikv</span><span class="nv"> </span><span class="s">used</span><span class="nv"> </span><span class="s">sotrage</span><span class="nv"> </span><span class="s">capacity'</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">CALCULATED</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s1">'</span><span class="s">pd.cluster.capacity[{#SINGLETON}]'</span>
              <span class="na">units</span><span class="pi">:</span> <span class="s1">'</span><span class="s">%'</span>
              <span class="na">params</span><span class="pi">:</span> <span class="s1">'</span><span class="s">last(//pd.cluster_status.storage_size[{#SINGLETON}])</span><span class="nv"> </span><span class="s">/</span><span class="nv"> </span><span class="s">last(//pd.cluster_status.storage_capacity[{#SINGLETON}])</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">100'</span>
              <span class="na">tags</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">tag</span><span class="pi">:</span> <span class="s">Application</span>
                  <span class="na">value</span><span class="pi">:</span> <span class="s">TIDB-PD</span>
            <span class="pi">-</span>
              <span class="na">uuid</span><span class="pi">:</span> <span class="s">d39f58372e3f464c87b2ec42acdf2061</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">TiDB</span><span class="nv"> </span><span class="s">cluster:</span><span class="nv"> </span><span class="s">Storage</span><span class="nv"> </span><span class="s">capacity'</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s1">'</span><span class="s">pd.cluster_status.storage_capacity[{#SINGLETON}]'</span>
              <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
              <span class="na">history</span><span class="pi">:</span> <span class="s">7d</span>
              <span class="na">value_type</span><span class="pi">:</span> <span class="s">FLOAT</span>
              <span class="na">units</span><span class="pi">:</span> <span class="s">MB</span>
              <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">The</span><span class="nv"> </span><span class="s">total</span><span class="nv"> </span><span class="s">storage</span><span class="nv"> </span><span class="s">capacity</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">this</span><span class="nv"> </span><span class="s">TiDB</span><span class="nv"> </span><span class="s">cluster.'</span>
              <span class="na">preprocessing</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">JSONPATH</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">$[?(@.name</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">"pd_cluster_status"</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">@.labels.type</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">"storage_capacity")].value.first()'</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">JAVASCRIPT</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">return</span><span class="nv"> </span><span class="s">value/1024/1024'</span>
              <span class="na">master_item</span><span class="pi">:</span>
                <span class="na">key</span><span class="pi">:</span> <span class="s">pd.get_metrics</span>
              <span class="na">tags</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">tag</span><span class="pi">:</span> <span class="s">Application</span>
                  <span class="na">value</span><span class="pi">:</span> <span class="s">TIDB-PD</span>
            <span class="pi">-</span>
              <span class="na">uuid</span><span class="pi">:</span> <span class="s">c72e6a2f89d041c4bf764021b9bc182c</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">TiDB</span><span class="nv"> </span><span class="s">cluster:</span><span class="nv"> </span><span class="s">Storage</span><span class="nv"> </span><span class="s">size'</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s1">'</span><span class="s">pd.cluster_status.storage_size[{#SINGLETON}]'</span>
              <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
              <span class="na">history</span><span class="pi">:</span> <span class="s">7d</span>
              <span class="na">value_type</span><span class="pi">:</span> <span class="s">FLOAT</span>
              <span class="na">units</span><span class="pi">:</span> <span class="s">MB</span>
              <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">The</span><span class="nv"> </span><span class="s">storage</span><span class="nv"> </span><span class="s">size</span><span class="nv"> </span><span class="s">that</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">currently</span><span class="nv"> </span><span class="s">used</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">TiDB</span><span class="nv"> </span><span class="s">cluster.'</span>
              <span class="na">preprocessing</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">JSONPATH</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">$[?(@.name</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">"pd_cluster_status"</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">@.labels.type</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">"storage_size")].value.first()'</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">JAVASCRIPT</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">return</span><span class="nv"> </span><span class="s">value/1024/1024'</span>
              <span class="na">master_item</span><span class="pi">:</span>
                <span class="na">key</span><span class="pi">:</span> <span class="s">pd.get_metrics</span>
              <span class="na">tags</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">tag</span><span class="pi">:</span> <span class="s">Application</span>
                  <span class="na">value</span><span class="pi">:</span> <span class="s">TIDB-PD</span>
            <span class="pi">-</span>
              <span class="na">uuid</span><span class="pi">:</span> <span class="s">ce35701fa8344c4cbd1dc6b1d24dfa10</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">TiDB</span><span class="nv"> </span><span class="s">cluster:</span><span class="nv"> </span><span class="s">Lowspace</span><span class="nv"> </span><span class="s">stores'</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s1">'</span><span class="s">pd.cluster_status.store_low_space[{#SINGLETON}]'</span>
              <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
              <span class="na">history</span><span class="pi">:</span> <span class="s">7d</span>
              <span class="na">units</span><span class="pi">:</span> <span class="s">MB</span>
              <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">The</span><span class="nv"> </span><span class="s">count</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">low</span><span class="nv"> </span><span class="s">space</span><span class="nv"> </span><span class="s">stores.'</span>
              <span class="na">preprocessing</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">JSONPATH</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">$[?(@.name</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">"pd_cluster_status"</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">@.labels.type</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">"store_low_space_count")].value.first()'</span>
              <span class="na">master_item</span><span class="pi">:</span>
                <span class="na">key</span><span class="pi">:</span> <span class="s">pd.get_metrics</span>
              <span class="na">tags</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">tag</span><span class="pi">:</span> <span class="s">Application</span>
                  <span class="na">value</span><span class="pi">:</span> <span class="s">TIDB-PD</span>
          <span class="na">trigger_prototypes</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">uuid</span><span class="pi">:</span> <span class="s">843d566b33bc401390c2a633d08bb033</span>
              <span class="na">expression</span><span class="pi">:</span> <span class="s1">'</span><span class="s">min(/service.TiDB-PD/pd.cluster_status.storage_size[{#SINGLETON}],5m)/last(/service.TiDB-PD/pd.cluster_status.storage_capacity[{#SINGLETON}])*100&gt;{$PD.STORAGE_USAGE.MAX.WARN}'</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">TiDB</span><span class="nv"> </span><span class="s">cluster:</span><span class="nv"> </span><span class="s">Current</span><span class="nv"> </span><span class="s">storage</span><span class="nv"> </span><span class="s">usage</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">too</span><span class="nv"> </span><span class="s">high</span><span class="nv"> </span><span class="s">(over</span><span class="nv"> </span><span class="s">{$PD.STORAGE_USAGE.MAX.WARN}%</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">5m)'</span>
              <span class="na">status</span><span class="pi">:</span> <span class="s">DISABLED</span>
              <span class="na">priority</span><span class="pi">:</span> <span class="s">WARNING</span>
              <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Over</span><span class="nv"> </span><span class="s">{$PD.STORAGE_USAGE.MAX.WARN}%</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">cluster</span><span class="nv"> </span><span class="s">space</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">occupied.'</span>
          <span class="na">graph_prototypes</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">uuid</span><span class="pi">:</span> <span class="s">270de7aa73cf454cb147a3f5b39ebb35</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">TiDB</span><span class="nv"> </span><span class="s">cluster:</span><span class="nv"> </span><span class="s">Storage</span><span class="nv"> </span><span class="s">Usage[{#SINGLETON}]'</span>
              <span class="na">graph_items</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">color</span><span class="pi">:</span> <span class="s">1A7C11</span>
                  <span class="na">item</span><span class="pi">:</span>
                    <span class="na">host</span><span class="pi">:</span> <span class="s">service.TiDB-PD</span>
                    <span class="na">key</span><span class="pi">:</span> <span class="s1">'</span><span class="s">pd.cluster_status.storage_size[{#SINGLETON}]'</span>
                <span class="pi">-</span>
                  <span class="na">sortorder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1'</span>
                  <span class="na">color</span><span class="pi">:</span> <span class="s">2774A4</span>
                  <span class="na">item</span><span class="pi">:</span>
                    <span class="na">host</span><span class="pi">:</span> <span class="s">service.TiDB-PD</span>
                    <span class="na">key</span><span class="pi">:</span> <span class="s1">'</span><span class="s">pd.cluster_status.storage_capacity[{#SINGLETON}]'</span>
          <span class="na">master_item</span><span class="pi">:</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">pd.get_metrics</span>
          <span class="na">preprocessing</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">JSONPATH</span>
              <span class="na">parameters</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s1">'</span><span class="s">$[?(@.name=="pd_cluster_status")]'</span>
              <span class="na">error_handler</span><span class="pi">:</span> <span class="s">CUSTOM_VALUE</span>
              <span class="na">error_handler_params</span><span class="pi">:</span> <span class="s1">'</span><span class="s">[]'</span>
            <span class="pi">-</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">JAVASCRIPT</span>
              <span class="na">parameters</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s1">'</span><span class="s">return</span><span class="nv"> </span><span class="s">JSON.stringify(value</span><span class="nv"> </span><span class="s">!=</span><span class="nv"> </span><span class="s">"[]"</span><span class="nv"> </span><span class="s">?</span><span class="nv"> </span><span class="s">[{'</span><span class="s1">'</span><span class="s">{#SINGLETON}'</span><span class="s1">'</span><span class="s">:</span><span class="nv"> </span><span class="s">'</span><span class="s1">'</span><span class="s">'</span><span class="s1">'</span><span class="s">}]</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">[]);'</span>
        <span class="pi">-</span>
          <span class="na">uuid</span><span class="pi">:</span> <span class="s">e75aae0f2933400399028f8286b555f2</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">pd</span><span class="nv"> </span><span class="s">events</span><span class="nv"> </span><span class="s">metrics</span><span class="nv"> </span><span class="s">discovery'</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">pd.events.discovery</span>
          <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
          <span class="na">lifetime</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
          <span class="na">item_prototypes</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">uuid</span><span class="pi">:</span> <span class="s">1dac13d2c6d04cf09faee366442069c3</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">TiDB:</span><span class="nv"> </span><span class="s">pd</span><span class="nv"> </span><span class="s">tso</span><span class="nv"> </span><span class="s">events[save]'</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s1">'</span><span class="s">pd.tso.evnets[{#SINGLETON}]'</span>
              <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
              <span class="na">value_type</span><span class="pi">:</span> <span class="s">FLOAT</span>
              <span class="na">preprocessing</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">JSONPATH</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">$[?(@.name</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">"pd_tso_events"</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">@.labels.type</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">"save")].value.first()'</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">SIMPLE_CHANGE</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
              <span class="na">master_item</span><span class="pi">:</span>
                <span class="na">key</span><span class="pi">:</span> <span class="s">pd.get_metrics</span>
              <span class="na">tags</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">tag</span><span class="pi">:</span> <span class="s">Application</span>
                  <span class="na">value</span><span class="pi">:</span> <span class="s">TIDB-PD</span>
          <span class="na">master_item</span><span class="pi">:</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">pd.get_metrics</span>
          <span class="na">preprocessing</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">JSONPATH</span>
              <span class="na">parameters</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s1">'</span><span class="s">$[?(@.name=="pd_tso_events")]'</span>
              <span class="na">error_handler</span><span class="pi">:</span> <span class="s">CUSTOM_VALUE</span>
              <span class="na">error_handler_params</span><span class="pi">:</span> <span class="s1">'</span><span class="s">[]'</span>
            <span class="pi">-</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">JAVASCRIPT</span>
              <span class="na">parameters</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s1">'</span><span class="s">return</span><span class="nv"> </span><span class="s">JSON.stringify(value</span><span class="nv"> </span><span class="s">!=</span><span class="nv"> </span><span class="s">"[]"</span><span class="nv"> </span><span class="s">?</span><span class="nv"> </span><span class="s">[{'</span><span class="s1">'</span><span class="s">{#SINGLETON}'</span><span class="s1">'</span><span class="s">:</span><span class="nv"> </span><span class="s">'</span><span class="s1">'</span><span class="s">'</span><span class="s1">'</span><span class="s">}]</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">[]);'</span>
        <span class="pi">-</span>
          <span class="na">uuid</span><span class="pi">:</span> <span class="s">1138b1dbad934a57af545d04a2979294</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">pd</span><span class="nv"> </span><span class="s">process</span><span class="nv"> </span><span class="s">start</span><span class="nv">  </span><span class="s">time</span><span class="nv"> </span><span class="s">discovery'</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">pd.process.start.time.discovery</span>
          <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
          <span class="na">lifetime</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
          <span class="na">item_prototypes</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">uuid</span><span class="pi">:</span> <span class="s">4f0ec43060af4ef3a506f578af97b664</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">TiDB-PD:</span><span class="nv"> </span><span class="s">process</span><span class="nv"> </span><span class="s">start</span><span class="nv"> </span><span class="s">time</span><span class="nv"> </span><span class="s">seconds'</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s1">'</span><span class="s">process.start.time.seconds[{#SINGLETON}]'</span>
              <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
              <span class="na">preprocessing</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">JSONPATH</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">$[?(@.name</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">"process_start_time_seconds"</span><span class="nv"> </span><span class="s">)].value.first()'</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">SIMPLE_CHANGE</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
              <span class="na">master_item</span><span class="pi">:</span>
                <span class="na">key</span><span class="pi">:</span> <span class="s">pd.get_metrics</span>
              <span class="na">tags</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">tag</span><span class="pi">:</span> <span class="s">Application</span>
                  <span class="na">value</span><span class="pi">:</span> <span class="s">TIDB-PD</span>
          <span class="na">master_item</span><span class="pi">:</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">pd.get_metrics</span>
          <span class="na">preprocessing</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">JSONPATH</span>
              <span class="na">parameters</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s1">'</span><span class="s">$[?(@.name=="process_start_time_seconds")]'</span>
              <span class="na">error_handler</span><span class="pi">:</span> <span class="s">CUSTOM_VALUE</span>
              <span class="na">error_handler_params</span><span class="pi">:</span> <span class="s1">'</span><span class="s">[]'</span>
            <span class="pi">-</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">JAVASCRIPT</span>
              <span class="na">parameters</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s1">'</span><span class="s">return</span><span class="nv"> </span><span class="s">JSON.stringify(value</span><span class="nv"> </span><span class="s">!=</span><span class="nv"> </span><span class="s">"[]"</span><span class="nv"> </span><span class="s">?</span><span class="nv"> </span><span class="s">[{'</span><span class="s1">'</span><span class="s">{#SINGLETON}'</span><span class="s1">'</span><span class="s">:</span><span class="nv"> </span><span class="s">'</span><span class="s1">'</span><span class="s">'</span><span class="s1">'</span><span class="s">}]</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">[]);'</span>
      <span class="na">macros</span><span class="pi">:</span>
        <span class="pi">-</span>
          <span class="na">macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{$PD.MISS_REGION.MAX.WARN}'</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">100'</span>
          <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Maximum</span><span class="nv"> </span><span class="s">number</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">missed</span><span class="nv"> </span><span class="s">regions'</span>
        <span class="pi">-</span>
          <span class="na">macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{$PD.PORT}'</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2379'</span>
          <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">The</span><span class="nv"> </span><span class="s">port</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">PD</span><span class="nv"> </span><span class="s">server</span><span class="nv"> </span><span class="s">metrics</span><span class="nv"> </span><span class="s">web</span><span class="nv"> </span><span class="s">endpoint'</span>
        <span class="pi">-</span>
          <span class="na">macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{$PD.STORAGE_USAGE.MAX.WARN}'</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">80'</span>
          <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Maximum</span><span class="nv"> </span><span class="s">percentage</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">cluster</span><span class="nv"> </span><span class="s">space</span><span class="nv"> </span><span class="s">used'</span>
        <span class="pi">-</span>
          <span class="na">macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{$PD.URL}'</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{HOST.IP}'</span>
          <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">PD</span><span class="nv"> </span><span class="s">server</span><span class="nv"> </span><span class="s">URL'</span>
      <span class="na">valuemaps</span><span class="pi">:</span>
        <span class="pi">-</span>
          <span class="na">uuid</span><span class="pi">:</span> <span class="s">bce54cbdf2b8487985f9c7847a4c4918</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Service</span><span class="nv"> </span><span class="s">state'</span>
          <span class="na">mappings</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
              <span class="na">newvalue</span><span class="pi">:</span> <span class="s">Down</span>
            <span class="pi">-</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1'</span>
              <span class="na">newvalue</span><span class="pi">:</span> <span class="s">Up</span>
</code></pre></div></div>

<h3 id="效果">效果</h3>
<h4 id="prometheus-img">prometheus img</h4>
<p><img src="/assets/images/zabbix/2023-03-09_16-35.png" /></p>

<h4 id="zabbix-img">zabbix img</h4>
<p><img src="/assets/images/zabbix/2023-03-09_16-35_1.png" /></p>

<h3 id="参考链接">参考链接</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://www.zabbix.com/documentation/6.0/en/manual/appendix/functions/aggregate
https://www.zabbix.com/documentation/6.0/en/manual/appendix/functions/aggregate/foreach
https://support.zabbix.com/browse/ZBXNEXT-6879
</code></pre></div></div>]]></content><author><name>Your Name</name></author><category term="Monitor" /><summary type="html"><![CDATA[zabbix 收集TIDB的etcd_disk_wal_fsync_duration_seconds_bucket, 实现prometheus的 histogram_quantile]]></summary></entry><entry><title type="html">6位唯一码</title><link href="/6lenid/" rel="alternate" type="text/html" title="6位唯一码" /><published>2023-02-27T00:00:00+08:00</published><updated>2023-02-27T00:00:00+08:00</updated><id>/6lenid</id><content type="html" xml:base="/6lenid/"><![CDATA[<h3 id="6位唯一码">6位唯一码</h3>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
        <span class="s">"fmt"</span>
        <span class="s">"math/rand"</span>
        <span class="s">"time"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">un</span><span class="p">()</span><span class="kt">string</span><span class="p">{</span>
    <span class="n">str</span> <span class="o">:=</span> <span class="s">"abcdefghijklmnopqrstuvwxyz1234567890"</span> <span class="c">// 取值池</span>
    <span class="n">timestamp</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">UnixNano</span><span class="p">()</span>  <span class="c">// 纳秒</span>
    <span class="n">un</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="m">6</span><span class="p">)</span>
    <span class="n">rand</span><span class="o">.</span><span class="n">Seed</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">un</span> <span class="p">{</span>
        <span class="n">un</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">str</span><span class="p">[</span><span class="n">rand</span><span class="o">.</span><span class="n">Intn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">str</span><span class="p">))]</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kt">string</span><span class="p">(</span><span class="n">un</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">(){</span>
    <span class="n">testMap</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span>
    <span class="n">testRange</span> <span class="o">:=</span> <span class="m">2</span>

    <span class="k">for</span> <span class="n">i</span><span class="o">:=</span><span class="m">1</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">testRange</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">{</span>
        <span class="n">un</span> <span class="o">:=</span> <span class="n">un</span><span class="p">()</span>
        <span class="n">_</span> <span class="p">,</span><span class="n">ok</span> <span class="o">:=</span> <span class="n">testMap</span><span class="p">[</span><span class="n">un</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">{</span>
            <span class="n">testMap</span><span class="p">[</span><span class="n">un</span><span class="p">]</span> <span class="o">+=</span> <span class="m">1</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">testMap</span><span class="p">[</span><span class="n">un</span><span class="p">]</span> <span class="o">=</span> <span class="m">0</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">conflict</span> <span class="o">:=</span> <span class="m">0</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">val</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">testMap</span><span class="p">{</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="m">0</span><span class="p">{</span>
            <span class="n">conflict</span> <span class="o">+=</span> <span class="m">1</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">testMap</span><span class="p">)</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">conflict</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>]]></content><author><name>Your Name</name></author><category term="golang" /><summary type="html"><![CDATA[6位唯一码]]></summary></entry><entry><title type="html">服务管理</title><link href="/kubernetes-kubeadm-service-manage/" rel="alternate" type="text/html" title="服务管理" /><published>2023-02-23T00:00:00+08:00</published><updated>2023-02-23T00:00:00+08:00</updated><id>/kubernetes-kubeadm-service-manage</id><content type="html" xml:base="/kubernetes-kubeadm-service-manage/"><![CDATA[<h2 id="创建及删除service">创建及删除service</h2>

<p>service 通过 kube-proxy 实现 服务转发到后端的pod.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ds]# <span class="nb">mkdir </span>svc <span class="o">&amp;&amp;</span> <span class="nb">cd </span>svc
</code></pre></div></div>

<h4 id="创建空间">创建空间</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl create ns nssvc
namespace/nssvc created
<span class="o">[</span>root@master svc]# kubens nssvc
Context <span class="s2">"kubernetes-admin@kubernetes"</span> modified.
Active namespace is <span class="s2">"nssvc"</span><span class="nb">.</span>
</code></pre></div></div>

<h4 id="创建一个deployment的yaml文件">创建一个deployment的yaml文件</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl create deployment web <span class="nt">--image</span><span class="o">=</span>nginx <span class="nt">--dry-run</span><span class="o">=</span>client <span class="nt">-o</span> yaml <span class="o">&gt;</span> web1.yaml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app1</span><span class="pi">:</span> <span class="s">web1</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">web</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app1</span><span class="pi">:</span> <span class="s">web1</span>
  <span class="na">strategy</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app1</span><span class="pi">:</span> <span class="s">web1</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
        <span class="na">resources</span><span class="pi">:</span> <span class="pi">{}</span>
<span class="na">status</span><span class="pi">:</span> <span class="pi">{}</span>
   
</code></pre></div></div>

<ul>
  <li>
    <p>deployment 创建出来的pod都具有 app1=web1这个标签. template这里</p>
  </li>
  <li>
    <p>deployment通过app1=web1这个标签来定位pod . selector这里</p>
  </li>
  <li>
    <p>deployment自身的标签是app=web</p>

    <h4 id="创建">创建</h4>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl apply <span class="nt">-f</span> web1.yaml 
deployment.apps/web created
</code></pre></div></div>

<h4 id="查看">查看</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get deploy <span class="nt">-o</span> wide
NAME   READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES   SELECTOR
web    1/1     1            1           43s   nginx        nginx    <span class="nv">app1</span><span class="o">=</span>web1
</code></pre></div></div>

<h4 id="创建svc">创建svc</h4>

<p>svc可以基于deployment来创建</p>

<p>​        kubectl expose deployment deploy的名字 &gt; –name=服务名 –port=端口 –target-port=端口</p>

<p>也可以基于pod来创建</p>

<p>​         kubectl expose pod pod的名字 –name=服务名 –port=端口 –target-port=端口</p>

<p>–name 不指定默认使用deployment或者pod的名字</p>

<p>–port 指服务的端口,可以随意指定</p>

<p>–target-port 指后端运行的端口</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl expose deployment web <span class="nt">--name</span><span class="o">=</span>svc1 <span class="nt">--port</span><span class="o">=</span>80 <span class="nt">--target-port</span><span class="o">=</span>80
service/svc1 exposed
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get svc <span class="nt">-o</span> wide
NAME   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE   SELECTOR
svc1   ClusterIP   10.106.29.73   &lt;none&gt;        80/TCP    18s   <span class="nv">app1</span><span class="o">=</span>web1
</code></pre></div></div>

<p>svc1通过app1=web1来定位pod,所以 这个svc虽然是基于depolyment来创建,其实定位的是此deployment所管理的pod</p>

<h4 id="查看-1">查看</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl describe svc svc1
Name:              svc1
Namespace:         nssvc
Labels:            <span class="nv">app</span><span class="o">=</span>web
Annotations:       &lt;none&gt;
Selector:          <span class="nv">app1</span><span class="o">=</span>web1
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                10.106.29.73
IPs:               10.106.29.73
Port:              &lt;<span class="nb">unset</span><span class="o">&gt;</span>  80/TCP
TargetPort:        80/TCP
Endpoints:         10.244.166.142:80
Session Affinity:  None
Events:            &lt;none&gt;
</code></pre></div></div>

<p>Endpoints是后端的IP</p>

<h4 id="扩展deployment">扩展deployment</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl scale deploy web <span class="nt">--replicas</span><span class="o">=</span>3
deployment.apps/web scaled
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get pods <span class="nt">-o</span> wide 
NAME                   READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES
web-79974f444d-2g75d   1/1     Running   0          35s   10.244.166.144   node1   &lt;none&gt;           &lt;none&gt;
web-79974f444d-gzqz2   1/1     Running   0          35s   10.244.166.141   node1   &lt;none&gt;           &lt;none&gt;
web-79974f444d-xznvt   1/1     Running   0          10m   10.244.166.142   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<h4 id="再次查看">再次查看</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl describe svc svc1
Name:              svc1
Namespace:         nssvc
Labels:            <span class="nv">app</span><span class="o">=</span>web
Annotations:       &lt;none&gt;
Selector:          <span class="nv">app1</span><span class="o">=</span>web1
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                10.106.29.73
IPs:               10.106.29.73
Port:              &lt;<span class="nb">unset</span><span class="o">&gt;</span>  80/TCP
TargetPort:        80/TCP
Endpoints:         10.244.166.141:80,10.244.166.142:80,10.244.166.144:80
Session Affinity:  None
Events:            &lt;none&gt;
</code></pre></div></div>

<h4 id="删除svc">删除svc</h4>

<ul>
  <li>kubectl delete svc 名字</li>
  <li>kubectl delete -f svc的.yaml文件</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl delete svc svc1
service <span class="s2">"svc1"</span> deleted
</code></pre></div></div>

<h4 id="pod多个标签">pod多个标签</h4>

<p>可以指定根据哪个标签来定位</p>

<p>kubectl expose pod web-xxx –name=scv1 –selector=app1=web1 –port=80 –target-port=80</p>

<h3 id="验证负载均衡">验证负载均衡</h3>

<h4 id="修改pod">修改pod</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl <span class="nb">exec</span> <span class="nt">-ti</span> web-79974f444d-2g75d <span class="nt">--</span> bash
root@web-79974f444d-2g75d:/# <span class="nb">echo </span>111 <span class="o">&gt;</span> /usr/share/nginx/html/index.html 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl <span class="nb">exec</span> <span class="nt">-ti</span> web-79974f444d-gzqz2 <span class="nt">--</span> bash
root@web-79974f444d-gzqz2:/# <span class="nb">echo </span>222 <span class="o">&gt;</span> /usr/share/nginx/html/index.html 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl <span class="nb">exec</span> <span class="nt">-ti</span> web-79974f444d-xznvt <span class="nt">--</span> bash
root@web-79974f444d-xznvt:/# <span class="nb">echo </span>333 <span class="o">&gt;</span> /usr/share/nginx/html/index.html 
</code></pre></div></div>

<h4 id="创建svc-1">创建svc</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl expose deployment web <span class="nt">--name</span><span class="o">=</span>svc1 <span class="nt">--port</span><span class="o">=</span>80 <span class="nt">--target-port</span><span class="o">=</span>80
service/svc1 exposed
</code></pre></div></div>

<h4 id="查看svc的ip">查看svc的IP</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get svc
NAME   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
svc1   ClusterIP   10.103.10.106   &lt;none&gt;        80/TCP    18s
</code></pre></div></div>

<h4 id="测试">测试</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# curl <span class="nt">-s</span> 10.103.10.106
111
<span class="o">[</span>root@master svc]# curl <span class="nt">-s</span> 10.103.10.106
333
<span class="o">[</span>root@master svc]# curl <span class="nt">-s</span> 10.103.10.106
333
<span class="o">[</span>root@master svc]# curl <span class="nt">-s</span> 10.103.10.106
333
<span class="o">[</span>root@master svc]# curl <span class="nt">-s</span> 10.103.10.106
222
</code></pre></div></div>

<h4 id="删除">删除</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl delete svc svc1
service <span class="s2">"svc1"</span> deleted
</code></pre></div></div>

<h4 id="yaml创建service">yaml创建service</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl expose deployment web <span class="nt">--name</span><span class="o">=</span>svc1 <span class="nt">--port</span><span class="o">=</span>80 <span class="nt">--target-port</span><span class="o">=</span>80 <span class="nt">--dry-run</span><span class="o">=</span>client <span class="nt">-o</span> yaml <span class="o">&gt;</span> svc1.yaml
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
kind: Service
metadata:
  creationTimestamp: null
  labels:
    app: web
  name: svc1
spec:
  ports:
  - port: 80
    protocol: TCP
    targetPort: 80
  selector:
    app1: web1
status:
  loadBalancer: <span class="o">{}</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl apply <span class="nt">-f</span> svc1.yaml 
service/svc1 created
<span class="o">[</span>root@master svc]# kubectl get svc
NAME   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
svc1   ClusterIP   10.110.221.154   &lt;none&gt;        80/TCP    8s
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl delete deployment web
deployment.apps <span class="s2">"web"</span> deleted
<span class="o">[</span>root@master svc]# kubectl delete svc svc1
service <span class="s2">"svc1"</span> deleted
</code></pre></div></div>

<h3 id="服务发现">服务发现</h3>

<ul>
  <li>通过clusterIP发现svc</li>
  <li>通过变量发现svc</li>
  <li>通过dns发现svc</li>
</ul>

<h4 id="环境准备">环境准备</h4>

<h4 id="mysql">mysql</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">mysql:8</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">env</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">redhat</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_USER</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">tom</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_PASSWORD</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">redhat</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_DATABASE</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">blog</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
      <span class="na">containerPort</span><span class="pi">:</span> <span class="m">3306</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get pods <span class="nt">-o</span> wide
NAME    READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES
mysql   1/1     Running   0          32s   10.244.166.140   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>为mysql创建svc</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl expose pod mysql <span class="nt">--name</span><span class="o">=</span>dbsvc <span class="nt">--port</span><span class="o">=</span>3306
service/dbsvc exposed
</code></pre></div></div>

<h4 id="wordpress">wordpress</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">wordpress:latest</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_USE</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">root</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_PASSWORD</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">redhat</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_NAME</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">blog</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_HOST</span>
        <span class="na">value</span><span class="pi">:</span> 
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
      <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<p>mysql的主机地址没有填写</p>

<h4 id="通过clusterip的方式访问">通过clusterip的方式访问</h4>

<p>获取mysql的svc ip地址</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get svc
NAME    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
dbsvc   ClusterIP   10.106.124.116   &lt;none&gt;        3306/TCP   50m
</code></pre></div></div>

<p>修改wordpress的地址</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">wordpress:latest</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_USE</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">root</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_PASSWORD</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">redhat</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_NAME</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">blog</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_HOST</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">10.106.124.116</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
      <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<p>创建wordpress</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl apply <span class="nt">-f</span> pod-wordpress.yaml 
pod/wordpress created
</code></pre></div></div>

<p>查看状态</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get pods <span class="nt">-o</span> wide
NAME        READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES
mysql       1/1     Running   0          79m   10.244.166.140   node1   &lt;none&gt;           &lt;none&gt;
wordpress   1/1     Running   0          21m   10.244.166.147   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>测试</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>firefox &amp;
</code></pre></div></div>

<h4 id="通过变量">通过变量</h4>

<p>同一个命名空间内,如果先存在了A服务,则在创建B pod的时候,B pod会自动学习到A服务的变量，标记服务IP和端口的格式如下</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A 服务名_SERVICE_HOST
B 服务名_SERVICE_PORT
</code></pre></div></div>

<p><strong>服务名要大写</strong></p>

<p>在B pod的yaml文件里要引用关于A的变量时候,用$(变量名)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@wordpress:/var/www/html# <span class="nb">env</span> | <span class="nb">grep </span>DB
<span class="nv">DBSVC_PORT</span><span class="o">=</span>tcp://10.106.124.116:3306
<span class="nv">DBSVC_PORT_3306_TCP_ADDR</span><span class="o">=</span>10.106.124.116
<span class="nv">DBSVC_PORT_3306_TCP</span><span class="o">=</span>tcp://10.106.124.116:3306
<span class="nv">DBSVC_PORT_3306_TCP_PORT</span><span class="o">=</span>3306
<span class="nv">WORDPRESS_DB_USE</span><span class="o">=</span>root
<span class="nv">WORDPRESS_DB_HOST</span><span class="o">=</span>10.106.124.116
<span class="nv">DBSVC_SERVICE_PORT</span><span class="o">=</span>3306
<span class="nv">WORDPRESS_DB_PASSWORD</span><span class="o">=</span>redhat
<span class="nv">DBSVC_SERVICE_HOST</span><span class="o">=</span>10.106.124.116
<span class="nv">WORDPRESS_DB_NAME</span><span class="o">=</span>blod
<span class="nv">DBSVC_PORT_3306_TCP_PROTO</span><span class="o">=</span>tcp
</code></pre></div></div>

<p>所以在wordpress的yaml文件中，可以直接使用变量的方式获取dbsvc的IP</p>

<p>删除wordpress的pod</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl delete pod wordpress <span class="nt">--force</span>
warning: Immediate deletion does not <span class="nb">wait </span><span class="k">for </span>confirmation that the running resource has been terminated. The resource may <span class="k">continue </span>to run on the cluster indefinitely.
pod <span class="s2">"wordpress"</span> force deleted
</code></pre></div></div>

<p>创建</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl apply <span class="nt">-f</span> pod-wordpress.yaml 
pod/wordpress created
</code></pre></div></div>

<p>删除</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl delete pod wordpress
pod <span class="s2">"wordpress"</span> deleted
</code></pre></div></div>

<h4 id="通过dns">通过DNS</h4>

<p>kubernetes安装后 有一个coredns的deplyment</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get pods <span class="nt">-n</span> kube-system| <span class="nb">grep </span>dns
coredns-545d6fc579-j9f7q                   1/1     Running   7          12d
coredns-545d6fc579-t7st8                   1/1     Running   7          12d
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get svc <span class="nt">-n</span> kube-system
NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                  AGE
kube-dns         ClusterIP   10.96.0.10       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   12d
</code></pre></div></div>

<p>在k8s中,只要创建了服务,都会自动到coreDNS里去注册,这样coreDNS会知道每个服务的IP地址</p>

<p>同一个命名空间,可以通过服务名来访问</p>

<p>临时创建一个pod测试</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl run busybox <span class="nt">--rm</span> <span class="nt">-ti</span> <span class="nt">--image</span><span class="o">=</span>busybox sh
If you don<span class="s1">'t see a command prompt, try pressing enter.
/ # ping dbsvc
PING dbsvc (10.106.124.116): 56 data bytes
</span></code></pre></div></div>

<p>可以看到已经解析了</p>

<p>如果访问其它命名空间的服务使用</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>服务名.命名空间
</code></pre></div></div>

<p>修改wordpress的配置</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">wordpress:latest</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_USE</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">root</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_PASSWORD</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">redhat</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_NAME</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">blog</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_HOST</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">dbsvc</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
      <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl apply <span class="nt">-f</span> pod-wordpress.yaml 
pod/wordpress created
</code></pre></div></div>

<p>查看</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get pods <span class="nt">-o</span> wide 
NAME        READY   STATUS    RESTARTS   AGE    IP               NODE    NOMINATED NODE   READINESS GATES
mysql       1/1     Running   0          104m   10.244.166.140   node1   &lt;none&gt;           &lt;none&gt;
wordpress   1/1     Running   0          31s    10.244.166.149   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<h3 id="通过nodeport发布服务">通过NodePort发布服务</h3>

<p>把服务的端口映射到物理机器(kubernetes集群中所有节点)的某端口,以后访问服务器该端口的时候,请求就会转发到该svc上</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get pods
NAME        READY   STATUS    RESTARTS   AGE
mysql       1/1     Running   0          121m
wordpress   1/1     Running   0          17m
</code></pre></div></div>

<h4 id="为此pod创建类型为nodeport类型的service名字为blog">为此pod创建类型为NodePort类型的service,名字为blog</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl expose pod wordpress <span class="nt">--name</span><span class="o">=</span>blog <span class="nt">--port</span><span class="o">=</span>80 <span class="nt">--type</span><span class="o">=</span>NodePort 
service/blog exposed
</code></pre></div></div>

<p>查看服务</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get svc
NAME    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
blog    NodePort    10.110.246.12    &lt;none&gt;        80:31285/TCP   5m19s
dbsvc   ClusterIP   10.106.124.116   &lt;none&gt;        3306/TCP       126m
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get node <span class="nt">-o</span> wide
NAME     STATUS   ROLES                  AGE   VERSION   INTERNAL-IP       EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION          CONTAINER-RUNTIME
master   Ready    control-plane,master   12d   v1.21.1   192.168.122.200   &lt;none&gt;        CentOS Linux 7 <span class="o">(</span>Core<span class="o">)</span>   3.10.0-862.el7.x86_64   docker://20.10.17
node1    Ready    node1                  12d   v1.21.1   192.168.122.202   &lt;none&gt;        CentOS Linux 7 <span class="o">(</span>Core<span class="o">)</span>   3.10.0-862.el7.x86_64   docker://20.10.17
node2    Ready    node2                  12d   v1.21.1   192.168.122.203   &lt;none&gt;        CentOS Linux 7 <span class="o">(</span>Core<span class="o">)</span>   3.10.0-862.el7.x86_64   docker://20.10.17
</code></pre></div></div>

<p>通过任一node的IP+ 31285端口都可以访问这个服务</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.122.202:31285/
</code></pre></div></div>

<p>删除以上pod和svc</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl delete pod mysql
pod <span class="s2">"mysql"</span> deleted
<span class="o">[</span>root@master svc]# kubectl delete pod wordpress <span class="nt">-force</span>
error: the path <span class="s2">"orce"</span> does not exist
<span class="o">[</span>root@master svc]# kubectl delete pod wordpress <span class="nt">--force</span>
warning: Immediate deletion does not <span class="nb">wait </span><span class="k">for </span>confirmation that the running resource has been terminated. The resource may <span class="k">continue </span>to run on the cluster indefinitely.
pod <span class="s2">"wordpress"</span> force deleted
<span class="o">[</span>root@master svc]# kubectl get svc
NAME    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
blog    NodePort    10.110.246.12    &lt;none&gt;        80:31285/TCP   32m
dbsvc   ClusterIP   10.106.124.116   &lt;none&gt;        3306/TCP       153m
<span class="o">[</span>root@master svc]# kubectl delete svc blog
service <span class="s2">"blog"</span> deleted
<span class="o">[</span>root@master svc]# kubectl delete svc dbsvc
service <span class="s2">"dbsvc"</span> deleted
</code></pre></div></div>

<h3 id="通过loadbalancer">通过loadbalancer</h3>

<h4 id="创建命名空间">创建命名空间</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl create ns metallb-system
namespace/metallb-system created
</code></pre></div></div>

<h4 id="创建secret">创建secret</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl create secret generic <span class="nt">-n</span> metallb-system memberlist <span class="nt">--from-literal</span><span class="o">=</span><span class="nv">secretkey</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span>openssl rand <span class="nt">-base64</span> 128<span class="si">)</span><span class="s2">"</span>
secret/memberlist created
</code></pre></div></div>

<h4 id="下载部署metallb">下载部署metallb</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/metallb.yaml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
</code></pre></div></div>

<h4 id="安装">安装</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl apply <span class="nt">-f</span> metallb.yaml 
Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="k">in </span>v1.21+, unavailable <span class="k">in </span>v1.25+
podsecuritypolicy.policy/controller configured
podsecuritypolicy.policy/speaker configured
serviceaccount/controller unchanged
serviceaccount/speaker unchanged
clusterrole.rbac.authorization.k8s.io/metallb-system:controller unchanged
clusterrole.rbac.authorization.k8s.io/metallb-system:speaker unchanged
role.rbac.authorization.k8s.io/config-watcher unchanged
role.rbac.authorization.k8s.io/pod-lister unchanged
clusterrolebinding.rbac.authorization.k8s.io/metallb-system:controller unchanged
clusterrolebinding.rbac.authorization.k8s.io/metallb-system:speaker unchanged
rolebinding.rbac.authorization.k8s.io/config-watcher unchanged
rolebinding.rbac.authorization.k8s.io/pod-lister unchanged
daemonset.apps/speaker unchanged
deployment.apps/controller unchanged
</code></pre></div></div>

<h4 id="查看运行状态">查看运行状态</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl get pods <span class="nt">-n</span> metallb-system
NAME                         READY   STATUS    RESTARTS   AGE
controller-b4df945f8-d9kc4   1/1     Running   0          2m17s
speaker-dwwhj                1/1     Running   0          2m17s
speaker-gnlkz                1/1     Running   0          2m17s
speaker-jdv9v                1/1     Running   0          2m17s
</code></pre></div></div>

<h4 id="创建地址池">创建地址池</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">metallb-system</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">config</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">address-pools:</span>
    <span class="s">- name: default</span>
      <span class="s">protocol: layer2</span>
      <span class="s">addresses:</span>
      <span class="s">- 192.168.122.200-192.168.122.205  # 虚拟机使用桥接网卡地址网段</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl apply <span class="nt">-f</span> pool1.yaml 
configmap/config created
</code></pre></div></div>

<h4 id="测试-1">测试</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl run pod1 <span class="nt">--image</span><span class="o">=</span>nginx <span class="nt">--image-pull-policy</span><span class="o">=</span>IfNotPresent
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl expose <span class="nt">--name</span><span class="o">=</span>svc10 pod pod1 <span class="nt">--port</span><span class="o">=</span>80 <span class="nt">--type</span><span class="o">=</span>LoadBalancer
service/svc10 exposed
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl get svc
NAME    TYPE           CLUSTER-IP       EXTERNAL-IP       PORT<span class="o">(</span>S<span class="o">)</span>        AGE
svc1    ClusterIP      10.107.76.165    &lt;none&gt;            80/TCP         2d3h
svc10   LoadBalancer   10.100.124.221   192.168.122.202   80:30113/TCP   4s
svc2    ClusterIP      10.107.147.148   &lt;none&gt;            80/TCP         2d3h
svc3    ClusterIP      10.111.192.216   &lt;none&gt;            80/TCP         2d3h
</code></pre></div></div>

<p>访问192.168.122.202则成功</p>

<h4 id="删除-1">删除</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<h3 id="创建ingress并发布服务">创建ingress并发布服务</h3>

<p>nodeport 会在服务增多的情况下导致映射端口过多</p>

<h4 id="搭建ingress-nginx服务器">搭建ingress-nginx服务器</h4>

<ul>
  <li>本质通过nginx的反向代理来实现.然后在用户所在的命名空间写ingress规则，这些规则会嵌入 ingres-nginx控制器里</li>
  <li>用户在自己的命名空间里定义ingress规则</li>
</ul>

<p>​     www1.rhce.cc 转发到svc1</p>

<p>​     www2.rhce.cc 转发到svc2</p>

<p>​      www3.rhce.cc 转发到svc3</p>

<p>我们把www1.rhce.cc 和  www2.rhce.cc 都解析为ingress-nginx控制器所在的IP，以后客户端访问www1.rhce.cc的时候访问的就是ingress-nginx控制器，根据规则,控制器会把请求转发到svc1</p>

<h4 id="部署nginx-ingress-控制器">部署nginx ingress 控制器</h4>

<p>参考:  https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal-clusters</p>

<p>镜像: https://hub.docker.com/r/anjia0532/google-containers.ingress-nginx.controller/tags</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.3.0/deploy/static/provider/baremetal/deploy.yaml
</code></pre></div></div>

<p>查看命名空间</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get ns
NAME              STATUS   AGE
default           Active   14d
ingress-nginx     Active   31s
kube-node-lease   Active   14d
kube-public       Active   14d
kube-system       Active   14d
nsdeploy          Active   2d21h
nsds              Active   44h
nsjob             Active   30h
nsprobe           Active   44h
nssec             Active   4d21h
nssvc             Active   29h
nsvolume          Active   6d20h
</code></pre></div></div>

<p>查看deployment</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get deploy <span class="nt">-n</span> ingress-nginx
NAME                       READY   UP-TO-DATE   AVAILABLE   AGE
ingress-nginx-controller   0/1     1            0           46s
</code></pre></div></div>

<p>查看pod节点</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">[</span>root@master svc]# kubectl get pods <span class="nt">-n</span> ingress-nginx <span class="nt">-o</span> wide 
NAME                                        READY   STATUS              RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES
ingress-nginx-admission-create-t265f        0/1     ErrImagePull        0          61s   10.244.166.157   node1   &lt;none&gt;           &lt;none&gt;
ingress-nginx-admission-patch-72c7w         0/1     ImagePullBackOff    0          61s   10.244.166.158   node1   &lt;none&gt;           &lt;none&gt;
ingress-nginx-controller-787f856bb4-2qd46   0/1     ContainerCreating   0          61s   &lt;none&gt;           node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>这里发现ErrImagePull报错:</p>

<p>修改yaml文件</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Namespace</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">automountServiceAccountToken</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">namespaces</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">configmaps</span>
  <span class="pi">-</span> <span class="s">pods</span>
  <span class="pi">-</span> <span class="s">secrets</span>
  <span class="pi">-</span> <span class="s">endpoints</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">services</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">networking.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingresses</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">networking.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingresses/status</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">update</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">networking.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingressclasses</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resourceNames</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingress-controller-leader</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">configmaps</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">update</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">configmaps</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">create</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">coordination.k8s.io</span>
  <span class="na">resourceNames</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingress-controller-leader</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">leases</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">update</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">coordination.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">leases</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">create</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">events</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">create</span>
  <span class="pi">-</span> <span class="s">patch</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">secrets</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">create</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">configmaps</span>
  <span class="pi">-</span> <span class="s">endpoints</span>
  <span class="pi">-</span> <span class="s">nodes</span>
  <span class="pi">-</span> <span class="s">pods</span>
  <span class="pi">-</span> <span class="s">secrets</span>
  <span class="pi">-</span> <span class="s">namespaces</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">coordination.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">leases</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">nodes</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">services</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">networking.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingresses</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">events</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">create</span>
  <span class="pi">-</span> <span class="s">patch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">networking.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingresses/status</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">update</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">networking.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingressclasses</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">admissionregistration.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">validatingwebhookconfigurations</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">update</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">RoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">RoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">allow-snippet-annotations</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-controller</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-controller</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">appProtocol</span><span class="pi">:</span> <span class="s">http</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="s">http</span>
  <span class="pi">-</span> <span class="na">appProtocol</span><span class="pi">:</span> <span class="s">https</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">https</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">443</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="s">https</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="c1"># type: NodePort</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span> <span class="c1">#这里改成LoadBalancer，获取外部IP</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-controller-admission</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">appProtocol</span><span class="pi">:</span> <span class="s">https</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">https-webhook</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">443</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="s">webhook</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-controller</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">minReadySeconds</span><span class="pi">:</span> <span class="m">0</span>
  <span class="na">revisionHistoryLimit</span><span class="pi">:</span> <span class="m">10</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
      <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
      <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
        <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
        <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">/nginx-ingress-controller</span>
        <span class="pi">-</span> <span class="s">--election-id=ingress-controller-leader</span>
        <span class="pi">-</span> <span class="s">--controller-class=k8s.io/ingress-nginx</span>
        <span class="pi">-</span> <span class="s">--ingress-class=nginx</span>
        <span class="pi">-</span> <span class="s">--configmap=$(POD_NAMESPACE)/ingress-nginx-controller</span>
        <span class="pi">-</span> <span class="s">--validating-webhook=:8443</span>
        <span class="pi">-</span> <span class="s">--validating-webhook-certificate=/usr/local/certificates/cert</span>
        <span class="pi">-</span> <span class="s">--validating-webhook-key=/usr/local/certificates/key</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">POD_NAME</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.name</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">POD_NAMESPACE</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.namespace</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">LD_PRELOAD</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">/usr/local/lib/libmimalloc.so</span>
        <span class="c1"># image: registry.k8s.io/ingress-nginx/controller:v1.3.0@sha256:d1707ca76d3b044ab8a28277a2466a02100ee9f58a86af1535a3edf9323ea1b5</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">anjia0532/google-containers.ingress-nginx.controller:v1.3.0</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">lifecycle</span><span class="pi">:</span>
          <span class="na">preStop</span><span class="pi">:</span>
            <span class="na">exec</span><span class="pi">:</span>
              <span class="na">command</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">/wait-shutdown</span>
        <span class="na">livenessProbe</span><span class="pi">:</span>
          <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">5</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/healthz</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">10254</span>
            <span class="na">scheme</span><span class="pi">:</span> <span class="s">HTTP</span>
          <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">10</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">10</span>
          <span class="na">successThreshold</span><span class="pi">:</span> <span class="m">1</span>
          <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">1</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">controller</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">443</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">https</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8443</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">webhook</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
        <span class="na">readinessProbe</span><span class="pi">:</span>
          <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">3</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/healthz</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">10254</span>
            <span class="na">scheme</span><span class="pi">:</span> <span class="s">HTTP</span>
          <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">10</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">10</span>
          <span class="na">successThreshold</span><span class="pi">:</span> <span class="m">1</span>
          <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">1</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s">100m</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">90Mi</span>
        <span class="na">securityContext</span><span class="pi">:</span>
          <span class="na">allowPrivilegeEscalation</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">capabilities</span><span class="pi">:</span>
            <span class="na">add</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">NET_BIND_SERVICE</span>
            <span class="na">drop</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">ALL</span>
          <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">101</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/usr/local/certificates/</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">webhook-cert</span>
          <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">dnsPolicy</span><span class="pi">:</span> <span class="s">ClusterFirst</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="na">kubernetes.io/os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
      <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">300</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">webhook-cert</span>
        <span class="na">secret</span><span class="pi">:</span>
          <span class="na">secretName</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission-create</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
        <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
        <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
        <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
        <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission-create</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">create</span>
        <span class="pi">-</span> <span class="s">--host=ingress-nginx-controller-admission,ingress-nginx-controller-admission.$(POD_NAMESPACE).svc</span>
        <span class="pi">-</span> <span class="s">--namespace=$(POD_NAMESPACE)</span>
        <span class="pi">-</span> <span class="s">--secret-name=ingress-nginx-admission</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">POD_NAMESPACE</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.namespace</span>
        <span class="c1"># image: registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">anjia0532/google-containers.ingress-nginx.kube-webhook-certgen:v1.1.1</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">create</span>
        <span class="na">securityContext</span><span class="pi">:</span>
          <span class="na">allowPrivilegeEscalation</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="na">kubernetes.io/os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">OnFailure</span>
      <span class="na">securityContext</span><span class="pi">:</span>
        <span class="na">fsGroup</span><span class="pi">:</span> <span class="m">2000</span>
        <span class="na">runAsNonRoot</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">2000</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission-patch</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
        <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
        <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
        <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
        <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission-patch</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">patch</span>
        <span class="pi">-</span> <span class="s">--webhook-name=ingress-nginx-admission</span>
        <span class="pi">-</span> <span class="s">--namespace=$(POD_NAMESPACE)</span>
        <span class="pi">-</span> <span class="s">--patch-mutating=false</span>
        <span class="pi">-</span> <span class="s">--secret-name=ingress-nginx-admission</span>
        <span class="pi">-</span> <span class="s">--patch-failure-policy=Fail</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">POD_NAMESPACE</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.namespace</span>
        <span class="c1"># image: registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">anjia0532/google-containers.ingress-nginx.kube-webhook-certgen:v1.1.1</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">patch</span>
        <span class="na">securityContext</span><span class="pi">:</span>
          <span class="na">allowPrivilegeEscalation</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="na">kubernetes.io/os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">OnFailure</span>
      <span class="na">securityContext</span><span class="pi">:</span>
        <span class="na">fsGroup</span><span class="pi">:</span> <span class="m">2000</span>
        <span class="na">runAsNonRoot</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">2000</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IngressClass</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">controller</span><span class="pi">:</span> <span class="s">k8s.io/ingress-nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">admissionregistration.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ValidatingWebhookConfiguration</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">admission-webhook</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/part-of</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">1.3.0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-admission</span>
<span class="na">webhooks</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">admissionReviewVersions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">v1</span>
  <span class="na">clientConfig</span><span class="pi">:</span>
    <span class="na">service</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-controller-admission</span>
      <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s">/networking/v1/ingresses</span>
  <span class="na">failurePolicy</span><span class="pi">:</span> <span class="s">Fail</span>
  <span class="na">matchPolicy</span><span class="pi">:</span> <span class="s">Equivalent</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">validate.nginx.ingress.kubernetes.io</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">networking.k8s.io</span>
    <span class="na">apiVersions</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">v1</span>
    <span class="na">operations</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">CREATE</span>
    <span class="pi">-</span> <span class="s">UPDATE</span>
    <span class="na">resources</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ingresses</span>
  <span class="na">sideEffects</span><span class="pi">:</span> <span class="s">None</span>
</code></pre></div></div>

<p>重新安装查看</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get pods <span class="nt">-n</span> ingress-nginx <span class="nt">-o</span> wide
NAME                                        READY   STATUS      RESTARTS   AGE     IP               NODE    NOMINATED NODE   READINESS GATES
ingress-nginx-admission-create-ftxdq        0/1     Completed   0          2m13s   10.244.166.173   node1   &lt;none&gt;           &lt;none&gt;
ingress-nginx-admission-patch-8c76s         0/1     Completed   3          2m13s   10.244.166.174   node1   &lt;none&gt;           &lt;none&gt;
ingress-nginx-controller-6d86674cfd-wdqts   0/1     Running     0          2m13s   10.244.166.170   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>修改node1和node2的hosts</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.244.166.170 www1.rhce.cc www1
10.244.166.170 www2.rhce.cc www2
</code></pre></div></div>

<h4 id="环境准备-1">环境准备</h4>

<p>3个pod</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl run nginx1 <span class="nt">--image</span><span class="o">=</span>nginx <span class="nt">--image-pull-policy</span><span class="o">=</span>IfNotPresent
pod/nginx1 created
<span class="o">[</span>root@master svc]# kubectl run nginx2 <span class="nt">--image</span><span class="o">=</span>nginx <span class="nt">--image-pull-policy</span><span class="o">=</span>IfNotPresent
pod/nginx2 created
<span class="o">[</span>root@master svc]# kubectl run nginx3 <span class="nt">--image</span><span class="o">=</span>nginx <span class="nt">--image-pull-policy</span><span class="o">=</span>IfNotPresent
pod/nginx3 created
</code></pre></div></div>

<p>3个svc</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl expose pod nginx1 <span class="nt">--name</span><span class="o">=</span>svc1 <span class="nt">--port</span><span class="o">=</span>80
service/svc1 exposed
<span class="o">[</span>root@master svc]# kubectl expose pod nginx2 <span class="nt">--name</span><span class="o">=</span>svc2 <span class="nt">--port</span><span class="o">=</span>80
service/svc2 exposed
<span class="o">[</span>root@master svc]# kubectl expose pod nginx3 <span class="nt">--name</span><span class="o">=</span>svc3 <span class="nt">--port</span><span class="o">=</span>80
service/svc3 exposed
</code></pre></div></div>

<p>查看svc</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl get svc
NAME   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
svc1   ClusterIP   10.107.76.165    &lt;none&gt;        80/TCP    24s
svc2   ClusterIP   10.107.147.148   &lt;none&gt;        80/TCP    19s
svc3   ClusterIP   10.111.192.216   &lt;none&gt;        80/TCP    15s
</code></pre></div></div>

<p>修改nginx的html文件</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl <span class="nb">exec</span> <span class="nt">-it</span> nginx1 <span class="nt">--</span> bash
root@nginx1:/# <span class="nb">echo </span>111 <span class="o">&gt;</span> /usr/share/nginx/html/index.html 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl <span class="nb">exec</span> <span class="nt">-it</span> nginx2 <span class="nt">--</span> bash
root@nginx2:/# <span class="nb">echo </span>222 <span class="o">&gt;</span> /usr/share/nginx/html/index.html
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl <span class="nb">exec</span> <span class="nt">-ti</span> nginx3 <span class="nt">--</span> bash
root@nginx3:/# <span class="nb">mkdir</span> /usr/share/nginx/html/cka
root@nginx3:/# <span class="nb">echo </span>333 <span class="o">&gt;</span> /usr/share/nginx/html/cka/index.html
</code></pre></div></div>

<h4 id="定义ingress规则">定义ingress规则</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mying</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">kubernetes.io/ingress.class</span><span class="pi">:</span> <span class="s">nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">www1.rhce.cc</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
        <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">svc1</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">number</span><span class="pi">:</span> <span class="m">80</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/cka</span>
        <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">svc3</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">number</span><span class="pi">:</span> <span class="m">80</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">www2.rhce.cc</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
        <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">svc2</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">number</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master svc]# kubectl apply <span class="nt">-f</span> ingress.yaml 
ingress.networking.k8s.io/mying created
</code></pre></div></div>

<p>查看ingress</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl get ing
NAME    CLASS    HOSTS                       ADDRESS           PORTS   AGE
mying   &lt;none&gt;   www1.rhce.cc,www2.rhce.cc   192.168.122.202   80      25h
</code></pre></div></div>

<p>这里不显示ADDRESS</p>

<p>测试</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@node1 ~]# curl www1.rhce.cc/cka/
333
<span class="o">[</span>root@node1 ~]# curl www1.rhce.cc
111
<span class="o">[</span>root@node1 ~]# curl www2.rhce.cc
222
</code></pre></div></div>]]></content><author><name>Your Name</name></author><category term="Kubernetes" /><summary type="html"><![CDATA[创建及删除service]]></summary></entry><entry><title type="html">leetcode-golang-easy-01</title><link href="/leetcode-golang-easy-01/" rel="alternate" type="text/html" title="leetcode-golang-easy-01" /><published>2023-02-23T00:00:00+08:00</published><updated>2023-02-23T00:00:00+08:00</updated><id>/leetcode-golang-easy-01</id><content type="html" xml:base="/leetcode-golang-easy-01/"><![CDATA[<h3 id="1-两数之和">1 两数之和</h3>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=1 lang=golang
 *
 * [1] 两数之和
 */</span>

<span class="c">// @lc code=start</span>
<span class="k">func</span> <span class="n">twoSum</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">target</span> <span class="kt">int</span><span class="p">)</span> <span class="p">[]</span><span class="kt">int</span> <span class="p">{</span>          <span class="c">// nums 是是一个整数数组,target是目标值</span>
	<span class="n">numMap</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span>                  <span class="c">// 储存没个数字的补数</span>
	<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">nums</span> <span class="p">{</span>                   <span class="c">// 循环nums,i为num索引</span>
		<span class="n">com</span> <span class="o">:=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">num</span>                  <span class="c">// com + num = target</span>
		<span class="k">if</span> <span class="n">index</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">numMap</span><span class="p">[</span><span class="n">com</span><span class="p">];</span> <span class="n">ok</span> <span class="p">{</span>    <span class="c">// 判断numMap中是否存在 com值,index为com索引</span>
			<span class="k">return</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="p">}</span>       <span class="c">// 返回com索引(index),num索引(i)</span>
		<span class="p">}</span>
		<span class="n">numMap</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>                      <span class="c">// 存储num和它的索引</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{}</span>                               
<span class="p">}</span>

<span class="c">// @lc code=end</span>

</code></pre></div></div>

<h3 id="2-回文数">2 回文数</h3>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=9 lang=golang
 *
 * [9] 回文数
 */</span>

<span class="c">// @lc code=start</span>
<span class="k">func</span> <span class="n">isPalindrome</span><span class="p">(</span><span class="n">x</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">false</span>                       <span class="c">// 负数不可能是回文数</span>
	<span class="p">}</span>


	<span class="k">var</span> <span class="n">r</span> <span class="kt">int</span>                           
	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="n">x</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">/=</span> <span class="m">10</span> <span class="p">{</span>               
		<span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="m">10</span> <span class="o">+</span> <span class="n">i</span><span class="o">%</span><span class="m">10</span>                   <span class="c">// 将x的每一位数取出来，加到r的末尾</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">r</span> <span class="o">==</span> <span class="n">x</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="3-罗马数字转整数">3 罗马数字转整数</h3>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=13 lang=golang
 *
 * [13] 罗马数字转整数
 */</span>

<span class="c">// @lc code=start</span>
<span class="k">func</span> <span class="n">romanToInt</span><span class="p">(</span><span class="n">s</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="n">mapSymbol</span> <span class="o">:=</span> <span class="k">map</span><span class="p">[</span><span class="kt">byte</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span>               <span class="c">//  映射集合</span>
		<span class="sc">'I'</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span>
		<span class="sc">'V'</span><span class="o">:</span> <span class="m">5</span><span class="p">,</span>
		<span class="sc">'X'</span><span class="o">:</span> <span class="m">10</span><span class="p">,</span>
		<span class="sc">'L'</span><span class="o">:</span> <span class="m">50</span><span class="p">,</span>
		<span class="sc">'C'</span><span class="o">:</span> <span class="m">100</span><span class="p">,</span>
		<span class="sc">'D'</span><span class="o">:</span> <span class="m">500</span><span class="p">,</span>
		<span class="sc">'M'</span><span class="o">:</span> <span class="m">1000</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="k">var</span> <span class="n">result</span> <span class="kt">int</span>
	<span class="n">prev</span> <span class="o">:=</span> <span class="m">0</span>

	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span> <span class="p">{</span>         
		<span class="n">curr</span> <span class="o">:=</span> <span class="n">mapSymbol</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>          <span class="c">// 获取当前数字</span>
		<span class="k">if</span> <span class="n">curr</span> <span class="o">&lt;</span> <span class="n">prev</span> <span class="p">{</span>                 <span class="c">// 当前值小于前值,表示的是一个减法，就从结果中减去当前整数</span>
			<span class="n">result</span> <span class="o">-=</span> <span class="n">curr</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">+=</span> <span class="n">curr</span>           <span class="c">// 表示的是一个加法，就将当前整数加到结果中</span>
		<span class="p">}</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">curr</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="4-最长公共前缀">4 最长公共前缀</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=14 lang=golang
 *
 * [14] 最长公共前缀
 */</span>

<span class="c">// @lc code=start</span>

<span class="k">func</span> <span class="n">longestCommonPrefix</span><span class="p">(</span><span class="n">strs</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strs</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">""</span>                                    <span class="c">//空strs返回空字符串           </span>
	<span class="p">}</span>
	<span class="n">prefix</span> <span class="o">:=</span> <span class="n">strs</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>                                    <span class="c">// 取strs第一个字符串作为前缀匹配</span>
	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">strs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">for</span> <span class="o">!</span><span class="n">strings</span><span class="o">.</span><span class="n">HasPrefix</span><span class="p">(</span><span class="n">strs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">prefix</span><span class="p">)</span> <span class="p">{</span>  
			<span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span><span class="p">[</span><span class="o">:</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="o">-</span><span class="m">1</span><span class="p">]</span>      <span class="c">// 依次对比剩余字符串,如未匹配则减少一位</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
				<span class="k">return</span> <span class="s">""</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">prefix</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="5-有效的括号">5 有效的括号</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=20 lang=golang
 *
 * [20] 有效的括号
 */</span>

<span class="c">// @lc code=start</span>
<span class="k">func</span> <span class="n">isValid</span><span class="p">(</span><span class="n">s</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="n">stack</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">rune</span><span class="p">{}</span>

	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">s</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'('</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'{'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'['</span> <span class="p">{</span>
			<span class="n">stack</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>                                <span class="c">// 入栈 </span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">')'</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="o">||</span> <span class="n">stack</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">-</span><span class="m">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'('</span> <span class="p">{</span>
				<span class="k">return</span> <span class="no">false</span>
			<span class="p">}</span>
			<span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">:</span><span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">-</span><span class="m">1</span><span class="p">]</span>                            <span class="c">// 出栈</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'}'</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="o">||</span> <span class="n">stack</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">-</span><span class="m">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'{'</span> <span class="p">{</span>
				<span class="k">return</span> <span class="no">false</span>
			<span class="p">}</span>
			<span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">:</span><span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">-</span><span class="m">1</span><span class="p">]</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">']'</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="o">||</span> <span class="n">stack</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">-</span><span class="m">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'['</span> <span class="p">{</span>
				<span class="k">return</span> <span class="no">false</span>
			<span class="p">}</span>
			<span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">:</span><span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">-</span><span class="m">1</span><span class="p">]</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>

</code></pre></div></div>

<h3 id="6-合并两个有序链表">6 合并两个有序链表</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=21 lang=golang
 *
 * [21] 合并两个有序链表
 */</span>

<span class="c">// @lc code=start</span>
<span class="c">/**
 * Definition for singly-linked list.
 * type ListNode struct {
 *     Val int
 *     Next *ListNode
 * }
 */</span>
<span class="k">func</span> <span class="n">mergeTwoLists</span><span class="p">(</span><span class="n">list1</span> <span class="o">*</span><span class="n">ListNode</span><span class="p">,</span> <span class="n">list2</span> <span class="o">*</span><span class="n">ListNode</span><span class="p">)</span> <span class="o">*</span><span class="n">ListNode</span> <span class="p">{</span>
	<span class="n">linklist</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">ListNode</span><span class="p">{}</span>
	<span class="n">cur</span> <span class="o">:=</span> <span class="n">linklist</span>

	<span class="k">for</span> <span class="n">list1</span> <span class="o">!=</span> <span class="no">nil</span> <span class="o">&amp;&amp;</span> <span class="n">list2</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">list1</span><span class="o">.</span><span class="n">Val</span> <span class="o">&lt;=</span> <span class="n">list2</span><span class="o">.</span><span class="n">Val</span> <span class="p">{</span>
			<span class="n">cur</span><span class="o">.</span><span class="n">Next</span> <span class="o">=</span> <span class="n">list1</span>
			<span class="n">list1</span> <span class="o">=</span> <span class="n">list1</span><span class="o">.</span><span class="n">Next</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cur</span><span class="o">.</span><span class="n">Next</span> <span class="o">=</span> <span class="n">list2</span>
			<span class="n">list2</span> <span class="o">=</span> <span class="n">list2</span><span class="o">.</span><span class="n">Next</span>
		<span class="p">}</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">Next</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="n">list1</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">cur</span><span class="o">.</span><span class="n">Next</span> <span class="o">=</span> <span class="n">list1</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="n">list2</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">cur</span><span class="o">.</span><span class="n">Next</span> <span class="o">=</span> <span class="n">list2</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">linklist</span><span class="o">.</span><span class="n">Next</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="7-删除有序数组中的重复项">7 删除有序数组中的重复项</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=26 lang=golang
 *
 * [26] 删除有序数组中的重复项
 */</span>

<span class="c">// @lc code=start</span>
<span class="k">func</span> <span class="n">removeDuplicates</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="n">i</span> <span class="o">:=</span> <span class="m">0</span>
	<span class="k">for</span> <span class="n">j</span> <span class="o">:=</span> <span class="m">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">++</span>
			<span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="m">1</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="8-移除元素">8 移除元素</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">removeElement</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">val</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="m">0</span>
	<span class="p">}</span>

	<span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">:=</span> <span class="m">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span><span class="o">-</span><span class="m">1</span>
	<span class="k">for</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">j</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">val</span> <span class="p">{</span>
			<span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">j</span><span class="o">--</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">++</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="9-搜索插入位置">9 搜索插入位置</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=35 lang=golang
 *
 * [35] 搜索插入位置
 */</span>

<span class="c">// @lc code=start</span>
<span class="k">func</span> <span class="n">searchInsert</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">target</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">:=</span> <span class="m">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span><span class="o">-</span><span class="m">1</span>
	<span class="k">for</span> <span class="n">left</span> <span class="o">&lt;=</span> <span class="n">right</span> <span class="p">{</span>
		<span class="n">mid</span> <span class="o">:=</span> <span class="p">(</span><span class="n">right</span> <span class="o">+</span> <span class="n">left</span><span class="p">)</span> <span class="o">/</span> <span class="m">2</span>
		<span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span> <span class="o">==</span> <span class="n">target</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">mid</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">target</span> <span class="p">{</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="m">1</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">right</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">-</span> <span class="m">1</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">left</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="10-最后一个单词的长度">10 最后一个单词的长度</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=58 lang=golang
 *
 * [58] 最后一个单词的长度
 */</span>

<span class="c">// @lc code=start</span>
<span class="k">func</span> <span class="n">lengthOfLastWord</span><span class="p">(</span><span class="n">s</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="n">end</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="m">1</span>
	<span class="k">for</span> <span class="n">s</span><span class="p">[</span><span class="n">end</span><span class="p">]</span> <span class="o">==</span> <span class="sc">' '</span> <span class="o">&amp;&amp;</span> <span class="n">end</span> <span class="o">&gt;=</span> <span class="m">0</span> <span class="p">{</span>
		<span class="n">end</span><span class="o">--</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="m">0</span>
	<span class="p">}</span>
	<span class="n">start</span> <span class="o">:=</span> <span class="n">end</span>
	<span class="k">for</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">' '</span> <span class="p">{</span>
		<span class="n">start</span><span class="o">--</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="11-加一">11 加一</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=66 lang=golang
 *
 * [66] 加一
 */</span>

<span class="c">// @lc code=start</span>
<span class="k">func</span> <span class="n">plusOne</span><span class="p">(</span><span class="n">digits</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span> <span class="p">[]</span><span class="kt">int</span> <span class="p">{</span>
	<span class="n">dLen</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="n">dLen</span> <span class="o">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span> <span class="p">{</span>
		<span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">++</span>
		<span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%=</span> <span class="m">10</span>
		<span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">digits</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">append</span><span class="p">([]</span><span class="kt">int</span><span class="p">{</span><span class="m">1</span><span class="p">},</span> <span class="n">digits</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="12-二进制求和">12 二进制求和</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=67 lang=golang
 *
 * [67] 二进制求和
 */</span>

<span class="c">// @lc code=start</span>
<span class="k">func</span> <span class="n">addBinary</span><span class="p">(</span><span class="n">a</span> <span class="kt">string</span><span class="p">,</span> <span class="n">b</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="n">aLen</span><span class="p">,</span> <span class="n">bLen</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">-</span><span class="m">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">-</span><span class="m">1</span>
	<span class="n">carry</span> <span class="o">:=</span> <span class="m">0</span>
	<span class="n">res</span> <span class="o">:=</span> <span class="s">""</span>
	<span class="k">for</span> <span class="n">aLen</span> <span class="o">&gt;=</span> <span class="m">0</span> <span class="o">||</span> <span class="n">bLen</span> <span class="o">&gt;=</span> <span class="m">0</span> <span class="p">{</span>
		<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">:=</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span>
		<span class="k">if</span> <span class="n">aLen</span> <span class="o">&gt;=</span> <span class="m">0</span> <span class="p">{</span>
			<span class="n">x</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">aLen</span><span class="p">]</span> <span class="o">-</span> <span class="sc">'0'</span><span class="p">)</span>
			<span class="n">aLen</span><span class="o">--</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="n">bLen</span> <span class="o">&gt;=</span> <span class="m">0</span> <span class="p">{</span>
			<span class="n">y</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">bLen</span><span class="p">]</span> <span class="o">-</span> <span class="sc">'0'</span><span class="p">)</span>
			<span class="n">bLen</span><span class="o">--</span>
		<span class="p">}</span>
		<span class="n">sum</span> <span class="o">:=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">carry</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Itoa</span><span class="p">(</span><span class="n">sum</span><span class="o">%</span><span class="m">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">res</span> <span class="c">// 对 2 取模就是当前位的值</span>
		<span class="n">carry</span> <span class="o">=</span> <span class="n">sum</span> <span class="o">/</span> <span class="m">2</span>                 <span class="c">// 对 2 取整就是进位的值</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">carry</span> <span class="o">==</span> <span class="m">1</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="s">"1"</span> <span class="o">+</span> <span class="n">res</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="13-x-的平方根">13 x 的平方根</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=69 lang=golang
 *
 * [69] x 的平方根
 */</span>

<span class="c">// @lc code=start</span>
<span class="k">func</span> <span class="n">mySqrt</span><span class="p">(</span><span class="n">x</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="m">1</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">x</span>
	<span class="p">}</span>
	<span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">:=</span> <span class="m">1</span><span class="p">,</span> <span class="n">x</span>
	<span class="k">for</span> <span class="n">left</span> <span class="o">&lt;=</span> <span class="n">right</span> <span class="p">{</span>
		<span class="n">mid</span> <span class="o">:=</span> <span class="n">left</span> <span class="o">+</span> <span class="p">(</span><span class="n">right</span><span class="o">-</span><span class="n">left</span><span class="p">)</span><span class="o">/</span><span class="m">2</span>
		<span class="k">if</span> <span class="n">mid</span><span class="o">*</span><span class="n">mid</span> <span class="o">==</span> <span class="n">x</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">mid</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">mid</span><span class="o">*</span><span class="n">mid</span> <span class="o">&gt;</span> <span class="n">x</span> <span class="p">{</span>
			<span class="n">right</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">-</span> <span class="m">1</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="m">1</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">right</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="14-爬楼梯">14 爬楼梯</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=70 lang=golang
 *
 * [70] 爬楼梯
 */</span>

<span class="c">// @lc code=start</span>
<span class="k">func</span> <span class="n">climbStairs</span><span class="p">(</span><span class="n">n</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="m">2</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">n</span>
	<span class="p">}</span>
	<span class="n">f1</span><span class="p">,</span> <span class="n">f2</span> <span class="o">:=</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span>
	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="n">f3</span> <span class="o">:=</span> <span class="n">f1</span> <span class="o">+</span> <span class="n">f2</span> <span class="c">//f(n) = f(n-1) + f(n-2)</span>
		<span class="n">f1</span> <span class="o">=</span> <span class="n">f2</span>       <span class="c">//f(n-2)</span>
		<span class="n">f2</span> <span class="o">=</span> <span class="n">f3</span>       <span class="c">//f(n-1)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">f2</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="15-删除排序链表中的重复元素">15 删除排序链表中的重复元素</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=83 lang=golang
 *
 * [83] 删除排序链表中的重复元素
 */</span>

<span class="c">// @lc code=start</span>
<span class="c">/**
 * Definition for singly-linked list.
 * type ListNode struct {
 *     Val int
 *     Next *ListNode
 * }
 */</span>
<span class="k">func</span> <span class="n">deleteDuplicates</span><span class="p">(</span><span class="n">head</span> <span class="o">*</span><span class="n">ListNode</span><span class="p">)</span> <span class="o">*</span><span class="n">ListNode</span> <span class="p">{</span>
	<span class="n">cur</span> <span class="o">:=</span> <span class="n">head</span>
	<span class="k">for</span> <span class="n">cur</span> <span class="o">!=</span> <span class="no">nil</span> <span class="o">&amp;&amp;</span> <span class="n">cur</span><span class="o">.</span><span class="n">Next</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">Val</span> <span class="o">==</span> <span class="n">cur</span><span class="o">.</span><span class="n">Next</span><span class="o">.</span><span class="n">Val</span> <span class="p">{</span>
			<span class="n">cur</span><span class="o">.</span><span class="n">Next</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">Next</span><span class="o">.</span><span class="n">Next</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">Next</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">head</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="16-合并两个有序数组">16 合并两个有序数组</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=88 lang=golang
 *
 * [88] 合并两个有序数组
 */</span>

<span class="c">// @lc code=start</span>
<span class="k">func</span> <span class="n">merge</span><span class="p">(</span><span class="n">nums1</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">m</span> <span class="kt">int</span><span class="p">,</span> <span class="n">nums2</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">n</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ms</span><span class="p">,</span> <span class="n">ns</span> <span class="o">:=</span> <span class="n">m</span><span class="o">-</span><span class="m">1</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="m">1</span>
	<span class="n">totalLen</span> <span class="o">:=</span> <span class="n">m</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="m">1</span>
	<span class="k">for</span> <span class="n">ms</span> <span class="o">&gt;=</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="n">ns</span> <span class="o">&gt;=</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">nums1</span><span class="p">[</span><span class="n">ms</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nums2</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="p">{</span>
			<span class="n">nums1</span><span class="p">[</span><span class="n">totalLen</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums1</span><span class="p">[</span><span class="n">ms</span><span class="p">]</span>
			<span class="n">ms</span><span class="o">--</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nums1</span><span class="p">[</span><span class="n">totalLen</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums2</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span>
			<span class="n">ns</span><span class="o">--</span>
		<span class="p">}</span>
		<span class="n">totalLen</span><span class="o">--</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="n">ns</span> <span class="o">&gt;=</span> <span class="m">0</span> <span class="p">{</span>
		<span class="n">nums1</span><span class="p">[</span><span class="n">totalLen</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums2</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span>
		<span class="n">totalLen</span><span class="o">--</span>
		<span class="n">ns</span><span class="o">--</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="17-二叉树的中序遍历">17 二叉树的中序遍历</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=94 lang=golang
 *
 * [94] 二叉树的中序遍历
 */</span>

<span class="c">// @lc code=start</span>
<span class="c">/**
 * Definition for a binary tree node.
 * type TreeNode struct {
 *     Val int
 *     Left *TreeNode
 *     Right *TreeNode
 * }
 */</span>
<span class="k">func</span> <span class="n">inorderTraversal</span><span class="p">(</span><span class="n">root</span> <span class="o">*</span><span class="n">TreeNode</span><span class="p">)</span> <span class="p">[]</span><span class="kt">int</span> <span class="p">{</span>
	<span class="c">//左子树 -&gt; 根节点 -&gt; 右子树</span>
	<span class="n">res</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">res</span>
	<span class="p">}</span>
	<span class="n">res</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">inorderTraversal</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
	<span class="n">res</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">root</span><span class="o">.</span><span class="n">Val</span><span class="p">)</span>
	<span class="n">res</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">inorderTraversal</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">res</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="18-相同的树">18 相同的树</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=100 lang=golang
 *
 * [100] 相同的树
 */</span>

<span class="c">// @lc code=start</span>
<span class="c">/**
 * Definition for a binary tree node.
 * type TreeNode struct {
 *     Val int
 *     Left *TreeNode
 *     Right *TreeNode
 * }
 */</span>
<span class="k">func</span> <span class="n">isSameTree</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">TreeNode</span><span class="p">,</span> <span class="n">q</span> <span class="o">*</span><span class="n">TreeNode</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="no">nil</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">true</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="no">nil</span> <span class="o">||</span> <span class="n">q</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">false</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">Val</span> <span class="o">!=</span> <span class="n">q</span><span class="o">.</span><span class="n">Val</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">false</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">isSameTree</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">Left</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isSameTree</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">Right</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="19-对称二叉树">19 对称二叉树</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=101 lang=golang
 *
 * [101] 对称二叉树
 */</span>

<span class="c">// @lc code=start</span>
<span class="c">/**
 * Definition for a binary tree node.
 * type TreeNode struct {
 *     Val int
 *     Left *TreeNode
 *     Right *TreeNode
 * }
 */</span>

<span class="k">func</span> <span class="n">isMirror</span><span class="p">(</span><span class="n">left</span> <span class="o">*</span><span class="n">TreeNode</span><span class="p">,</span> <span class="n">right</span> <span class="o">*</span><span class="n">TreeNode</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">left</span> <span class="o">==</span> <span class="no">nil</span> <span class="o">&amp;&amp;</span> <span class="n">right</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">true</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">left</span> <span class="o">==</span> <span class="no">nil</span> <span class="o">||</span> <span class="n">right</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">false</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">Val</span> <span class="o">!=</span> <span class="n">right</span><span class="o">.</span><span class="n">Val</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">false</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">isMirror</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">Left</span><span class="p">,</span> <span class="n">right</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isMirror</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">Right</span><span class="p">,</span> <span class="n">right</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">isSymmetric</span><span class="p">(</span><span class="n">root</span> <span class="o">*</span><span class="n">TreeNode</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">isMirror</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>

<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="20-二叉树的最大深度">20 二叉树的最大深度</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=104 lang=golang
 *
 * [104] 二叉树的最大深度
 */</span>

<span class="c">// @lc code=start</span>
<span class="c">/**
 * Definition for a binary tree node.
 * type TreeNode struct {
 *     Val int
 *     Left *TreeNode
 *     Right *TreeNode
 * }
 */</span>

<span class="k">func</span> <span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">x</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">y</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">maxDepth</span><span class="p">(</span><span class="n">root</span> <span class="o">*</span><span class="n">TreeNode</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="m">0</span>
	<span class="p">}</span>
	<span class="n">leftDepth</span> <span class="o">:=</span> <span class="n">maxDepth</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span>
	<span class="n">rightDepth</span> <span class="o">:=</span> <span class="n">maxDepth</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">max</span><span class="p">(</span><span class="n">leftDepth</span><span class="p">,</span> <span class="n">rightDepth</span><span class="p">)</span> <span class="o">+</span> <span class="m">1</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="21-将有序数组转换为二叉搜索树">21 将有序数组转换为二叉搜索树</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=108 lang=golang
 *
 * [108] 将有序数组转换为二叉搜索树
 */</span>

<span class="c">// @lc code=start</span>
<span class="c">/**
 * Definition for a binary tree node.
 * type TreeNode struct {
 *     Val int
 *     Left *TreeNode
 *     Right *TreeNode
 * }
 */</span>
<span class="k">func</span> <span class="n">sortedArrayToBST</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="n">TreeNode</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">nil</span>
	<span class="p">}</span>
	<span class="n">mid</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span> <span class="o">/</span> <span class="m">2</span>
	<span class="n">root</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">TreeNode</span><span class="p">{</span><span class="n">Val</span><span class="o">:</span> <span class="n">nums</span><span class="p">[</span><span class="n">mid</span><span class="p">]}</span>           <span class="c">//根节点是数组的中间元素</span>
	<span class="n">root</span><span class="o">.</span><span class="n">Left</span> <span class="o">=</span> <span class="n">sortedArrayToBST</span><span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="o">:</span><span class="n">mid</span><span class="p">])</span>    <span class="c">//左边的元素作为左子树</span>
	<span class="n">root</span><span class="o">.</span><span class="n">Right</span> <span class="o">=</span> <span class="n">sortedArrayToBST</span><span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="n">mid</span><span class="o">+</span><span class="m">1</span><span class="o">:</span><span class="p">])</span> <span class="c">//右边的元素作为右子树</span>
	<span class="k">return</span> <span class="n">root</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="22-平衡二叉树">22 平衡二叉树</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=110 lang=golang
 *
 * [110] 平衡二叉树
 */</span>

<span class="c">// @lc code=start</span>
<span class="c">/**
 * Definition for a binary tree node.
 * type TreeNode struct {
 *     Val int
 *     Left *TreeNode
 *     Right *TreeNode
 * }
 */</span>

<span class="k">func</span> <span class="n">abs</span><span class="p">(</span><span class="n">a</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">a</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">a</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">a</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">b</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">maxDepth</span><span class="p">(</span><span class="n">root</span> <span class="o">*</span><span class="n">TreeNode</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="m">0</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">max</span><span class="p">(</span><span class="n">maxDepth</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">Left</span><span class="p">),</span> <span class="n">maxDepth</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">Right</span><span class="p">))</span> <span class="o">+</span> <span class="m">1</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">isBalanced</span><span class="p">(</span><span class="n">root</span> <span class="o">*</span><span class="n">TreeNode</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">true</span>
	<span class="p">}</span>
	<span class="n">leftDepth</span> <span class="o">:=</span> <span class="n">maxDepth</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span>
	<span class="n">rightDepth</span> <span class="o">:=</span> <span class="n">maxDepth</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">abs</span><span class="p">(</span><span class="n">leftDepth</span><span class="o">-</span><span class="n">rightDepth</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">1</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">false</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">isBalanced</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isBalanced</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>

<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="23-二叉树的最小深度">23 二叉树的最小深度</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=111 lang=golang
 *
 * [111] 二叉树的最小深度
 */</span>

<span class="c">// @lc code=start</span>
<span class="c">/**
 * Definition for a binary tree node.
 * type TreeNode struct {
 *     Val int
 *     Left *TreeNode
 *     Right *TreeNode
 * }
 */</span>

<span class="k">func</span> <span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">a</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">b</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">minDepth</span><span class="p">(</span><span class="n">root</span> <span class="o">*</span><span class="n">TreeNode</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="m">0</span>
	<span class="p">}</span>
	<span class="n">leftDepth</span> <span class="o">:=</span> <span class="n">minDepth</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span>
	<span class="n">rightDepth</span> <span class="o">:=</span> <span class="n">minDepth</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">leftDepth</span> <span class="o">==</span> <span class="m">0</span> <span class="o">||</span> <span class="n">rightDepth</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">leftDepth</span> <span class="o">+</span> <span class="n">rightDepth</span> <span class="o">+</span> <span class="m">1</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="m">1</span> <span class="o">+</span> <span class="n">min</span><span class="p">(</span><span class="n">leftDepth</span><span class="p">,</span> <span class="n">rightDepth</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>

<h3 id="24-路径总和">24 路径总和</h3>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @lc app=leetcode.cn id=112 lang=golang
 *
 * [112] 路径总和
 */</span>

<span class="c">// @lc code=start</span>
<span class="c">/**
 * Definition for a binary tree node.
 * type TreeNode struct {
 *     Val int
 *     Left *TreeNode
 *     Right *TreeNode
 * }
 */</span>
<span class="k">func</span> <span class="n">hasPathSum</span><span class="p">(</span><span class="n">root</span> <span class="o">*</span><span class="n">TreeNode</span><span class="p">,</span> <span class="n">targetSum</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">false</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">Val</span> <span class="o">==</span> <span class="n">targetSum</span> <span class="o">&amp;&amp;</span> <span class="n">root</span><span class="o">.</span><span class="n">Left</span> <span class="o">==</span> <span class="no">nil</span> <span class="o">&amp;&amp;</span> <span class="n">root</span><span class="o">.</span><span class="n">Right</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">true</span>
	<span class="p">}</span>
	<span class="n">targetSum</span> <span class="o">-=</span> <span class="n">root</span><span class="o">.</span><span class="n">Val</span>
	<span class="k">return</span> <span class="n">hasPathSum</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">Left</span><span class="p">,</span> <span class="n">targetSum</span><span class="p">)</span> <span class="o">||</span> <span class="n">hasPathSum</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">Right</span><span class="p">,</span> <span class="n">targetSum</span><span class="p">)</span>

<span class="p">}</span>

<span class="c">// @lc code=end</span>
</code></pre></div></div>]]></content><author><name>Your Name</name></author><category term="leetcode" /><summary type="html"><![CDATA[1 两数之和]]></summary></entry><entry><title type="html">Job</title><link href="/kubernetes-kubeadm-job/" rel="alternate" type="text/html" title="Job" /><published>2022-12-15T00:00:00+08:00</published><updated>2022-12-15T00:00:00+08:00</updated><id>/kubernetes-kubeadm-job</id><content type="html" xml:base="/kubernetes-kubeadm-job/"><![CDATA[<p>Job</p>

<p>临时使用或者是定期运行的工作,可以通过 cronjob实现</p>

<h3 id="创建及删除job">创建及删除job</h3>

<p>job用于临时性任务,成功则job结束，失败则创建新的或者重启pod</p>

<h4 id="创建空间">创建空间</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create ns nsjob
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl create ns nsjob
namespace/nsjob created
<span class="o">[</span>root@master probe]# kubens nsjob
Context <span class="s2">"kubernetes-admin@kubernetes"</span> modified.
Active namespace is <span class="s2">"nsjob"</span><span class="nb">.</span>
</code></pre></div></div>

<h4 id="创建job">创建job</h4>

<p>两种方式,命令行或者是生成yaml,建议命令行生成yaml再修改生成job</p>

<p>kubectl create job 名字 –image=镜像 – “命令”</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create job job1 <span class="nt">--image</span><span class="o">=</span>busybox <span class="nt">--dry-run</span><span class="o">=</span>client <span class="nt">-o</span> yaml <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s2">"echo hello &amp;&amp; sleep 10"</span> <span class="o">&gt;</span> job.yaml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">job1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">sh</span>
        <span class="pi">-</span> <span class="s">-c</span>
        <span class="pi">-</span> <span class="s">echo hello &amp;&amp; sleep </span><span class="m">10</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">busybox</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">job1</span>
        <span class="na">resources</span><span class="pi">:</span> <span class="pi">{}</span>
      <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Never</span>
<span class="na">status</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre></div></div>

<p>增加IfNotPresent</p>

<p>job的restart 策略有两种:</p>

<ul>
  <li>Never: 只要任务没有完成,则新创建pod运行，知道job完成,会产生多个pod</li>
  <li>OnFailure: 只要pod没有完成, 就会重启pod,重新执行任务</li>
</ul>

<h4 id="创建job-1">创建job</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl apply <span class="nt">-f</span> job.yaml 
job.batch/job1 created
</code></pre></div></div>

<h4 id="查看job状态">查看job状态</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl get <span class="nb">jobs
</span>NAME   COMPLETIONS   DURATION   AGE
job1   1/1           11s        34s
</code></pre></div></div>

<p>1/1显示完成</p>

<h4 id="删除pod">删除pod</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl delete job job1
job.batch <span class="s2">"job1"</span> deleted
</code></pre></div></div>

<h4 id="job中指定参数">job中指定参数</h4>

<p>parallelism: N  并行运行N个pod，parallelism的值 不会超过completions</p>

<p>completions: M  job测试多次的话,要有M次要成功才算成功,即要有M个状态为Complete的pod,如果没有就重复执行</p>

<p>backoffLimit: N  如果job失败,则重试几次</p>

<p>activeDeadlineSeconds: N  job运行的最长时间，单位: 秒</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">job1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">parallelism</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">completions</span><span class="pi">:</span> <span class="m">6</span>
  <span class="na">backoffLimit</span><span class="pi">:</span> <span class="m">4</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">sh</span>
        <span class="pi">-</span> <span class="s">-c</span>
        <span class="pi">-</span> <span class="s">echo hello &amp;&amp; sleep </span><span class="m">10</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">busybox</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">job1</span>
        <span class="na">resources</span><span class="pi">:</span> <span class="pi">{}</span>
      <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Never</span>
<span class="na">status</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre></div></div>

<p>并行设置3个,要有6个pod处于完成状态才可以</p>

<h4 id="创建">创建</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl apply <span class="nt">-f</span> job.yaml 
job.batch/job1 created
</code></pre></div></div>

<h4 id="查看pod">查看pod</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl get pods
NAME         READY   STATUS      RESTARTS   AGE
job1-9m4rl   0/1     Completed   0          17s
job1-hhm75   1/1     Running     0          5s
job1-l9kqn   1/1     Running     0          5s
job1-pw7kk   0/1     Completed   0          17s
job1-qmdxd   0/1     Completed   0          17s
job1-rm44q   1/1     Running     0          5s
</code></pre></div></div>

<p>有三个运行的job</p>

<h4 id="查看job">查看job</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl get <span class="nb">jobs
</span>NAME   COMPLETIONS   DURATION   AGE
job1   6/6           24s        68s
</code></pre></div></div>

<h4 id="再次看pod的状态">再次看pod的状态</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl get pods
NAME         READY   STATUS      RESTARTS   AGE
job1-9m4rl   0/1     Completed   0          95s
job1-hhm75   0/1     Completed   0          83s
job1-l9kqn   0/1     Completed   0          83s
job1-pw7kk   0/1     Completed   0          95s
job1-qmdxd   0/1     Completed   0          95s
job1-rm44q   0/1     Completed   0          83s
</code></pre></div></div>

<h4 id="删除">删除</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl delete <span class="nt">-f</span> job.yaml 
job.batch <span class="s2">"job1"</span> deleted
</code></pre></div></div>

<h4 id="测试失败">测试失败</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">job1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">parallelism</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">completions</span><span class="pi">:</span> <span class="m">6</span>
  <span class="na">backoffLimit</span><span class="pi">:</span> <span class="m">4</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">sh</span>
        <span class="pi">-</span> <span class="s">-c</span>
        <span class="pi">-</span> <span class="s">echoX hello &amp;&amp; sleep </span><span class="m">10</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">busybox</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">job1</span>
        <span class="na">resources</span><span class="pi">:</span> <span class="pi">{}</span>
      <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Never</span>
<span class="na">status</span><span class="pi">:</span> <span class="pi">{}</span>
<span class="s">~</span>              
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl apply <span class="nt">-f</span> job.yaml 
job.batch/job1 created
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl get pods
NAME         READY   STATUS   RESTARTS   AGE
job1-6858m   0/1     Error    0          6s
job1-dbpgx   0/1     Error    0          9s
job1-gndds   0/1     Error    0          8s
job1-nb9gr   0/1     Error    0          8s
job1-xh45n   0/1     Error    0          9s
job1-xnhqb   0/1     Error    0          9s
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl delete <span class="nt">-f</span> job.yaml 
job.batch <span class="s2">"job1"</span> deleted
</code></pre></div></div>

<h3 id="创建及删除cronjob">创建及删除cronjob</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl get cj
No resources found <span class="k">in </span>nsjob namespace.
</code></pre></div></div>

<h4 id="命令创建">命令创建</h4>

<p>kubectl create cj 名字 –image=镜像 –schedule=”*/1 * * * *” – /bin/sh -c “命令”</p>

<p>–schedule 定时</p>

<h4 id="yaml创建">yaml创建</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl create cj job2 <span class="nt">--image</span><span class="o">=</span>busybox <span class="nt">--schedule</span><span class="o">=</span><span class="s2">"*/1 * * * *"</span> <span class="nt">--dry-run</span><span class="o">=</span>client <span class="nt">-o</span> yaml <span class="nt">--</span> /bin/sh <span class="nt">-c</span> <span class="s2">"echo hello world"</span> <span class="o">&gt;</span> job2.yaml
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: batch/v1
kind: CronJob
metadata:
  creationTimestamp: null
  name: job2
spec:
  jobTemplate:
    metadata:
      creationTimestamp: null
      name: job2
    spec:
      template:
        metadata:
          creationTimestamp: null
        spec:
          containers:
          - <span class="nb">command</span>:
            - /bin/sh
            - <span class="nt">-c</span>
            - <span class="nb">echo </span>hello world
            image: busybox
            name: job2
            resources: <span class="o">{}</span>
          restartPolicy: OnFailure
  schedule: <span class="s1">'*/1 * * * *'</span>
status: <span class="o">{}</span>
</code></pre></div></div>

<h4 id="创建-1">创建</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl apply <span class="nt">-f</span> job2.yaml 
cronjob.batch/job2 created
</code></pre></div></div>

<h4 id="查看">查看</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl get cj
NAME   SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
job2   <span class="k">*</span>/1 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span>   False     0        &lt;none&gt;          10s
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl get pods
NAME                  READY   STATUS              RESTARTS   AGE
job2-27642647-th984   0/1     ContainerCreating   0          21s
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl get pods
NAME                  READY   STATUS      RESTARTS   AGE
job2-27642647-th984   0/1     Completed   0          79s
job2-27642648-wgkzc   0/1     Completed   0          19s
</code></pre></div></div>

<h4 id="删除-1">删除</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl delete <span class="nt">-f</span> job2.yaml 
cronjob.batch <span class="s2">"job2"</span> deleted
</code></pre></div></div>]]></content><author><name>Your Name</name></author><category term="Kubernetes" /><summary type="html"><![CDATA[Job]]></summary></entry><entry><title type="html">探针</title><link href="/kubernetes-kubeadm-probe/" rel="alternate" type="text/html" title="探针" /><published>2022-11-20T00:00:00+08:00</published><updated>2022-11-20T00:00:00+08:00</updated><id>/kubernetes-kubeadm-probe</id><content type="html" xml:base="/kubernetes-kubeadm-probe/"><![CDATA[<p>probe</p>

<h3 id="为pod配置liveness探针">为pod配置liveness探针</h3>

<p>deployment 只能保证pod的状态为running,内部服务状态无法保证</p>

<table>
  <thead>
    <tr>
      <th>deployment</th>
      <th>检测你出勤了没有</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>probe</td>
      <td>检查你是否在工作</td>
    </tr>
  </tbody>
</table>

<p>liveness 检查到某个pod运行有问题,就会重启，实际就是创建一个同名的Pod</p>

<h4 id="command探测">command探测</h4>

<p>容器内部执行命令,返回0 正常，0 异常</p>

<h4 id="创建目录">创建目录</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>probe
<span class="nb">cd </span>probe
</code></pre></div></div>

<h4 id="创建namespace">创建namespace</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl create ns nsprobe
namespace/nsprobe created
<span class="o">[</span>root@master probe]# kubens nsprobe
Context <span class="s2">"kubernetes-admin@kubernetes"</span> modified.
Active namespace is <span class="s2">"nsprobe"</span><span class="nb">.</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span>  <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span>  <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">test</span><span class="pi">:</span>  <span class="s">liveness</span>
  <span class="na">name</span><span class="pi">:</span>  <span class="s">liveness-exec</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span>  <span class="s">liveness</span>
    <span class="na">image</span><span class="pi">:</span>  <span class="s">busybox</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span>  <span class="s">IfNotPresent</span>
    <span class="na">args</span><span class="pi">:</span>
    <span class="pi">-</span>  <span class="s">/bin/sh</span>
    <span class="pi">-</span>  <span class="s">-c</span>
    <span class="pi">-</span>  <span class="s">touch /tmp/healthy; sleep 30 ; rm -rf /tmp/healthy; sleep </span><span class="m">1000</span>
    <span class="na">livenessProbe</span><span class="pi">:</span>
      <span class="na">exec</span><span class="pi">:</span>
        <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">cat</span>
        <span class="pi">-</span> <span class="s">/tmp/healthy</span>
      <span class="na">initialDelaySeconds</span><span class="pi">:</span>  <span class="m">5</span> <span class="c1"># 启动的5s内不探测</span>
      <span class="na">periodSeconds</span><span class="pi">:</span>  <span class="m">5</span> <span class="c1"># 每5s探测一次</span>
</code></pre></div></div>

<p>initialDelaySeconds: pod启动多少秒内不探测</p>

<p>periodSeconds: 探测间隔</p>

<p>successThreshold: 探测失败后,最少连续探测成功后多少次才被认定为成功,默认为1</p>

<p>failureThreshold: 探测失败后kubernetes的重拾次数 默认为3,最小值是1</p>

<h4 id="创建">创建</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl apply <span class="nt">-f</span> liveness1.yaml 
pod/liveness-exec created
</code></pre></div></div>

<h4 id="查看">查看</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl get pods
NAME            READY   STATUS    RESTARTS   AGE
liveness-exec   1/1     Running   2          2m53s
</code></pre></div></div>

<h4 id="检查tmphealthy是否存在">检查/tmp/healthy是否存在</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@master probe]# kubectl exec liveness-exec -- ls /tmp
[root@master probe]# kubectl get pods
NAME            READY   STATUS    RESTARTS   AGE
liveness-exec   1/1     Running   3          4m30s
</code></pre></div></div>

<p>这里healthy文件被删除了,pod被重建</p>

<h4 id="liveness-probe-httpget探测方式">liveness probe httpget探测方式</h4>

<p>http是否可以访问,下面是通过80端口访问到/usr/shar/nginx/html/index.html</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span>  <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span>  <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">test</span><span class="pi">:</span>  <span class="s">liveness</span>
  <span class="na">name</span><span class="pi">:</span>  <span class="s">liveness-http</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span>  <span class="s">liveness</span>
    <span class="na">image</span><span class="pi">:</span>  <span class="s">nginx</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span>  <span class="s">IfNotPresent</span>
    <span class="na">livenessProbe</span><span class="pi">:</span>
      <span class="na">failureThreshold</span><span class="pi">:</span>  <span class="m">3</span>
      <span class="na">httpGet</span><span class="pi">:</span>
        <span class="na">path</span><span class="pi">:</span>  <span class="s">/index.html</span>
        <span class="na">port</span><span class="pi">:</span>  <span class="m">80</span>
        <span class="na">scheme</span><span class="pi">:</span>  <span class="s">HTTP</span>
      <span class="na">initialDelaySeconds</span><span class="pi">:</span>  <span class="m">10</span>
      <span class="na">periodSeconds</span><span class="pi">:</span>  <span class="m">10</span>
      <span class="na">successThreshold</span><span class="pi">:</span>  <span class="m">1</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl apply <span class="nt">-f</span> liveness-http.yaml 
pod/liveness-http created
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl get pods
NAME            READY   STATUS             RESTARTS   AGE
liveness-exec   0/1     CrashLoopBackOff   7          14m
liveness-http   1/1     Running            0          87s
</code></pre></div></div>

<p>删除index.html</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl <span class="nb">exec</span> <span class="nt">-it</span> liveness-http <span class="nt">--</span> bash
root@liveness-http:/# <span class="nb">rm</span> <span class="nt">-rf</span> /usr/share/nginx/html/
50x.html    index.html  
root@liveness-http:/# <span class="nb">rm</span> <span class="nt">-rf</span> /usr/share/nginx/html/index.html 
root@liveness-http:/# 
<span class="nb">exit</span>
</code></pre></div></div>

<p>查看</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl <span class="nb">exec</span> <span class="nt">-it</span> liveness-http <span class="nt">--</span> <span class="nb">ls</span> /usr/share/nginx/html/
50x.html  index.html
</code></pre></div></div>

<p>index.html存在，证明pod已经重新拉起</p>

<h4 id="liveness-probe-tcpsocket的探测方式">liveness probe tcpsocket的探测方式</h4>

<p>是否可以tcp三次握手</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span>  <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span>  <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">test</span><span class="pi">:</span>  <span class="s">liveness</span>
  <span class="na">name</span><span class="pi">:</span>  <span class="s">liveness-tcp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span>  <span class="s">liveness</span>
    <span class="na">image</span><span class="pi">:</span>  <span class="s">nginx</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span>  <span class="s">IfNotPresent</span>
    <span class="na">livenessProbe</span><span class="pi">:</span>
      <span class="na">failureThreshold</span><span class="pi">:</span>  <span class="m">3</span>
      <span class="na">tcpSocket</span><span class="pi">:</span>
        <span class="na">port</span><span class="pi">:</span>  <span class="m">808</span>
      <span class="na">initialDelaySeconds</span><span class="pi">:</span>  <span class="m">5</span>
      <span class="na">periodSeconds</span><span class="pi">:</span>  <span class="m">5</span>
</code></pre></div></div>

<p>nginx 端口是80,这里探测808 肯定失败</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl apply <span class="nt">-f</span> liveness-tcp.yaml 
pod/liveness-tcp created
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl get pods
NAME            READY   STATUS             RESTARTS   AGE
liveness-exec   0/1     CrashLoopBackOff   9          23m
liveness-http   1/1     Running            1          9m33s
liveness-tcp    1/1     Running            1          30s
</code></pre></div></div>

<p>可以看到完成了一次重启</p>

<h4 id="删除">删除</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl delete pod liveness-exec
pod <span class="s2">"liveness-exec"</span> deleted
<span class="o">[</span>root@master probe]# kubectl delete pod liveness-http
pod <span class="s2">"liveness-http"</span> deleted
<span class="o">[</span>root@master probe]# kubectl delete pod liveness-tcp
pod <span class="s2">"liveness-tcp"</span> deleted
</code></pre></div></div>

<h3 id="为pod配置readliness探针">为pod配置readliness探针</h3>

<p>livenss:  探测到pod有问题后,通过重启pod来解决问题</p>

<p>readliness:  探测到pod有问题之后不重启,只是svc接受到请求后,不再转发请求到这个pod</p>

<h4 id="创建-1">创建</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span>  <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span>  <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">run</span><span class="pi">:</span>  <span class="s">app</span>
  <span class="na">name</span><span class="pi">:</span>  <span class="s">pod1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span>  <span class="s">c1</span>
    <span class="na">image</span><span class="pi">:</span>  <span class="s">nginx</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span>  <span class="s">IfNotPresent</span>
    <span class="na">lifecycle</span><span class="pi">:</span>
      <span class="na">postStart</span><span class="pi">:</span>
        <span class="na">exec</span><span class="pi">:</span>
          <span class="na">command</span><span class="pi">:</span>  <span class="pi">[</span><span class="s2">"</span><span class="s">/bin/bash"</span><span class="pi">,</span><span class="s2">"</span><span class="s">-c"</span><span class="pi">,</span><span class="s2">"</span><span class="s">touch</span><span class="nv"> </span><span class="s">/tmp/healthy"</span><span class="pi">]</span>
    <span class="na">readinessProbe</span><span class="pi">:</span>
      <span class="na">exec</span><span class="pi">:</span>
        <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">cat</span>
        <span class="pi">-</span> <span class="s">/tmp/healthy</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl apply <span class="nt">-f</span> readiness.yaml 
pod/pod1 created
<span class="o">[</span>root@master probe]# <span class="nb">sed</span> <span class="s1">'s/pod1/pod2/'</span> readiness.yaml | kubectl apply <span class="nt">-f</span> -
pod/pod2 created
<span class="o">[</span>root@master probe]# <span class="nb">sed</span> <span class="s1">'s/pod1/pod3/'</span> readiness.yaml | kubectl apply <span class="nt">-f</span> -
pod/pod3 created
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl get pods <span class="nt">--show-labels</span>
NAME   READY   STATUS    RESTARTS   AGE   LABELS
pod1   1/1     Running   0          58s   <span class="nv">run</span><span class="o">=</span>app
pod2   1/1     Running   0          20s   <span class="nv">run</span><span class="o">=</span>app
pod3   1/1     Running   0          15s   <span class="nv">run</span><span class="o">=</span>app
</code></pre></div></div>

<h4 id="创建svc">创建svc</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl expose <span class="nt">--name</span><span class="o">=</span>readsvc pod pod1 <span class="nt">--port</span><span class="o">=</span>80 <span class="nt">--selector</span><span class="o">=</span><span class="nv">run</span><span class="o">=</span>app
service/readsvc exposed
</code></pre></div></div>

<p>这里是为pod1创建svc,因为标签一样,所以readsvc会关联三个pod</p>

<h4 id="修改pod的-indexhtml">修改pod的 index.html</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl <span class="nb">exec</span> <span class="nt">-ti</span> pod1 <span class="nt">--</span> bash
root@pod1:/# <span class="nb">echo </span>111 <span class="o">&gt;</span> /usr/share/nginx/html/index.html 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl <span class="nb">exec</span> <span class="nt">-ti</span> pod2 <span class="nt">--</span> bash
root@pod2:/# <span class="nb">echo </span>222 <span class="o">&gt;</span> /usr/share/nginx/html/index.html 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl <span class="nb">exec</span> <span class="nt">-ti</span> pod3 <span class="nt">--</span> bash
root@pod3:/# <span class="nb">echo </span>333 <span class="o">&gt;</span> /usr/share/nginx/html/index.html
</code></pre></div></div>

<h4 id="获取svc的ip地址">获取svc的IP地址</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl get svc readsvc
NAME      TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
readsvc   ClusterIP   10.102.65.92   &lt;none&gt;        80/TCP    3m28s
</code></pre></div></div>

<h4 id="访问测试">访问测试</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# curl <span class="nt">-s</span> 10.102.65.92
111
<span class="o">[</span>root@master probe]# curl <span class="nt">-s</span> 10.102.65.92
333
<span class="o">[</span>root@master probe]# curl <span class="nt">-s</span> 10.102.65.92
333
<span class="o">[</span>root@master probe]# curl <span class="nt">-s</span> 10.102.65.92
222
</code></pre></div></div>

<h4 id="删除pod3里的tmlhealthy">删除pod3里的/tml/healthy</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl <span class="nb">exec</span> <span class="nt">-ti</span> pod3 <span class="nt">--</span> <span class="nb">rm</span> <span class="nt">-rf</span> /tmp/healthy
<span class="o">[</span>root@master probe]# kubectl <span class="nb">exec</span> <span class="nt">-ti</span> pod3 <span class="nt">--</span> <span class="nb">ls</span> <span class="nt">-l</span> /tmp/
total 0
</code></pre></div></div>

<h4 id="查看pod3的状态">查看pod3的状态</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl describe pod pod3
Name:         pod3
Namespace:    nsprobe
Priority:     0
Node:         node1/192.168.122.202
Start Time:   Sat, 23 Jul 2022 13:21:42 +0800
Labels:       <span class="nv">run</span><span class="o">=</span>app
Annotations:  cni.projectcalico.org/containerID: be54cb3773b113867bbb9b53964166def9e455d175dbf2af134bf1801342b85a
              cni.projectcalico.org/podIP: 10.244.166.185/32
              cni.projectcalico.org/podIPs: 10.244.166.185/32
Status:       Running
IP:           10.244.166.185
IPs:
  IP:  10.244.166.185
Containers:
  c1:
    Container ID:   docker://1dfc5239cc2d026ef09d8a5edbde7e8647c0823d24387e201bce0806adf2eeee
    Image:          nginx
    Image ID:       docker-pullable://nginx@sha256:0d17b565c37bcbd895e9d92315a05c1c3c9a29f762b011a10c54a66cd53c9b31
    Port:           &lt;none&gt;
    Host Port:      &lt;none&gt;
    State:          Running
      Started:      Sat, 23 Jul 2022 13:21:43 +0800
    Ready:          False
    Restart Count:  0
    Readiness:      <span class="nb">exec</span> <span class="o">[</span><span class="nb">cat</span> /tmp/healthy] <span class="nv">delay</span><span class="o">=</span>0s <span class="nb">timeout</span><span class="o">=</span>1s <span class="nv">period</span><span class="o">=</span>10s <span class="c">#success=1 #failure=3</span>
    Environment:    &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-db7dv <span class="o">(</span>ro<span class="o">)</span>
Conditions:
  Type              Status
  Initialized       True 
  Ready             False 
  ContainersReady   False 
  PodScheduled      True 
Volumes:
  kube-api-access-db7dv:
    Type:                    Projected <span class="o">(</span>a volume that contains injected data from multiple sources<span class="o">)</span>
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       &lt;nil&gt;
    DownwardAPI:             <span class="nb">true
</span>QoS Class:                   BestEffort
Node-Selectors:              &lt;none&gt;
Tolerations:                 node.kubernetes.io/not-ready:NoExecute <span class="nv">op</span><span class="o">=</span>Exists <span class="k">for </span>300s
                             node.kubernetes.io/unreachable:NoExecute <span class="nv">op</span><span class="o">=</span>Exists <span class="k">for </span>300s
Events:
  Type     Reason     Age               From               Message
  <span class="nt">----</span>     <span class="nt">------</span>     <span class="nt">----</span>              <span class="nt">----</span>               <span class="nt">-------</span>
  Normal   Scheduled  6m53s             default-scheduler  Successfully assigned nsprobe/pod3 to node1
  Normal   Pulled     6m50s             kubelet            Container image <span class="s2">"nginx"</span> already present on machine
  Normal   Created    6m50s             kubelet            Created container c1
  Normal   Started    6m49s             kubelet            Started container c1
  Warning  Unhealthy  0s <span class="o">(</span>x4 over 30s<span class="o">)</span>  kubelet            Readiness probe failed: <span class="nb">cat</span>: /tmp/healthy: No such file or directory
</code></pre></div></div>

<h4 id="再次访问readsvc">再次访问readsvc</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# curl <span class="nt">-s</span> 10.102.65.92
111
<span class="o">[</span>root@master probe]# curl <span class="nt">-s</span> 10.102.65.92
222
<span class="o">[</span>root@master probe]# curl <span class="nt">-s</span> 10.102.65.92
111
</code></pre></div></div>

<p>可以看到请求不再转发给pod3了</p>

<h4 id="查看pod的状态">查看pod的状态</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl get pods
NAME   READY   STATUS    RESTARTS   AGE
pod1   1/1     Running   0          8m55s
pod2   1/1     Running   0          8m17s
pod3   0/1     Running   0          8m12s
</code></pre></div></div>

<p>虽然svc不再转发请求到pod3,但pod3的容器依然是正常运行的</p>

<h4 id="删除-1">删除</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master probe]# kubectl delete svc readsvc
service <span class="s2">"readsvc"</span> deleted
<span class="o">[</span>root@master probe]# kubectl delete pod pod<span class="o">{</span>1,2,3<span class="o">}</span> <span class="nt">--force</span>
warning: Immediate deletion does not <span class="nb">wait </span><span class="k">for </span>confirmation that the running resource has been terminated. The resource may <span class="k">continue </span>to run on the cluster indefinitely.
pod <span class="s2">"pod1"</span> force deleted
pod <span class="s2">"pod2"</span> force deleted
pod <span class="s2">"pod3"</span> force deleted
</code></pre></div></div>]]></content><author><name>Your Name</name></author><category term="Kubernetes" /><summary type="html"><![CDATA[probe]]></summary></entry><entry><title type="html">Netlink 简介</title><link href="/linux-netlink/" rel="alternate" type="text/html" title="Netlink 简介" /><published>2022-11-20T00:00:00+08:00</published><updated>2022-11-20T00:00:00+08:00</updated><id>/linux-netlink</id><content type="html" xml:base="/linux-netlink/"><![CDATA[<p>netlink 简介</p>

<h3 id="netlink">netlink</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// net/netlink  位置</span>
<span class="n">af_netlink</span><span class="p">.</span><span class="n">c</span>
<span class="n">af_netlink</span><span class="p">.</span><span class="n">h</span>
<span class="n">genetlink</span><span class="p">.</span><span class="n">c</span>
<span class="n">diag</span><span class="p">.</span><span class="n">c</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 优点</span>
<span class="c1">// 不需要轮询</span>
<span class="c1">// 内核可以向用户空间发送异步消息</span>
<span class="c1">// 支持组播</span>
</code></pre></div></div>

<h4 id="创建netlink套接字">创建netlink套接字</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>用户空间: sock(AF_NETLINK,SOCK_RAW|SOCK_CLEXEC,NETLINK_ROUTE) -&gt; netlink_create() -&gt; _netlink_create()
内核空间: netlink_kernel_create() -&gt; _netlink_create()
</code></pre></div></div>

<h4 id="库文件">库文件</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://netfilter.org/projects/libmnl/
</code></pre></div></div>

<h4 id="sockaddr_nl">sockaddr_nl</h4>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// include/uapi/linux/netlink.h</span>
<span class="k">struct</span> <span class="n">sockaddr_nl</span><span class="p">{</span>
	<span class="n">__kernel_sa_family_t</span>	<span class="n">nl_family</span><span class="p">;</span>    <span class="cm">/*AF_NETLINK*/</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> 			<span class="n">nl_pad</span><span class="p">;</span>		  <span class="cm">/*为零*/</span>
	<span class="n">__u32</span> 					<span class="n">nl_pid</span><span class="p">;</span>       <span class="cm">/*端口号*/</span>
	<span class="n">__u32</span> 					<span class="n">nl_groups</span><span class="p">;</span>    <span class="cm">/*组播组掩码*/</span>
<span class="p">}</span>
</code></pre></div></div>

<p>nl_pid 内核套接字,为0。 用户态程序设置为程序PID</p>

<h4 id="netlink消息报头">netlink消息报头</h4>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// include/uapi/linux/netlink.h</span>
<span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="p">{</span>
	<span class="n">__u32</span>		<span class="n">nlmsg_len</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">nlmsg_type</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">nlmsg_flags</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">nlmsg_seq</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">nlmsg_pid</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">nlmsg_data</span><span class="p">[];</span>
<span class="p">};</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//nlmsg_type</span>
<span class="cp">#define NLMSG_NOOP			0x1		</span><span class="cm">/* Nothing.		*/</span><span class="cp">
#define NLMSG_ERROR			0x2		</span><span class="cm">/* Error		*/</span><span class="cp">
#define NLMSG_DONE			0x3		</span><span class="cm">/* End of a dump	*/</span><span class="cp">
#define NLMSG_OVERRUN		0x4		</span><span class="cm">/* Data lost		*/</span><span class="cp">
</span></code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// nlmsg_flags</span>

<span class="cp">#define NLM_F_REQUEST			0x01	</span><span class="cm">/* It is request message. 	*/</span><span class="cp">
#define NLM_F_MULTI				0x02	</span><span class="cm">/* Multipart message, terminated by NLMSG_DONE */</span><span class="cp">
#define NLM_F_ACK				0x04	</span><span class="cm">/* Reply with ack, with zero or error code */</span><span class="cp">
#define NLM_F_ECHO				0x08	</span><span class="cm">/* Receive resulting notifications */</span><span class="cp">
#define NLM_F_DUMP_INTR			0x10	</span><span class="cm">/* Dump was inconsistent due to sequence change */</span><span class="cp">
#define NLM_F_DUMP_FILTERED		0x20	</span><span class="cm">/* Dump was filtered as requested */</span><span class="cp">
</span>
<span class="cm">/* Modifiers to GET request */</span>
<span class="cp">#define NLM_F_ROOT				0x100	</span><span class="cm">/* specify tree	root	*/</span><span class="cp">
#define NLM_F_MATCH				0x200	</span><span class="cm">/* return all matching	*/</span><span class="cp">
#define NLM_F_ATOMIC			0x400	</span><span class="cm">/* atomic GET		*/</span><span class="cp">
#define NLM_F_DUMP				(NLM_F_ROOT|NLM_F_MATCH)
</span>
<span class="cm">/* Modifiers to NEW request */</span>
<span class="cp">#define NLM_F_REPLACE			0x100	</span><span class="cm">/* Override existing		*/</span><span class="cp">
#define NLM_F_EXCL				0x200	</span><span class="cm">/* Do not touch, if it exists	*/</span><span class="cp">
#define NLM_F_CREATE			0x400	</span><span class="cm">/* Create, if it does not exist	*/</span><span class="cp">
#define NLM_F_APPEND			0x800	</span><span class="cm">/* Add to end of list		*/</span><span class="cp">
</span>
<span class="cm">/* Modifiers to DELETE request */</span>
<span class="cp">#define NLM_F_NONREC			0x100	</span><span class="cm">/* Do not delete recursively	*/</span><span class="cp">
#define NLM_F_BULK				0x200	</span><span class="cm">/* Delete multiple objects	*/</span><span class="cp">
</span>
<span class="cm">/* Flags for ACK message */</span>
<span class="cp">#define NLM_F_CAPPED			0x100	</span><span class="cm">/* request was capped */</span><span class="cp">
#define NLM_F_ACK_TLVS			0x200	</span><span class="cm">/* extended ACK TVLs were included */</span><span class="cp">
</span></code></pre></div></div>

<h3 id="ip-route">ip route</h3>

<h4 id="ip-route-add-添加顺序">ip route add 添加顺序</h4>

<ul>
  <li>用户态通过 netlink 协议，发送消息 RTM_NEWROUTE，</li>
  <li>内核态由rtnetlink_rcv() 处理。</li>
  <li>通过调用net/ipv4/fib_frontend.c的inet_rtm_newroute()完成。</li>
  <li>再使用方法fib_table_insert()插入转发数据库(FIB)</li>
  <li>通知订阅了RTM_NEWROUTE消息的侦听(使用rtmsg_fib()方法)</li>
  <li>创建一条netlinki消息，通过rtnl_notify()发送，通知加入了RTNLGRP_IPV4_ROUTE组播组的所有侦听者</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ip</span> <span class="n">route</span> <span class="n">add</span> <span class="o">-&gt;</span> <span class="n">rtnetlink_rcv</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">inet_rtm_newroute</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">fib_table_insert</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">rtmsg_fib</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">rtnl_notify</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="ip-route-del-删除顺序">ip route del 删除顺序</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip route del -&gt; rtnetlink_rcv() -&gt; inet_rtm_delroute() -&gt; fib_table_delete() -&gt; rtmsg_fib() -&gt; rtnl_notify()
</code></pre></div></div>

<h4 id="ip-monitor-route">ip monitor route</h4>

<p>通过Netlink，加入RTNLGRP_IPV4_ROUTE组播组。通过rtnl_notify()发送的消息会被ip monitor接收</p>

<h3 id="netlink-消息">netlink 消息</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0                                         31
        netlink消息报头(nlmsghdr)
        通用netlink消息报头(genlmsghdr)
        用户特定的消息报头(可选)
        通用netlink消息有效载荷(可选)
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// include/uapi/linux/genetlink.h</span>
<span class="k">struct</span> <span class="n">genlmsghdr</span> <span class="p">{</span>
    <span class="n">__u8</span> <span class="n">cmd</span><span class="p">;</span>                     <span class="c1">// 通用消息类型</span>
    <span class="n">__u8</span> <span class="n">version</span><span class="p">;</span>                 <span class="c1">// 版本控制</span>
    <span class="n">__u16</span> <span class="n">reserved</span><span class="p">;</span>               <span class="c1">// 保留</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sk_buff</span> <span class="o">*</span><span class="n">genlmsg_new</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">payload</span><span class="p">,</span><span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
</code></pre></div></div>

<p>实现了为netlink消息分配缓冲区，这个是nlmsg_new()的包装器</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>genlmsg_new（） -&gt; 调用genlmsg_put() 创建netlink报头 
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// include/net/genetlink.h</span>
<span class="n">genlmsg_unicast</span><span class="p">()</span> <span class="c1">// 单播 是nlmsg_unicast() 包装器</span>
<span class="n">genlmsg_multicast</span><span class="p">()</span> <span class="c1">// 发送消息到默认网络命名空间(namespace) net_init</span>
<span class="n">genlmsg_multicast_allns</span><span class="p">()</span>  <span class="c1">// 发送到所有网络命名空间(namespace)</span>
</code></pre></div></div>

<p>用户态创建netlink套接字</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>socket(AF_NETLINK,SOCK_RAM,NETLINK_GENERIC) -&gt; 内核 netlink_create()
</code></pre></div></div>

<h4 id="监视接口">监视接口</h4>

<p>http://yinyaliang.site/monitor-tcp-state/</p>]]></content><author><name>Your Name</name></author><category term="Linux" /><summary type="html"><![CDATA[netlink 简介]]></summary></entry><entry><title type="html">zabbix discovery use prometheus data</title><link href="/monitor-zabbix-metrics/" rel="alternate" type="text/html" title="zabbix discovery use prometheus data" /><published>2022-11-16T00:00:00+08:00</published><updated>2022-11-16T00:00:00+08:00</updated><id>/monitor-zabbix-metrics</id><content type="html" xml:base="/monitor-zabbix-metrics/"><![CDATA[<p>zabbix 使用prometheus数据格式实现自动发现</p>

<h4 id="数据格式">数据格式</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># HELP apisix_http_status HTTP status codes per service in APISIX
# TYPE apisix_http_status counter
apisix_http_status{code="200",route="ceshi-api",matched_uri="/*",matched_host="ceshi.camin.vip",service="ceshi-api",consumer="",node=""} 26489
apisix_http_status{code="200",route="ceshi-api",matched_uri="/*",matched_host="ceshi.camin.vip",service="ceshi-api",consumer="",node="10.1.9.3"} 624693
apisix_http_status{code="200",route="ceshi-api",matched_uri="/*",matched_host="ceshi.campre.dom",service="ceshi-api",consumer="",node="10.1.9.3"} 4820
apisix_http_status{code="200",route="ceshi.camin.vip",matched_uri="/*",matched_host="ceshi.camin.vip",service="ceshi-console",consumer="",node="10.1.9.1"} 8006
apisix_http_status{code="200",route="ceshi.camin.vip",matched_uri="/*",matched_host="ceshi.camin.vip",service="ceshi-console",consumer="",node="10.0.1.1"} 2376
</code></pre></div></div>

<h4 id="模板">模板</h4>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">zabbix_export</span><span class="pi">:</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">6.0'</span>
  <span class="na">date</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2022-11-16T06:43:50Z'</span>
  <span class="na">groups</span><span class="pi">:</span>
    <span class="pi">-</span>
      <span class="na">uuid</span><span class="pi">:</span> <span class="s">5875dc458fab45f699bdaf705773c951</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">模板/服务</span>
  <span class="na">templates</span><span class="pi">:</span>
    <span class="pi">-</span>
      <span class="na">uuid</span><span class="pi">:</span> <span class="s">70715d4c9a5744a0a0550c7131c107f5</span>
      <span class="na">template</span><span class="pi">:</span> <span class="s">service.apisix</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">service.apisix</span>
      <span class="na">groups</span><span class="pi">:</span>
        <span class="pi">-</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">模板/服务</span>
      <span class="na">items</span><span class="pi">:</span>
        <span class="pi">-</span>
          <span class="na">uuid</span><span class="pi">:</span> <span class="s">d265901f69d640889c4f2a84b4971ab8</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">apisix</span><span class="nv"> </span><span class="s">metrics'</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">HTTP_AGENT</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">apisix.info</span>
          <span class="na">trends</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
          <span class="na">value_type</span><span class="pi">:</span> <span class="s">TEXT</span>
          <span class="na">url</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{HOST.IP}:9091/apisix/prometheus/metrics'</span>
          <span class="na">tags</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">tag</span><span class="pi">:</span> <span class="s">Application</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s">RAW</span>
      <span class="na">discovery_rules</span><span class="pi">:</span>
        <span class="pi">-</span>
          <span class="na">uuid</span><span class="pi">:</span> <span class="s">cda308711c9f4ef8aef2c3f74d3bb2a3</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">service</span><span class="nv"> </span><span class="s">apisix</span><span class="nv"> </span><span class="s">http</span><span class="nv"> </span><span class="s">code</span><span class="nv"> </span><span class="s">2xx'</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">apisix.httpcode.2xx</span>
          <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
          <span class="na">item_prototypes</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">uuid</span><span class="pi">:</span> <span class="s">ff316b35fb62427492c1cf0ec435a401</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#NAME}{code={#CODE},route={#ROUTE},matched_uri={#MATCHED_URI},matched_host={#MATCHED_HOST},service={#SERVICE},consumer={#CONSUMER},node={#NODE}}'</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s1">'</span><span class="s">apisix.httpcode.2xx[{#CODE},{#ROUTE},{#MATCHED_URI},{#MATCHED_HOST},{#SERVICE},{#CONSUMER},{#NODE}]'</span>
              <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
              <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{code="{#CODE}",route="{#ROUTE}",matched_uri="{#MATCHED_URI}",matched_host="{#MATCHED_HOST}",service="{#SERVICE}",consumer="{#CONSUMER}",node="{#NODE}"}'</span>
              <span class="na">preprocessing</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">PROMETHEUS_PATTERN</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">apisix_http_status{code="{#CODE}",route="{#ROUTE}",matched_uri="{#MATCHED_URI}",matched_host="{#MATCHED_HOST}",service="{#SERVICE}",consumer="{#CONSUMER}",node="{#NODE}"}'</span>
                    <span class="pi">-</span> <span class="s">value</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">SIMPLE_CHANGE</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
              <span class="na">master_item</span><span class="pi">:</span>
                <span class="na">key</span><span class="pi">:</span> <span class="s">apisix.info</span>
              <span class="na">tags</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">tag</span><span class="pi">:</span> <span class="s">Application</span>
                  <span class="na">value</span><span class="pi">:</span> <span class="s">APISIX-2XX</span>
          <span class="na">master_item</span><span class="pi">:</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">apisix.info</span>
          <span class="na">lld_macro_paths</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#CODE}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">code'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#CONSUMER}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">consumer'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#HELP}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">$.help</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#MATCHED_HOST}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">matched_host'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#MATCHED_URI}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">matched_uri'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#NAME}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">$.name</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#NODE}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">node'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#ROUTE}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">route'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#SERVICE}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">service'</span><span class="s1">'</span><span class="s">]'</span>
          <span class="na">preprocessing</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">PROMETHEUS_TO_JSON</span>
              <span class="na">parameters</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s1">'</span><span class="s">apisix_http_status{code=~"2.*"}'</span>
        <span class="pi">-</span>
          <span class="na">uuid</span><span class="pi">:</span> <span class="s">6a079ccfcf1e4df188515f0951c6f5e1</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">service</span><span class="nv"> </span><span class="s">apisix</span><span class="nv"> </span><span class="s">http</span><span class="nv"> </span><span class="s">code</span><span class="nv"> </span><span class="s">3xx'</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">apisix.httpcode.3xx</span>
          <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
          <span class="na">item_prototypes</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">uuid</span><span class="pi">:</span> <span class="s">e2a5955d8e2746a7a45d7ff27f3feb13</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#NAME}{code={#CODE},route={#ROUTE},matched_uri={#MATCHED_URI},matched_host={#MATCHED_HOST},service={#SERVICE},consumer={#CONSUMER},node={#NODE}}'</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s1">'</span><span class="s">apisix.httpcode.3xx[{#CODE},{#ROUTE},{#MATCHED_URI},{#MATCHED_HOST},{#SERVICE},{#CONSUMER},{#NODE}]'</span>
              <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
              <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{code="{#CODE}",route="{#ROUTE}",matched_uri="{#MATCHED_URI}",matched_host="{#MATCHED_HOST}",service="{#SERVICE}",consumer="{#CONSUMER}",node="{#NODE}"}'</span>
              <span class="na">preprocessing</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">PROMETHEUS_PATTERN</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">apisix_http_status{code="{#CODE}",route="{#ROUTE}",matched_uri="{#MATCHED_URI}",matched_host="{#MATCHED_HOST}",service="{#SERVICE}",consumer="{#CONSUMER}",node="{#NODE}"}'</span>
                    <span class="pi">-</span> <span class="s">value</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">SIMPLE_CHANGE</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
              <span class="na">master_item</span><span class="pi">:</span>
                <span class="na">key</span><span class="pi">:</span> <span class="s">apisix.info</span>
              <span class="na">tags</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">tag</span><span class="pi">:</span> <span class="s">Application</span>
                  <span class="na">value</span><span class="pi">:</span> <span class="s">APISIX-3XX</span>
          <span class="na">master_item</span><span class="pi">:</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">apisix.info</span>
          <span class="na">lld_macro_paths</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#CODE}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">code'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#CONSUMER}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">consumer'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#HELP}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">$.help</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#MATCHED_HOST}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">matched_host'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#MATCHED_URI}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">matched_uri'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#NAME}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">$.name</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#NODE}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">node'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#ROUTE}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">route'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#SERVICE}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">service'</span><span class="s1">'</span><span class="s">]'</span>
          <span class="na">preprocessing</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">PROMETHEUS_TO_JSON</span>
              <span class="na">parameters</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s1">'</span><span class="s">apisix_http_status{code=~"3.*"}'</span>
        <span class="pi">-</span>
          <span class="na">uuid</span><span class="pi">:</span> <span class="s">f5e8b61f49a14bb79a96c911145a73e8</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">service</span><span class="nv"> </span><span class="s">apisix</span><span class="nv"> </span><span class="s">http</span><span class="nv"> </span><span class="s">code</span><span class="nv"> </span><span class="s">4xx'</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">apisix.httpcode.4xx</span>
          <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
          <span class="na">item_prototypes</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">uuid</span><span class="pi">:</span> <span class="s">c2a0c5e646cd420e95124f558a80fb86</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#NAME}{code={#CODE},route={#ROUTE},matched_uri={#MATCHED_URI},matched_host={#MATCHED_HOST},service={#SERVICE},consumer={#CONSUMER},node={#NODE}}'</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s1">'</span><span class="s">apisix.httpcode.4xx[{#CODE},{#ROUTE},{#MATCHED_URI},{#MATCHED_HOST},{#SERVICE},{#CONSUMER},{#NODE}]'</span>
              <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
              <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{code="{#CODE}",route="{#ROUTE}",matched_uri="{#MATCHED_URI}",matched_host="{#MATCHED_HOST}",service="{#SERVICE}",consumer="{#CONSUMER}",node="{#NODE}"}'</span>
              <span class="na">preprocessing</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">PROMETHEUS_PATTERN</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">apisix_http_status{code="{#CODE}",route="{#ROUTE}",matched_uri="{#MATCHED_URI}",matched_host="{#MATCHED_HOST}",service="{#SERVICE}",consumer="{#CONSUMER}",node="{#NODE}"}'</span>
                    <span class="pi">-</span> <span class="s">value</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">SIMPLE_CHANGE</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
              <span class="na">master_item</span><span class="pi">:</span>
                <span class="na">key</span><span class="pi">:</span> <span class="s">apisix.info</span>
              <span class="na">tags</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">tag</span><span class="pi">:</span> <span class="s">Application</span>
                  <span class="na">value</span><span class="pi">:</span> <span class="s">APISIX-4XX</span>
              <span class="na">trigger_prototypes</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">uuid</span><span class="pi">:</span> <span class="s">859ab9da74524cfaa20be1b0fd37e06f</span>
                  <span class="na">expression</span><span class="pi">:</span> <span class="s1">'</span><span class="s">last(/service.apisix/apisix.httpcode.4xx[{#CODE},{#ROUTE},{#MATCHED_URI},{#MATCHED_HOST},{#SERVICE},{#CONSUMER},{#NODE}])&gt;0'</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#ROUTE}</span><span class="nv"> </span><span class="s">{#NODE}</span><span class="nv"> </span><span class="s">{#CODE}</span><span class="nv"> </span><span class="s">over</span><span class="nv"> </span><span class="s">0'</span>
                  <span class="na">priority</span><span class="pi">:</span> <span class="s">WARNING</span>
          <span class="na">master_item</span><span class="pi">:</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">apisix.info</span>
          <span class="na">lld_macro_paths</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#CODE}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">code'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#CONSUMER}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">consumer'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#HELP}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">$.help</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#MATCHED_HOST}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">matched_host'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#MATCHED_URI}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">matched_uri'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#NAME}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">$.name</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#NODE}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">node'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#ROUTE}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">route'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#SERVICE}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">service'</span><span class="s1">'</span><span class="s">]'</span>
          <span class="na">preprocessing</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">PROMETHEUS_TO_JSON</span>
              <span class="na">parameters</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s1">'</span><span class="s">apisix_http_status{code=~"4.*"}'</span>
        <span class="pi">-</span>
          <span class="na">uuid</span><span class="pi">:</span> <span class="s">ee04b62140fd470badfd521e22127e52</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">service</span><span class="nv"> </span><span class="s">apisix</span><span class="nv"> </span><span class="s">http</span><span class="nv"> </span><span class="s">code</span><span class="nv"> </span><span class="s">5xx'</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">apisix.httpcode.5xx</span>
          <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
          <span class="na">item_prototypes</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">uuid</span><span class="pi">:</span> <span class="s">ba0685038fd84ab5ae87fbe15b2d683f</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#NAME}{code={#CODE},route={#ROUTE},matched_uri={#MATCHED_URI},matched_host={#MATCHED_HOST},service={#SERVICE},consumer={#CONSUMER},node={#NODE}}'</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">DEPENDENT</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s1">'</span><span class="s">apisix.httpcode.5xx[{#CODE},{#ROUTE},{#MATCHED_URI},{#MATCHED_HOST},{#SERVICE},{#CONSUMER},{#NODE}]'</span>
              <span class="na">delay</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
              <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{code="{#CODE}",route="{#ROUTE}",matched_uri="{#MATCHED_URI}",matched_host="{#MATCHED_HOST}",service="{#SERVICE}",consumer="{#CONSUMER}",node="{#NODE}"}'</span>
              <span class="na">preprocessing</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">PROMETHEUS_PATTERN</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">apisix_http_status{code="{#CODE}",route="{#ROUTE}",matched_uri="{#MATCHED_URI}",matched_host="{#MATCHED_HOST}",service="{#SERVICE}",consumer="{#CONSUMER}",node="{#NODE}"}'</span>
                    <span class="pi">-</span> <span class="s">value</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
                <span class="pi">-</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">SIMPLE_CHANGE</span>
                  <span class="na">parameters</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
              <span class="na">master_item</span><span class="pi">:</span>
                <span class="na">key</span><span class="pi">:</span> <span class="s">apisix.info</span>
              <span class="na">tags</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">tag</span><span class="pi">:</span> <span class="s">Application</span>
                  <span class="na">value</span><span class="pi">:</span> <span class="s">APISIX-5XX</span>
              <span class="na">trigger_prototypes</span><span class="pi">:</span>
                <span class="pi">-</span>
                  <span class="na">uuid</span><span class="pi">:</span> <span class="s">263014e968b34f17b21eb4926359c83c</span>
                  <span class="na">expression</span><span class="pi">:</span> <span class="s1">'</span><span class="s">last(/service.apisix/apisix.httpcode.5xx[{#CODE},{#ROUTE},{#MATCHED_URI},{#MATCHED_HOST},{#SERVICE},{#CONSUMER},{#NODE}])&gt;0'</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#ROUTE}</span><span class="nv"> </span><span class="s">{#NODE}</span><span class="nv"> </span><span class="s">{#CODE}</span><span class="nv"> </span><span class="s">over</span><span class="nv"> </span><span class="s">0'</span>
                  <span class="na">priority</span><span class="pi">:</span> <span class="s">WARNING</span>
          <span class="na">master_item</span><span class="pi">:</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">apisix.info</span>
          <span class="na">lld_macro_paths</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#CODE}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">code'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#CONSUMER}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">consumer'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#HELP}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">$.help</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#MATCHED_HOST}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">matched_host'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#MATCHED_URI}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">matched_uri'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#NAME}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">$.name</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#NODE}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">node'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#ROUTE}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">route'</span><span class="s1">'</span><span class="s">]'</span>
            <span class="pi">-</span>
              <span class="na">lld_macro</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{#SERVICE}'</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$.labels['</span><span class="s1">'</span><span class="s">service'</span><span class="s1">'</span><span class="s">]'</span>
          <span class="na">preprocessing</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">PROMETHEUS_TO_JSON</span>
              <span class="na">parameters</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s1">'</span><span class="s">apisix_http_status{code=~"5.*"}'</span>
</code></pre></div></div>

<h4 id="效果">效果</h4>
<p><img src="/assets/images/zabbix/zabbix-metrics.png" /></p>]]></content><author><name>Your Name</name></author><category term="Monitor" /><summary type="html"><![CDATA[zabbix 使用prometheus数据格式实现自动发现]]></summary></entry><entry><title type="html">获取tcp状态</title><link href="/c-02/" rel="alternate" type="text/html" title="获取tcp状态" /><published>2022-11-09T00:00:00+08:00</published><updated>2022-11-09T00:00:00+08:00</updated><id>/c-02</id><content type="html" xml:base="/c-02/"><![CDATA[<p>通过module方式 替换zabbix通过ss命令获取tcp状态</p>

<h4 id="老的方式">老的方式</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span><span class="kn">import</span> <span class="nn">os</span><span class="p">,</span><span class="n">sys</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>

<span class="n">Base_Dir</span> <span class="o">=</span> <span class="s">'/data/scripts/oss/zabbix/'</span>
<span class="n">sys</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">Base_Dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">eeo_zabbix</span> <span class="kn">import</span> <span class="n">trapper_zabbix</span>

<span class="k">class</span> <span class="nc">tcp_state</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">command</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">command</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">com</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="s">"/usr/sbin/ss -ant"</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">com</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">iterable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="s">'items'</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="n">self_get</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get</span>
                    <span class="k">for</span> <span class="n">elem</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">=</span> <span class="n">self_get</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">count</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">dict</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">self_get</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get</span>
                <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">=</span> <span class="n">self_get</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwds</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="k">return</span> <span class="s">','</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="s">'%r:%r'</span><span class="p">.</span><span class="n">__mod__</span><span class="p">,</span><span class="bp">self</span><span class="p">.</span><span class="n">iteritems</span><span class="p">()))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">tcp_state</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results</span><span class="p">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">trapper_zabbix</span><span class="p">(</span><span class="s">'tcp.{0}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="新的方式">新的方式</h4>
<h5 id="优点">优点</h5>
<p>不需要配置文件、不需要部署脚本、模板挂载即可用,下面为demo代码</p>

<h5 id="tcp_countc">tcp_count.c</h5>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"tcp_count.h"</span><span class="cp">
</span><span class="c1">// TCP状态 参考:https://users.cs.northwestern.edu/~agupta/cs340/project2/TCPIP_State_Transition_Diagram.pdf</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tcp_state_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"ESTABLISHED"</span><span class="p">,</span>
    <span class="s">"SYN-SENT"</span><span class="p">,</span>
    <span class="s">"SYN-RECEIVED"</span><span class="p">,</span>
    <span class="s">"FIN-WAIT-1"</span><span class="p">,</span>
    <span class="s">"FIN-WAIT-2"</span><span class="p">,</span>
    <span class="s">"TIME-WAIT"</span><span class="p">,</span>
    <span class="s">"CLOSING"</span><span class="p">,</span>
    <span class="s">"CLOSE-WAIT"</span><span class="p">,</span>
    <span class="s">"LAST-ACK"</span><span class="p">,</span>
    <span class="s">"LISTEN"</span><span class="p">,</span>
    <span class="s">"CLOSED"</span>
    <span class="p">};</span>

<span class="k">enum</span>
<span class="p">{</span>
    <span class="n">TCP_ESTABLISHED</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">TCP_SYN_SENT</span><span class="p">,</span>
    <span class="n">TCP_SYN_RECV</span><span class="p">,</span>
    <span class="n">TCP_FIN_WAIT1</span><span class="p">,</span>
    <span class="n">TCP_FIN_WAIT2</span><span class="p">,</span>
    <span class="n">TCP_TIME_WAIT</span><span class="p">,</span>
    <span class="n">TCP_CLOSE</span><span class="p">,</span>
    <span class="n">TCP_CLOSE_WAIT</span><span class="p">,</span>
    <span class="n">TCP_LAST_ACK</span><span class="p">,</span>
    <span class="n">TCP_LISTEN</span><span class="p">,</span>
    <span class="n">TCP_CLOSING</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">param_in_tcp_state</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">haystack</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">needle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">haylen</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">haylen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">haystack</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="n">needle</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">recv_and_count</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">counter</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">count_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">recv_status</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_nl</span> <span class="n">nladdr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov</span><span class="p">;</span> <span class="c1">// 定义数据缓冲区格式</span>
    <span class="k">struct</span> <span class="n">msghdr</span> <span class="n">rcv_msg</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32768</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msglen</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">inet_diag_msg</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nladdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nladdr</span><span class="p">));</span>
    <span class="n">nladdr</span><span class="p">.</span><span class="n">nl_family</span> <span class="o">=</span> <span class="n">AF_NETLINK</span><span class="p">;</span>

    <span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">;</span>
    <span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

    <span class="n">rcv_msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">msghdr</span><span class="p">){</span>
        <span class="p">.</span><span class="n">msg_name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nladdr</span><span class="p">,</span>
        <span class="p">.</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nladdr</span><span class="p">),</span>
        <span class="p">.</span><span class="n">msg_iov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span>
        <span class="p">.</span><span class="n">msg_iovlen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="kt">int</span> <span class="n">found_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">found_done</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="n">recv_status</span> <span class="o">=</span> <span class="n">recvmsg</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcv_msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">recv_status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">msglen</span> <span class="o">=</span> <span class="n">recv_status</span><span class="p">;</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">NLMSG_OK</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">msglen</span><span class="p">))</span> <span class="c1">// 判断buf中的数据是否读取完毕</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">nlmsg_seq</span> <span class="o">!=</span> <span class="mi">860902</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">found_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">nlmsg_type</span> <span class="o">==</span> <span class="n">NLMSG_DONE</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">found_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">NLMSG_DATA</span><span class="p">(</span><span class="n">h</span><span class="p">);</span> <span class="c1">// 取当前netlink消息头结构紧邻的inet_diag_msg结构</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">counter</span><span class="p">[</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">idiag_state</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">count_state</span><span class="o">++</span><span class="p">;</span>

            <span class="n">h</span> <span class="o">=</span> <span class="n">NLMSG_NEXT</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">msglen</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">count_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">send_msg_request</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port_state</span><span class="p">)</span>
<span class="p">{</span>

    <span class="k">struct</span> <span class="n">sockaddr_nl</span> <span class="n">nladdr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov</span><span class="p">;</span>

    <span class="c1">// 初始化请求的数据</span>
    <span class="k">struct</span> <span class="n">send_msg</span>
    <span class="p">{</span>
        <span class="k">struct</span> <span class="n">nlmsghdr</span> <span class="n">nlh</span><span class="p">;</span>                                            <span class="c1">// request header</span>
        <span class="k">struct</span> <span class="n">inet_diag_req</span> <span class="n">r</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">send_msg</span><span class="p">;</span>

    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nladdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nladdr</span><span class="p">));</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_msg</span><span class="p">.</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">send_msg</span><span class="p">.</span><span class="n">r</span><span class="p">));</span>

    <span class="n">send_msg</span><span class="p">.</span><span class="n">nlh</span><span class="p">.</span><span class="n">nlmsg_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">send_msg</span><span class="p">);</span>                             <span class="c1">// 32位消息的长度，以字节为单位，包括消息头</span>
    <span class="n">send_msg</span><span class="p">.</span><span class="n">nlh</span><span class="p">.</span><span class="n">nlmsg_type</span> <span class="o">=</span> <span class="n">TCPDIAG_GETSOCK</span><span class="p">;</span>                             <span class="c1">// 消息的类型</span>
    <span class="n">send_msg</span><span class="p">.</span><span class="n">nlh</span><span class="p">.</span><span class="n">nlmsg_flags</span> <span class="o">=</span> <span class="n">NLM_F_ROOT</span> <span class="o">|</span> <span class="n">NLM_F_MATCH</span> <span class="o">|</span> <span class="n">NLM_F_REQUEST</span><span class="p">;</span>   <span class="c1">// 附加标志</span>
    <span class="n">send_msg</span><span class="p">.</span><span class="n">nlh</span><span class="p">.</span><span class="n">nlmsg_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                            <span class="c1">// 消息序号 </span>
    <span class="n">send_msg</span><span class="p">.</span><span class="n">nlh</span><span class="p">.</span><span class="n">nlmsg_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                            <span class="c1">// 标识</span>

    <span class="n">send_msg</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">idiag_states</span> <span class="o">=</span> <span class="n">port_state</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mh">0xffff</span> <span class="o">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">port_state</span><span class="p">);</span> <span class="c1">// idiag_states字段的每一位表示一个状态，因此通过位偏移可以将具体某个状态位置1</span>

    <span class="n">nladdr</span><span class="p">.</span><span class="n">nl_family</span> <span class="o">=</span> <span class="n">AF_NETLINK</span><span class="p">;</span> <span class="c1">// 总是为AF_NETLINK</span>

    <span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">send_msg</span><span class="p">;</span>
    <span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">send_msg</span><span class="p">);</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">msghdr</span><span class="p">){</span>
        <span class="c1">//使用sendmsg()发送数据，必须使用msghdr结构</span>
        <span class="p">.</span><span class="n">msg_name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nladdr</span><span class="p">,</span>
        <span class="p">.</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nladdr</span><span class="p">),</span>
        <span class="p">.</span><span class="n">msg_iov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span>
        <span class="p">.</span><span class="n">msg_iovlen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="n">sendmsg</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// 通过sendmsg函数发送消息到内核中</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tcp_state_count</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">ret_count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">socket_fd</span><span class="p">;</span>
    <span class="n">socket_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_NETLINK</span><span class="p">,</span> <span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">NETLINK_SOCK_DIAG</span><span class="p">);</span> <span class="c1">// AF_NETLINK IPv4   SOCK_RAW 原始套接字 NETLINK_SOCK_DIAG 自内核查询协议信息  返回值：-1表示失败</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">socket_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>                                           <span class="c1">// create failed</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">SYSINFO_RET_FAIL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">send_msg_request</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">close</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">SYSINFO_RET_FAIL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">*</span><span class="n">ret_count</span> <span class="o">=</span> <span class="n">recv_and_count</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

    <span class="n">close</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">SYSINFO_RET_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tcp_state</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>

    <span class="kt">int</span> <span class="n">port_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">SYSINFO_RET_FAIL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">param_in_tcp_state</span><span class="p">(</span><span class="n">tcp_state_array</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">TCP_STATE_COUNT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">SYSINFO_RET_FAIL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s">"ESTABLISHED"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">port_state</span> <span class="o">=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s">"SYN-SENT"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">port_state</span> <span class="o">=</span> <span class="n">TCP_SYN_SENT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s">"SYN-RECEIVED"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">port_state</span> <span class="o">=</span> <span class="n">TCP_SYN_RECV</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s">"FIN-WAIT-1"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">port_state</span> <span class="o">=</span> <span class="n">TCP_FIN_WAIT1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s">"FIN-WAIT-2"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">port_state</span> <span class="o">=</span> <span class="n">TCP_FIN_WAIT2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s">"TIME-WAIT"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">port_state</span> <span class="o">=</span> <span class="n">TCP_TIME_WAIT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s">"CLOSED"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">port_state</span> <span class="o">=</span> <span class="n">TCP_CLOSE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s">"CLOSE-WAIT"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">port_state</span> <span class="o">=</span> <span class="n">TCP_CLOSE_WAIT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s">"LAST-ACK"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">port_state</span> <span class="o">=</span> <span class="n">TCP_LAST_ACK</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s">"LISTEN"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">port_state</span> <span class="o">=</span> <span class="n">TCP_LISTEN</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s">"CLOSING"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">port_state</span> <span class="o">=</span> <span class="n">TCP_CLOSING</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">tcp_state_count</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">port_state</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">SYSINFO_RET_FAIL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">SYSINFO_RET_FAIL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">SYSINFO_RET_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
    <span class="n">tcp_state</span><span class="p">(</span><span class="s">"LISTEN"</span><span class="p">,</span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h5 id="tcp_counth">tcp_count.h</h5>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;linux/netlink.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/inet_diag.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="cp">#define SYSINFO_RET_OK		0
#define SYSINFO_RET_FAIL	1
#define TCP_STATE_COUNT 11
#define NULL ((void *)0)
</span></code></pre></div></div>

<h4 id="验证">验证</h4>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">yin</span><span class="err">@</span><span class="n">ding</span><span class="o">:/</span><span class="n">home</span><span class="o">/</span><span class="n">c</span><span class="o">/</span><span class="n">netlink</span><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span> 
<span class="mi">23</span>
<span class="n">yin</span><span class="err">@</span><span class="n">ding</span><span class="o">:/</span><span class="n">home</span><span class="o">/</span><span class="n">c</span><span class="o">/</span><span class="n">netlink</span><span class="err">$</span> <span class="n">ss</span> <span class="o">-</span><span class="n">ant</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">LISTEN</span> <span class="o">|</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span>
<span class="mi">23</span>
</code></pre></div></div>

<h4 id="参考">参考</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://www.rfc-editor.org/rfc/rfc3549.html
https://github.com/xgfone/snippet/blob/master/snippet/docs/linux/netlink/netlink-note.md#netlink-%E6%B6%88%E6%81%AF%E7%BB%93%E6%9E%84
</code></pre></div></div>]]></content><author><name>Your Name</name></author><category term="Linux" /><summary type="html"><![CDATA[通过module方式 替换zabbix通过ss命令获取tcp状态]]></summary></entry></feed>