<!doctype html>
<html lang="zh" class="no-js">
  <head>
     <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3436206915764997"
     crossorigin="anonymous"></script>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Pod 管理 - 尹亚亮</title>
<meta name="description" content="创建和删除pod">


  <meta name="author" content="Your Name">
  
  <meta property="article:author" content="Your Name">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="zh_CN">
<meta property="og:site_name" content="尹亚亮">
<meta property="og:title" content="Pod 管理">
<meta property="og:url" content="/kubernetes-kubeadm-pod/">


  <meta property="og:description" content="创建和删除pod">







  <meta property="article:published_time" content="2022-09-08T00:00:00+08:00">





  

  


<link rel="canonical" href="/kubernetes-kubeadm-pod/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Your Name",
      "url": "/"
    
  }
</script>


  <meta name="google-site-verification" content="A4xb7189wuH7_ck4RBWFMcZetHQvGEtM6c4NkowkBXo" />




  <meta name="yandex-verification" content="b34490b8136e1c97">


  <meta name="naver-site-verification" content="bcc3391cbb77775a98167dd719a9653fad02042a">


  <meta name="baidu-site-verification" content="code-faatzlDIxD">

<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="尹亚亮 Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    
  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">转到主导航栏</a></li>
    <li><a href="#main" class="screen-reader-shortcut">转到内容</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">转到底部</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          尹亚亮
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/year-archive/">归档</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">分类</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">切换菜单</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Pod 管理">
    <meta itemprop="description" content="创建和删除pod">
    <meta itemprop="datePublished" content="2022-09-08T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="/kubernetes-kubeadm-pod/" class="u-url" itemprop="url">Pod 管理
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2022-09-08T00:00:00+08:00">September 8, 2022</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> 目录</h4></header>
              <ul class="toc__menu"><li><a href="#创建和删除pod">创建和删除pod</a><ul><li><a href="#下载镜像">下载镜像</a></li><li><a href="#查看">查看</a></li><li><a href="#创建">创建</a></li><li><a href="#删除">删除</a></li><li><a href="#生成yaml文件创建pod">生成yaml文件创建pod</a></li><li><a href="#使用yaml文件创建">使用yaml文件创建</a></li><li><a href="#创建pod时指定pod运行其它进程">创建pod时指定pod运行其它进程</a></li><li><a href="#pod创建多容器">pod创建多容器</a></li></ul></li><li><a href="#在pod里执行命令">在pod里执行命令</a><ul><li><a href="#生命周期">生命周期</a></li></ul></li><li><a href="#创建初始化pod">创建初始化pod</a><ul><li><a href="#初始化容器在正式运行容器前执行准备工作">初始化容器,在正式运行容器前执行准备工作</a></li></ul></li><li><a href="#创建静态pod">创建静态Pod</a><ul><li><a href="#在node上创建">在node上创建</a></li><li><a href="#在master上创建">在master上创建</a></li></ul></li><li><a href="#指定pod在指定的节点上运行">指定pod在指定的节点上运行</a><ul><li><a href="#查看节点的标签">查看节点的标签</a></li><li><a href="#查看特定节点的标签">查看特定节点的标签</a></li><li><a href="#给节点设置标签">给节点设置标签</a></li><li><a href="#取消某个节点的标签">取消某个节点的标签</a></li><li><a href="#给所有节点设置标签">给所有节点设置标签</a></li><li><a href="#创建指定节点运行的pod">创建指定节点运行的pod</a></li><li><a href="#创建在特定节点上运行的pod">创建在特定节点上运行的pod</a></li><li><a href="#annotations设置">Annotations设置</a></li></ul></li><li><a href="#通过cordon及drain把节点设置为维护模式">通过cordon及drain把节点设置为维护模式</a><ul><li><a href="#cordon">cordon</a></li><li><a href="#drain">drain</a></li></ul></li><li><a href="#配置并查看节点的污点">配置并查看节点的污点</a><ul><li><a href="#给节点设置污点">给节点设置污点</a></li><li><a href="#设置operator的值为equal">设置operator的值为Equal</a></li><li><a href="#operator-的值等于exists的情况">operator 的值等于Exists的情况</a></li></ul></li></ul>

            </nav>
          </aside>
        
        <h3 id="创建和删除pod">创建和删除pod</h3>

<p>pod是k8s里最小调度单元</p>

<h4 id="下载镜像">下载镜像</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull hub.c.163.com/library/centos:7
docker pull nginx
docker pull nginx:1.7.9
docker pull nginx:1.9
docker pull busybox
docker pull alpine
docker pull perl
</code></pre></div></div>

<h4 id="查看">查看</h4>

<p>默认命名空间</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master tmp]# kubectl get pods
No resources found <span class="k">in </span>default namespace.
</code></pre></div></div>

<p>指定命名空间</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master tmp]# kubectl get pods <span class="nt">-n</span> kube-system
NAME                                       READY   STATUS    RESTARTS   AGE
calico-kube-controllers-7cc8dd57d9-dhv5r   1/1     Running   0          161m
calico-node-54njj                          1/1     Running   2          4h43m
calico-node-559jn                          1/1     Running   1          4h43m
calico-node-w6rwp                          1/1     Running   1          4h27m
coredns-545d6fc579-j9f7q                   1/1     Running   1          5h
coredns-545d6fc579-t7st8                   1/1     Running   1          5h
etcd-master                                1/1     Running   1          5h
kube-apiserver-master                      1/1     Running   1          5h
kube-controller-manager-master             1/1     Running   1          5h
kube-proxy-j28gq                           1/1     Running   1          5h
kube-proxy-jgsxd                           1/1     Running   2          4h54m
kube-proxy-qrf8c                           1/1     Running   1          4h27m
kube-scheduler-master                      1/1     Running   1          5h
metrics-server-6b7f4dfdcb-tjfcj            1/1     Running   0          159m
</code></pre></div></div>

<p>所有命名空间</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master tmp]# kubectl get pods <span class="nt">-A</span>
NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE
kube-system   calico-kube-controllers-7cc8dd57d9-dhv5r   1/1     Running   0          161m
kube-system   calico-node-54njj                          1/1     Running   2          4h44m
kube-system   calico-node-559jn                          1/1     Running   1          4h44m
kube-system   calico-node-w6rwp                          1/1     Running   1          4h28m
kube-system   coredns-545d6fc579-j9f7q                   1/1     Running   1          5h
kube-system   coredns-545d6fc579-t7st8                   1/1     Running   1          5h
kube-system   etcd-master                                1/1     Running   1          5h1m
kube-system   kube-apiserver-master                      1/1     Running   1          5h1m
kube-system   kube-controller-manager-master             1/1     Running   1          5h1m
kube-system   kube-proxy-j28gq                           1/1     Running   1          5h
kube-system   kube-proxy-jgsxd                           1/1     Running   2          4h54m
kube-system   kube-proxy-qrf8c                           1/1     Running   1          4h28m
kube-system   kube-scheduler-master                      1/1     Running   1          5h1m
kube-system   metrics-server-6b7f4dfdcb-tjfcj            1/1     Running   0          160m
</code></pre></div></div>

<h4 id="创建">创建</h4>

<p>kubectl run 名字 –image=镜像</p>

<p>指定pod的标签</p>

<p>kubectl run 名字 –image=镜像 –labels=标签=值   多个标签使用多个–labels</p>

<p>指定变量</p>

<p>kubectl run 名字 –image=镜像 –env=”变量名=值”  多个变量使用多个–env</p>

<p>指定端口</p>

<p>kubectl run 名字 –image=镜像 –port=端口号</p>

<p>指定下载策略</p>

<p>kubectl run 名字 –image=镜像 –image-pull-policy=镜像现在策略</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl run pod1 <span class="nt">--image</span><span class="o">=</span>nginx
</code></pre></div></div>

<p>默认镜像下载策略为Always,即使本地有镜像也会去下载,建议加上 –image-pull-policy=IfNotPresent</p>

<p>验证</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master tmp]# kubectl get pods
NAME   READY   STATUS    RESTARTS   AGE
pod1   1/1     Running   0          74s
</code></pre></div></div>

<p>查看运行的节点</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master tmp]# kubectl get pods <span class="nt">-o</span> wide
NAME   READY   STATUS    RESTARTS   AGE    IP             NODE    NOMINATED NODE   READINESS GATES
pod1   1/1     Running   0          114s   10.244.104.3   node2   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<h4 id="删除">删除</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete pod pod1 <span class="nt">--force</span>
</code></pre></div></div>

<p>–force 加快删除速度</p>

<p>验证</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master tmp]# kubectl get pods
No resources found <span class="k">in </span>default namespace.
</code></pre></div></div>

<h4 id="生成yaml文件创建pod">生成yaml文件创建pod</h4>

<p>kubectl run 名字 –image=镜像 –dry-run=client -o yaml &gt; pod.yaml</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>pod<span class="p">;</span><span class="nb">cd </span>pod
kubectl run pod1 <span class="nt">--image</span><span class="o">=</span>nginx <span class="nt">--dry-run</span><span class="o">=</span>client <span class="nt">-o</span> yaml <span class="o">&gt;</span> pod.yaml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">run</span><span class="pi">:</span> <span class="s">pod1</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pod1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>  <span class="c1"># 新增</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">pod1</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">dnsPolicy</span><span class="pi">:</span> <span class="s">ClusterFirst</span>
  <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Always</span>
<span class="na">status</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre></div></div>

<p>解释</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1    　　　　　　# 必选，版本号</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod         　　　　　　# 必选，Pod</span>
<span class="na">metadata</span><span class="pi">:</span>         <span class="s">　　　　　　# 必选，元数据</span>
  <span class="s">name</span><span class="err">:</span> <span class="s">String    　　　　　　# 必选，Pod名称</span>
  <span class="s">namespace</span><span class="err">:</span> <span class="s">String    　　　</span> <span class="c1"># 必选，Pod所属的命名空间</span>
  <span class="na">labels</span><span class="pi">:</span>            <span class="s">　　　　</span> <span class="c1"># 自定义标签，Map格式</span>
    <span class="na">Key</span><span class="pi">:</span> <span class="s">Value    　　　　　　# 键值对</span>
  <span class="na">annotations</span><span class="pi">:</span>    <span class="s">　　　　　　# 自定义注解</span>
    <span class="s">Key</span><span class="err">:</span> <span class="s">Value    　　　　　</span>  <span class="c1"># 键值对</span>
<span class="na">spec</span><span class="pi">:</span>            <span class="s">　　　　　　</span> <span class="c1"># 必选，Pod中容器的详细属性</span>
  <span class="na">containers</span><span class="pi">:</span>        <span class="s">　　　　</span> <span class="c1"># 必选，Pod中容器列表</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">String   　　　　</span>   <span class="c1"># 必选，容器名称</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">String    　　　　</span> <span class="c1"># 必选，容器的镜像地址和名称</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">Always | Never | IfNotPresent</span><span class="pi">}</span>   
<span class="err"> </span><span class="s">　　　　</span>                     <span class="c1"># 获取镜像的策略，Always表示下载镜像，IfnotPresent 表示优先使用本地镜像，否则下载镜像，Never表示仅使用本地镜像。</span>
    <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">String</span><span class="pi">]</span>         <span class="c1"># 容器的启动命令列表(覆盖)，如不指定，使用打包镜像时的启动命令。</span>
    <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">String</span><span class="pi">]</span>            <span class="c1"># 容器的启动命令参数列表</span>
    <span class="na">workingDir</span><span class="pi">:</span> <span class="s">String</span>        <span class="c1"># 容器的工作目录</span>
    <span class="na">volumeMounts</span><span class="pi">:</span>             <span class="c1"># 挂载到容器内部的存储卷配置</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">String</span>            <span class="c1"># 引用Pod定义的共享存储卷的名，需用Pod.spec.volumes[]部分定义的卷名</span>
      <span class="na">mountPath</span><span class="pi">:</span> <span class="s">String</span>       <span class="c1"># 存储卷在容器内Mount的绝对路径，应少于512字符</span>
      <span class="na">readOnly</span><span class="pi">:</span> <span class="s">boolean</span>       <span class="c1"># 是否为只读模式</span>
<span class="err">  </span><span class="na">ports</span><span class="pi">:</span>                      <span class="c1"># 容器需要暴露的端口库号列表</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">String</span>              <span class="c1"># 端口号名称</span>
    <span class="na">containerPort</span><span class="pi">:</span> <span class="s">Int</span>        <span class="c1"># 容器需要监听的端口号</span>
    <span class="na">hostPort</span><span class="pi">:</span> <span class="s">Int</span>             <span class="c1"># 可选，容器所在主机需要监听的端口号，默认与Container相同</span>
  <span class="na">env</span><span class="pi">:</span>                        <span class="c1"># 容器运行前需设置的环境变量列表</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">String</span>              <span class="c1"># 环境变量名称</span>
    <span class="na">value</span><span class="pi">:</span> <span class="s">String</span>             <span class="c1"># 环境变量的值</span>
  <span class="na">resources</span><span class="pi">:</span>                  <span class="c1"># 资源限制和请求的设置</span>
    <span class="na">limits</span><span class="pi">:</span>                   <span class="c1"># 资源限制的设置</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">String</span>             <span class="c1"># Cpu的限制，单位为Core数，将用于docker run --cpu-shares参数，如果整数后跟m，表示占用权重，1Core=1000m</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">String</span>          <span class="c1"># 内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span>
    <span class="na">requests</span><span class="pi">:</span>                 <span class="c1"># 资源请求的设置</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="s">string</span>             <span class="c1"># CPU请求，容器启动的初始可用数量</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">string</span>          <span class="c1"># 内存请求，容器启动的初始可用数量</span>
  <span class="na">livenessProbe</span><span class="pi">:</span>   
<span class="err"> </span><span class="s">　　　　</span>           <span class="c1"># 对Pod内容器健康检查设置，当探测无响应几次后将自动重启该容器，检查方法有exec、httpGet和tcpSocket，对一个容器只需设置其中一种方法即可。</span>
    <span class="na">exec</span><span class="pi">:</span>                     <span class="c1"># 对Pod容器内检查方式设置为exec方式</span>
      <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">String</span><span class="pi">]</span>       <span class="c1"># exec方式需要制定的命令或脚本</span>
    <span class="na">httpGet</span><span class="pi">:</span>                  <span class="c1"># 对Pod容器内检查方式设置为HttpGet方式，需要指定path、port</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s">String</span>            <span class="c1"># 网址URL路径（去除对应的域名或IP地址的部分）</span>
      <span class="na">port</span><span class="pi">:</span> <span class="s">Int</span>               <span class="c1"># 对应端口</span>
      <span class="na">host</span><span class="pi">:</span> <span class="s">String</span>            <span class="c1"># 域名或IP地址</span>
      <span class="na">schema</span><span class="pi">:</span> <span class="s">String</span>          <span class="c1"># 对应的检测协议，如http</span>
      <span class="na">HttpHeaders</span><span class="pi">:</span>            <span class="c1"># 指定报文头部信息</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">String</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">String</span>
    <span class="na">tcpSocket</span><span class="pi">:</span>                <span class="c1"># 对Pod容器内检查方式设置为tcpSocket方式</span>
      <span class="na">port</span><span class="pi">:</span> <span class="s">Int</span>
    <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="s">Int</span>  <span class="c1"># 容器启动完成后首次探测的时间，单位为秒</span>
    <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="s">Int</span>       <span class="c1"># 对容器健康检查探测等待响应的超时时间，单位为秒，默认为1秒</span>
    <span class="na">periodSeconds</span><span class="pi">:</span> <span class="s">Int</span>        <span class="c1"># 对容器监控检查的定期探测时间设置，单位为秒，默认10秒一次</span>
    <span class="na">successThreshold</span><span class="pi">:</span> <span class="s">Int</span>     <span class="c1"># 探测几次成功后认为成功</span>
    <span class="na">failureThreshold</span><span class="pi">:</span> <span class="s">Int</span>     <span class="c1"># 探测几次失败后认为失败</span>
    <span class="na">securityContext</span><span class="pi">:</span>
      <span class="na">privileged</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">restartPolicy</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">Always | Never | OnFailure</span><span class="pi">}</span> 
<span class="err"> </span><span class="s">　　　　</span>           <span class="c1"># Pod的重启策略，Always表示一旦不管以何种方式终止运行，kubelet都将重启，OnFailure表示只有Pod以非0退出码才重启，Nerver表示不再重启该Pod</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>              <span class="c1"># 设置NodeSelector表示将该Pod调度到包含这个label的node上，以Key:Value的格式指定</span>
    <span class="na">Key</span><span class="pi">:</span> <span class="s">Value</span>               <span class="c1"># 调度到指定的标签Node上</span>
  <span class="na">imagePullSecrets</span><span class="pi">:</span>          <span class="c1"># Pull镜像时使用的secret名称，以Key:SecretKey格式指定</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">String</span>
  <span class="na">hostNetwork</span><span class="pi">:</span> <span class="no">false</span>         <span class="c1"># 是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</span>
  <span class="na">volumes</span><span class="pi">:</span>                   <span class="c1"># 在该Pod上定义共享存储卷列表</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">String</span>             <span class="c1"># 共享存储卷名称（Volumes类型有多种）</span>
    <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{</span> <span class="pi">}</span>            <span class="c1"># 类型为emptyDir的存储卷，与Pod同生命周期的一个临时目录，为空值</span>
    <span class="na">hostPath</span><span class="pi">:</span> <span class="s">String</span>         <span class="c1"># 类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">String</span>             <span class="c1"># Pod所在宿主机的目录，将被用于同期中Mount的目录</span>
  <span class="na">secret</span><span class="pi">:</span>                    <span class="c1"># 类型为Secret的存储卷，挂载集群与定义的Secret对象到容器内部</span>
    <span class="na">secretname</span><span class="pi">:</span> <span class="s">String</span>
    <span class="na">items</span><span class="pi">:</span>                   <span class="c1"># 当仅需挂载一个Secret对象中的指定Key时使用</span>
    <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">String</span>
     <span class="na">path</span><span class="pi">:</span> <span class="s">String</span>
  <span class="na">configMap</span><span class="pi">:</span>                 <span class="c1"># 类型为ConfigMap的存储卷，挂载预定义的ConfigMap对象到容器内部</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">String</span>
    <span class="na">items</span><span class="pi">:</span>                   <span class="c1"># 当仅需挂载一个ConfigMap对象中的指定Key时使用</span>
    <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">String</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s">String</span>
</code></pre></div></div>

<p>参考: https://www.cnblogs.com/kevingrace/p/11309409.html</p>

<h4 id="使用yaml文件创建">使用yaml文件创建</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl apply <span class="nt">-f</span> pod.yaml
pod/pod1 created
</code></pre></div></div>

<p>验证</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods
NAME   READY   STATUS    RESTARTS   AGE
pod1   1/1     Running   0          24s
</code></pre></div></div>

<h4 id="创建pod时指定pod运行其它进程">创建pod时指定pod运行其它进程</h4>

<p>kubectl run 名字 –image=镜像 –dry-run=client -o yaml – “命令” &gt;pod.yaml</p>

<p>kubectl run 名字 –image=镜像 –dry-run=client -o yaml – sh -c “命令” &gt;pod.yaml</p>

<p>–两边要有空格</p>

<p>–dry-run=client -o yaml 下载–前面，命令卸载– 后面</p>

<p>pod中执行echo aa,休眠1000秒</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl run pod2 <span class="nt">--image</span><span class="o">=</span>nginx <span class="nt">--image-pull-policy</span><span class="o">=</span>IfNotPresent <span class="nt">--dry-run</span><span class="o">=</span>client <span class="nt">-o</span> yaml <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s2">"echo aa; sleep 1000"</span><span class="o">&gt;</span> pod2.yaml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">run</span><span class="pi">:</span> <span class="s">pod2</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pod2</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">sh</span>
    <span class="pi">-</span> <span class="s">-c</span>
    <span class="pi">-</span> <span class="s">echo aa; sleep </span><span class="m">1000</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">pod2</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">dnsPolicy</span><span class="pi">:</span> <span class="s">ClusterFirst</span>
  <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Always</span>
<span class="na">status</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre></div></div>

<p>创建</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl apply <span class="nt">-f</span> pod2.yaml
pod/pod2 created
</code></pre></div></div>

<p>删除</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete <span class="nt">-f</span> pod2.yaml
</code></pre></div></div>

<h4 id="pod创建多容器">pod创建多容器</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">run</span><span class="pi">:</span> <span class="s">pod2</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pod2</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">sh"</span><span class="pi">,</span><span class="s2">"</span><span class="s">-c"</span><span class="pi">,</span><span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">aa;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span><span class="pi">]</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">c1</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">c2</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
  <span class="na">dnsPolicy</span><span class="pi">:</span> <span class="s">ClusterFirst</span>
  <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Always</span>
<span class="na">status</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre></div></div>

<p>查看</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods
NAME   READY   STATUS    RESTARTS   AGE
pod1   1/1     Running   0          9m46s
pod2   2/2     Running   0          13s
</code></pre></div></div>

<p>查看标签</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods <span class="nt">--show-labels</span>
NAME   READY   STATUS    RESTARTS   AGE   LABELS
pod1   1/1     Running   0          10m   <span class="nv">run</span><span class="o">=</span>pod1
pod2   2/2     Running   0          40s   <span class="nv">run</span><span class="o">=</span>pod2
</code></pre></div></div>

<p>指定标签查看</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods <span class="nt">-l</span> <span class="nv">run</span><span class="o">=</span>pod2
NAME   READY   STATUS    RESTARTS   AGE
pod2   2/2     Running   0          67s
</code></pre></div></div>

<h3 id="在pod里执行命令">在pod里执行命令</h3>

<p>kubectl exec pod 名字 – 命令</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl <span class="nb">exec </span>pod1 <span class="nt">--</span> <span class="nb">ls</span> /usr/share/nginx/html
50x.html
index.html
</code></pre></div></div>

<p>拷贝文件</p>

<p>kubectl cp /path1/fil1 pod:/path2/ 把物理机文件/path1/file1拷贝到pod的path2里</p>

<p>kubectl cp pod:/path1/fil1 /path2/ 把pod的文件path2里 拷贝到物理机/path1/file1</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl <span class="nb">cp</span> /etc/hosts pod1:/usr/share/nginx/html
<span class="o">[</span>root@master ~]# kubectl <span class="nb">exec </span>pod1 <span class="nt">--</span> <span class="nb">ls</span> /usr/share/nginx/html
50x.html
hosts
index.html
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl <span class="nb">cp </span>pod1:/usr/share/nginx/html/ /tmp
<span class="nb">tar</span>: Removing leading <span class="sb">`</span>/<span class="s1">' from member names
[root@master ~]# ls /tmp/
50x.html 
</span></code></pre></div></div>

<p>进入pod获取bash</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl <span class="nb">exec</span> <span class="nt">-it</span> pod1 <span class="nt">--</span> bash
root@pod1:/# <span class="nb">exit
exit</span>
</code></pre></div></div>

<p>多个pod默认进入第一个</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl <span class="nb">exec</span> <span class="nt">-it</span> pod2 <span class="nt">--</span> bash
Defaulted container <span class="s2">"c1"</span> out of: c1, c2
root@pod2:/# <span class="nb">exit
exit</span>
<span class="o">[</span>root@master ~]# 
</code></pre></div></div>

<p>使用 -c 指定容器名</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl <span class="nb">exec</span> <span class="nt">-it</span> pod2 <span class="nt">-c</span> c2 <span class="nt">--</span> bash 
root@pod2:/# <span class="nb">exit
exit</span>
</code></pre></div></div>

<p>查看pod属性</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl describe pod pod2
Name:         pod2
Namespace:    default
Priority:     0
Node:         node1/192.168.122.202
Start Time:   Mon, 11 Jul 2022 01:35:21 +0800
Labels:       <span class="nv">run</span><span class="o">=</span>pod2
Annotations:  cni.projectcalico.org/containerID: 81dcb5949057c2d0a998f5119020dd76ee12dc2d9faa79e30c00d93709d21e5e
              cni.projectcalico.org/podIP: 10.244.166.134/32
              cni.projectcalico.org/podIPs: 10.244.166.134/32
Status:       Running
IP:           10.244.166.134
IPs:
  IP:  10.244.166.134
Containers:
  c1:
    Container ID:  docker://0449ea9f0ea0921a06b1f11e8ac89414c11db12e28aee93882c5d574906684bb
    Image:         nginx
    Image ID:      docker-pullable://nginx@sha256:0d17b565c37bcbd895e9d92315a05c1c3c9a29f762b011a10c54a66cd53c9b31
    Port:          &lt;none&gt;
    Host Port:     &lt;none&gt;
    Command:
      sh
      <span class="nt">-c</span>
      <span class="nb">echo </span>aa<span class="p">;</span> <span class="nb">sleep </span>1000
    State:          Running
      Started:      Mon, 11 Jul 2022 23:55:07 +0800
    Last State:     Terminated
      Reason:       Error
      Exit Code:    137
      Started:      Mon, 11 Jul 2022 01:35:22 +0800
      Finished:     Mon, 11 Jul 2022 01:37:13 +0800
    Ready:          True
    Restart Count:  1
    Environment:    &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-789mj <span class="o">(</span>ro<span class="o">)</span>
  c2:
    Container ID:   docker://39c132c6c5a53c4b1667b44c303e3d25d7280de889bd7bf2509dcde1d2b44623
    Image:          nginx
    Image ID:       docker-pullable://nginx@sha256:0d17b565c37bcbd895e9d92315a05c1c3c9a29f762b011a10c54a66cd53c9b31
    Port:           &lt;none&gt;
    Host Port:      &lt;none&gt;
    State:          Running
      Started:      Mon, 11 Jul 2022 23:55:07 +0800
    Last State:     Terminated
      Reason:       Completed
      Exit Code:    0
      Started:      Mon, 11 Jul 2022 01:35:23 +0800
      Finished:     Mon, 11 Jul 2022 01:37:03 +0800
    Ready:          True
    Restart Count:  1
    Environment:    &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-789mj <span class="o">(</span>ro<span class="o">)</span>
Conditions:
  Type              Status
  Initialized       True 
  Ready             True 
  ContainersReady   True 
  PodScheduled      True 
Volumes:
  kube-api-access-789mj:
    Type:                    Projected <span class="o">(</span>a volume that contains injected data from multiple sources<span class="o">)</span>
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       &lt;nil&gt;
    DownwardAPI:             <span class="nb">true
</span>QoS Class:                   BestEffort
Node-Selectors:              &lt;none&gt;
Tolerations:                 node.kubernetes.io/not-ready:NoExecute <span class="nv">op</span><span class="o">=</span>Exists <span class="k">for </span>300s
                             node.kubernetes.io/unreachable:NoExecute <span class="nv">op</span><span class="o">=</span>Exists <span class="k">for </span>300s
Events:
  Type    Reason          Age                From               Message
  <span class="nt">----</span>    <span class="nt">------</span>          <span class="nt">----</span>               <span class="nt">----</span>               <span class="nt">-------</span>
  Normal  Scheduled       22h                default-scheduler  Successfully assigned default/pod2 to node1
  Normal  Pulled          22h                kubelet            Container image <span class="s2">"nginx"</span> already present on machine
  Normal  Created         22h                kubelet            Created container c1
  Normal  Started         22h                kubelet            Started container c1
  Normal  Pulled          22h                kubelet            Container image <span class="s2">"nginx"</span> already present on machine
  Normal  Created         22h                kubelet            Created container c2
  Normal  Started         22h                kubelet            Started container c2
  Normal  SandboxChanged  13m <span class="o">(</span>x2 over 13m<span class="o">)</span>  kubelet            Pod sandbox changed, it will be killed and re-created.
  Normal  Pulled          13m                kubelet            Container image <span class="s2">"nginx"</span> already present on machine
  Normal  Created         13m                kubelet            Created container c1
  Normal  Started         13m                kubelet            Started container c1
  Normal  Pulled          13m                kubelet            Container image <span class="s2">"nginx"</span> already present on machine
  Normal  Created         13m                kubelet            Created container c2
  Normal  Started         13m                kubelet            Started container c2
</code></pre></div></div>

<p>查看pod输出</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl logs pod1
/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
/docker-entrypoint.sh: Looking <span class="k">for </span>shell scripts <span class="k">in</span> /docker-entrypoint.d/
/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh
10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf
10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 <span class="k">in</span> /etc/nginx/conf.d/default.conf
/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh
/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh
/docker-entrypoint.sh: Configuration <span class="nb">complete</span><span class="p">;</span> ready <span class="k">for </span>start up
2022/07/11 15:55:05 <span class="o">[</span>notice] 1#1: using the <span class="s2">"epoll"</span> event method
2022/07/11 15:55:05 <span class="o">[</span>notice] 1#1: nginx/1.21.5
2022/07/11 15:55:05 <span class="o">[</span>notice] 1#1: built by gcc 10.2.1 20210110 <span class="o">(</span>Debian 10.2.1-6<span class="o">)</span> 
2022/07/11 15:55:05 <span class="o">[</span>notice] 1#1: OS: Linux 3.10.0-862.el7.x86_64
2022/07/11 15:55:05 <span class="o">[</span>notice] 1#1: getrlimit<span class="o">(</span>RLIMIT_NOFILE<span class="o">)</span>: 65536:65536
2022/07/11 15:55:05 <span class="o">[</span>notice] 1#1: start worker processes
2022/07/11 15:55:05 <span class="o">[</span>notice] 1#1: start worker process 31
2022/07/11 15:55:05 <span class="o">[</span>notice] 1#1: start worker process 32
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl logs pod2
error: a container name must be specified <span class="k">for </span>pod pod2, choose one of: <span class="o">[</span>c1 c2]
<span class="o">[</span>root@master ~]# kubectl logs pod2 <span class="nt">-c</span> c1
aa
</code></pre></div></div>

<p>删除pod</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl delete pod pod1
pod <span class="s2">"pod1"</span> deleted
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl delete <span class="nt">-f</span> pod2.yaml
pod <span class="s2">"pod2"</span> deleted
</code></pre></div></div>

<h4 id="生命周期">生命周期</h4>

<p>增加–force会提高删除pod的速度, 不加慢的原因是 pod的删除有个延期删除,默认是30s,可以通过 terminationGracePeriodSeconds来制定</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">run</span><span class="pi">:</span> <span class="s">pod2</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pod2</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">15</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">sh"</span><span class="pi">,</span><span class="s2">"</span><span class="s">-c"</span><span class="pi">,</span><span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">aa;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span><span class="pi">]</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">c1</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">c2</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
  <span class="na">dnsPolicy</span><span class="pi">:</span> <span class="s">ClusterFirst</span>
  <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Always</span>
<span class="na">status</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre></div></div>

<p>此参数对nginx不起作用</p>

<p>如果pod被强制删除,客户端访问报错，可以使用钩子解决</p>

<p>1、postStart: 创建pod的时候,会随着pod里的主进程同时运行,没有先后顺序</p>

<p>2、preStop: 删除pod的时候,要先运行preStop里的程序,之后再关闭pod.</p>

<p>preStop也必须在terminationGracePeriodSeconds时间内完成.否则会被强制删除</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">run</span><span class="pi">:</span> <span class="s">pod2</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pod2</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">600</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">sh"</span><span class="pi">,</span><span class="s2">"</span><span class="s">-c"</span><span class="pi">,</span><span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">aa;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span><span class="pi">]</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">c1</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">{}</span>
    <span class="na">lifecycle</span><span class="pi">:</span>
      <span class="na">preStop</span><span class="pi">:</span>
        <span class="na">exec</span><span class="pi">:</span>
          <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/bin/bash"</span><span class="pi">,</span><span class="s2">"</span><span class="s">-c"</span><span class="pi">,</span><span class="s2">"</span><span class="s">/usr/sbin/nginx</span><span class="nv"> </span><span class="s">-s</span><span class="nv"> </span><span class="s">quit"</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">c2</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
  <span class="na">dnsPolicy</span><span class="pi">:</span> <span class="s">ClusterFirst</span>
  <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Always</span>
<span class="na">status</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre></div></div>

<h3 id="创建初始化pod">创建初始化pod</h3>

<h4 id="初始化容器在正式运行容器前执行准备工作">初始化容器,在正式运行容器前执行准备工作</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    run: pod3
  name: pod3
spec:
  containers:
  - image: nginx
    name: c1
    imagePullPolicy: IfNotPresent
    resources: <span class="o">{}</span>
  initContainers:
  - image: docker.io/alpine:latest
    name: xx
    imagePullPolicy: IfNotPresent
    <span class="nb">command</span>: <span class="o">[</span><span class="s2">"/bin/sh"</span>,<span class="s2">"-c"</span>,<span class="s2">"/sbin/sysctl -w vm.swappiness=10"</span><span class="o">]</span>
    securityContext:
      privileged: <span class="nb">true
    </span>resources: <span class="o">{}</span>
  dnsPolicy: ClusterFirst
  restartPolicy: Always
status: <span class="o">{}</span>
</code></pre></div></div>

<p>里面有两个容器,一个初始化容器xx和一个普通容器c1.xx运行起来，修改pod所在物理机的内核参数</p>

<p>测试</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@node1 ~]# <span class="nb">cat</span> /proc/sys/vm/swappiness 
30
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@node2 ~]# <span class="nb">cat</span> /proc/sys/vm/swappiness
30
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods <span class="nt">-o</span> wide
NAME   READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES
pod3   1/1     Running   0          22s   10.244.104.7   node2   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@node2 ~]# <span class="nb">cat</span> /proc/sys/vm/swappiness
10
</code></pre></div></div>

<p>通过初始化容器和普通容器共享数据</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">myapp</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">myapp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">volumes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">workdir</span> <span class="c1"># 定义一个workdir的存储卷</span>
    <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">podx</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">volumeMounts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">workdir</span>
      <span class="na">mountPath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/xx"</span> <span class="c1">#把workdir挂载到容器的/xx目录</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">initContainers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">busybox</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">poda</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/bin/sh"</span><span class="pi">,</span><span class="s2">"</span><span class="s">-c"</span><span class="pi">,</span><span class="s2">"</span><span class="s">touch</span><span class="nv"> </span><span class="s">/work-dir/aa.txt"</span><span class="pi">]</span>
    <span class="na">volumeMounts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">workdir</span>
      <span class="na">mountPath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/work-dir"</span> <span class="c1"># 把workdir挂载到容器的/work-dir目录</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">dnsPolicy</span><span class="pi">:</span> <span class="s">ClusterFirst</span>
  <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Always</span>
<span class="na">status</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre></div></div>

<p>pod名称为myapp, 在pod中创建一个名字为workdir的存储卷.</p>

<p>poda是初始化容器,把存储卷workdir挂载到本容器的/work-dir目录。然后在挂载点/work-dir里创建aa.txt</p>

<p>普通容器podx会把存储卷workdir挂载到本容器的/xx里,访问/xx的时候实际上访问的就是存储卷workdir.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods <span class="nt">-o</span> wide
NAME    READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES
myapp   1/1     Running   0          12s   10.244.166.135   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl <span class="nb">exec </span>myapp <span class="nt">-c</span> podx <span class="nt">--</span> <span class="nb">ls</span> /xx
aa.txt
</code></pre></div></div>

<p>删除pod</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl delete <span class="nt">-f</span> pod3.yaml
pod <span class="s2">"pod3"</span> deleted
<span class="o">[</span>root@master pod]# kubectl delete <span class="nt">-f</span> pod4.yaml
pod <span class="s2">"myapp"</span> deleted
</code></pre></div></div>

<h3 id="创建静态pod">创建静态Pod</h3>

<h4 id="在node上创建">在node上创建</h4>

<p>静态pod 不是由master创建启动,在node上只要启动kubelet，就会自动创建pod</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@node1 ~]# systemctl status kubelet <span class="nt">-l</span>
● kubelet.service - kubelet: The Kubernetes Node Agent
   Loaded: loaded <span class="o">(</span>/usr/lib/systemd/system/kubelet.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: disabled<span class="o">)</span>
  Drop-In: /usr/lib/systemd/system/kubelet.service.d
           └─10-kubeadm.conf
</code></pre></div></div>

<p>配置文件地址</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf
</code></pre></div></div>

<p>编辑文件,追加–pod-manifest-path=/etc/kubernetes/kubelet.d</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Note: This dropin only works with kubeadm and kubelet v1.11+</span>
<span class="o">[</span>Service]
<span class="nv">Environment</span><span class="o">=</span><span class="s2">"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --pod-manifest-path=/etc/kubernetes/kubelet.d"</span>
<span class="nv">Environment</span><span class="o">=</span><span class="s2">"KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"</span>
<span class="c"># This is a file that "kubeadm init" and "kubeadm join" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span>
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/var/lib/kubelet/kubeadm-flags.env
<span class="c"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span>
<span class="c"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span>
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/sysconfig/kubelet
<span class="nv">ExecStart</span><span class="o">=</span>
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/kubelet <span class="nv">$KUBELET_KUBECONFIG_ARGS</span> <span class="nv">$KUBELET_CONFIG_ARGS</span> <span class="nv">$KUBELET_KUBEADM_ARGS</span> <span class="nv">$KUBELET_EXTRA_ARGS</span>

</code></pre></div></div>

<p>重启服务</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@node1 ~]# systemctl daemon-reload
<span class="o">[</span>root@node1 ~]# systemctl restart kubelet
<span class="o">[</span>root@node1 pod]# <span class="nb">mkdir</span> <span class="nt">-p</span> /etc/kubernetes/kubelet.d
</code></pre></div></div>

<p>在node1上创建pod</p>

<p>vim /etc/kubernetes/kubelet.d/pod.yaml</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">run</span><span class="pi">:</span> <span class="s">myrole</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">static-web</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">web</span>   
</code></pre></div></div>

<p>在master上查看</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods 
NAME               READY   STATUS    RESTARTS   AGE
static-web-node1   1/1     Running   1          57s
</code></pre></div></div>

<p>在node1上删除</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@node1 pod]# <span class="nb">rm</span> <span class="nt">-rf</span> /etc/kubernetes/kubelet.d/pod.yaml 
</code></pre></div></div>

<p>在master上查看</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods 
No resources found <span class="k">in </span>default namespace.
</code></pre></div></div>

<h4 id="在master上创建">在master上创建</h4>

<p>可以在master上看到 Environment=”KUBELET_CONFIG_ARGS=–config=/var/lib/kubelet/config.yaml”</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# <span class="nb">cat</span> /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf
<span class="c"># Note: This dropin only works with kubeadm and kubelet v1.11+</span>
<span class="o">[</span>Service]
<span class="nv">Environment</span><span class="o">=</span><span class="s2">"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"</span>
<span class="nv">Environment</span><span class="o">=</span><span class="s2">"KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"</span>
<span class="c"># This is a file that "kubeadm init" and "kubeadm join" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span>
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/var/lib/kubelet/kubeadm-flags.env
<span class="c"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span>
<span class="c"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span>
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/sysconfig/kubelet
<span class="nv">ExecStart</span><span class="o">=</span>
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/kubelet <span class="nv">$KUBELET_KUBECONFIG_ARGS</span> <span class="nv">$KUBELET_CONFIG_ARGS</span> <span class="nv">$KUBELET_KUBEADM_ARGS</span> <span class="nv">$KUBELET_EXTRA_ARGS</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# <span class="nb">grep </span>static /var/lib/kubelet/config.yaml
staticPodPath: /etc/kubernetes/manifests
</code></pre></div></div>

<h3 id="指定pod在指定的节点上运行">指定pod在指定的节点上运行</h3>

<p>给节点添加标签,指定pod在特定的节点上运行</p>

<p>标签格式: key = value</p>

<h4 id="查看节点的标签">查看节点的标签</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl get nodes <span class="nt">--show-labels</span>
NAME     STATUS   ROLES                  AGE    VERSION   LABELS
master   Ready    control-plane,master   4d2h   v1.21.1   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>master,kubernetes.io/os<span class="o">=</span>linux,node-role.kubernetes.io/control-plane<span class="o">=</span>,node-role.kubernetes.io/master<span class="o">=</span>,node.kubernetes.io/exclude-from-external-load-balancers<span class="o">=</span>
node1    Ready    &lt;none&gt;                 4d2h   v1.21.1   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>node1,kubernetes.io/os<span class="o">=</span>linux
node2    Ready    &lt;none&gt;                 4d2h   v1.21.1   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>node2,kubernetes.io/os<span class="o">=</span>linux
</code></pre></div></div>

<h4 id="查看特定节点的标签">查看特定节点的标签</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl get nodes node1 <span class="nt">--show-labels</span>
NAME    STATUS   ROLES    AGE    VERSION   LABELS
node1   Ready    &lt;none&gt;   4d2h   v1.21.1   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>node1,kubernetes.io/os<span class="o">=</span>linux
</code></pre></div></div>

<h4 id="给节点设置标签">给节点设置标签</h4>

<p>kubectl label node 节点名 key=value</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl label node node1 <span class="nv">mytag</span><span class="o">=</span>node1
node/node1 labeled
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl get nodes node1 <span class="nt">--show-labels</span>
NAME    STATUS   ROLES    AGE    VERSION   LABELS
node1   Ready    &lt;none&gt;   4d2h   v1.21.1   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>node1,kubernetes.io/os<span class="o">=</span>linux,mytag<span class="o">=</span>node1
</code></pre></div></div>

<h4 id="取消某个节点的标签">取消某个节点的标签</h4>

<p>kubectl label node 节点名 key-</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl label node node1 mytag-
node/node1 labeled
<span class="o">[</span>root@master ~]# kubectl get nodes node1 <span class="nt">--show-labels</span>
NAME    STATUS   ROLES    AGE    VERSION   LABELS
node1   Ready    &lt;none&gt;   4d2h   v1.21.1   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>node1,kubernetes.io/os<span class="o">=</span>linux
</code></pre></div></div>

<h4 id="给所有节点设置标签">给所有节点设置标签</h4>

<p>kubectl label node –all key=value</p>

<p>给nod1设置ROLES为NODE1,node2设置ROLES为NODE2</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl label nodes node1 node-role.kubernetes.io/node1<span class="o">=</span><span class="s2">""</span>
node/node1 labeled
<span class="o">[</span>root@master ~]# kubectl get nodes node1 <span class="nt">--show-labels</span>
NAME    STATUS   ROLES   AGE    VERSION   LABELS
node1   Ready    node1   4d2h   v1.21.1   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>node1,kubernetes.io/os<span class="o">=</span>linux,node-role.kubernetes.io/node1<span class="o">=</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl label nodes node2 node-role.kubernetes.io/node2<span class="o">=</span><span class="s2">""</span>
node/node2 labeled
<span class="o">[</span>root@master ~]# kubectl get nodes node2 <span class="nt">--show-labels</span>
NAME    STATUS   ROLES   AGE    VERSION   LABELS
node2   Ready    node2   4d2h   v1.21.1   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>node2,kubernetes.io/os<span class="o">=</span>linux,node-role.kubernetes.io/node2<span class="o">=</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master ~]# kubectl get nodes
NAME     STATUS   ROLES                  AGE    VERSION
master   Ready    control-plane,master   4d2h   v1.21.1
node1    Ready    node1                  4d2h   v1.21.1
node2    Ready    node2                  4d2h   v1.21.1
</code></pre></div></div>

<h4 id="创建指定节点运行的pod">创建指定节点运行的pod</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span>  <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span>  <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">web1</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">role</span><span class="pi">:</span>  <span class="s">myrole</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="na">mytag</span><span class="pi">:</span>  <span class="s">node1</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span>  <span class="s">web</span>
      <span class="na">image</span><span class="pi">:</span>  <span class="s">nginx</span>
      <span class="na">imagePullPolicy</span><span class="pi">:</span>  <span class="s">IfNotPresent</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl apply <span class="nt">-f</span> podlabel.yaml
pod/web1 created
</code></pre></div></div>

<p>web1只会运行在含有标签为mytag=node1的节点上</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods
NAME   READY   STATUS    RESTARTS   AGE
web1   1/1     Running   0          9s
</code></pre></div></div>

<h4 id="创建在特定节点上运行的pod">创建在特定节点上运行的pod</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">root@master pod</span><span class="pi">]</span><span class="c1"># cat podlabel.yaml </span>
<span class="na">apiVersion</span><span class="pi">:</span>  <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span>  <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">web1</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">role</span><span class="pi">:</span>  <span class="s">myrole</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="na">mytag</span><span class="pi">:</span>  <span class="s">node1</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span>  <span class="s">web</span>
      <span class="na">image</span><span class="pi">:</span>  <span class="s">nginx</span>
      <span class="na">imagePullPolicy</span><span class="pi">:</span>  <span class="s">IfNotPresent</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl apply <span class="nt">-f</span> podlabel.yaml
pod/web1 created
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods
NAME   READY   STATUS    RESTARTS   AGE
web1   1/1     Running   0          9s
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods <span class="nt">-o</span> wide
NAME   READY   STATUS    RESTARTS   AGE     IP               NODE    NOMINATED NODE   READINESS GATES
web1   1/1     Running   0          8m12s   10.244.166.139   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<h4 id="annotations设置">Annotations设置</h4>

<p>不管node还是pod,包括后面讲述的其他对象(比如deployment),都还有一个属性Annotations。这个属性可以理解为注释</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl describe nodes node1
Name:               node1
Roles:              node1
Labels:             beta.kubernetes.io/arch<span class="o">=</span>amd64
                    beta.kubernetes.io/os<span class="o">=</span>linux
                    kubernetes.io/arch<span class="o">=</span>amd64
                    kubernetes.io/hostname<span class="o">=</span>node1
                    kubernetes.io/os<span class="o">=</span>linux
                    <span class="nv">mytag</span><span class="o">=</span>node1
                    node-role.kubernetes.io/node1<span class="o">=</span>
Annotations:        kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock
                    node.alpha.kubernetes.io/ttl: 0
                    projectcalico.org/IPv4Address: 192.168.122.202/24
                    projectcalico.org/IPv4IPIPTunnelAddr: 10.244.166.128
                    volumes.kubernetes.io/controller-managed-attach-detach: <span class="nb">true</span>
</code></pre></div></div>

<p>设置Annotations</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl annotate nodes node1 <span class="nv">name</span><span class="o">=</span>yinyaliang
node/node1 annotated
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl describe node node1
Name:               node1
Roles:              node1
Labels:             beta.kubernetes.io/arch<span class="o">=</span>amd64
                    beta.kubernetes.io/os<span class="o">=</span>linux
                    kubernetes.io/arch<span class="o">=</span>amd64
                    kubernetes.io/hostname<span class="o">=</span>node1
                    kubernetes.io/os<span class="o">=</span>linux
                    <span class="nv">mytag</span><span class="o">=</span>node1
                    node-role.kubernetes.io/node1<span class="o">=</span>
Annotations:        kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock
                    name: yinyaliang
                    node.alpha.kubernetes.io/ttl: 0
                    projectcalico.org/IPv4Address: 192.168.122.202/24
                    projectcalico.org/IPv4IPIPTunnelAddr: 10.244.166.128
                    volumes.kubernetes.io/controller-managed-attach-detach: <span class="nb">true</span>
</code></pre></div></div>

<h3 id="通过cordon及drain把节点设置为维护模式">通过cordon及drain把节点设置为维护模式</h3>

<h4 id="cordon">cordon</h4>

<p>如果某个节点不可用,可以对节点实施cordon或drain操作.这样节点会标记为SchedulingDisabled.新建的pod就会不再分配到这个节点</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get nodes
NAME     STATUS   ROLES                  AGE    VERSION
master   Ready    control-plane,master   4d3h   v1.21.1
node1    Ready    node1                  4d2h   v1.21.1
node2    Ready    node2                  4d3h   v1.21.1
</code></pre></div></div>

<p>都为ready，说明节点都可以调度</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl create deployment nginx <span class="nt">--image</span><span class="o">=</span>nginx <span class="nt">--dry-run</span><span class="o">=</span>client <span class="nt">-o</span> yaml&gt;d1.yaml
</code></pre></div></div>

<p>修改d1.yaml的replicas为3</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl apply <span class="nt">-f</span> d1.yaml 
deployment.apps/nginx created
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods <span class="nt">-o</span> wide
NAME                     READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES
nginx-6799fc88d8-9qrsp   1/1     Running   0          49s   10.244.104.10    node2   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-nvch7   1/1     Running   0          49s   10.244.104.9     node2   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-rljcr   1/1     Running   0          49s   10.244.104.8     node2   &lt;none&gt;           &lt;none&gt;
web1                     1/1     Running   0          15m   10.244.166.139   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>三个都被分配到node2上,把node2标记不可用</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl cordon node2
node/node2 cordoned
</code></pre></div></div>

<p>再次查看</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get nodes
NAME     STATUS                     ROLES                  AGE    VERSION
master   Ready                      control-plane,master   4d3h   v1.21.1
node1    Ready                      node1                  4d2h   v1.21.1
node2    Ready,SchedulingDisabled   node2                  4d3h   v1.21.1
</code></pre></div></div>

<p>扩展deployment为6个副本</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl apply <span class="nt">-f</span> d1.yaml
deployment.apps/nginx configured
</code></pre></div></div>

<p>或者</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl scale deployment nginx <span class="nt">--replicas</span><span class="o">=</span>6
</code></pre></div></div>

<p>可以看到新建节点都在node1上</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods <span class="nt">-o</span> wide
NAME                     READY   STATUS    RESTARTS   AGE     IP               NODE    NOMINATED NODE   READINESS GATES
nginx-6799fc88d8-6cxhg   1/1     Running   0          56s     10.244.166.142   node1   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-9qrsp   1/1     Running   0          3m53s   10.244.104.10    node2   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-hfxch   1/1     Running   0          56s     10.244.166.140   node1   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-nvch7   1/1     Running   0          3m53s   10.244.104.9     node2   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-rljcr   1/1     Running   0          3m53s   10.244.104.8     node2   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-skhmd   1/1     Running   0          56s     10.244.166.141   node1   &lt;none&gt;           &lt;none&gt;
web1                     1/1     Running   0          18m     10.244.166.139   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>从node2上删除一个节点测试</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl delete pod nginx-6799fc88d8-9qrsp
pod <span class="s2">"nginx-6799fc88d8-9qrsp"</span> deleted
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods <span class="nt">-o</span> wide
NAME                     READY   STATUS    RESTARTS   AGE     IP               NODE    NOMINATED NODE   READINESS GATES
nginx-6799fc88d8-6cxhg   1/1     Running   0          2m21s   10.244.166.142   node1   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-hfxch   1/1     Running   0          2m21s   10.244.166.140   node1   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-kkwps   1/1     Running   0          22s     10.244.166.143   node1   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-nvch7   1/1     Running   0          5m18s   10.244.104.9     node2   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-rljcr   1/1     Running   0          5m18s   10.244.104.8     node2   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-skhmd   1/1     Running   0          2m21s   10.244.166.141   node1   &lt;none&gt;           &lt;none&gt;
web1                     1/1     Running   0          20m     10.244.166.139   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>新节点也在node1上了</p>

<h4 id="drain">drain</h4>

<p>对节点的drain操作和cordon是一样的,但是drain比crodon多一个驱逐的效果 evicted,我们把nginx的deployment的副本设置为4</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl scale deploy nginx <span class="nt">--replicas</span><span class="o">=</span>4
deployment.apps/nginx scaled
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods <span class="nt">-o</span> wide
NAME                     READY   STATUS    RESTARTS   AGE     IP               NODE    NOMINATED NODE   READINESS GATES
nginx-6799fc88d8-hfxch   1/1     Running   0          4m45s   10.244.166.140   node1   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-nvch7   1/1     Running   0          7m42s   10.244.104.9     node2   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-rljcr   1/1     Running   0          7m42s   10.244.104.8     node2   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-skhmd   1/1     Running   0          4m45s   10.244.166.141   node1   &lt;none&gt;           &lt;none&gt;
web1                     1/1     Running   0          22m     10.244.166.139   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>对node2进行drain操作</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl drain node2
node/node2 already cordoned
error: unable to drain node <span class="s2">"node2"</span>, aborting command...

There are pending nodes to be drained:
 node2
error: cannot delete DaemonSet-managed Pods <span class="o">(</span>use <span class="nt">--ignore-daemonsets</span> to ignore<span class="o">)</span>: kube-system/calico-node-54njj, kube-system/kube-proxy-jgsxd
</code></pre></div></div>

<p>报错可以使用–ignore-daemonsets</p>

<p>取消node2的cordon操作</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl uncordon node2
node/node2 uncordoned
</code></pre></div></div>

<p>在对node2做drain操作</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl drain node2 <span class="nt">--ignore-daemonsets</span> <span class="nt">--delete-local-data</span>
Flag <span class="nt">--delete-local-data</span> has been deprecated, This option is deprecated and will be deleted. Use <span class="nt">--delete-emptydir-data</span><span class="nb">.</span>
node/node2 cordoned
WARNING: ignoring DaemonSet-managed Pods: kube-system/calico-node-54njj, kube-system/kube-proxy-jgsxd
evicting pod default/nginx-6799fc88d8-rljcr
evicting pod default/nginx-6799fc88d8-nvch7
pod/nginx-6799fc88d8-nvch7 evicted
pod/nginx-6799fc88d8-rljcr evicted
node/node2 evicted
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods <span class="nt">-o</span> wide
NAME                     READY   STATUS    RESTARTS   AGE     IP               NODE    NOMINATED NODE   READINESS GATES
nginx-6799fc88d8-2l9lt   1/1     Running   0          2m50s   10.244.166.144   node1   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-bhl7w   1/1     Running   0          2m50s   10.244.166.145   node1   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-hfxch   1/1     Running   0          11m     10.244.166.140   node1   &lt;none&gt;           &lt;none&gt;
nginx-6799fc88d8-skhmd   1/1     Running   0          11m     10.244.166.141   node1   &lt;none&gt;           &lt;none&gt;
web1                     1/1     Running   0          28m     10.244.166.139   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>取消drain操作</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl uncordon node2
node/node2 uncordoned
</code></pre></div></div>

<h3 id="配置并查看节点的污点">配置并查看节点的污点</h3>

<p>给节点设置及删除taint,设置operator的值为Equal,以及设置operator的值为Exists</p>

<p>如果我们给某节点设置了taint的话,只有那些设置了tolerations(容忍污点)的pod才能运行到此节点上,所以之前的调度master不会运行pod</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl describe nodes node1 | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'(Roles|Taints)'</span>
Roles:              node1
Taints:             &lt;none&gt;
<span class="o">[</span>root@master pod]# kubectl describe nodes master | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'(Roles|Taints)'</span>
Roles:              control-plane,master
Taints:             node-role.kubernetes.io/master:NoSchedule
</code></pre></div></div>

<h4 id="给节点设置污点">给节点设置污点</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl taint nodes 节点名 <span class="nv">key</span><span class="o">=</span>value:effect   这里effect一般是NoSchedule
</code></pre></div></div>

<p>所有节点</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl taint node <span class="nt">--all</span> <span class="nv">key</span><span class="o">=</span>value:NoSchedule
</code></pre></div></div>

<p>这里的value可以不写</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl taint nodes 节点名 <span class="nv">key</span><span class="o">=</span>:NoSchedule
</code></pre></div></div>

<p>删除</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl taint nodes 节点名 key-
</code></pre></div></div>

<p>为node1设置taint</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl taint nodes node1 <span class="nv">node1</span><span class="o">=</span>node1:NoSchedule
node/node1 tainted
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl describe nodes node1 | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'(Roles|Taints)'</span>
Roles:              node1
Taints:             <span class="nv">node1</span><span class="o">=</span>node1:NoSchedule
</code></pre></div></div>

<p>查看所有pod</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods <span class="nt">-o</span> wide <span class="nt">--no-headers</span>
nginx-6799fc88d8-2l9lt   1/1   Running   0     14m   10.244.166.144   node1   &lt;none&gt;   &lt;none&gt;
nginx-6799fc88d8-bhl7w   1/1   Running   0     14m   10.244.166.145   node1   &lt;none&gt;   &lt;none&gt;
nginx-6799fc88d8-hfxch   1/1   Running   0     22m   10.244.166.140   node1   &lt;none&gt;   &lt;none&gt;
nginx-6799fc88d8-skhmd   1/1   Running   0     22m   10.244.166.141   node1   &lt;none&gt;   &lt;none&gt;
web1                     1/1   Running   0     40m   10.244.166.139   node1   &lt;none&gt;   &lt;none&gt;
</code></pre></div></div>

<p>可以看到设置taint对当前正在运行的pod是不起作用的</p>

<p>把deplyment nginx的副本设置为0再设置为4.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl scale deploy nginx <span class="nt">--replicas</span><span class="o">=</span>0
deployment.apps/nginx scaled
<span class="o">[</span>root@master pod]# kubectl scale deploy nginx <span class="nt">--replicas</span><span class="o">=</span>4
deployment.apps/nginx scaled
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods <span class="nt">-o</span> wide <span class="nt">--no-headers</span>
nginx-6799fc88d8-jkfs5   0/1   ContainerCreating   0     28s   &lt;none&gt;           node2   &lt;none&gt;   &lt;none&gt;
nginx-6799fc88d8-khtnf   0/1   ContainerCreating   0     28s   &lt;none&gt;           node2   &lt;none&gt;   &lt;none&gt;
nginx-6799fc88d8-m9psk   1/1   Running             0     28s   10.244.104.11    node2   &lt;none&gt;   &lt;none&gt;
nginx-6799fc88d8-spqk8   0/1   ContainerCreating   0     28s   &lt;none&gt;           node2   &lt;none&gt;   &lt;none&gt;
web1                     1/1   Running             0     58m   10.244.166.139   node1   &lt;none&gt;   &lt;none&gt;
</code></pre></div></div>

<p>可以看到pod都在node2上运行了</p>

<p>删除nginx</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl delete deploy nginx
deployment.apps <span class="s2">"nginx"</span> deleted
</code></pre></div></div>

<p>如果需要pod在含有taint的节点上运行.则定义pod的时候需要指定toleration属性</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">tolerations</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">key</span><span class="pi">:</span>  <span class="s2">"</span><span class="s">key值"</span>
  <span class="na">operator</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Equal"</span>
  <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">value值"</span>
  <span class="na">effect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">值"</span>
</code></pre></div></div>

<p>这里的Equal需要和taint的值一样</p>

<p>Exists可以不指定value的值</p>

<h4 id="设置operator的值为equal">设置operator的值为Equal</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl describe nodes node1
Name:               node1
Roles:              node1
Labels:             beta.kubernetes.io/arch<span class="o">=</span>amd64
                    beta.kubernetes.io/os<span class="o">=</span>linux
                    kubernetes.io/arch<span class="o">=</span>amd64
                    kubernetes.io/hostname<span class="o">=</span>node1
                    kubernetes.io/os<span class="o">=</span>linux
                    <span class="nv">mytag</span><span class="o">=</span>node1
                    node-role.kubernetes.io/node1<span class="o">=</span>
Annotations:        kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock
                    name: yinyaliang
                    node.alpha.kubernetes.io/ttl: 0
                    projectcalico.org/IPv4Address: 192.168.122.202/24
                    projectcalico.org/IPv4IPIPTunnelAddr: 10.244.166.128
                    volumes.kubernetes.io/controller-managed-attach-detach: <span class="nb">true
</span>CreationTimestamp:  Sun, 10 Jul 2022 20:41:42 +0800
Taints:             <span class="nv">node1</span><span class="o">=</span>node1:NoSchedule
</code></pre></div></div>

<p>目前是 node1有标签 有污点</p>

<p>创建pod的yaml文件</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span>  <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span>  <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span>  <span class="s">web2</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">role</span><span class="pi">:</span>  <span class="s">myrole</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="na">mytag</span><span class="pi">:</span>  <span class="s">node1</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span>  <span class="s">web</span>
      <span class="na">image</span><span class="pi">:</span>  <span class="s">nginx</span>
      <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods
NAME   READY   STATUS    RESTARTS   AGE
web2   0/1     Pending   0          6s
</code></pre></div></div>

<p>会停留在pending状态</p>

<p>删除后修改yaml，增加tolerations</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">root@master pod</span><span class="pi">]</span><span class="c1"># cat podtaint.yaml </span>
<span class="na">apiVersion</span><span class="pi">:</span>  <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span>  <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span>  <span class="s">web2</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">role</span><span class="pi">:</span>  <span class="s">myrole</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="na">mytag</span><span class="pi">:</span>  <span class="s">node1</span>
  <span class="na">tolerations</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span>  <span class="s2">"</span><span class="s">node1"</span>
    <span class="na">operator</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Equal"</span>
    <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">node1"</span>
    <span class="na">effect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">NoSchedule"</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span>  <span class="s">web</span>
      <span class="na">image</span><span class="pi">:</span>  <span class="s">nginx</span>
      <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@master pod]# kubectl get pods -o wide
NAME   READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES
web2   1/1     Running   0          13s   10.244.166.146   node1   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>并不是节点设置了taint,pod设置了toleration，这个pod就一定会在此节点上运行. 这里用label来指定pod在node2上运行</p>

<p>删除pod</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete pods web2
</code></pre></div></div>

<p>删除node1上的taint</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl taint nodes node1 node1-
node/node1 untainted
</code></pre></div></div>

<p>给node1设置多个taint</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl taint nodes node1 <span class="nv">key123</span><span class="o">=</span>value123:NoSchedule
node/node1 tainted
<span class="o">[</span>root@master pod]# kubectl taint nodes node1 <span class="nv">keyxx</span><span class="o">=</span>valuexx:NoSchedule
node/node1 tainted
<span class="o">[</span>root@master pod]# kubectl taint nodes node1 <span class="nv">node1</span><span class="o">=</span>node1:NoSchedule
node/node1 tainted
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl describe nodes node1 | <span class="nb">grep</span> <span class="nt">-E</span> <span class="nt">-A2</span> <span class="s1">'(Roles|Taints)'</span>
Roles:              node1
Labels:             beta.kubernetes.io/arch<span class="o">=</span>amd64
                    beta.kubernetes.io/os<span class="o">=</span>linux
<span class="nt">--</span>
Taints:             <span class="nv">key123</span><span class="o">=</span>value123:NoSchedule
                    <span class="nv">keyxx</span><span class="o">=</span>valuexx:NoSchedule
                    <span class="nv">node1</span><span class="o">=</span>node1:NoSchedule
</code></pre></div></div>

<p>在podtaint.yaml不修改的情况下再次创建</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl apply <span class="nt">-f</span> podtaint.yaml
pod/web2 created
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods
NAME   READY   STATUS    RESTARTS   AGE
web2   0/1     Pending   0          14s
</code></pre></div></div>

<p>如果节点有多个污点则需要pod设置容忍所有的污点才可以在这个节点上运行</p>

<h4 id="operator-的值等于exists的情况">operator 的值等于Exists的情况</h4>

<p>在设置节点taint的时候,如果value的值非空,在pod里的tolerations字段只能写Equal,不能写Exists</p>

<p>取消node1的taint，只保留node1=node1</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl taint nodes node1 key123-
node/node1 untainted
<span class="o">[</span>root@master pod]# kubectl taint nodes node1 keyxx-
node/node1 untainted
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl describe nodes node1 | <span class="nb">grep </span>Taint
Taints:             <span class="nv">node1</span><span class="o">=</span>node1:NoSchedule
</code></pre></div></div>

<p>修改podtaint.yaml，配置operator的值为Exists</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion:  v1
kind:  Pod
metadata:
  name:  web2
  labels:
    role:  myrole
spec:
  nodeSelector:
    mytag:  node1
  tolerations:
  - key:  <span class="s2">"node1"</span>
    operator: <span class="s2">"Exists"</span>
    value: <span class="s2">"node1"</span>
    effect: <span class="s2">"NoSchedule"</span>
  containers:
    - name:  web
      image:  nginx
      imagePullPolicy: IfNotPresent
</code></pre></div></div>

<p>创建Pod</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl apply <span class="nt">-f</span> podtaint.yaml
The Pod <span class="s2">"web2"</span> is invalid: 
<span class="k">*</span> spec.tolerations[0].operator: Invalid value: core.Toleration<span class="o">{</span>Key:<span class="s2">"node1"</span>, Operator:<span class="s2">"Exists"</span>, Value:<span class="s2">"node1"</span>, Effect:<span class="s2">"NoSchedule"</span>, TolerationSeconds:<span class="o">(</span><span class="k">*</span>int64<span class="o">)(</span>nil<span class="o">)}</span>: value must be empty when <span class="sb">`</span>operator<span class="sb">`</span> is <span class="s1">'Exists'</span>
<span class="k">*</span> spec.tolerations: Forbidden: existing toleration can not be modified except its tolerationSeconds
</code></pre></div></div>

<p>如果operator选择的是Exists的话,是不能写value的</p>

<p>修改node1的taint的值</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl taint nodes node1 <span class="nv">node1</span><span class="o">=</span>:NoSchedule <span class="nt">--overwrite</span>
node/node1 modified
</code></pre></div></div>

<p>再修改podtaint.yaml的值</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span>  <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span>  <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span>  <span class="s">web2</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">role</span><span class="pi">:</span>  <span class="s">myrole</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="na">mytag</span><span class="pi">:</span>  <span class="s">node1</span>
  <span class="na">tolerations</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span>  <span class="s2">"</span><span class="s">node1"</span>
    <span class="na">operator</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Exists"</span>
    <span class="na">effect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">NoSchedule"</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span>  <span class="s">web</span>
      <span class="na">image</span><span class="pi">:</span>  <span class="s">nginx</span>
      <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
</code></pre></div></div>

<p>创建pod</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl apply <span class="nt">-f</span> podtaint.yaml
pod/web2 created
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl get pods
NAME   READY   STATUS    RESTARTS   AGE
web2   1/1     Running   0          31s
</code></pre></div></div>

<p>清理</p>

<p>删除 web2</p>

<p>清理node1上的taint</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@master pod]# kubectl delete pod web2
pod <span class="s2">"web2"</span> deleted
<span class="o">[</span>root@master pod]# kubectl taint nodes node1 node1-
node/node1 untainted
</code></pre></div></div>

        
      </section>

      <!-- <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 标签: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#kubernetes" class="page__taxonomy-item p-category" rel="tag">Kubernetes</a>
    
    </span>
  </p>



 
        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 更新时间:</strong> <time class="dt-published" datetime="2022-09-08T00:00:00+08:00">September 8, 2022</time></p>
 
      </footer> -->

      <!-- <section class="page__share">
  
    <h4 class="page__share-title">分享</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Pod+%E7%AE%A1%E7%90%86%20%2Fkubernetes-kubeadm-pod%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="分享 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=%2Fkubernetes-kubeadm-pod%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="分享 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=%2Fkubernetes-kubeadm-pod%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="分享 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>
 -->

      
  <nav class="pagination">
    
      <a href="/rs-cisco-config-stp-01/" class="pagination--pager" title="Switch STP
">上一页</a>
    
    
      <a href="/docker-03/" class="pagination--pager" title="docker 入门 – 02
">下一页</a>
    
  </nav>

    </div>

     <div class="page__comments">
  
  
      <h4 class="page__comments-title">留下评论</h4>
      <section id="utterances-comments"></section>
    
</div>

  </article>

</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        
        <div class="page__footer-follow">
  多研究些问题，少谈些主义。
 </div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







    <script>
  'use strict';

  (function() {
    var commentContainer = document.querySelector('#utterances-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://utteranc.es/client.js');
    script.setAttribute('repo', 'yinyaliang/yinyaliang.github.io');
    script.setAttribute('issue-term', 'pathname');
    script.setAttribute('label', 'comment');
    script.setAttribute('theme', 'github-dark');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>

  





  </body>
</html>
